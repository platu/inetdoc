<?xml version='1.0'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
        "/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [

<!ENTITY author		SYSTEM "author.xml">
<!ENTITY legal		SYSTEM "legal.xml">

<!ENTITY url.openldap
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.openldap.org/">
<citetitle>OpenLDAP main page</citetitle></link>'>

<!ENTITY url.openldap.admin-guide
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.openldap.org/doc/admin24/">
<citetitle>OpenLDAP Software 2.4 Administrator&#39;s Guide</citetitle></link>'>

<!ENTITY url.ltb-project
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://ltb-project.org/">
<citetitle>LDAP Tool Box project</citetitle></link>'>

<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.xml'>
%inetdoc_urls;

<!ENTITY % w3centities-f PUBLIC "-//W3C//ENTITIES Combined Set//EN//XML"
	"http://www.w3.org/2003/entities/2007/w3centities-f.ent">
%w3centities-f;
]>

<article xml:id='sysadm-net.ldap' xml:lang='fr'>

<info>
	<title>Introduction aux annuaires LDAP avec OpenLDAP</title>

	&author;
<abstract>
	<para>
	<informaltable frame='none' pgwide='1'>
	<tgroup cols='2' align='left' colsep='0' rowsep='0'>
	<colspec colwidth='5*'/>
	<colspec colwidth='220px'/>
	<tbody>
	<row>
	<entry valign='top'>
	<para>Dans ce support de travaux pratiques, on explore le service
	d'annuaire <acronym>LDAP</acronym>. On présente succinctement les éléments
	constitutifs d'un annuaire puis on étudie la configuration d'un service
	d'annuaire basé sur le logiciel <application>OpenLDAP</application>.
	Ensuite, on étudie la configuration de l'accès aux entrées de l'annuaire
	depuis un poste client. Les informations délivrées par l'annuaire sont les
	propriétés de comptes utilisateurs stockées dans la classe d'objet
	<literal>posixAccount</literal>.</para>
	</entry>
	<entry>
	<inlinemediaobject>
	<imageobject role='html'>
	<imagedata fileref='images/thumb011.png' format='PNG' width='220px' scalefit='1'/>
	</imageobject>
	<imageobject role='fo'>
	<imagedata fileref='images/ldap-tree.png' format='PNG' width='4.5cm' scalefit='1'/>
	</imageobject>
	</inlinemediaobject>
	</entry>
	</row>
	</tbody>
	</tgroup>
	</informaltable>
	</para>
</abstract>

<keywordset>
	<keyword>lab</keyword>
	<keyword>ldap</keyword>
	<keyword>attribut</keyword>
	<keyword>dit</keyword>
	<keyword>ldif</keyword>
	<keyword>slapd</keyword>
	<keyword>slappasswd</keyword>
	<keyword>nsswitch</keyword>
</keywordset>
</info>

<sect1 xml:id='sysadm-net.ldap.legal.meta'>
	&legal;
	<bridgehead xml:id='sysadm-net.ldap.qa.meta'
	renderas='sect2'>Méta-information</bridgehead>

	<para>Ce document est écrit avec <link
	xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link>
	XML sur un système <link
	xlink:href="http://www.debian.org"><citetitle>Debian
	GNU/Linux</citetitle></link>. Il est disponible en version imprimable au
	format PDF : <link
	xlink:href="https://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>

	<bridgehead xml:id='sysadm-net.ldap.qa.convtypo'
	renderas='sect2'>Conventions typographiques</bridgehead>

	<para>Tous les exemples d'exécution des commandes sont précédés d'une
	invite utilisateur ou <wordasword>prompt</wordasword> spécifique au niveau
	des droits utilisateurs nécessaires sur le système.</para>

	<itemizedlist>
	<listitem>
	<para>Toute commande précédée de l'invite <prompt>$</prompt> ne nécessite
	aucun privilège particulier et peut être utilisée au niveau utilisateur
	simple.</para>
	</listitem>
	<listitem>
	<para>Toute commande précédée de l'invite <prompt>#</prompt> nécessite les
	privilèges du super-utilisateur.</para>
	</listitem>
	</itemizedlist>
</sect1>

<sect1 xml:id='sysadm-net.ldap.definition'>
	<title>Principes d'un annuaire LDAP</title>

	<para>Dans l'histoire des systèmes Unix, les services de
	<emphasis>nommage</emphasis> ont connu de nombreuses évolutions avec le
	développement de l'Internet et des volumes d'informations à
	partager.</para>
  
	<para>Au début des années 80, un premier service baptisé
	<wordasword>Network Information Service</wordasword>
	(<acronym>NIS</acronym>) a vu le jour. Ce service est une méthode de
	distribution de la base de données des utilisateurs, de fichiers de
	configuration, d'authentification et d'autres données entre les hôtes d'un
	réseau local. Le logiciel <acronym>NIS</acronym> développé par
	<trademark>Sun Microsystems</trademark> fonctionne sur le mode
	Client/Serveur à partir d'une base de données «à plat» (<wordasword>flat
	bindery base</wordasword>). Son utilisation est étudiée dans le support de
	travaux pratiques &url.sysadm-net.nis;. Avec un service
	<acronym>NIS</acronym>, il n'est pas possible de constituer des groupes
	logiques ayant des attributs propres. Cette limitation est rapidement
	devenue critique avec l'augmentation du nombres des utilisateurs et des
	clients.</para>

	<para>D'autres services plus complets tels que <acronym>NIS+</acronym> ou
	<citetitle>kerberos</citetitle> qui n'assure que la partie authentification
	ont été développés par la suite. Depuis quelques années, les annuaires
	<acronym>LDAP</acronym> ou <wordasword>Lightweight Directory Access
	Protocol</wordasword> se sont imposés comme étant l'outil d'échange
	universel des paramètres utilisateurs.</para>

	<para>Pour définir ce qu'est le service <acronym>LDAP</acronym>, on peut
	retenir les caractéristiques suivantes.</para>

	<itemizedlist>
	<listitem>
	<para>Un service de publication d'annuaire</para>
	</listitem>
	<listitem>
	<para>Un protocole d'accès aux annuaires de type X.500 ou
	<wordasword>Lightweight Directory Access Protocol</wordasword></para>
	</listitem>
	<listitem>
	<para>Un dépôt de données basées sur des attributs ou un «genre» de base de
	données</para>
	</listitem>
	<listitem>
	<para>Un logiciel optimisé pour les recherches avancées et les lectures</para>
	</listitem>
	<listitem>
	<para>Une implémentation client/serveur</para>
	</listitem>
	<listitem>
	<para>Un mécanisme extensible de schémas de description de classes d'objets</para>
	</listitem>
	</itemizedlist>

	<para>Les entrées (<wordasword>Directory Service Entry</wordasword>) d'un
	annuaire <acronym>LDAP</acronym> sont distribuées suivant une arborescence
	(<wordasword>Directory Information Tree</wordasword>) hiérarchisée que l'on
	peut voir comme un système de fichiers avec ses répertoires et ses
	fichiers.  Au sommet de l'arborescence on trouve un nom de racine
	(<wordasword>Domain Component</wordasword>) ou suffixe.</para>

	<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/ldap-tree.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/ldap-tree.png' format='PNG' width='15cm'/>
	</imageobject>
	<textobject>
	<phrase>Arborescence LDAP élémentaire</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap/images/ldap-tree.png'>
	Arborescence LDAP élémentaire - vue complète</link></para>
	</caption>
	</mediaobject>

	<para>L'adresse d'une entrée de l'annuaire <acronym>LDAP</acronym> est
	appelée : <emphasis><wordasword>distinguished name</wordasword></emphasis>
	ou <acronym>dn</acronym>. En reprenant l'exemple d'arborescence ci-dessus,
	les adresses des différentes entrées sont notées comme suit.</para>

	<itemizedlist>
	<listitem>
	<para><literal>dn: dc=lab,dc=stri</literal></para>
	</listitem>
	<listitem>
	<para><literal>dn: ou=lab1,dc=lab,dc=stri</literal></para>
	<para><literal>dn: ou=lab2,dc=lab,dc=stri</literal></para>
	</listitem>
	<listitem>
	<para><literal>dn: cn=etu1,ou=lab1,dc=lab,dc=stri</literal></para>
	<para><literal>dn: cn=etu2,ou=lab1,dc=lab,dc=stri</literal></para>
	<para><literal>dn: cn=etu3,ou=lab2,dc=lab,dc=stri</literal></para>
	<para><literal>dn: cn=etu4,ou=lab2,dc=lab,dc=stri</literal></para>
	</listitem>
	</itemizedlist>

	<para>L'adresse de chaque entrée appartient à une classe d'objet
	(<wordasword>ObjectClass</wordasword>) spécifiée dans un schéma
	(<wordasword>schema</wordasword>). En reprenant les mêmes exemples
	d'entrées, on peut associer les classes d'objets correspondantes.</para>

	<informaltable frame='all'>
	<tgroup cols='2' colsep='1' rowsep='1'>
	<thead>
	<row>
	<entry><wordasword>entry</wordasword></entry>
	<entry><wordasword>objectclass</wordasword></entry>
	</row>
	</thead>
	<tbody>
	<row>
	<entry>
	<para><literal>o: lab.stri</literal></para>
	<para><literal>dc: lab</literal></para>
	<para><literal>dc: stri</literal></para>
	</entry>
	<entry>
	<para><literal>organisation</literal></para>
	<para><literal>dcObject</literal></para>
	<para><literal>dcObject</literal></para>
	</entry>
	</row>
	<row>
    <entry>
	<para><literal>ou: lab1</literal></para>
	</entry>
	<entry>
	<para><literal>organisationalUnit</literal></para>
	</entry>
	</row>
	<row>
	<entry>
	<para><literal>cn: etu1</literal></para>
	<para><literal>sn: etu1</literal></para>
	</entry>
	<entry>
	<para><literal>inetOrgPerson</literal></para>
	</entry>
	</row>
	</tbody>
	</tgroup>
	</informaltable>

	<para>Un schéma peut être vu comme un ensemble de règles qui décrivent la
	nature des données stockées. C'est un outil qui aide à maintenir la
	cohérence, la qualité et qui évite la duplication des données dans
	l'annuaire. Les attributs des classes d'objets déterminent les règles qui
	doivent être appliquées à une entrée. Un schéma contient les éléments
	suivants.</para>

	<itemizedlist>
	<listitem>
	<para>Les attributs requis</para>
	</listitem>
	<listitem>
	<para>Les attributs autorisés</para>
	</listitem>
	<listitem>
	<para>Les règles de comparaison des attributs</para>
	</listitem>
	<listitem>
	<para>Les valeurs limites qu'un attribut peut recevoir</para> 
	</listitem>
	<listitem>
	<para>Les restrictions sur les informations qui peuvent être enregistrées</para>
	</listitem>
	</itemizedlist>
</sect1>

<sect1 xml:id='sysadm-net.ldap.srvr'>
	<title>Configuration du serveur LDAP</title>

	<para>Avant d'aborder la configuration du service <acronym>LDAP</acronym>,
		il faut passer par les étapes rituelles de sélection et d'installation
		des paquets contenant les outils logiciels du service. Ensuite, il faut
		identifier les processus, les numéros de ports ouverts et les fichiers
		de configuration à éditer.</para>

<sect2 xml:id='sysadm-net.ldap.srvr.install'>
	<title>Installation du serveur LDAP</title>

<qandaset defaultlabel='number'>
	<qandadiv xml:id='sysadm-net.ldap.srvr.q1'>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q1-package'>
	<question>
	<para><phrase>Quels sont les paquets Debian relatifs au service
		<acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Interroger la base de données des paquets pour obtenir les
		informations demandées.</para>
	</question>
	<answer>
	<para>Dans la requête ci-dessous, on privilégie la recherche dans les
		champs de description des paquets.</para>

<screen><prompt>$</prompt> aptitude search '?description(OpenLDAP)'
p   collectd-core               - démon de statistiques et surveillance – système central
p   golang-openldap-dev         - OpenLDAP client integration for Go, using cgo
p   ldap-git-backup             - Back up LDAP database in an Git repository
p   ldap-utils                  - OpenLDAP utilities
p   ldapscripts                 - Add and remove users and groups (stored in a LDAP directory)
p   libdbd-ldap-perl            - Perl extension for LDAP access via an SQL/Perl DBI interface
i A libldap-2.4-2               - Bibliothèques OpenLDAP
i A libldap-common              - fichiers communs OpenLDAP pour les bibliothèques
p   libldap2-dev                - bibliothèques de développement pour OpenLDAP
p   liblmdb-dev                 - Lightning Memory-Mapped Database development files
p   liblmdb0                    - Lightning Memory-Mapped Database shared library
p   libmozilla-ldap-perl        - LDAP Perl module for the OpenLDAP C SDK
p   libnet-ldapapi-perl         - Perl bindings for OpenLDAP C API
p   libsasl2-modules-ldap       - Cyrus SASL - pluggable authentication modules (LDAP)
p   lmdb-doc                    - Lightning Memory-Mapped Database doxygen documentation
p   lmdb-utils                  - Lightning Memory-Mapped Database Utilities
p   lua-ldap                    - LDAP library for the Lua language
p   python-django-python3-ldap  - Django LDAP user authentication backend (Python2 version)
p   python-ldap                 - LDAP interface module for Python
p   python-ldap-dbg             - LDAP interface module for Python (debug extension)
p   python-lmdb                 - Python binding for LMDB Lightning Memory-Mapped Database
p   python-pyldap               - implements an LDAP client - Python 2.7
p   python-pyldap-doc           - implements an LDAP client - doc
p   python3-django-python3-ldap - Django LDAP user authentication backend (Python3 version)
p   python3-lmdb                - Python 3 binding for LMDB Lightning Memory-Mapped Database
p   python3-pyldap              - implements an LDAP client - Python 3.x
p   ruby-ldap                   - OpenLDAP library binding for Ruby
p   schema2ldif                 - Tool for converting OpenLDAP-style schemas to the LDIF format
p   slapd                       - OpenLDAP server (slapd)
p   smbldap-tools               - Scripts to manage Unix and Samba accounts stored on LDAP
p   vbackup                     - utilitaire modulaire de sauvegarde</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quels sont les paquets Debian à installer pour mettre en
		œuvre un serveur <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Dans liste obtenue en réponse à la question précédente, rechercher
		les paquets relatifs aux utilitaires et au serveur.</para>
	</question>
	<answer>
	<para>Dans la liste ci-dessus, on retient deux paquets :
		<systemitem>ldap-utils</systemitem> et
		<systemitem>slapd</systemitem>.</para>

<screen><prompt>#</prompt> aptitude install slapd ldap-utils
Les NOUVEAUX paquets suivants vont être installés :
  ldap-utils libltdl7{a} libodbc1{a} slapd
0 paquets mis à jour, 4 nouvellement installés, 0 à enlever et 0 non mis à jour.
Il est nécessaire de télécharger 2 314 ko d'archives. Après dépaquetage, 19,0 Mo
seront utilisés.
Voulez-vous continuer ? [Y/n/?]</screen>

	<para>Lors de l'installation, deux écrans <systemitem>debconf</systemitem>
		demandent la saisie du mot de passe administrateur du service
		<acronym>LDAP</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q1-proc'>
	<question>
	<para><phrase>Comment identifier le ou les processus correspondant au
		service installé&nbsp;?</phrase></para>

	<para>Utiliser une commande d'affichage de la liste des processus actifs
		sur le système pour identifier le démon correspondant au serveur
		<acronym>LDAP</acronym>.</para>
	</question>
	<answer>

<screen><prompt>$</prompt> ps aux | grep  l[d]ap
openldap  1303  0.0  0.1 1078732 5936&nbsp;?        Ssl  19:22   0:00 \
 /usr/sbin/slapd -h ldap:/// ldapi:/// -g openldap -u openldap -F /etc/ldap/slapd.d</screen>

	<para>À partir de ces informations, on identifie le démon serveur
		<systemitem class='daemon'>slapd</systemitem>, le compte utilisateur et
		le groupe système propriétaires du processus
		(<option>openldap</option>) et enfin le répertoire contenant les
		fichiers de configuration <filename
		class='directory'>/etc/ldap/slapd.d</filename>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment identifier le ou les numéros de ports ouverts par le
		service installé&nbsp;?</phrase></para>

	<para>Utiliser une commande d'affichage de la liste des ports ouverts sur
		le système.</para>
	</question>
	<answer>
	<para>Voici deux exemples usuels.</para>

<screen><prompt>#</prompt> lsof -i | grep l[d]ap
slapd    1303    openldap    8u  IPv4  22394      0t0  TCP *:ldap (LISTEN)
slapd    1303    openldap    9u  IPv6  22395      0t0  TCP *:ldap (LISTEN)</screen>

<screen><prompt>#</prompt> ss -tau | grep l[d]ap
tcp    LISTEN     0      128     *:ldap                  *:*
tcp    LISTEN     0      128    :::ldap                 :::*</screen>

	<para>Les numéros de port enregistrés pour le service
		<acronym>LDAP</acronym> sont disponibles dans le fichier
		<filename>/etc/services</filename>.</para>

<screen><prompt>$</prompt> grep ldap /etc/services
ldap            389/tcp        # Lightweight Directory Access Protocol
ldap            389/udp
ldaps           636/tcp        # LDAP over SSL
ldaps           636/udp</screen>

	<para>Relativement au indications données par les commandes
		<command>lsof</command> et <command>ss</command>, c'est le numéro de
		port 389 qui est ouvert en écoute lors de l'installation du paquet
		<systemitem>slapd</systemitem>.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.ldap.srvr.config'>
	<title>Analyse de la configuration du service LDAP</title>

	<para>Les versions récentes du logiciel <citetitle>OpenLDAP</citetitle>
		utilisent un mode de configuration basé sur un <wordasword>Directory
		Information Tree</wordasword> ou <acronym>DIT</acronym> propre.
		Cette arborescence de configuration est pointée par le nom
		<option>cn=config</option>. Elle est utilisée pour configurer
		dynamiquement	le démon <systemitem>slapd</systemitem>, modifier les
		définitions de schéma, les index, les listes de contrôle d'accès
		<acronym>ACLs</acronym>,	etc. Ce mode de configuration présente un
		avantage déterminant lorsque l'on	exploite des annuaires volumineux :
		toutes les opérations se font sans interruption de service.</para>

<qandaset defaultlabel='number'>
	<qandadiv xml:id='sysadm-net.ldap.srvr.q2'>

	<para>Les documents fournis avec le paquet <systemitem>slapd</systemitem>
		contiennent des informations indispensables à l'analyse du
		fonctionnement	du service.</para>

	<qandaentry>
	<question>
	<para><phrase>Quel est le mode de gestion de la configuration du service
		adopté depuis la version <option>2.4.23-3</option> du paquet de la
		distribution Debian GNU/Linux&nbsp;?</phrase></para>

	<para>Consulter les fichiers de documentation fournis avec le paquet
		<systemitem>slapd</systemitem>.</para>
	</question>
	<answer>
	<para>Les documents relatifs au paquet <systemitem>slapd</systemitem> sont
		situés dans le répertoire <filename
		class='directory'>/usr/share/doc/slapd/</filename>. Le fichier
		<filename>README.Debian.gz</filename> contient un exemple d'instruction
		de consultation de la configuration du service.</para>

<screen><prompt>#</prompt> ldapsearch -Y EXTERNAL -H ldapi:/// -b "cn=config"</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est le gestionnaire de base de données
		(<wordasword>backend</wordasword>) proposé dans l'annuaire de
		configuration&nbsp;?</phrase></para>

	<para>Reprendre la commande préconisée en réponse à la question précédente
		en utilisant le type de base de donnée comme filtre.</para>
	</question>
	<answer>

<screen><prompt>#</prompt> ldapsearch -Y EXTERNAL -H ldapi:/// -b "cn=config" olcDatabase={1}mdb
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
# extended LDIF
#
# LDAPv3
# base &lt;cn=config> with scope subtree
# filter: olcDatabase={1}mdb
# requesting: ALL
#

# {1}mdb, config
<emphasis>dn: olcDatabase={1}mdb,cn=config</emphasis>
objectClass: olcDatabaseConfig
objectClass: olcMdbConfig
olcDatabase: {1}mdb
olcDbDirectory: /var/lib/ldap
olcSuffix: dc=nodomain
olcAccess: {0}to attrs=userPassword by self write by anonymous auth by * none
olcAccess: {1}to attrs=shadowLastChange by self write by * read
olcAccess: {2}to * by * read
olcLastMod: TRUE
olcRootDN: cn=admin,dc=nodomain
olcRootPW: {SSHA}Hsonccb6iwsCLyvV5Qa8SNbwO9vNVVej
olcDbCheckpoint: 512 30
olcDbIndex: objectClass eq
olcDbIndex: cn,uid eq
olcDbIndex: uidNumber,gidNumber eq
olcDbIndex: member,memberUid eq
olcDbMaxSize: 1073741824

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1</screen>

	<para>Par définition, un annuaire <acronym>LDAP</acronym> est une base de
		données optimisée en lecture. Du point de vue implémentation, les
		entrées sont stockées sous forme «binaire» et indexées à l'aide d'un
		gestionnaire de base de données. Le gestionnaire d'arrière plan proposé
		par défaut est <option>mdb</option>. Il s'agit d'une variante récente
		du gestionnaire <wordasword>Berkeley DB transactional
		backend</wordasword>.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q2-suffix'>
	<question>
	<para><phrase>Comment identifier le nom de l'annuaire fourni par défaut
		avec le paquet <systemitem>slapd</systemitem>&nbsp;?</phrase></para>

	<para>Rechercher la clé <literal>olcSuffix</literal> dans la configuration
		de l'annuaire.</para>
	</question>
	<answer>

<screen><prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" olcSuffix | grep ^olcSuffix
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
olcSuffix: <emphasis>dc=nodomain</emphasis></screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q2-schema'>
	<question>
	<para><phrase>Quels sont les <wordasword>schemas</wordasword> actifs avec
		la configuration courante du paquet <systemitem>slapd</systemitem>
		?</phrase></para>

	<para>Rechercher la clé <literal>olcSchemaConfig</literal> dans la
		configuration de l'annuaire.</para>
	</question>
	<answer>

<screen><prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" olcSchemaConfig | grep ^cn
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
cn: config
cn: module{0}
cn: schema
cn: <emphasis>{0}core</emphasis>
cn: <emphasis>{1}cosine</emphasis>
cn: <emphasis>{2}nis</emphasis>
cn: <emphasis>{3}inetorgperson</emphasis></screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q2-base'>
	<question>
	<para><phrase>Où sont stockées les bases définies par défaut lors de
		l'installation du paquet <systemitem>slapd</systemitem>
		?</phrase></para>

	<para>Rechercher la clé <literal>olcDbDirectory</literal> dans la
		configuration de l'annuaire.</para>
	</question>
	<answer>

<screen><prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" olcDbDirectory |\
	grep ^olcDbDirectory
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
olcDbDirectory: <emphasis>/var/lib/ldap</emphasis></screen>

	<para>C'est dans le répertoire <filename
		class='directory'>/var/lib/ldap</filename> que sont stockées les
		fichiers des bases <wordasword>Berkeley DB</wordasword>.</para>

<screen><prompt>#</prompt> ls -lAh /var/lib/ldap/
total 68K
-rw------- 1 openldap openldap  64K sept. 12 17:21 data.mdb
-rw------- 1 openldap openldap 8,0K sept. 12 17:21 lock.mdb</screen>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.ldap.srvr.init'>
	<title>Réinitialisation de la base de l'annuaire LDAP</title>

<qandaset defaultlabel='number'>
	<qandadiv xml:id='sysadm-net.ldap.srvr.q3'>

	<para>L'installation du paquet <systemitem>slapd</systemitem> implique
		l'installation d'un annuaire minimal avec une base associée. Ce mode
		opératoire est nécessaire, ne serait-ce que pour accéder à la
		configuration	du service et tester la validité de l'installation.
		Après avoir traité les questions ci-dessus, on sait que l'installation
		est fonctionnelle. On peut donc passer à l'initialisation de notre
		propre annuaire.</para>

<note>
	<para>Les manipulations proposées dans cette section permettent de
		reprendre à zéro la configuration d'un annuaire
		<acronym>LDAP</acronym>. Il peut être utile de revenir à cette étape en
		cas de «doute» sur l'intégrité de l'annuaire lors du traitement des
		questions des sections suivantes.</para>
</note>

	<qandaentry>
	<question>
	<para><phrase>Comment arrêter le service <acronym>LDAP</acronym>
		?</phrase></para>

	<para>Utiliser les scripts fournis avec le gestionnaire de lancement des
		processus système.</para>
	</question>
	<answer>
	<para>Chaque processus système dispose d'un script de gestion de son
		lancement, arrêt (et|ou) redémarrage. Avec le gestionnaire
		<application>systemd</application>, il faut faire une recherche dans la
		liste des services. Une fois le service identifié, on l'arrête avec la
		commande <command>systemctl</command>.</para>

<screen><prompt>#</prompt> systemctl list-units | grep slapd
slapd.service       loaded active running   LSB: OpenLDAP standalone server

<prompt>#</prompt> systemctl stop slapd</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quels sont les éléments à supprimer pour pouvoir installer
		une nouvelle configuration et une nouvelle base
		<acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Utiliser le résultat de la question sur la <link
		linkend='sysadm-net.ldap.srvr.q2-base'>localisation des
		bases</link> et la documentation fournie avec le paquet
		<systemitem>slapd</systemitem>.</para>
	</question>
	<answer>
	<para>À partir des réponses aux questions ci-dessus, on sait que c'est le
		répertoire <filename class='directory'>/var/lib/ldap/</filename> qui
		contient les bases. La lecture du fichier de documentation du paquet
		avec la commande <userinput><prompt>#</prompt> zless
		/usr/share/doc/slapd/README.Debian.gz</userinput> indique que les
		fichiers de configuration sont situés dans le répertoire <filename
		class='directory'>/etc/ldap/slapd.d/</filename>.</para>

	<para>On supprime donc tous ces fichiers et répertoires.</para>

<screen><prompt>#</prompt> rm /var/lib/ldap/*
<prompt>#</prompt> rm -rf /etc/ldap/slapd.d</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment reprendre à zéro la configuration du paquet
		<systemitem>slapd</systemitem>&nbsp;?</phrase></para>

	<para>Utiliser l'outil du gestionnaire de paquets <citetitle>Debian
		GNU/Linux</citetitle> qui permet la modification des paramètres de
		configuration d'un service à l'aide de menus
		<systemitem>debconf</systemitem>.</para>
	</question>
	<answer>
	<para>C'est la commande <command>dpkg-reconfigure</command> qui sert à
		réviser les paramètres de configuration d'un paquet. Voici une copie
		des	écrans proposés avec le paquet
		<systemitem>slapd</systemitem>.</para>

<screen><prompt>#</prompt> dpkg-reconfigure slapd
No configuration file was found for slapd at /etc/ldap/slapd.conf. ... (warning).
  Creating initial configuration... done.
  Creating LDAP directory... done.
Starting OpenLDAP: slapd.</screen>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/dpkg-reconfigure-slapd-1.png' format='PNG' width='400px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/dpkg-reconfigure-slapd-1.png' format='PNG'  width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/dpkg-reconfigure-slapd-1.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/dpkg-reconfigure-slapd-2.png' format='PNG' width='400px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/dpkg-reconfigure-slapd-2.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/dpkg-reconfigure-slapd-2.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/dpkg-reconfigure-slapd-3.png' format='PNG' width='400px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/dpkg-reconfigure-slapd-3.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/dpkg-reconfigure-slapd-3.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/dpkg-reconfigure-slapd-4.png' format='PNG' width='400px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/dpkg-reconfigure-slapd-4.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/dpkg-reconfigure-slapd-4.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/dpkg-reconfigure-slapd-5.png' format='PNG' width='400px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/dpkg-reconfigure-slapd-5.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/dpkg-reconfigure-slapd-5.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/dpkg-reconfigure-slapd-6.png' format='PNG' width='380px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/dpkg-reconfigure-slapd-6.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/dpkg-reconfigure-slapd-6.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/dpkg-reconfigure-slapd-7.png' format='PNG' width='320px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/dpkg-reconfigure-slapd-7.png' format='PNG' width='6cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/dpkg-reconfigure-slapd-7.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/dpkg-reconfigure-slapd-8.png' format='PNG' width='400px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/dpkg-reconfigure-slapd-8.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/dpkg-reconfigure-slapd-8.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment valider la nouvelle configuration du paquet
		<systemitem>slapd</systemitem>&nbsp;?</phrase></para>

	<para>Reprendre la question sur le <link
		linkend='sysadm-net.ldap.srvr.q2-suffix'>nom distinctif</link> de
		l'annuaire.</para>
	</question>
	<answer>
<screen><prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" olcSuffix | grep ^olcSuffix
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
olcSuffix: <emphasis>dc=lab,dc=stri</emphasis></screen>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.ldap.srvr.build'>
	<title>Composition d'un nouvel annuaire LDAP</title>

	<para>Une fois que les fichiers de configuration et de base de données du
		nouvel annuaire sont en place, on peut passer à l'ajout de nouvelles
		entrées dans cet annuaire. Comme le fil conducteur de cette série de
		travaux pratiques est la gestion d'une base de comptes utilisateurs, on
		doit ajouter les objets suivants.</para>

	<itemizedlist>
	<listitem>
	<para>Deux unités organisationnelles : <option>people</option> et
		<option>groups</option>.</para>
	</listitem>
	<listitem>
	<para>Quatre compte utilisateurs : papa et maman Skywalker ainsi que leurs
		deux enfants</para>
	</listitem>
	</itemizedlist>

	<para>Toutes les manipulations sur les objets de l'annuaire utilisent un
		format de fichier texte particulier baptisé <acronym>LDIF</acronym>
		pour <wordasword>LDAP Data Interchange Format</wordasword>. C'est un
		format de représentation des données contenues dans un annuaire
		particulièrement utile pour les opérations de sauvegarde et de
		restauration en volume.</para>
    
	<para>Du point de vue formatage, chaque enregistrement doit être séparé du
		suivant par une ligne vide et chaque attribut d'un enregistrement
		apparaît sur une ligne sous la forme «nomAttribut: valeur».</para>

<qandaset defaultlabel='number'>
	<qandadiv xml:id='sysadm-net.ldap.srvr.q4'>

	<qandaentry>
	<question>
	<para><phrase>Comment visualiser la liste des entrées contenues dans
		l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Utiliser les pages de manuels de la commande
		<command>ldapsearch</command> et rechercher les informations sur les
		méthodes d'authentification, la désignation de la base dans laquelle on
		effectue la recherche et le nom distinctif utilisé pour se connecter à
		l'annuaire.</para>
	</question>
	<answer>
	<para>La commande <command>ldapsearch</command> propose plusieurs modes
		d'authentification qui influent sur la liste des attributs affichés
		pour une même entrée. Dans notre exemple, ce sont les mots de passes
		qui peuvent ne pas apparaître ou apparaître sous différentes
		formes.</para>

	<itemizedlist>
	<listitem>
	<para>L'option <option>-x</option> évite le recours à la méthode
		<acronym>SASL</acronym> pour l'authentification.</para>

<screen><prompt>#</prompt> ldapsearch -LLL -x -H ldap:/// -b "dc=lab,dc=stri" -D cn=admin,dc=lab,dc=stri -W
Enter LDAP Password: 
dn: dc=lab,dc=stri
objectClass: top
objectClass: dcObject
objectClass: organization
o: lab.stri
dc: lab

dn: cn=admin,dc=lab,dc=stri
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator
<emphasis>userPassword:: e1NTSEF9Ykd1QVJVWi82UWt1WXhpd1QvS0ZVUHM5dkFpNVdwVU4=</emphasis></screen>
	</listitem>

	<listitem>
	<para>L'option <option>-Y EXTERNAL</option> utilise la méthode
		<acronym>SASL</acronym> du même nom.</para>

<screen><prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "dc=lab,dc=stri" \
	-D cn=admin,dc=lab,dc=stri -W
Enter LDAP Password: 
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
dn: dc=lab,dc=stri
objectClass: top
objectClass: dcObject
objectClass: organization
o: lab.stri
dc: lab

dn: cn=admin,dc=lab,dc=stri
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator</screen>
	</listitem>

	<listitem>
	<para>L'option <option>-LLL</option> désactive l'affichage des commentaires
		et de la version <acronym>LDIF</acronym> utilisée dans la
		réponse.</para>
	</listitem>

	<listitem>
	<para>L'option <option>-b</option> désigne le point de départ de la
		recherche.</para>
	</listitem>

	<listitem>
	<para>L'option <option>-D</option> désigne le nom distinctif de connexion à
		l'annuaire.</para>
	</listitem>

	<listitem>
	<para>L'option <option>-W</option> provoque l'affichage de l'invite de
		demande du mot passe correspondant au nom distinctif utilisé.</para>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-LogLevel'>
	<question>
	<para><phrase>Comment activer la journalisation des manipulations sur les
		entrées de l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Rechercher l'entrée relative au niveau de journalisation dans le
		<acronym>DIT</acronym> et modifier sa valeur de façon à obtenir un état
		dans les journaux système à chaque opération sur l'annuaire.</para>

	<para>La modification de l'entrée du <acronym>DIT</acronym> doit se faire à
		l'aide d'un fichier <acronym>LDIF</acronym> approprié.</para>
	</question>
	<answer>
	<para>L'entrée à rechercher dans le <acronym>DIT</acronym> est baptisée
		<option>olcLogLevel</option>.</para>

<screen><prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" olcLogLevel |\
   	grep ^olcLogLevel
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
<emphasis>olcLogLevel: none</emphasis></screen>

	<para>on se propose de modifier la valeur <option>none</option> par
		<option>stats</option> de façon à journaliser les connexions, les
		opérations et les résultats. Voici une copie du fichier
		<acronym>LDIF</acronym> permettant de réaliser cette
		modification.</para>

<screen><prompt>#</prompt> cat setolcLogLevel2stats.ldif 
# Set olcLogLevel 2 stats
dn: cn=config
changetype: modify
replace: olcLogLevel
olcLogLevel: stats</screen>

	<para>On applique ce changement de valeur avec la commande
		<command>ldapmodify</command> puis on vérifie que l'attribut a bien
		reçu le paramètre.</para>

<screen><prompt>#</prompt> ldapmodify -Y EXTERNAL -H ldapi:/// -f setolcLogLevel2stats.ldif 
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"

<prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" olcLogLevel |\
	grep ^olcLogLevel
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
<emphasis>olcLogLevel: stats</emphasis></screen>

	<para>Enfin, on relève les traces de la dernière opération dans les
		journaux système.</para> 

<screen><prompt>#</prompt> grep -5 olcLogLevel /var/log/syslog
slapd[4867]: conn=1004 op=0 BIND dn="" method=163
slapd[4867]: conn=1004 op=0 BIND authcid="gidNumber=0+uidNumber=0,\
	cn=peercred,cn=external,cn=auth" \
	authzid="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth"
slapd[4867]: conn=1004 op=0 BIND dn="gidNumber=0+uidNumber=0,\
	cn=peercred,cn=external,cn=auth" \
	mech=EXTERNAL sasl_ssf=0 ssf=71
slapd[4867]: conn=1004 op=0 RESULT tag=97 err=0 text=
slapd[4867]: conn=1004 op=1 SRCH base="cn=config" scope=2 deref=0 \
	filter="(objectClass=*)"
slapd[4867]: conn=1004 op=1 <emphasis>SRCH attr=olcLogLevel</emphasis>
slapd[4867]: conn=1004 op=1 SEARCH RESULT tag=101 <emphasis>err=0</emphasis> nentries=11 text=
slapd[4867]: conn=1004 op=2 UNBIND
slapd[4867]: conn=1004 fd=14 closed</screen>

<note>
	<para>Dans le contexte des travaux pratiques, le nombre d'entrées de
		l'annuaire reste très limité et la journalisation n'a pas d'impact
		mesurable sur les performances du système. Dans un contexte
		d'exploitation réelle avec un annuaire comprenant au moins une dizaine
		de milliers d'entrées, la situation est très différente et il faut
		limiter au maximum le recours à la journalisation des transactions sur
		l'annuaire.</para>
</note>

	<para>Pour ramener la valeur de l'attribut <option>olcLogLevel</option> à
		<option>none</option>, il suffit de créer un fichier
		<acronym>LDIF</acronym> avec la directive correspondante.</para> 

<screen># Set olcLogLevel 2 none
dn: cn=config
changetype: modify
replace: olcLogLevel
olcLogLevel: none</screen>
      </answer>
    </qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-ou'>
	<question>
	<para><phrase>Quelle est la syntaxe du fichier <acronym>LDIF</acronym> qui
		permet d'ajouter les deux unités organisationnelles
		(<wordasword>organisational unit</wordasword>)&nbsp;?</phrase></para>

	<para>Rechercher un tutoriel <acronym>LDIF</acronym> en ligne donnant un
		exemple de fichier <acronym>LDIF</acronym> avec une ou plusieurs
		entrées <option>ou:</option>.</para>
	</question>
	<answer>
	<para>Voici un exemple de fichier <acronym>LDIF</acronym> contenant les
		déclarations des deux unités organisationnelles à ajouter.</para>

<screen><prompt>#</prompt> cat ou.ldif 
dn: ou=people,dc=lab,dc=stri
objectClass: organizationalUnit
ou: people

dn: ou=groups,dc=lab,dc=stri
objectClass: organizationalUnit
ou: groups</screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-ldapadd'>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour ajouter une ou
		plusieurs entrées dans l'annuaire&nbsp;?</phrase></para>

	<para>Rechercher dans la liste des programmes fournis avec le paquet des
		outils <acronym>LDAP</acronym>.</para>
	</question>
	<answer>
	<para>C'est la commande <command>ldapadd</command> qui est utile dans notre
		contexte. On l'utilise en mode d'authentification simple avec le
		fichier <acronym>LDIF</acronym> ci-dessus pour compléter
		l'annuaire.</para>

<screen><prompt>#</prompt> ldapadd -cxWD cn=admin,dc=lab,dc=stri -f ou.ldif 
Enter LDAP Password: 
adding new entry "ou=people,dc=lab,dc=stri"

adding new entry "ou=groups,dc=lab,dc=stri"</screen>

	<para>On vérifie ensuite que les deux nouvelles entrées sont bien présentes
		dans l'annuaire.</para>

<screen><prompt>#</prompt> ldapsearch -LLL -x -H ldap:/// -b "dc=lab,dc=stri" -D cn=admin,dc=lab,dc=stri -W
Enter LDAP Password: 
dn: dc=lab,dc=stri
objectClass: top
objectClass: dcObject
objectClass: organization
o: lab.stri
dc: lab

dn: cn=admin,dc=lab,dc=stri
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator
userPassword:: e1NTSEF9Ykd1QVJVWi82UWt1WXhpd1QvS0ZVUHM5dkFpNVdwVU4=

dn: ou=people,dc=lab,dc=stri
objectClass: organizationalUnit
ou: people

dn: ou=groups,dc=lab,dc=stri
objectClass: organizationalUnit
ou: groups</screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-passwd'>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour saisir manuellement un
		mot de passe et obtenir la chaîne chiffrée correspondante
		?</phrase></para>

	<para>Rechercher dans la liste des programmes fournis avec les paquets de
		la distribution puis consulter les pages de manuels
		correspondantes.</para>
	</question>
	<answer>
	<para>En effectuant une recherche par mot clé dans les pages de manuels du
		système, on peut identifier l'outil recherché.</para>

<screen><prompt>#</prompt> man -k passwd | grep -i ldap
ldappasswd (1)       - change the password of an LDAP entry
<emphasis>slappasswd</emphasis> (8)       - OpenLDAP password utility</screen>

	<para>On utilise la commande <command>slappasswd</command> pour générer une
		chaîne chiffrée que l'on insère dans le fichier <acronym>LDIF</acronym>
		des comptes utilisateurs.</para>

<screen><prompt>#</prompt> slappasswd 
New password: 
Re-enter new password: 
{SSHA}LrPFvc6YekTGSEYiMezxYxcmE/0ZE/9L</screen>

	<para>Dans le contexte de ces travaux pratiques, on attribue le même mot de
		passe aux quatre comptes utilisateurs.</para>

	<para>Il existe une technique simple pour la génération de mots de passe
		utilisateurs aléatoires. Une fois le mot de passe généré, il peut être
		transmis à l'utilisateur final par un «canal de confiance» et implanté
		dans les attributs de l'annuaire relatifs au compte utilisateur.</para>

<screen><prompt>#</prompt> head -c 9 /dev/urandom | base64
<emphasis>piupfsRIU23u</emphasis>
<prompt>#</prompt> slappasswd -v -h "{SSHA}" -s <emphasis>piupfsRIU23u</emphasis>
{SSHA}PxK09I2Oi6ZA2bPP55Eptm9JRkJeP6oV</screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-posixAccount'>
	<question>
	<para><phrase>Quelle est la syntaxe du fichier <acronym>LDIF</acronym> qui
		permet d'ajouter les quatre utilisateurs avec leurs attributs
		système : identifiants <systemitem>uid/gid</systemitem>,
		authentifiants <systemitem>login/passwd</systemitem>, etc
		?</phrase></para>

	<para>Rechercher un tutoriel <acronym>LDIF</acronym> en ligne donnant un
		exemple de fichier <acronym>LDIF</acronym> avec un exemple de
		description des attributs d'un compte utilisateur.</para>
	</question>
	<answer>
	<para>Voici un exemple de fichier <acronym>LDIF</acronym> contenant les
		déclarations des quatre comptes utilisateurs à ajouter.</para>

<screen><prompt>#</prompt> cat users.ldif 
# Padmé Amidala
dn: uid=padme,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Padme
sn: Padmé Amidala Skywalker
uid: padme
uidNumber: 10000
gidNumber: 10000
loginShell: /bin/bash
homeDirectory: /ahome/padme
userPassword: {SSHA}LrPFvc6YekTGSEYiMezxYxcmE/0ZE/9L
gecos: Padme Amidala Skywalker

# Anakin Skywalker
dn: uid=anakin,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Anakin
sn: Anakin Skywalker
uid: anakin
uidNumber: 10001
gidNumber: 10001
loginShell: /bin/bash
homeDirectory: /ahome/anakin
userPassword: {SSHA}LrPFvc6YekTGSEYiMezxYxcmE/0ZE/9L
gecos: Anakin Skywalker

# Leia Organa Skywalker
dn: uid=leia,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Leia
sn: Leia Organa
uid: leia
uidNumber: 10002
gidNumber: 10002
loginShell: /bin/bash
homeDirectory: /ahome/leia
userPassword: {SSHA}LrPFvc6YekTGSEYiMezxYxcmE/0ZE/9L
gecos: Leia Organa Skywalker

# Luke Skywalker
dn: uid=luke,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Luke
sn: Luke Skywalker
uid: luke
uidNumber: 10003
gidNumber: 10003
loginShell: /bin/bash
homeDirectory: /ahome/luke
userPassword: {SSHA}LrPFvc6YekTGSEYiMezxYxcmE/0ZE/9L
gecos: Luke Skywalker</screen>

	<para>Comme dans le cas précédent, on utilise la commande
		<command>ldapadd</command> en mode d'authentification simple pour
		insérer les comptes dans l'annuaire.</para>

<screen><prompt>#</prompt> ldapadd -cxWD cn=admin,dc=lab,dc=stri -f users.ldif 
Enter LDAP Password: 
adding new entry "uid=padme,ou=people,dc=lab,dc=stri"

adding new entry "uid=anakin,ou=people,dc=lab,dc=stri"

adding new entry "uid=leia,ou=people,dc=lab,dc=stri"

adding new entry "uid=luke,ou=people,dc=lab,dc=stri"</screen>

	<para>Le résultat de la commande <userinput><prompt>#</prompt> ldapsearch
		-LLL -x -H ldap:/// -b "dc=lab,dc=stri" -D cn=admin,dc=lab,dc=stri
		-W</userinput> doit faire apparaître les nouvelles entrées de
		l'annuaire.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.ldap.clnt'>
	<title>Configuration de l'accès client au serveur LDAP</title>

	<para>Dans cette section, on suppose qu'un annuaire <acronym>LDAP</acronym>
		existe et qu'il contient des comptes utilisateurs. On se propose de
		configurer un poste client pour qu'il obtienne de façon transparente
		les informations sur les comptes utilisateurs desservis par
		l'annuaire.</para>

<sect2 xml:id='sysadm-net.ldap.clnt.query'>
	<title>Interrogation à distance de l'annuaire LDAP</title>

	<para>On reprend ici les requêtes de consultation des entrées de l'annuaire
		vues dans la <xref linkend='sysadm-net.ldap.srvr.build'/>. Cette
		fois-ci les requêtes sont émises depuis un hôte réseau différent du
		serveur <acronym>LDAP</acronym>.</para>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Quel est le paquet qui fournit, entre autres, la commande
		de consultation des entrées de l'annuaire&nbsp;?</phrase></para>

	<para>Interroger la base de données des paquets pour obtenir les
		informations demandées.</para>
	</question>
	<answer>
<screen><prompt>#</prompt> aptitude install ldap-utils</screen>

	<para>Le paquet <systemitem>ldap-utils</systemitem> apparaît à la question
		sur <link linkend='sysadm-net.ldap.srvr.q1-package'>la liste des
		paquets relatifs au service</link> <acronym>LDAP</acronym>. Si on
		recherche les commandes présentes dans la liste des fichiers de ce
		paquet, on obtient les informations suivantes.</para>

<screen><prompt>$</prompt> dpkg -L ldap-utils | grep bin
/usr/bin
/usr/bin/ldapmodrdn
/usr/bin/ldappasswd
/usr/bin/ldapdelete
/usr/bin/ldapsearch
/usr/bin/ldapmodify
/usr/bin/ldapexop
/usr/bin/ldapurl
/usr/bin/ldapcompare
/usr/bin/ldapwhoami
/usr/bin/ldapadd</screen>

	<para>Une fois ce paquet installé, il est possible d'utiliser toutes
		les commandes disponibles pour manipuler les enregistrements de
		l'annuaire.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe d'interrogation de l'annuaire qui
		permet d'obtenir tous les attributs de l'enregistrement
		correspondant à un utilisateur particulier&nbsp;?</phrase></para>
	</question>
	<answer>
	<para>On reprend la commande <command>ldapsearch</command> en spécifiant un
		attribut <option>uid</option> particulier.</para>

<screen><prompt>#</prompt> ldapsearch -LLL -H ldap://192.0.2.12 \
	-b dc=lab,dc=stri -D cn=admin,dc=lab,dc=stri -W uid=padme
Enter LDAP Password:
dn: uid=padme,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Padme
sn:: UGFkbcOpIEFtaWRhbGEgU2t5d2Fsa2Vy
uid: padme
uidNumber: 10000
gidNumber: 10000
loginShell: /bin/bash
homeDirectory: /ahome/padme
userPassword:: e1NTSEF9THJQRnZjNllla1RHU0VZaU1lenhZeGNtRS8wWkUvOUw=
gecos: Padme Amidala Skywalker</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe de la commande permettant de changer le
		mot de passe de l'utilisateur dont on an affiché les attributs à la
		question précédente&nbsp;?</phrase></para>
	</question>
	<answer>
	<para>On utilise la commande <command>ldappasswd</command> fournie par le
		paquet <systemitem>ldap-utils</systemitem> comme dans le cas de la
		commande de recherche. Après consultation des pages de manuels, on
		obtient la syntaxe suivante.</para>

<screen><prompt>#</prompt> ldappasswd -x -H ldap://192.0.2.12 \
	-D cn=admin,dc=lab,dc=stri -W -S uid=padme,ou=people,dc=lab,dc=stri
New password:
Re-enter new password:
Enter LDAP Password:</screen>

	<para>En posant exactement la même requête que dans la question	précédente,
		on peut vérifier que le mot de passe utilisateur a bien été
		modifié.</para>

<screen><prompt>#</prompt> ldapsearch -LLL -H ldap://192.0.2.12 \
	-b dc=lab,dc=stri -D cn=admin,dc=lab,dc=stri -W uid=padme
Enter LDAP Password:
dn: uid=padme,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Padme
sn:: UGFkbcOpIEFtaWRhbGEgU2t5d2Fsa2Vy
uid: padme
uidNumber: 10000
gidNumber: 10000
loginShell: /bin/bash
homeDirectory: /ahome/padme
gecos: Padme Amidala Skywalker
userPassword:: e1NTSEF9blZYUG9NTTNOdVdoZWFSOTBMZFBkY1lGZGRvSEVlTEY=</screen>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.ldap.clnt.nss'>
	<title>Configuration <wordasword>Name Service Switch</wordasword></title>

	<para>Les manipulations présentées ici ont pour but de rendre transparent
		l'accès aux attributs des comptes utilisateurs. Le mécanisme
		<wordasword>Name Service Switch</wordasword> assure un aiguillage de
		l'accès à ces attributs entre les fichiers locaux et les différents
		services réseau disponibles. Ici, l'annuaire <acronym>LDAP</acronym>
		constitue un dépôt de référence pour le stockage des attributs des
		comptes utilisateurs.</para>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Quel est le nom du paquet relatif au mécanisme
		<wordasword>Name Service Switch</wordasword> permettant d'accéder
		aux ressources de l'annuaire <acronym>LDAP</acronym>
		?</phrase></para>

	<para>Rechercher dans les bases du gestionnaire de paquets un paquet dont
		le nom débute par la chaîne <option>libnss</option>.</para>
	</question>
	<answer>
	<para>La liste ci-dessous permet d'identifier le paquet
		<systemitem>libnss-ldapd</systemitem>.</para>

<screen><prompt>#</prompt> aptitude search ^libnss-
p   libnss-cache      - NSS module for using nsscache-generated files
p   libnss-db         - Module NSS pour utiliser des bases de données Berkeley
						comme service de noms
p   libnss-docker     - nss module for finding Docker containers
p   libnss-extrausers - nss module to have an additional passwd, shadow and
						group file
p   libnss-gw-name    - nss module that names the current gateway’s IP address
p   libnss-ldap       - NSS module for using LDAP as a naming service
p   <emphasis>libnss-ldapd      - NSS module for using LDAP as a naming service</emphasis>
p   libnss-libvirt    - nss plugin providing IP add ress resolution for virtual
						machines
p   libnss-lwres      - NSS module for using bind9's lwres as a naming service
i A libnss-mdns       - module NSS pour la résolution de nom Multicast DNS
p   libnss-myhostname - nss module providing fallback resolution for the
						current hostname
p   libnss-mymachines - nss module to resolve hostnames for local container
						instances
v   libnss-pgsql1     -
p   libnss-pgsql2     - NSS module for using PostgreSQL as a naming service
p   libnss-rainbow2   - nss library for rainbow
p   libnss-resolve    - module NSS pour la résolution de nom avec
						systemd-resolved
p   libnss-securepass - NSS (Name Service Switch) module for Securepass
p   libnss-sss        - Nss library for the System Security Services Daemon
p   libnss-systemd    - nss module providing dynamic user and group name
						resolution
p   libnss-winbind    - greffons d'intégration de service de nom pour Samba
p   libnss-wrapper    - NSS wrapper library</screen>

<warning>
	<para>Relativement au paquet <systemitem>libnss-ldap</systemitem>, le
		paquet <systemitem>libnss-ldapd</systemitem> modifie directement les
		paramètres des fichiers
		<filename>/etc/pam.d/common-*</filename>.</para>
</warning>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quels sont les paquets supplémentaires qui sont ajoutés lors
		de l'installation des bibliothèques <acronym>LDAP</acronym> pour
		le mécanisme <wordasword>Name Service Switch</wordasword>
		?</phrase></para>

	<para>Utiliser les informations fournies par le gestionnaire de paquets
		pour chaque ajout.</para>
	</question>
	<answer>
	<para>Le lancement de l'installation du	paquet
		<systemitem>libnss-ldapd</systemitem> donne la liste suivante.</para>

<screen><prompt>#</prompt> aptitude install libnss-ldapd                                     
Les NOUVEAUX paquets suivants vont être installés :                                           
  libnss-ldapd libpam-ldapd{a} nscd{a} nslcd{a} nslcd-utils{a}                                
0 paquets mis à jour, 5 nouvellement installés, 0 à enlever et 0 non mis à jour.              
Il est nécessaire de télécharger 669 ko d'archives. Après dépaquetage,
1 286 ko seront utilisés.                                                                                             
Voulez-vous continuer ? [Y/n/?]</screen>

	<para>Plusieurs paquets supplémentaires apparaissent :</para>
	<itemizedlist>
	<listitem>
	<para><systemitem>libpam-ldapd</systemitem> fournit les fonctions
		<acronym>PAM</acronym> nécessaires à l'authentification, aux
		autorisations et à la gestion de session via un annuaire
		<acronym>LDAP</acronym>.</para>
	</listitem>
	<listitem>
	<para><systemitem>nscd</systemitem> (<wordasword>Name Service Cache
		Daemon</wordasword>) est un démon qui gère la recherche des mots de
		passe, des groupes et hôtes des programmes en cours d’exécution, et met
		en cache le résultat pour une prochaine recherche.</para>
	</listitem>
	<listitem>
	<para><systemitem>nslcd</systemitem> fournit una autre démon pour la
		collecte des informations sur les comptes utilisateurs depuis un
		serveur <acronym>LDAP</acronym>.</para>
	</listitem>
	<listitem>
	<para><systemitem>nslcd-utils</systemitem> fournit des outils pour
		l'interrogation et la mise à jour des entrées d'annuaire
		<acronym>LDAP</acronym>.</para>
	</listitem>
	</itemizedlist>

<warning>
	<para>Pour les besoins des travaux pratiques ou de la mise au point de
		l'authentification via <acronym>LDAP</acronym>, il est utile de
		désactiver les services de cache qui ne sont utiles qu'en exploitation
		avec un grand nombre d'entrées dans l'annuaire.</para>

<screen><prompt>#</prompt> systemctl stop nscd</screen>
</warning>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est le rôle de l'interface entre les fonctions
		<acronym>PAM</acronym> (<wordasword>Pluggable Authentication
		Modules</wordasword>) et l'annuaire <acronym>LDAP</acronym>
		?</phrase></para>
	</question>
	<answer>
	<para>Par définition, <acronym>PAM</acronym> est un mécanisme qui permet
		d'intégrer différents modes d'authentification en les rendant
		transparents vis à vis de l'utilisateur et des logiciels qui accèdent
		aux ressources du système. Dans le contexte de ces travaux pratiques,
		il s'agit de permettre à l'utilisateur de se connecter, d'accéder au
		système de fichiers, de changer son mot de passe, etc sans avoir à
		lancer des commandes spécifiques.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les principales étapes de la configuration des
		paquets de bibliothèques <acronym>NSS</acronym> et
		<acronym>PAM</acronym>&nbsp;?</phrase></para>

	<para>Lors de l'installation des principaux paquets de bibliothèques
		<acronym>LDAP</acronym>, on passe par une série de menus
		<systemitem>debconf</systemitem> qu'il faut renseigner correctement
		pour accéder au serveur <acronym>LDAP</acronym> de façon
		transparente.</para>
	</question>
	<answer>

<warning>
	<para>En cas d'erreur de saisie dans la série de menus ci-dessous, il faut
		reprendre la configuration de chacun des deux paquets individuellement.
		Classiquement, on passe par la commande
		<command>dpkg-reconfigure</command>.</para>

<screen><prompt>#</prompt> dpkg-reconfigure libnss-ldapd
<prompt>#</prompt> dpkg-reconfigure libpam-ldapd
<prompt>#</prompt> dpkg-reconfigure nslcd</screen>
</warning>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/01-libnss-ldapd.jpeg' format='JPEG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/01-libnss-ldapd.jpeg' format='JPEG' width='12cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/01-libnss-ldapd.jpeg'>Copie
	d'écran configuration libnss-ldapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/02-nslcd.jpeg' format='JPEG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/02-nslcd.jpeg' format='JPEG' width='12cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/02-nslcd.jpeg'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/03-nslcd.jpeg' format='JPEG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/03-nslcd.jpeg' format='PNG' width='12cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/03-nslcd.jpeg'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/04-nslcd.jpeg' format='JPEG' width='420px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/04-nslcd.jpeg' format='JPEG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/04-nslcd.jpeg'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/05-nslcd.jpeg' format='JPEG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/05-nslcd.jpeg' format='PNG' width='12cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/05-nslcd.jpeg'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/06-nslcd.jpeg' format='JPEG' width='420px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/06-nslcd.jpeg' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/06-nslcd.jpeg'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/07-nslcd.jpeg' format='JPEG' width='420px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/07-nslcd.jpeg' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/07-nslcd.jpeg'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les modifications apportées au fichier de
		configuration <filename>/etc/nsswitch.conf</filename> pour activer
		l'accès aux ressources de l'annuaire <acronym>LDAP</acronym>
		?</phrase></para>

	<para>Lors de l'installation des paquets à l'étape précédente, le fichier
		<filename>/etc/nsswitch.conf</filename> a été modifié.</para>
	</question>
	<answer>
<screen><prompt>#</prompt> grep ldap /etc/nsswitch.conf 
passwd:         compat ldap
group:          compat ldap
shadow:         compat ldap</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment illustrer simplement le fonctionnement du mécanisme
		<wordasword>Name Service Switch</wordasword> intégrant
		l'utilisation de l'annuaire <acronym>LDAP</acronym>
		?</phrase></para>

	<para>Rechercher la commande de récupération des entrées depuis les bases
		de données d'administration dans les outils fournis avec les
		bibliothèques standard (paquet
		<systemitem>libc-bin</systemitem>).</para>
	</question>
	<answer>
	<para>La commande <command>getent</command> fournie avec le paquet
		<systemitem>libc-bin</systemitem> donne la liste des entrées
		accessibles pour chaque catégorie du fichier de configuration. Voici un
		exemple pour la catégorie <option>passwd</option> qui fait apparaître
		les entrées de l'annuaire <acronym>LDAP</acronym> à la suite des
		comptes utilisateurs système issus des fichiers locaux.</para>

<screen><prompt>#</prompt> getent passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
Debian-exim:x:101:103::/var/spool/exim4:/bin/false
statd:x:102:65534::/var/lib/nfs:/bin/false
sshd:x:103:65534::/var/run/sshd:/usr/sbin/nologin
etu:x:1000:1000:Etudiant,,,:/home/etu:/bin/bash
rdnssd:x:104:65534::/var/run/rdnssd:/bin/false
systemd-timesync:x:105:108:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:106:109:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:107:110:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:108:111:systemd Bus Proxy,,,:/run/systemd:/bin/false
messagebus:x:109:113::/var/run/dbus:/bin/false
uuidd:x:100:101::/run/uuidd:/bin/false
_apt:x:110:65534::/nonexistent:/bin/false
avahi:x:111:116:Avahi mDNS daemon,,,:/var/run/avahi-daemon:/usr/sbin/nologin
nslcd:x:112:117:nslcd name service LDAP connection daemon,,,:/var/run/nslcd/:/usr/sbin/nologin
<emphasis>padme:x:10000:10000:Padme Amidala Skywalker:/ahome/padme:/bin/bash
anakin:x:10001:10001:Anakin Skywalker:/ahome/anakin:/bin/bash
leia:x:10002:10002:Leia Organa:/ahome/leia:/bin/bash
luke:x:10003:10003:Luke Skywalker:/ahome/luke:/bin/bash</emphasis></screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.clnt.nss.q2-auth'>
	<question>
	<para><phrase>Comment valider l'authentification d'un utilisateur déclaré
		dans l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Choisir un service qui nécessite une authentification sur le système
		et qui utilise une entrée de l'annuaire <acronym>LDAP</acronym>.</para>

<warning>
	<para>Après chaque manipulation sur la configuration des paquets
		<systemitem>libnss-ldapd</systemitem> et
		<systemitem>nslcd</systemitem>, il faut impérativement relancer le
		démon de gestion du cache des services de noms :
		<userinput><prompt>#</prompt> systemctl restart
		nscd</userinput>.</para>

	<para>Sans le redémarrage de ce démon, il est fréquent que les tests de
		connexion échouent alors que la configuration système est
		correcte.</para>
</warning>
	</question>
	<answer>
	<para>Les exemples de services nécessitant une authentification ne manquent
		pas. La commande <command>su</command> qui permet de changer d'identité
		est le plus immédiat.</para>

<screen><prompt>etu@LDAP-Client:~$</prompt> su luke
Mot de passe : 
luke@LDAP-Client:/home/etu$ cd
bash: cd: /ahome/luke: Aucun fichier ou dossier de ce type</screen>

	<para>Dans les journaux du système, on retrouve les mêmes éléments.</para>

<screen><prompt>#</prompt> grep luke /var/log/auth.log
LDAP-Client su[1676]: pam_unix(su:auth): authentication failure; logname=etu
		uid=1000 euid=0 tty=/dev/pts/0 ruser=etu rhost=  user=luke
LDAP-Client su[1676]: Successful su for luke by etu
LDAP-Client su[1676]: + /dev/pts/0 etu:luke
LDAP-Client su[1676]: pam_unix(su:session): session opened for user luke by
		etu(uid=1000)
LDAP-Client su[1676]: pam_unix(su:session): session closed for user luke</screen>

	<para>Voici un autre exemple d'accès avec <acronym>SSH</acronym>.</para>

<screen><prompt>$</prompt> ssh anakin@fe80::b8ad:caff:fefe:65%vlan10
Warning: Permanently added 'fe80::b8ad:caff:fefe:65%vlan10' (ECDSA) to the list
of known hosts.
anakin@fe80::b8ad:caff:fefe:65%vlan10's password: 
Linux LDAP-Client 4.12.0-1-686-pae #1 SMP Debian 4.12.6-1 (2017-08-12) i686

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Could not chdir to home directory /ahome/anakin: No such file or directory</screen>

	<para>Il ne manque que l'accès au système de fichiers pour que la
		configuration soit vraiment complète.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.ldap.web'>
	<title>Accès à l'annuaire LDAP depuis un service web</title>

	<para>Du point de vue métier, les manipulations à base de fichiers
	<acronym>LDIF</acronym> sont réservées aux traitements en volume réalisés
	par les administrateurs système. Les développeurs disposent de
	bibliothèques fournies avec les langages de programmation. Dans la plupart
	des cas, les développements ont pour but de fournir une interface
	Web.</para>


	<para>Le projet <citetitle>LDAP Tool Box</citetitle> propose un outil
	baptisé <citetitle>White Pages</citetitle> qui permet de constituer un
	trombinoscope des utilisateurs enregistrés dans un annuaire
	<acronym>LDAP</acronym>.</para>

	<para>L'objectif de cette section est d'installer le service web
	<citetitle>White Pages</citetitle> et de compléter les attributs des
	utilisateurs de l'annuaire avec une photo.</para>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Quel est le paquet à installer pour mettre en place le
		service Web <citetitle>White Pages</citetitle>&nbsp;?</phrase></para>

	<para>Rechercher sur le site &url.ltb-project;, le lien de
		téléchargement direct du paquet Debian pour le service
		<citetitle>White Pages</citetitle>.</para>
	</question>
	<answer>
	<para>Tout en bas de la page des téléchargements, on trouve un lien direct
		vers le paquet
		<systemitem>white-pages_0.3-1_all.deb</systemitem>.</para>

	<para>Après le téléchargement, l'installation nécessite quelques
		ajustements compte tenu des dépendances des paquets entre les
		différentes versions du langage <acronym>PHP</acronym>.</para>

<screen><prompt>#</prompt>  wget http://ltb-project.org/archives/white-pages_0.3-1_all.deb
&lt;snip>

<prompt>#</prompt> dpkg -i white-pages_0.3-1_all.deb
&lt;snip>

<prompt>#</prompt> aptitude -f install
&lt;snip>

<prompt>#</prompt> aptitude install apache2 libapache2-mod-php
&lt;snip></screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment activer l'accès au service Web&nbsp;?</phrase></para>

	<para>Consulter les fichiers de documentation et de configuration fournis
		avec le paquet <citetitle>apache2</citetitle>. Repérer les instructions
		d'activation et de désactivation d'un site. Retrouver les éléments
		spécifiques à la configuration du service <citetitle>White
		Pages</citetitle>.</para>
	</question>
	<answer>
	<para>Cette question comprend plusieurs étapes.</para>
	<orderedlist>
	<listitem>
	<para>Le paquet <systemitem>apache2</systemitem> comprend une liste
		d'outils dédiés aux manipulations sur les sites et leur
		configuration.</para>

<screen><prompt>#</prompt> dpkg -L apache2 | grep "bin.*a2"
/usr/sbin/a2enmod
/usr/sbin/a2query
/usr/sbin/a2disconf
/usr/sbin/a2dismod
/usr/sbin/a2dissite
/usr/sbin/a2enconf
/usr/sbin/a2ensite</screen>
	</listitem>
	<listitem>
	<para>On utilise <command>a2dissite</command> pour désactiver le site par
		défaut et <command>a2ensite</command> pour activer les pages
		blanches.</para>

<screen><prompt>#</prompt> a2dissite 000-default
&lt;snip>

<prompt>#</prompt> a2ensite white-pages
&lt;snip>

<prompt>#</prompt> apachectl configtest
&lt;snip>
Syntax OK

<prompt>#</prompt> systemctl reload apache2
&lt;snip></screen>

	<para>La consultation de la page web donne le résultat suivant.</para>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/01-white-pages.jpeg' format='JPEG' width='420px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/01-white-pages.jpeg' format='JPEG' width='12cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran service pages blanches</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/01-white-pages.jpeg'>
	Copie d'écran service pages blanches - vue complète</link></para>
	</caption>
</mediaobject>
	</listitem>
	<listitem>
	<para>Les paramètres du nouveau site sont donnés dans le fichier
		<filename>/etc/apache2/sites-available/white-pages.conf</filename>.</para>
	</listitem>
	</orderedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment paramétrer l'accès à l'annuaire
		<acronym>LDAP</acronym> à partir du service Web&nbsp;?</phrase></para>

	<para>Identifier les fichiers de configuration fournis avec le paquet
		<systemitem>white-pages</systemitem>.</para>
	</question>
	<answer>
	<para>C'est le fichier
		<filename>/usr/share/white-pages/conf/config.inc.php</filename> qui
		contient les éléments d'accès à l'annuaire <acronym>LDAP</acronym>.
		Voici un extrait de ce fichier avec les lignes utiles complétées avec
		le contexte de ce support de travaux pratiques.</para> 

<screen><prompt>#</prompt> grep ^\$ldap /usr/share/white-pages/conf/config.inc.php
$ldap_url = "ldap://localhost";
$ldap_starttls = false;
$ldap_binddn = "cn=admin,dc=lab,dc=stri";
$ldap_bindpw = "XXXXXX";
$ldap_base = "dc=lab,dc=stri";
$ldap_user_base = "ou=people,".$ldap_base;
$ldap_user_filter = "(objectClass=inetOrgPerson)";
$ldap_size_limit = 100;</screen>

	<para>Une fois le fichier modifié, il faut recharger le service Web avec la
		commande <userinput><prompt>#</prompt> systemctl reload
		apache2</userinput>.</para>

	<para>La consultation de la rubrique <guimenuitem>Pages
		Blanches</guimenuitem> donne le résultat ci-dessous. L'intérêt de
		cette manipulation est de montrer que l'on peut compléter les attributs
		d'un utilisateur de l'annuaire avec une photo. Cette opération est
		l'objet des questions suivantes.</para>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/02-white-pages.jpeg' format='JPEG' width='420px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/02-white-pages.jpeg' format='JPEG' width='12cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran trombinoscope</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" 
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/02-white-pages.jpeg'>
	Copie d'écran trombinoscope - vue complète</link></para>
	</caption>
</mediaobject>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est l'attribut de la classe
		<systemitem>inetOrgPerson</systemitem> qui correspond à une
		photo d'identité&nbsp;?</phrase></para>

	<para>Rechercher les options de la commande <command>ldapsearch</command>
		qui permettent d'extraire la liste des attributs de la classe
		<systemitem>inetOrgPerson</systemitem>.</para>
	</question>
	<answer>
	<para>On obtient l'information en deux temps.</para>
	<itemizedlist>
	<listitem>
	<para>On identifie le contexte de la classe recherchée en premier.</para>

<screen><prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" | grep -i inetorgperson
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
dn: <emphasis>cn={3}inetorgperson,cn=schema,cn=config</emphasis>
cn: {3}inetorgperson
olcObjectClasses: {0}( 2.16.840.1.113730.3.2.2 NAME 'inetOrgPerson' DESC 'RFC2</screen>
	</listitem>
	<listitem>
	<para>Une fois le contexte connu avec précision, on peut extraire la liste
		des attributs relatifs à la classe
		<systemitem>inetOrgPerson</systemitem>.</para>

	<para>Dans la liste ci-dessous, on repère l'attribut
		<systemitem>jpegPhoto</systemitem> qui correspond à notre
		besoin.</para>

<screen><prompt>#</prompt> ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn={3}inetorgperson,cn=schema,cn=config"
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
dn: cn={3}inetorgperson,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: {3}inetorgperson
olcAttributeTypes: {0}( 2.16.840.1.113730.3.1.1 NAME 'carLicense' DESC 'RFC279
 8: vehicle license or registration plate' EQUALITY caseIgnoreMatch SUBSTR cas
 eIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )
olcAttributeTypes: {1}( 2.16.840.1.113730.3.1.2 NAME 'departmentNumber' DESC '
 RFC2798: identifies a department within an organization' EQUALITY caseIgnoreM
 atch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )
olcAttributeTypes: {2}( 2.16.840.1.113730.3.1.241 NAME 'displayName' DESC 'RFC
 2798: preferred name to be used when displaying entries' EQUALITY caseIgnoreM
 atch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SI
 NGLE-VALUE )
olcAttributeTypes: {3}( 2.16.840.1.113730.3.1.3 NAME 'employeeNumber' DESC 'RF
 C2798: numerically identifies an employee within an organization' EQUALITY ca
 seIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.12
 1.1.15 SINGLE-VALUE )
olcAttributeTypes: {4}( 2.16.840.1.113730.3.1.4 NAME 'employeeType' DESC 'RFC2
 798: type of employment for a person' EQUALITY caseIgnoreMatch SUBSTR caseIgn
 oreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )
olcAttributeTypes: {5}( 0.9.2342.19200300.100.1.60 NAME '<emphasis>jpegPhoto</emphasis>' DESC 'RFC2
 798: a JPEG image' SYNTAX 1.3.6.1.4.1.1466.115.121.1.28 )
olcAttributeTypes: {6}( 2.16.840.1.113730.3.1.39 NAME 'preferredLanguage' DESC
 'RFC2798: preferred written or spoken language for a person' EQUALITY caseIg
 noreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.
 15 SINGLE-VALUE )
olcAttributeTypes: {7}( 2.16.840.1.113730.3.1.40 NAME 'userSMIMECertificate' D
 ESC 'RFC2798: PKCS#7 SignedData used to support S/MIME' SYNTAX 1.3.6.1.4.1.14
 66.115.121.1.5 )
olcAttributeTypes: {8}( 2.16.840.1.113730.3.1.216 NAME 'userPKCS12' DESC 'RFC2
 798: personal identity information, a PKCS #12 PFX' SYNTAX 1.3.6.1.4.1.1466.1
 15.121.1.5 )
olcObjectClasses: {0}( 2.16.840.1.113730.3.2.2 NAME 'inetOrgPerson' DESC 'RFC2
 798: Internet Organizational Person' SUP organizationalPerson STRUCTURAL MAY
 ( audio $ businessCategory $ carLicense $ departmentNumber $ displayName $ em
 ployeeNumber $ employeeType $ givenName $ homePhone $ homePostalAddress $ ini
 tials $ jpegPhoto $ labeledURI $ mail $ manager $ mobile $ o $ pager $ photo
 $ roomNumber $ secretary $ uid $ userCertificate $ x500uniqueIdentifier $ pre
 ferredLanguage $ userSMIMECertificate $ userPKCS12 ) )</screen>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe du fichier <acronym>LDIF</acronym> qui
	permet de modifier l'attribut <systemitem>jpegPhoto</systemitem> d'un
	utilisateur de l'annuaire&nbsp;?</phrase></para>

	<para>Rechercher un exemple de modification d'attribut avec la commande
	<command>ldapmodify</command>.</para>
	
	<para>Rechercher aussi un fichier <acronym>JPEG</acronym> qui fasse office
		de photo d'identité.</para>
	</question>
	<answer>
	<para>Tout d'abord, on dépose le fichier <acronym>JPEG</acronym> à
		utiliser dans le dossier <filename
		class='directory'>/var/tmp</filename> à titre d'exemple.</para>

	<para>La syntaxe du fichier <acronym>LDIF</acronym> est relativement simple
		une fois que l'on a bien identifié le contexte.</para>

<screen><prompt>#</prompt> cat leia-photo.ldif
dn: uid=leia,ou=people,dc=lab,dc=stri
changetype: modify
add: jpegPhoto
jpegPhoto:&lt;file:///var/tmp/leia.jpg</screen>

	<para>Enfin, on applique la modification dans l'annuaire
		<acronym>LDAP</acronym>.</para>

<screen><prompt>#</prompt> ldapmodify -x -H ldap:/// -D "cn=admin,dc=lab,dc=stri" -W -f leia-photo.ldif</screen>

	<para>Le résultat est visible sur la copie d'écran de navigateur Web
		ci-dessus.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect1>

<sect1 xml:id='sysadm-net.ldap.refdocs'>
	<title>Documents de référence</title>

<variablelist>
	<varlistentry xml:id='sysadm-net.ldap.refdocs.openldap'>
		<term><citetitle>OpenLDAP Software 2.4 Administrator's
				Guide</citetitle></term>
	<listitem>
	<para>La documentation officielle : &url.openldap.admin-guide; constitue le
		point d'entrée essentiel pour la mise en œuvre du service
		<acronym>LDAP</acronym>.</para>
	</listitem>
	</varlistentry>
</variablelist>
</sect1>
</article>
