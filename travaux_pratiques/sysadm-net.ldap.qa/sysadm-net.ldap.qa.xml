<?xml version='1.0'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
        "/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [

<!ENTITY author		SYSTEM "author.xml">
<!ENTITY legal		SYSTEM "legal.xml">

<!-- A copy of http://www.w3.org/2003/entities/2007/w3centities-f.ent is at:
/usr/local/share -->
<!ENTITY % w3centities-f PUBLIC "-//W3C//ENTITIES Combined Set//EN//XML"
	"/usr/local/share/w3centities-f.ent">
%w3centities-f;

<!ENTITY url.openldap
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.openldap.org/">
<citetitle>OpenLDAP main page</citetitle></link>'>

<!ENTITY url.openldap.admin-guide
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.openldap.org/doc/admin25/">
<citetitle>OpenLDAP Software 2.5 Administrator&#39;s Guide</citetitle></link>'>

<!ENTITY url.ltb-project
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://ltb-project.org/">
<citetitle>LDAP Tool Box project</citetitle></link>'>

<!ENTITY url.ltb-white-pages
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://ltb-project.org/documentation/white-pages.html">
<citetitle>White Pages</citetitle></link>'>

<!ENTITY url.letsencrypt
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://letsencrypt.org/">
<citetitle>Let&apos;s Encrypt</citetitle></link>'>

<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.xml'>
%inetdoc_urls;
]>

<article xml:id='sysadm-net.ldap' xml:lang='fr'>

<info>
	<title>Introduction aux annuaires LDAP avec OpenLDAP</title>

	&author;
<abstract>
	<para>
	<informaltable frame='none' pgwide='1'>
	<tgroup cols='2' align='left' colsep='0' rowsep='0'>
	<colspec colwidth='5*'/>
	<colspec colwidth='220px'/>
	<tbody>
	<row>
	<entry valign='top'>
	<para>Dans ce support de travaux pratiques, on explore le service
	d'annuaire <acronym>LDAP</acronym>. On présente succinctement les éléments
	constitutifs d'un annuaire puis on étudie la configuration d'un service
	d'annuaire basé sur le logiciel <application>OpenLDAP</application>.
	Ensuite, on étudie la configuration de l'accès aux entrées de l'annuaire
	depuis un poste client. Les informations délivrées par l'annuaire sont les
	propriétés de comptes utilisateurs stockées dans la classe d'objet
	<literal>posixAccount</literal>.</para>
	</entry>
	<entry>
	<inlinemediaobject>
	<imageobject role='html'>
	<imagedata fileref='images/thumb011.png' format='PNG' width='220px' scalefit='1'/>
	</imageobject>
	<imageobject role='fo'>
	<imagedata fileref='images/ldap-tree.png' format='PNG' width='4.5cm' scalefit='1'/>
	</imageobject>
	</inlinemediaobject>
	</entry>
	</row>
	</tbody>
	</tgroup>
	</informaltable>
	</para>
</abstract>

<keywordset>
	<keyword>lab</keyword>
	<keyword>ldap</keyword>
	<keyword>attribut</keyword>
	<keyword>dit</keyword>
	<keyword>ldif</keyword>
	<keyword>slapd</keyword>
	<keyword>slappasswd</keyword>
	<keyword>nsswitch</keyword>
</keywordset>
</info>

<sect1 xml:id='sysadm-net.ldap.legal.meta'>
	&legal;
	<bridgehead xml:id='sysadm-net.ldap.qa.meta'
	renderas='sect2'>Méta-information</bridgehead>

	<para>Ce document est écrit avec <link
	xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link>
	XML sur un système <link
	xlink:href="http://www.debian.org"><citetitle>Debian
	GNU/Linux</citetitle></link>. Il est disponible en version imprimable au
	format PDF : <link
	xlink:href="https://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>
</sect1>

<sect1 xml:id='sysadm-net.ldap.definition'>
	<title>Principes d'un annuaire LDAP</title>

	<para>Dans l'histoire des systèmes Unix, les services de
	<emphasis>nommage</emphasis> ont connu de nombreuses évolutions avec le
	développement de l'Internet et des volumes d'informations à
	partager.</para>

	<para>Au début des années 80, un premier service baptisé
	<wordasword>Network Information Service</wordasword>
	(<acronym>NIS</acronym>) a vu le jour. Ce service est une méthode de
	distribution de la base de données des utilisateurs, de fichiers de
	configuration, d'authentification et d'autres données entre les hôtes d'un
	réseau local. Le logiciel <acronym>NIS</acronym> développé par
	<trademark>Sun Microsystems</trademark> fonctionne sur le mode
	Client/Serveur à partir d'une base de données «à plat» (<wordasword>flat
	bindery base</wordasword>). Son utilisation est étudiée dans le support de
	travaux pratiques &url.sysadm-net.nis;. Avec un service
	<acronym>NIS</acronym>, il n'est pas possible de constituer des groupes
	logiques ayant des attributs propres. Cette limitation est rapidement
	devenue critique avec l'augmentation du nombres des utilisateurs et des
	clients.</para>

	<para>D'autres services plus complets tels que <acronym>NIS+</acronym> ou
	<citetitle>kerberos</citetitle> qui n'assure que la partie authentification
	ont été développés par la suite. Depuis quelques années, les annuaires
	<acronym>LDAP</acronym> ou <wordasword>Lightweight Directory Access
	Protocol</wordasword> se sont imposés comme étant l'outil d'échange
	universel des paramètres utilisateurs.</para>

	<para>Pour définir ce qu'est le service <acronym>LDAP</acronym>, on peut
	retenir les caractéristiques suivantes.</para>

	<itemizedlist>
	<listitem>
	<para>Un service de publication d'annuaire</para>
	</listitem>
	<listitem>
	<para>Un protocole d'accès aux annuaires de type X.500 ou
	<wordasword>Lightweight Directory Access Protocol</wordasword></para>
	</listitem>
	<listitem>
	<para>Un dépôt de données basées sur des attributs ou un «genre» de base de
	données</para>
	</listitem>
	<listitem>
	<para>Un logiciel optimisé pour les recherches avancées et les lectures</para>
	</listitem>
	<listitem>
	<para>Une implémentation client/serveur</para>
	</listitem>
	<listitem>
	<para>Un mécanisme extensible de schémas de description de classes d'objets</para>
	</listitem>
	</itemizedlist>

	<para>Les entrées (<wordasword>Directory Service Entry</wordasword>) d'un
	annuaire <acronym>LDAP</acronym> sont distribuées suivant une arborescence
	(<wordasword>Directory Information Tree</wordasword>) hiérarchisée que l'on
	peut voir comme un système de fichiers avec ses répertoires et ses
	fichiers.  Au sommet de l'arborescence on trouve un nom de racine
	(<wordasword>Domain Component</wordasword>) ou suffixe.</para>

	<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/ldap-tree.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/ldap-tree.png' format='PNG' width='15cm'/>
	</imageobject>
	<textobject>
	<phrase>Arborescence LDAP élémentaire</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook" xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap/images/ldap-tree.png'>
	Arborescence LDAP élémentaire - vue complète</link></para>
	</caption>
	</mediaobject>

	<para>L'adresse d'une entrée de l'annuaire <acronym>LDAP</acronym> est
	appelée : <emphasis><wordasword>distinguished name</wordasword></emphasis>
	ou <acronym>dn</acronym>. En reprenant l'exemple d'arborescence ci-dessus,
	les adresses des différentes entrées sont notées comme suit.</para>

	<itemizedlist>
	<listitem>
	<para><literal>dn: dc=lab,dc=stri</literal></para>
	</listitem>
	<listitem>
	<para><literal>dn: ou=lab1,dc=lab,dc=stri</literal></para>
	<para><literal>dn: ou=lab2,dc=lab,dc=stri</literal></para>
	</listitem>
	<listitem>
	<para><literal>dn: cn=etu1,ou=lab1,dc=lab,dc=stri</literal></para>
	<para><literal>dn: cn=etu2,ou=lab1,dc=lab,dc=stri</literal></para>
	<para><literal>dn: cn=etu3,ou=lab2,dc=lab,dc=stri</literal></para>
	<para><literal>dn: cn=etu4,ou=lab2,dc=lab,dc=stri</literal></para>
	</listitem>
	</itemizedlist>

	<para>L'adresse de chaque entrée appartient à une classe d'objet
	(<wordasword>ObjectClass</wordasword>) spécifiée dans un schéma
	(<wordasword>schema</wordasword>). En reprenant les mêmes exemples
	d'entrées, on peut associer les classes d'objets correspondantes.</para>

	<informaltable frame='all'>
	<tgroup cols='2' colsep='1' rowsep='1'>
	<thead>
	<row>
	<entry><wordasword>entry</wordasword></entry>
	<entry><wordasword>objectclass</wordasword></entry>
	</row>
	</thead>
	<tbody>
	<row>
	<entry>
	<para><literal>o: lab.stri</literal></para>
	<para><literal>dc: lab</literal></para>
	<para><literal>dc: stri</literal></para>
	</entry>
	<entry>
	<para><literal>organisation</literal></para>
	<para><literal>dcObject</literal></para>
	<para><literal>dcObject</literal></para>
	</entry>
	</row>
	<row>
    <entry>
	<para><literal>ou: lab1</literal></para>
	</entry>
	<entry>
	<para><literal>organisationalUnit</literal></para>
	</entry>
	</row>
	<row>
	<entry>
	<para><literal>cn: etu1</literal></para>
	<para><literal>sn: etu1</literal></para>
	</entry>
	<entry>
	<para><literal>inetOrgPerson</literal></para>
	</entry>
	</row>
	</tbody>
	</tgroup>
	</informaltable>

	<para>Un schéma peut être vu comme un ensemble de règles qui décrivent la
	nature des données stockées. C'est un outil qui aide à maintenir la
	cohérence, la qualité et qui évite la duplication des données dans
	l'annuaire. Les attributs des classes d'objets déterminent les règles qui
	doivent être appliquées à une entrée. Un schéma contient les éléments
	suivants.</para>

	<itemizedlist>
	<listitem>
	<para>Les attributs requis</para>
	</listitem>
	<listitem>
	<para>Les attributs autorisés</para>
	</listitem>
	<listitem>
	<para>Les règles de comparaison des attributs</para>
	</listitem>
	<listitem>
	<para>Les valeurs limites qu'un attribut peut recevoir</para>
	</listitem>
	<listitem>
	<para>Les restrictions sur les informations qui peuvent être enregistrées</para>
	</listitem>
	</itemizedlist>
</sect1>

<sect1 xml:id='sysadm-net.ldap.srvr'>
	<title>Configuration du serveur LDAP</title>

	<para>Avant d'aborder la configuration du service <acronym>LDAP</acronym>,
	il faut passer par les étapes rituelles de sélection et d'installation des
	paquets contenant les outils logiciels du service. Ensuite, il faut
	identifier les processus, les numéros de ports ouverts et les fichiers de
	configuration à éditer.</para>

<sect2 xml:id='sysadm-net.ldap.srvr.install'>
	<title>Installation du serveur LDAP</title>

<qandaset defaultlabel='number'>
	<qandadiv xml:id='sysadm-net.ldap.srvr.q1'>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q1-package'>
	<question>
	<para><phrase>Quels sont les paquets Debian relatifs au service
	<acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Interroger la base de données des paquets pour obtenir les
	informations demandées.</para>
	</question>
	<answer>
	<para>Dans la requête ci-dessous, on privilégie la recherche dans les
	champs de description des paquets.</para>

<screen>apt search ^OpenLDAP</screen>

<screen>En train de trier... Fait
Recherche en texte intégral... Fait
ldap-utils/testing 2.5.13+dfsg-5 amd64
  OpenLDAP utilities

libldap-2.5-0/testing,now 2.5.13+dfsg-5 amd64  [installé, automatique]
  Bibliothèques OpenLDAP

libldap-common/testing,now 2.5.13+dfsg-5 all  [installé, automatique]
  fichiers communs OpenLDAP pour les bibliothèques

libldap-dev/testing 2.5.13+dfsg-5 amd64
  bibliothèques de développement pour OpenLDAP

ruby-ldap/testing 0.9.20-2+b5 amd64
  OpenLDAP library binding for Ruby

slapd/testing 2.5.13+dfsg-5 amd64
  OpenLDAP server (slapd)</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quels sont les paquets Debian à installer pour mettre en
	œuvre un serveur <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Dans liste obtenue en réponse à la question précédente, rechercher
	les paquets relatifs aux utilitaires et au serveur.</para>
	</question>
	<answer>
	<para>Dans la liste ci-dessus, on retient deux paquets :
	<systemitem>ldap-utils</systemitem> et
	<systemitem>slapd</systemitem>.</para>

<screen>sudo apt -y install slapd ldap-utils</screen>

<screen>Lecture des listes de paquets... Fait
Construction de l'arbre des dépendances... Fait
Lecture des informations d'état... Fait
Les paquets supplémentaires suivants seront installés :
  libltdl7 libodbc2
Paquets suggérés :
  libsasl2-modules-gssapi-mit | libsasl2-modules-gssapi-heimdal odbc-postgresql tdsodbc
Les NOUVEAUX paquets suivants seront installés :
  ldap-utils libltdl7 libodbc2 slapd
0 mis à jour, 4 nouvellement installés, 0 à enlever et 0 non mis à jour.</screen>

	<para>Lors de l'installation, deux écrans <systemitem>debconf</systemitem>
	demandent la saisie du mot de passe administrateur du service
	<acronym>LDAP</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q1-proc'>
	<question>
	<para><phrase>Comment identifier le ou les processus correspondant au
	service installé&nbsp;?</phrase></para>

	<para>Utiliser une commande d'affichage de la liste des processus actifs
	sur le système pour identifier le démon correspondant au serveur
	<acronym>LDAP</acronym>.</para>
	</question>
	<answer>

<screen>ps aux | grep  l[d]ap</screen>

<screen>openldap    1699  0.0  1.0 1159776 10540 ?       Ssl  18:22   0:00
  /usr/sbin/slapd -h ldap:/// ldapi:/// -g openldap -u openldap -F /etc/ldap/slapd.d</screen>

	<para>À partir de ces informations, on identifie le démon serveur
	<systemitem class='daemon'>slapd</systemitem>, le compte utilisateur et le
	groupe système propriétaires du processus (<option>openldap</option>) et
	enfin le répertoire contenant les fichiers de configuration <filename
	class='directory'>/etc/ldap/slapd.d</filename>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment identifier le ou les numéros de ports ouverts par le
	service installé&nbsp;?</phrase></para>

	<para>Utiliser une commande d'affichage de la liste des ports ouverts sur
	le système.</para>
	</question>
	<answer>
	<para>Voici deux exemples usuels.</para>

<screen>sudo lsof -i | grep l[d]ap</screen>

<screen>slapd   1699 openldap    8u  IPv4  19101      0t0  TCP *:ldap (LISTEN)
slapd   1699 openldap    9u  IPv6  19102      0t0  TCP *:ldap (LISTEN)</screen>

<screen>ss -tau | grep l[d]ap</screen>

<screen>tcp   LISTEN 0      2048        0.0.0.0:ldap             0.0.0.0:*
tcp   LISTEN 0      2048           [::]:ldap                [::]:*</screen>

	<para>Les numéros de port enregistrés pour le service
	<acronym>LDAP</acronym> sont disponibles dans le fichier
	<filename>/etc/services</filename>.</para>

<screen>grep ldap /etc/services</screen>

<screen>ldap            389/tcp        # Lightweight Directory Access Protocol
ldap            389/udp
ldaps           636/tcp        # LDAP over SSL
ldaps           636/udp</screen>

	<para>Relativement au indications données par les commandes
	<command>lsof</command> et <command>ss</command>, c'est le numéro de port
	389 qui est ouvert en écoute lors de l'installation du paquet
	<systemitem>slapd</systemitem>.</para>

	<para>Par défaut l'accès <acronym>TLS</acronym> au service n'est pas
	activé.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.ldap.srvr.config'>
	<title>Analyse de la configuration du service LDAP</title>

	<para>Les versions actuelles du logiciel <citetitle>OpenLDAP</citetitle>
	utilisent un mode de configuration basé sur un <wordasword>Directory
	Information Tree</wordasword> ou <acronym>DIT</acronym> propre.  Cette
	arborescence de configuration est pointée par le nom
	<option>cn=config</option>. Elle est utilisée pour configurer dynamiquement
	le démon <systemitem>slapd</systemitem>, modifier les définitions de
	schéma, les index, les listes de contrôle d'accès <acronym>ACLs</acronym>,
	etc. Ce mode de configuration présente un avantage déterminant lorsque l'on
	exploite des annuaires volumineux&nbsp;: toutes les opérations se font sans
	interruption de service.</para>

<qandaset defaultlabel='number'>
	<qandadiv xml:id='sysadm-net.ldap.srvr.q2'>

	<para>Les documents fournis avec le paquet <systemitem>slapd</systemitem>
	contiennent des informations indispensables à l'analyse du fonctionnement
	du service.</para>

	<qandaentry>
	<question>
	<para><phrase>Quel est le mode de gestion de la configuration du service du
	paquet de la distribution Debian GNU/Linux&nbsp;?</phrase></para>

	<para>Consulter les fichiers de documentation fournis avec le paquet
	<systemitem>slapd</systemitem>.</para>
	</question>
	<answer>
	<para>Les documents relatifs au paquet <systemitem>slapd</systemitem> sont
	situés dans le répertoire <filename
	class='directory'>/usr/share/doc/slapd/</filename>. Le fichier
	<filename>README.Debian.gz</filename> contient un exemple d'instruction de
	consultation de la configuration du service.</para>

<screen>sudo ldapsearch -Y EXTERNAL -H ldapi:/// -b "cn=config"</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est le gestionnaire de base de données
	(<wordasword>backend</wordasword>) proposé dans l'annuaire de
	configuration&nbsp;?</phrase></para>

	<para>Reprendre la commande préconisée en réponse à la question précédente
	en utilisant le type de base de donnée comme filtre.</para>
	</question>
	<answer>

<screen>sudo ldapsearch -Y EXTERNAL -H ldapi:/// -b "cn=config" \
  olcDatabase={1}mdb</screen>

<screen>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
# extended LDIF
#
# LDAPv3
# base &lt;cn=config> with scope subtree
# filter: olcDatabase={1}mdb
# requesting: ALL
#

# {1}mdb, config
<emphasis>dn: olcDatabase={1}mdb,cn=config</emphasis>
objectClass: olcDatabaseConfig
objectClass: olcMdbConfig
<emphasis>olcDatabase: {1}mdb</emphasis>
<emphasis>olcDbDirectory: /var/lib/ldap</emphasis>
olcSuffix: dc=nodomain
olcAccess: {0}to attrs=userPassword by self write by anonymous auth by * none
olcAccess: {1}to attrs=shadowLastChange by self write by * read
olcAccess: {2}to * by * read
olcLastMod: TRUE
olcRootDN: cn=admin,dc=nodomain
olcRootPW: {SSHA}y3201Tkxe0HgfQOhLxiVJ3wwI8+dnQwK
olcDbCheckpoint: 512 30
olcDbIndex: objectClass eq
olcDbIndex: cn,uid eq
olcDbIndex: uidNumber,gidNumber eq
olcDbIndex: member,memberUid eq
olcDbMaxSize: 1073741824

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1</screen>

	<para>Par définition, un annuaire <acronym>LDAP</acronym> est une base de
	données optimisée en lecture. Du point de vue implémentation, les entrées
	sont stockées sous forme «binaire» et indexées à l'aide d'un gestionnaire
	de base de données. Le gestionnaire d'arrière plan proposé par défaut est
	<option>mdb</option>. Il s'agit d'une variante actualisée du gestionnaire
	<wordasword>Berkeley DB transactional backend</wordasword>.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q2-suffix'>
	<question>
	<para><phrase>Comment identifier le nom de l'annuaire fourni par défaut
	avec le paquet <systemitem>slapd</systemitem>&nbsp;?</phrase></para>

	<para>Rechercher la clé <literal>olcSuffix</literal> dans la configuration
	de l'annuaire.</para>
	</question>
	<answer>

<screen>sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" \
  olcSuffix | grep ^olcSuffix</screen>

<screen>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
<emphasis>olcSuffix: dc=nodomain</emphasis></screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q2-schema'>
	<question>
	<para><phrase>Quels sont les <wordasword>schemas</wordasword> actifs avec
	la configuration courante du paquet
	<systemitem>slapd</systemitem>&nbsp;?</phrase></para>

	<para>Rechercher la clé <literal>olcSchemaConfig</literal> dans la
	configuration de l'annuaire.</para>
	</question>
	<answer>

<screen>sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" \
  olcSchemaConfig | grep ^cn</screen>

<screen>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
cn: config
cn: module{0}
cn: schema
<emphasis>cn: {0}core
cn: {1}cosine
cn: {2}nis
cn: {3}inetorgperson</emphasis></screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q2-base'>
	<question>
	<para><phrase>Où sont stockées les bases définies par défaut lors de
	l'installation du paquet
	<systemitem>slapd</systemitem>&nbsp;?</phrase></para>

	<para>Rechercher la clé <literal>olcDbDirectory</literal> dans la
	configuration de l'annuaire.</para>
	</question>
	<answer>

<screen>sudo ldapsearch -Y EXTERNAL -H ldapi:/// -b "cn=config" \
  olcDbDirectory | grep ^olcDbDirectory</screen>

<screen>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
<emphasis>olcDbDirectory: /var/lib/ldap</emphasis></screen>

	<para>C'est dans le répertoire <filename
	class='directory'>/var/lib/ldap</filename> que sont stockées les fichiers
	des bases <wordasword>Berkeley DB</wordasword>.</para>

<screen>ls -lAh /var/lib/ldap/</screen>

<screen>total 40K
-rw------- 1 openldap openldap  36K  2 sept. 18:22 data.mdb
-rw------- 1 openldap openldap 8,0K  2 sept. 18:22 lock.mdb</screen>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.ldap.srvr.init'>
	<title>Réinitialisation de la base de l'annuaire LDAP</title>

<qandaset defaultlabel='number'>
	<qandadiv xml:id='sysadm-net.ldap.srvr.q3'>

	<para>L'installation du paquet <systemitem>slapd</systemitem> implique
	l'installation d'un annuaire minimal avec une base associée. Ce mode
	opératoire est nécessaire, ne serait-ce que pour accéder à la configuration
	du service et tester la validité de l'installation.  Après avoir traité les
	questions ci-dessus, on sait que l'installation est fonctionnelle. On peut
	donc passer à l'initialisation de notre propre annuaire.</para>

<note>
	<para>Les manipulations proposées dans cette section permettent de
	reprendre à zéro la configuration d'un annuaire <acronym>LDAP</acronym>. Il
	peut être utile de revenir à cette étape en cas de «doute» sur l'intégrité
	de l'annuaire lors du traitement des questions des sections
	suivantes.</para>
</note>

	<qandaentry>
	<question>
	<para><phrase>Comment arrêter le service
	<acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Utiliser les scripts fournis avec le gestionnaire de lancement des
	processus système.</para>
	</question>
	<answer>
	<para>Chaque processus système dispose d'un script de gestion de son
	lancement, arrêt (et|ou) redémarrage. Avec le gestionnaire
	<application>systemd</application>, il faut faire une recherche dans la
	liste des services. Une fois le service identifié, on l'arrête avec la
	commande <command>systemctl</command>.</para>

<screen>systemctl status slapd</screen>

<screen>● slapd.service - LSB: OpenLDAP standalone server (Lightweight Directory Access Protocol)
     Loaded: loaded (/etc/init.d/slapd; generated)
    Drop-In: /usr/lib/systemd/system/slapd.service.d
             └─slapd-remain-after-exit.conf
     <emphasis>Active: active (running)</emphasis> since Sat 2023-09-02 18:22:14 CEST; 21min ago
       Docs: man:systemd-sysv-generator(8)
    Process: 1693 ExecStart=/etc/init.d/slapd start (code=exited, status=0/SUCCESS)
      Tasks: 4 (limit: 1084)
     Memory: 7.4M
        CPU: 59ms
     CGroup: /system.slice/slapd.service
             └─1699 /usr/sbin/slapd -h "ldap:/// ldapi:///" -g openldap -u openldap -F /etc/ldap/slapd.d

sept. 02 18:22:14 ldap-server systemd[1]: Starting slapd.service - LSB: OpenLDAP standalone server (Lightweight Directory Access Protocol)...
sept. 02 18:22:14 ldap-server slapd[1698]: @(#) $OpenLDAP: slapd 2.5.13+dfsg-5 (Feb  8 2023 01:56:12) $
                                                   Debian OpenLDAP Maintainers &lt;pkg-openldap-devel@lists.alioth.debian.org>
sept. 02 18:22:14 ldap-server slapd[1699]: slapd starting
sept. 02 18:22:14 ldap-server slapd[1693]: Starting OpenLDAP: slapd.
sept. 02 18:22:14 ldap-server systemd[1]: Started slapd.service - LSB: OpenLDAP standalone server (Lightweight Directory Access Protocol).</screen>

	<para>Instruction d'arrêt du service&nbsp;:</para>

<screen>sudo systemctl stop slapd</screen>

	<para>On peut exécuter à nouveau la commande <command>systemctl status
	slapd</command> pour confirmer que le service est bien stoppé et
	inactif.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quels sont les éléments à supprimer pour pouvoir installer
	une nouvelle configuration et une nouvelle base
	<acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Utiliser le résultat de la question sur la <link
	linkend='sysadm-net.ldap.srvr.q2-base'>localisation des bases</link> et la
	documentation fournie avec le paquet <systemitem>slapd</systemitem>.</para>
	</question>
	<answer>
	<para>À partir des réponses aux questions ci-dessus, on sait que c'est le
	répertoire <filename class='directory'>/var/lib/ldap/</filename> qui
	contient les bases. La lecture du fichier de documentation du paquet avec
	la commande <userinput>zless
	/usr/share/doc/slapd/README.Debian.gz</userinput> indique que les fichiers
	de configuration sont situés dans le répertoire <filename
	class='directory'>/etc/ldap/slapd.d/</filename>.</para>

	<para>On supprime donc tous ces fichiers et répertoires.</para>

<screen>sudo rm -rf /var/lib/ldap/* /etc/ldap/slapd.d</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment reprendre à zéro la configuration du paquet
	<systemitem>slapd</systemitem>&nbsp;?</phrase></para>

	<para>Utiliser l'outil du gestionnaire de paquets <citetitle>Debian
	GNU/Linux</citetitle> qui permet la modification des paramètres de
	configuration d'un service à l'aide de menus
	<systemitem>debconf</systemitem>.</para>
	</question>
	<answer>
	<para>C'est la commande <command>dpkg-reconfigure</command> qui sert à
	réviser les paramètres de configuration d'un paquet. Voici une copie des
	écrans proposés avec le paquet <systemitem>slapd</systemitem>.</para>

<screen>sudo dpkg-reconfigure slapd</screen>

<screen>  Creating initial configuration... done.
  Creating LDAP directory... done.</screen>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/slapd1.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/slapd1.png' format='PNG'  width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/slapd1.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/slapd2.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/slapd2.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/slapd2.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/slapd3.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/slapd3.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/slapd3.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/slapd4.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/slapd4.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/slapd4.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/slapd5.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/slapd5.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/slapd5.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/slapd6.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/slapd6.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran dpkg-reconfigure slapd</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/slapd6.png'>
	Copie d'écran dpkg-reconfigure slapd - vue complète</link></para>
	</caption>
</mediaobject>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment valider la nouvelle configuration du paquet
	<systemitem>slapd</systemitem>&nbsp;?</phrase></para>

	<para>Reprendre la question sur le <link
	linkend='sysadm-net.ldap.srvr.q2-suffix'>nom distinctif</link> de
	l'annuaire.</para>
	</question>
	<answer>
<screen>sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" \
  olcSuffix | grep ^olcSuffix</screen>

<screen>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
olcSuffix: <emphasis>dc=lab,dc=stri</emphasis></screen>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.ldap.srvr.build'>
	<title>Composition d'un nouvel annuaire LDAP</title>

	<para>Une fois que les fichiers de configuration et de base de données du
	nouvel annuaire sont en place, on peut passer à l'ajout de nouvelles
	entrées dans cet annuaire. Comme le fil conducteur de cette série de
	travaux pratiques est la gestion d'une base de comptes utilisateurs, on
	doit ajouter les objets suivants.</para>

	<itemizedlist>
	<listitem>
	<para>Deux unités organisationnelles : <option>people</option> et
	<option>groups</option>.</para>
	</listitem>
	<listitem>
	<para>Quatre compte utilisateurs : papa et maman Skywalker ainsi que leurs
	deux enfants</para>
	</listitem>
	</itemizedlist>

	<para>Toutes les manipulations sur les objets de l'annuaire utilisent un
	format de fichier texte particulier baptisé <acronym>LDIF</acronym> pour
	<wordasword>LDAP Data Interchange Format</wordasword>. C'est un format de
	représentation des données contenues dans un annuaire particulièrement
	utile pour les opérations de sauvegarde et de restauration en
	volume.</para>

	<para>Du point de vue formatage, chaque enregistrement doit être séparé du
	suivant par une ligne vide et chaque attribut d'un enregistrement apparaît
	sur une ligne sous la forme «nomAttribut: valeur».</para>

<qandaset defaultlabel='number'>
	<qandadiv xml:id='sysadm-net.ldap.srvr.q4'>

	<qandaentry>
	<question>
	<para><phrase>Comment visualiser la liste des entrées contenues dans
	l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Utiliser les pages de manuels de la commande
	<command>ldapsearch</command> et rechercher les informations sur les
	méthodes d'authentification, la désignation de la base dans laquelle on
	effectue la recherche et le nom distinctif utilisé pour se connecter à
	l'annuaire.</para>
	</question>
	<answer>
	<para>La commande <command>ldapsearch</command> propose plusieurs modes
	d'authentification qui influent sur la liste des attributs affichés pour
	une même entrée. Dans notre exemple, ce sont les mots de passes qui peuvent
	ne pas apparaître ou apparaître sous différentes formes.</para>

	<itemizedlist>
	<listitem>
	<para>L'option <option>-x</option> évite le recours à la méthode
	<acronym>SASL</acronym> pour l'authentification.</para>

<screen>sudo ldapsearch -LLL -x -H ldap:/// -b "dc=lab,dc=stri" \
  -D cn=admin,dc=lab,dc=stri -W</screen>

<screen>Enter LDAP Password:
dn: dc=lab,dc=stri
objectClass: top
objectClass: dcObject
objectClass: organization
o: lab.stri
dc: lab</screen>
	</listitem>

	<listitem>
	<para>L'option <option>-Y EXTERNAL</option> utilise la méthode
	<acronym>SASL</acronym> du même nom.</para>

<screen>sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "dc=lab,dc=stri" \
  -D cn=admin,dc=lab,dc=stri -W</screen>

<screen>Enter LDAP Password:
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
dn: dc=lab,dc=stri
objectClass: top
objectClass: dcObject
objectClass: organization
o: lab.stri
dc: lab</screen>
	</listitem>

	<listitem>
	<para>L'option <option>-LLL</option> désactive l'affichage des commentaires
	et de la version <acronym>LDIF</acronym> utilisée dans la réponse.</para>
	</listitem>

	<listitem>
	<para>L'option <option>-b</option> désigne le point de départ de la
	recherche.</para>
	</listitem>

	<listitem>
	<para>L'option <option>-D</option> désigne le nom distinctif de connexion à
	l'annuaire.</para>
	</listitem>

	<listitem>
	<para>L'option <option>-W</option> provoque l'affichage de l'invite de
	demande du mot passe correspondant au nom distinctif utilisé.</para>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-LogLevel'>
	<question>
	<para><phrase>Comment activer la journalisation des manipulations sur les
	entrées de l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Rechercher l'entrée relative au niveau de journalisation dans le
	<acronym>DIT</acronym> et modifier sa valeur de façon à obtenir un état
	dans les journaux système à chaque opération sur l'annuaire.</para>

	<para>La modification de l'entrée du <acronym>DIT</acronym> doit se faire à
	l'aide d'un fichier <acronym>LDIF</acronym> approprié.</para>
	</question>
	<answer>
	<para>L'entrée à rechercher dans le <acronym>DIT</acronym> est baptisée
	<option>olcLogLevel</option>.</para>

<screen>sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" \
  olcLogLevel | grep ^olcLogLevel</screen>

<screen>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
olcLogLevel: none</screen>

	<para>on se propose de remplacer la valeur <option>none</option> par
	<option>stats</option> de façon à journaliser les connexions, les
	opérations et les résultats. Voici une copie du fichier
	<acronym>LDIF</acronym> permettant de réaliser cette modification.</para>

	<para>On commence par créer un dossier dédié aux fichiers
	<acronym>LDIF</acronym>.</para>

<screen>mkdir -p $HOME/ldif &amp;&amp; cd $HOME/ldif</screen>

	<para>Ensuite on peut créer le fichier <acronym>LDIF</acronym> de
	modification de la journalisation du service
	<acronym>LDAP</acronym>.</para>

<screen>cat > setolcLogLevel2stats.ldif &lt;&lt; EOF
# Set olcLogLevel to "stats"
dn: cn=config
changetype: modify
replace: olcLogLevel
olcLogLevel: stats
EOF</screen>

	<para>On applique ce changement de valeur avec la commande
	<command>ldapmodify</command> puis on vérifie que l'attribut a bien reçu le
	paramètre.</para>

<screen>sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f setolcLogLevel2stats.ldif</screen>

<screen>CSASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"</screen>

<screen>sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" \
  olcLogLevel | grep ^olcLogLevel</screen>

<screen>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
<emphasis>olcLogLevel: stats</emphasis></screen>

	<para>Enfin, on relève les traces de la dernière opération dans les
	journaux système.</para>

<screen>journalctl -o cat -n 20 -u slapd --grep="conn"
conn=1009 fd=12 closed
conn=1009 op=2 UNBIND
conn=1009 op=1 SEARCH RESULT tag=101 err=0 qtime=0.000017 etime=0.000193 nentries=10 text=
conn=1009 op=1 SRCH attr=olcLogLevel
conn=1009 op=1 SRCH base="cn=config" scope=2 deref=0 filter="(objectClass=*)"
conn=1009 op=0 RESULT tag=97 err=0 qtime=0.000018 etime=0.000107 text=
conn=1009 op=0 BIND dn="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" mech=EXTERNAL bind_ssf=0 ssf=71
conn=1009 op=0 BIND authcid="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" authzid="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth"
conn=1009 op=0 BIND dn="" method=163
conn=1009 fd=12 ACCEPT from PATH=/var/run/slapd/ldapi (PATH=/var/run/slapd/ldapi)
conn=1008 fd=12 closed
conn=1008 op=2 UNBIND
conn=1008 op=1 RESULT tag=103 err=0 qtime=0.000021 etime=0.000558 text=</screen>

<note>
	<para>Dans le contexte des travaux pratiques, le nombre d'entrées de
	l'annuaire reste très limité et la journalisation n'a pas d'impact
	mesurable sur les performances du système. Dans un contexte d'exploitation
	réelle avec un annuaire comprenant au moins une dizaine de milliers
	d'entrées, la situation est très différente et il faut limiter au maximum
	le recours à la journalisation des transactions sur l'annuaire.</para>
</note>

	<para>Pour ramener la valeur de l'attribut <option>olcLogLevel</option> à
	<option>none</option>, il suffit de créer un fichier
	<acronym>LDIF</acronym> avec la directive correspondante.</para>

<screen>cat > setolcLogLevel2none.ldif &lt;&lt; EOF
# Set olcLogLevel to "none"
dn: cn=config
changetype: modify
replace: olcLogLevel
olcLogLevel: none
EOF</screen>
      </answer>
    </qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-ou'>
	<question>
	<para><phrase>Quelle est la syntaxe du fichier <acronym>LDIF</acronym> qui
	permet d'ajouter les deux unités organisationnelles
	(<wordasword>organisational unit</wordasword>)&nbsp;?</phrase></para>

	<para>Rechercher un tutoriel <acronym>LDIF</acronym> en ligne donnant un
	exemple de fichier <acronym>LDIF</acronym> avec une ou plusieurs entrées
	<option>ou:</option>.</para>
	</question>
	<answer>
	<para>Voici un exemple de fichier <acronym>LDIF</acronym> contenant les
	déclarations des deux unités organisationnelles à ajouter.</para>

<screen>cat > ou.ldif &lt;&lt; EOF
dn: ou=people,dc=lab,dc=stri
objectClass: organizationalUnit
ou: people

dn: ou=groups,dc=lab,dc=stri
objectClass: organizationalUnit
ou: groups
EOF</screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-ldapadd'>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour ajouter une ou
	plusieurs entrées dans l'annuaire&nbsp;?</phrase></para>

	<para>Rechercher dans la liste des programmes fournis avec le paquet des
	outils <acronym>LDAP</acronym>.</para>
	</question>
	<answer>
	<para>C'est la commande <command>ldapadd</command> qui est utile dans notre
	contexte. On l'utilise en mode d'authentification simple avec le fichier
	<acronym>LDIF</acronym> ci-dessus pour compléter l'annuaire.</para>

<screen>sudo ldapadd -cxWD cn=admin,dc=lab,dc=stri -f ou.ldif</screen>

<screen>Enter LDAP Password:
adding new entry "ou=people,dc=lab,dc=stri"

adding new entry "ou=groups,dc=lab,dc=stri"</screen>

	<para>On vérifie ensuite que les deux nouvelles entrées sont bien présentes
	dans l'annuaire.</para>

<screen>sudo ldapsearch -LLL -x -H ldap:/// -b "dc=lab,dc=stri" \
  -D cn=admin,dc=lab,dc=stri -W</screen>

<screen>Enter LDAP Password:
dn: dc=lab,dc=stri
objectClass: top
objectClass: dcObject
objectClass: organization
o: lab.stri
dc: lab

dn: ou=people,dc=lab,dc=stri
objectClass: organizationalUnit
ou: people

dn: ou=groups,dc=lab,dc=stri
objectClass: organizationalUnit
ou: groups</screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-passwd'>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour saisir manuellement un
	mot de passe et obtenir la chaîne chiffrée
	correspondante&nbsp;?</phrase></para>

	<para>Rechercher dans la liste des programmes fournis avec les paquets de
	la distribution puis consulter les pages de manuels correspondantes.</para>
	</question>
	<answer>
	<para>En effectuant une recherche par mot clé dans les pages de manuels du
	système, on peut identifier l'outil recherché.</para>

<screen>man -k passwd | grep -i ldap</screen>

<screen>ldappasswd (1)       - change the password of an LDAP entry
<emphasis>slappasswd</emphasis> (8)       - OpenLDAP password utility</screen>

	<para>On utilise la commande <command>slappasswd</command> pour générer une
	chaîne chiffrée que l'on insère dans le fichier <acronym>LDIF</acronym> des
	comptes utilisateurs.</para>

	<para>Prenons l'exemple du mot de passe <literal>V3ry53cr3t</literal>, on
	obtient le résultat suivant&nbsp;:</para>

<screen>sudo slappasswd</screen>

<screen>New password:
Re-enter new password:
{SSHA}rpB4tgcVlh51sPCtpBi+acrS6Ifc1lu0</screen>

	<para>Dans le contexte de ces travaux pratiques, on attribue le même mot de
	passe aux quatre comptes utilisateurs.</para>

	<para>Il existe une technique simple pour la génération de mots de passe
	utilisateurs aléatoires. Une fois le mot de passe généré, il peut être
	transmis à l'utilisateur final par un «canal de confiance» et implanté dans
	les attributs de l'annuaire relatifs au compte utilisateur.</para>

	<orderedlist>
	<listitem>
	<para>On génère un mot de passe aléatoire que l'on stocke dans un fichier.</para>

<screen>openssl rand -base64 16 | tr -d '=' > user.passwd</screen>

	<para>On obtient par exemple&nbsp;:</para>

<screen>cat user.passwd
vyJtXX6r73KPzyDYymWjsA</screen>
	</listitem>
	<listitem>
	<para>Utilise ce mot de passe pour générer la chaîne à introduire dans le
	fichier <acronym>LDIF</acronym> de création d'utilisateur dans
	l'annuaire.</para>

<screen>sudo slappasswd -v -h "{SSHA}" -s $(cat user.passwd)</screen>

<screen>{SSHA}hFGouu+ytfnH0qPy7y9G0L0Rb6R6slZ4</screen>
	</listitem>
	</orderedlist>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.srvr.q4-posixAccount'>
	<question>
	<para><phrase>Quelle est la syntaxe du fichier <acronym>LDIF</acronym> qui
	permet d'ajouter les quatre utilisateurs avec leurs attributs système :
	identifiants <systemitem>uid/gid</systemitem>, authentifiants
	<systemitem>login/passwd</systemitem>, etc&nbsp;?</phrase></para>

	<para>Rechercher un tutoriel <acronym>LDIF</acronym> en ligne donnant un
	exemple de fichier <acronym>LDIF</acronym> avec un exemple de description
	des attributs d'un compte utilisateur.</para>
	</question>
	<answer>
	<para>Voici un exemple de fichier <acronym>LDIF</acronym> contenant les
	déclarations des quatre comptes utilisateurs à ajouter.</para>

<warning>
	<para>Pensez à éditer les entrées <literal>userPassword</literal> à votre contexte&nbsp;!</para>
</warning>

<screen>cat > users.ldif &lt;&lt; EOF
# Padmé Amidala
dn: uid=padme,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Padme
sn: Padmé Amidala Skywalker
uid: padme
uidNumber: 10000
gidNumber: 10000
loginShell: /bin/bash
homeDirectory: /ahome/padme
userPassword: {SSHA}hFGouu+ytfnH0qPy7y9G0L0Rb6R6slZ4
gecos: Padme Amidala Skywalker

# Anakin Skywalker
dn: uid=anakin,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Anakin
sn: Anakin Skywalker
uid: anakin
uidNumber: 10001
gidNumber: 10001
loginShell: /bin/bash
homeDirectory: /ahome/anakin
userPassword: {SSHA}hFGouu+ytfnH0qPy7y9G0L0Rb6R6slZ4
gecos: Anakin Skywalker

# Leia Organa Skywalker
dn: uid=leia,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Leia
sn: Leia Organa
uid: leia
uidNumber: 10002
gidNumber: 10002
loginShell: /bin/bash
homeDirectory: /ahome/leia
userPassword: {SSHA}hFGouu+ytfnH0qPy7y9G0L0Rb6R6slZ4
gecos: Leia Organa Skywalker

# Luke Skywalker
dn: uid=luke,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Luke
sn: Luke Skywalker
uid: luke
uidNumber: 10003
gidNumber: 10003
loginShell: /bin/bash
homeDirectory: /ahome/luke
userPassword: {SSHA}hFGouu+ytfnH0qPy7y9G0L0Rb6R6slZ4
gecos: Luke Skywalker
EOF</screen>

	<para>Comme dans le cas précédent, on utilise la commande
	<command>ldapadd</command> en mode d'authentification simple pour insérer
	les utilisateurs dans l'annuaire.</para>

<screen>sudo ldapadd -cxWD cn=admin,dc=lab,dc=stri -f users.ldif</screen>

<screen>Enter LDAP Password:
adding new entry "uid=padme,ou=people,dc=lab,dc=stri"

adding new entry "uid=anakin,ou=people,dc=lab,dc=stri"

adding new entry "uid=leia,ou=people,dc=lab,dc=stri"

adding new entry "uid=luke,ou=people,dc=lab,dc=stri"</screen>

	<para>On peut lister à nouveau les entrées contenues dans l'annuaire pour
	vérifier la présence des utilisateurs.</para>

<screen>sudo ldapsearch -LLL -x -H ldap:/// -b "dc=lab,dc=stri" \
  -D cn=admin,dc=lab,dc=stri -W</screen>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.ldap.clnt'>
	<title>Configuration de l'accès client au serveur LDAP</title>

	<para>Dans cette section, on suppose qu'un annuaire <acronym>LDAP</acronym>
	existe et qu'il contient des utilisateurs. On se propose de configurer un
	poste client pour qu'il obtienne de façon transparente les informations sur
	les comptes utilisateurs desservis par l'annuaire.</para>

<sect2 xml:id='sysadm-net.ldap.clnt.query'>
	<title>Interrogation à distance de l'annuaire LDAP</title>

	<para>On reprend ici les requêtes de consultation des entrées de l'annuaire
	vues dans la <xref linkend='sysadm-net.ldap.srvr.build'/>. Cette fois-ci
	les requêtes sont émises depuis un hôte réseau différent du serveur
	<acronym>LDAP</acronym>.</para>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Quel est le paquet qui fournit, entre autres, la commande de
	consultation des entrées de l'annuaire&nbsp;?</phrase></para>

	<para>Interroger la base de données des paquets pour obtenir les
	informations demandées.</para>
	</question>
	<answer>
<screen>sudo apt -y install ldap-utils</screen>

	<para>Le paquet <systemitem>ldap-utils</systemitem> apparaît à la question
	sur <link linkend='sysadm-net.ldap.srvr.q1-package'>la liste des paquets
	relatifs au service</link> <acronym>LDAP</acronym>. Si on recherche les
	commandes présentes dans la liste des fichiers de ce paquet, on obtient les
	informations suivantes.</para>

<screen>dpkg -L ldap-utils | grep "bin/"</screen>

<screen>/usr/bin/ldapcompare
/usr/bin/ldapdelete
/usr/bin/ldapexop
/usr/bin/ldapmodify
/usr/bin/ldapmodrdn
/usr/bin/ldappasswd
/usr/bin/ldapsearch
/usr/bin/ldapurl
/usr/bin/ldapwhoami
/usr/bin/ldapadd</screen>

	<para>Une fois ce paquet installé, il est possible d'utiliser toutes les
	commandes disponibles pour manipuler les enregistrements de
	l'annuaire.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe d'interrogation de l'annuaire qui
	permet d'obtenir tous les attributs de l'enregistrement correspondant à un
	utilisateur particulier&nbsp;?</phrase></para>
	</question>
	<answer>
	<para>On utilise la commande <command>ldapsearch</command> en spécifiant un
	attribut <option>uid</option> particulier.</para>

<screen>sudo ldapsearch -LLL -H ldap://[2001:678:3fc:64:baad:caff:fefe:7] \
  -b dc=lab,dc=stri -D cn=admin,dc=lab,dc=stri -W <emphasis>uid=padme</emphasis></screen>

<screen>Enter LDAP Password:
dn: <emphasis>uid=padme,ou=people,dc=lab,dc=stri</emphasis>
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Padme
sn:: UGFkbcOpIEFtaWRhbGEgU2t5d2Fsa2Vy
uid: padme
uidNumber: 10000
gidNumber: 10000
loginShell: /bin/bash
homeDirectory: /ahome/padme
userPassword:: e1NTSEF9aEZHb3V1K3l0Zm5IMHFQeTd5OUcwTDBSYjZSNnNsWjQ=
gecos: Padme Amidala Skywalker</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe de la commande permettant de changer le
	mot de passe de l'utilisateur dont on an affiché les attributs à la
	question précédente&nbsp;?</phrase></para>
	</question>
	<answer>
	<para>On utilise la commande <command>ldappasswd</command> fournie par le
	paquet <systemitem>ldap-utils</systemitem> comme dans le cas de la commande
	de recherche. Après consultation des pages de manuels, on obtient la
	syntaxe suivante.</para>

<screen>sudo ldappasswd -x -H ldap://[2001:678:3fc:64:baad:caff:fefe:7] \
  -D cn=admin,dc=lab,dc=stri -W -S uid=padme,ou=people,dc=lab,dc=stri</screen>

<screen>New password:
Re-enter new password:
Enter LDAP Password:</screen>

	<para>En posant exactement la même requête que dans la question	précédente,
	on peut vérifier que le mot de passe utilisateur a bien été modifié.</para>

<screen>sudo ldapsearch -LLL -H ldap://[2001:678:3fc:64:baad:caff:fefe:7] \
  -b dc=lab,dc=stri -D cn=admin,dc=lab,dc=stri -W uid=padme</screen>

<screen>Enter LDAP Password:
dn: uid=padme,ou=people,dc=lab,dc=stri
objectClass: inetOrgPerson
objectClass: shadowAccount
objectClass: posixAccount
cn: Padme
sn:: UGFkbcOpIEFtaWRhbGEgU2t5d2Fsa2Vy
uid: padme
uidNumber: 10000
gidNumber: 10000
loginShell: /bin/bash
homeDirectory: /ahome/padme
gecos: Padme Amidala Skywalker
userPassword:: e1NTSEF9bngwTTlpUi9QYitpaVJTbzNpN0tkejVkSTRJMVpZclM=</screen>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.ldap.clnt.nss'>
	<title>Configuration <wordasword>Name Service Switch</wordasword></title>

	<para>Les manipulations présentées ici ont pour but de rendre transparent
	l'accès aux attributs des comptes utilisateurs. Le mécanisme
	<wordasword>Name Service Switch</wordasword> assure un aiguillage de
	l'accès à ces attributs entre les fichiers locaux et les différents
	services réseau disponibles. Ici, l'annuaire <acronym>LDAP</acronym>
	constitue un dépôt de référence pour le stockage des attributs des comptes
	utilisateurs.</para>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Quel est le nom du paquet relatif au mécanisme
	<wordasword>Name Service Switch</wordasword> permettant d'accéder aux
	ressources de l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Rechercher dans les bases du gestionnaire de paquets un paquet dont
	le nom débute par la chaîne <option>libnss</option>.</para>
	</question>
	<answer>
	<para>La liste ci-dessous permet d'identifier le paquet
	<systemitem>libnss-ldapd</systemitem>.</para>

<screen>apt search --names-only ^libnss-</screen>

<screen>apt search --names-only ^libnss-ldap</screen>

<screen>En train de trier... Fait
Recherche en texte intégral... Fait
<emphasis>libnss-ldapd</emphasis>/testing 0.9.12-4 amd64
  NSS module for using LDAP as a naming service</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quels sont les paquets supplémentaires qui sont ajoutés lors
	de l'installation des bibliothèques <acronym>LDAP</acronym> pour le
	mécanisme <wordasword>Name Service
	Switch</wordasword>&nbsp;?</phrase></para>

	<para>Utiliser les informations fournies par le gestionnaire de paquets
	pour chaque ajout.</para>
	</question>
	<answer>
	<para>Le lancement de l'installation du	paquet
	<systemitem>libnss-ldapd</systemitem> donne la liste suivante.</para>

<screen>udo apt install libnss-ldapd
Lecture des listes de paquets... Fait
Construction de l'arbre des dépendances... Fait
Lecture des informations d'état... Fait
Les paquets supplémentaires suivants seront installés :
  <emphasis>libpam-ldapd nscd nslcd nslcd-utils</emphasis>
Paquets suggérés :
  kstart
Les NOUVEAUX paquets suivants seront installés :
  libnss-ldapd libpam-ldapd nscd nslcd nslcd-utils
0 mis à jour, 5 nouvellement installés, 0 à enlever et 0 non mis à jour.
Il est nécessaire de prendre 390 ko dans les archives.
Après cette opération, 971 ko d'espace disque supplémentaires seront utilisés.
Souhaitez-vous continuer ? [O/n]</screen>

	<para>Plusieurs paquets supplémentaires apparaissent&nbsp;:</para>
	<itemizedlist>
	<listitem>
	<para><systemitem>libpam-ldapd</systemitem> fournit les fonctions
	<acronym>PAM</acronym> nécessaires à l'authentification, aux autorisations
	et à la gestion de session via un annuaire <acronym>LDAP</acronym>.</para>
	</listitem>
	<listitem>
	<para><systemitem>nscd</systemitem> (<wordasword>Name Service Cache
	Daemon</wordasword>) est un démon qui gère la recherche des mots de passe,
	des groupes et hôtes des programmes en cours d’exécution, et met en cache
	le résultat pour une prochaine recherche.</para>
	</listitem>
	<listitem>
	<para><systemitem>nslcd</systemitem> fournit un autre démon pour la
	collecte des informations sur les comptes utilisateurs depuis un serveur
	<acronym>LDAP</acronym>.</para>
	</listitem>
	<listitem>
	<para><systemitem>nslcd-utils</systemitem> fournit des outils pour
	l'interrogation et la mise à jour des entrées d'annuaire
	<acronym>LDAP</acronym>.</para>
	</listitem>
	</itemizedlist>

<warning>
	<para>Pour les besoins des travaux pratiques ou de la mise au point de
	l'authentification via <acronym>LDAP</acronym>, il est utile de relancer
	les services de cache à chaque modification des conditions d'accès à
	l'annuaire.</para>

<screen>sudo systemctl restart nslcd</screen>

<screen>sudo systemctl restart nscd</screen>
</warning>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est le rôle de l'interface entre les fonctions
	<acronym>PAM</acronym> (<wordasword>Pluggable Authentication
	Modules</wordasword>) et l'annuaire
	<acronym>LDAP</acronym>&nbsp;?</phrase></para>
	</question>
	<answer>
	<para>Par définition, <acronym>PAM</acronym> est un mécanisme qui permet
	d'intégrer différents modes d'authentification en les rendant transparents
	vis à vis de l'utilisateur et des logiciels qui accèdent aux ressources du
	système. Dans le contexte de ces travaux pratiques, il s'agit de permettre
	à l'utilisateur de se connecter, d'accéder au système de fichiers, de
	changer son mot de passe, etc sans avoir à lancer des commandes
	spécifiques.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les principales étapes de la configuration des
	paquets de bibliothèques <acronym>NSS</acronym> et
	<acronym>PAM</acronym>&nbsp;?</phrase></para>

	<para>Lors de l'installation des principaux paquets de bibliothèques
	<acronym>LDAP</acronym>, on passe par une série de menus
	<systemitem>debconf</systemitem> qu'il faut renseigner correctement pour
	accéder au serveur <acronym>LDAP</acronym> de façon transparente.</para>
	</question>
	<answer>

<warning>
	<para>En cas d'erreur de saisie dans la série de menus ci-dessous, il faut
	reprendre la configuration de chacun des deux paquets individuellement.
	Classiquement, on passe par la commande
	<command>dpkg-reconfigure</command>.</para>
</warning>

<screen>sudo dpkg-reconfigure libnss-ldapd</screen>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/libnss-ldapd.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/libnss-ldapd.png' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/libnss-ldapd.png'>Copie
	d'écran configuration libnss-ldapd - vue complète</link></para>
	</caption>
</mediaobject>

<screen>sudo dpkg-reconfigure nslcd</screen>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/nslcd1.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/nslcd1.png' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/nslcd1.png'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/nslcd2.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/nslcd2.png' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/nslcd2.png'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/nslcd3.png' format='PNG' width='420px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/nslcd3.png' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/nslcd3.png'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/nslcd4.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/nslcd4.png' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/nslcd4.png'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/nslcd5.png' format='PNG' width='420px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/nslcd5.png' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/nslcd5.png'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/nslcd6.png' format='PNG' width='420px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/nslcd6.png' format='PNG' width='10cm'/>
	</imageobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/nslcd6.png'>Copie
	d'écran configuration nslcd - vue complète</link></para>
	</caption>
</mediaobject>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les modifications apportées au fichier de
	configuration <filename>/etc/nsswitch.conf</filename> pour activer l'accès
	aux ressources de l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Lors de l'installation des paquets à l'étape précédente, le fichier
	<filename>/etc/nsswitch.conf</filename> a été modifié.</para>
	</question>
	<answer>
<screen>grep ldap /etc/nsswitch.conf
passwd:         files systemd <emphasis>ldap</emphasis>
group:          files systemd <emphasis>ldap</emphasis>
shadow:         files systemd <emphasis>ldap</emphasis></screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment illustrer simplement le fonctionnement du mécanisme
	<wordasword>name service switch</wordasword> intégrant l'utilisation de
	l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Rechercher la commande de récupération des entrées depuis les bases
	de données d'administration dans les outils fournis avec les bibliothèques
	standard (paquet <systemitem>libc-bin</systemitem>).</para>
	</question>
	<answer>

<screen>dpkg -L libc-bin | grep "bin/"</screen>

	<para>La commande <command>getent</command> fournie avec le paquet
	<systemitem>libc-bin</systemitem> donne la liste des entrées accessibles
	pour chaque catégorie du fichier de configuration. Voici un exemple pour la
	catégorie <option>passwd</option> qui fait apparaître les entrées de
	l'annuaire <acronym>LDAP</acronym> à la suite des comptes utilisateurs
	système issus des fichiers locaux.</para>


<screen>getent passwd</screen>

<screen>root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
_apt:x:42:65534::/nonexistent:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:998:998:systemd Network Management:/:/usr/sbin/nologin
systemd-timesync:x:997:997:systemd Time Synchronization:/:/usr/sbin/nologin
messagebus:x:100:107::/nonexistent:/usr/sbin/nologin
sshd:x:101:65534::/run/sshd:/usr/sbin/nologin
etu:x:1000:1000:Etudiant.e,,,:/home/etu:/bin/bash
systemd-resolve:x:996:996:systemd Resolver:/:/usr/sbin/nologin
rdnssd:x:102:65534::/var/run/rdnssd:/usr/sbin/nologin
nslcd:x:103:109:nslcd name service LDAP connection daemon,,,:/run/nslcd:/usr/sbin/nologin
<emphasis>padme:x:10000:10000:Padme Amidala Skywalker:/ahome/padme:/bin/bash
anakin:x:10001:10001:Anakin Skywalker:/ahome/anakin:/bin/bash
leia:x:10002:10002:Leia Organa Skywalker:/ahome/leia:/bin/bash
luke:x:10003:10003:Luke Skywalker:/ahome/luke:/bin/bash</emphasis></screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.ldap.clnt.nss.q2-auth'>
	<question>
	<para><phrase>Comment valider l'authentification d'un utilisateur déclaré
	dans l'annuaire <acronym>LDAP</acronym>&nbsp;?</phrase></para>

	<para>Choisir un service qui nécessite une authentification sur le système
	et qui utilise une entrée de l'annuaire <acronym>LDAP</acronym>.</para>
	</question>
	<answer>
	<para>Les exemples de services nécessitant une authentification ne manquent
		pas. La commande <command>su</command> qui permet de changer d'identité
		est le plus immédiat.</para>

<screen>su - padme</screen>

<screen>Mot de passe :
su: avertissement : impossible de changer le répertoire vers /ahome/padme: Aucun fichier ou dossier de ce type
padme@ldap-client:/home/etu$</screen>

	<para>Dans les journaux du système, on retrouve les mêmes éléments.</para>

<screen>journalctl -o cat -n 20 --grep="pam_unix" | grep padme</screen>

<screen>pam_unix(su-l:session): session closed for user padme
pam_unix(su-l:session): session opened for user padme(uid=10000) by etu(uid=1000)
pam_unix(su-l:auth): authentication failure; logname=etu uid=1000 euid=0 tty=/dev/pts/0 ruser=etu rhost=  user=padme
pam_unix(su-l:session): session closed for user padme
pam_unix(su-l:session): session opened for user padme(uid=10000) by etu(uid=1000)
pam_unix(su-l:auth): authentication failure; logname=etu uid=1000 euid=0 tty=/dev/pts/0 ruser=etu rhost=  user=padme</screen>

	<para>Voici un autre exemple d'accès avec <acronym>ssh</acronym>.</para>

<screen>ssh padme@localhost</screen>

<screen>The authenticity of host 'localhost (::1)' can't be established.
ED25519 key fingerprint is SHA256:yFLaZk+OfY7z7bHyHPXgjowRS4KMHjfoMQxracRdG9M.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'localhost' (ED25519) to the list of known hosts.
padme@localhost's password:
Linux ldap-client 6.4.0-3-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.4.11-1 (2023-08-17) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Could not chdir to home directory /ahome/padme: No such file or directory
padme@ldap-client:/$
déconnexion
Connection to localhost closed.</screen>

<screen>journalctl -o cat -n 100 -u ssh | grep padme</screen>

	<para>Il ne manque que l'accès au système de fichiers pour que la
	configuration soit vraiment complète.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.ldap.web'>
	<title>accès à l'annuaire LDAP depuis un service web</title>

	<para>Du point de vue métier, les manipulations à base de fichiers
	<acronym>LDIF</acronym> sont réservées aux traitements en volume réalisés
	par les administrateurs système. Les développeurs disposent de
	bibliothèques fournies avec les langages de programmation. Dans la plupart
	des cas, les développements ont pour but de fournir une interface
	web.</para>


	<para>Le projet &url.ltb-project; propose un outil baptisé <citetitle>white
	pages</citetitle> qui permet de constituer un trombinoscope des
	utilisateurs enregistrés dans un annuaire <acronym>LDAP</acronym>.</para>

	<para>l'objectif de cette section est d'installer le service web
	&url.ltb-white-pages; et de compléter les attributs des utilisateurs de
	l'annuaire avec une photo.</para>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Quel est le paquet à installer pour mettre en place le
	service web <citetitle>White Pages</citetitle>&nbsp;?</phrase></para>

	<para>Rechercher sur le site &url.ltb-project;, le lien de téléchargement
	direct du paquet Debian pour le service <citetitle>White
	Pages</citetitle>.</para>
	</question>
	<answer>
	<para>À partir du lien <literal>Download</literal> en bas de la page
	principale, on trouve un lien direct vers le paquet.</para>

	<para>Après le téléchargement, l'installation nécessite quelques
	ajustements compte tenu des dépendances des paquets entre les différentes
	versions du langage <acronym>PHP</acronym> et du
	<wordasword>framework</wordasword> <citetitle>Smarty</citetitle>.</para>

<screen>wget https://ltb-project.org/archives/white-pages_0.4-2_all.deb</screen>

<screen>sudo dpkg -i white-pages_0.4-2_all.deb</screen>

<screen>sudo apt -y -f install</screen>

<screen>sudo apt install smarty3</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment activer l'accès au service web&nbsp;?</phrase></para>

	<para>Consulter les fichiers de documentation et de configuration fournis
	avec le paquet <citetitle>apache2</citetitle>. Repérer les instructions
	d'activation et de désactivation d'un site. Retrouver les éléments
	spécifiques à la configuration du service <citetitle>White
	Pages</citetitle>.</para>
	</question>
	<answer>
	<para>Cette question comprend plusieurs étapes.</para>
	<orderedlist>
	<listitem>
	<para>Le paquet <systemitem>apache2</systemitem> comprend une liste
	d'outils dédiés aux manipulations sur les sites et leur
	configuration.</para>

<screen>dpkg -L apache2 | grep "bin.*a2"
/usr/sbin/a2enmod
/usr/sbin/a2query
/usr/sbin/a2disconf
/usr/sbin/a2dismod
/usr/sbin/a2dissite
/usr/sbin/a2enconf
/usr/sbin/a2ensite</screen>
	</listitem>
	<listitem>
	<para>On utilise <command>a2dissite</command> pour désactiver le site par
	défaut et <command>a2ensite</command> pour activer les pages
	blanches.</para>

<screen>sudo a2dissite 000-default</screen>

<screen>sudo a2ensite white-pages</screen>

<screen>sudo apachectl configtest</screen>

<screen>sudo systemctl reload apache2</screen>

	<para>La consultation de la page web donne le résultat suivant.</para>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/white-pages1.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/white-pages1.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran service pages blanches</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/white-pages1.png'>
	Copie d'écran service pages blanches - vue complète</link></para>
	</caption>
</mediaobject>
	</listitem>
	<listitem>
	<para>Les paramètres du nouveau site sont donnés dans le fichier
	<filename>/etc/apache2/sites-available/white-pages.conf</filename>.</para>
	</listitem>
	</orderedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment paramétrer l'accès à l'annuaire
	<acronym>LDAP</acronym> à partir du service web&nbsp;?</phrase></para>

	<para>Identifier les fichiers de configuration fournis avec le paquet
	<systemitem>white-pages</systemitem>.</para>
	</question>
	<answer>
	<para>C'est le fichier
	<filename>/usr/share/white-pages/conf/config.inc.php</filename> qui
	contient les éléments d'accès à l'annuaire <acronym>LDAP</acronym>. Voici
	un extrait de ce fichier avec les lignes utiles complétées avec le contexte
	de ce support de travaux pratiques.</para>

<screen><prompt>#</prompt> grep ^\$ldap /usr/share/white-pages/conf/config.inc.php
$LDAP_url = "ldap://localhost";
$LDAP_starttls = false;
$LDAP_binddn = "cn=admin,dc=lab,dc=stri";
$LDAP_bindpw = "xxxxxx";
$LDAP_base = "dc=lab,dc=stri";
$LDAP_user_base = "ou=people,".$ldap;
$LDAP_user_filter = "(objectclass=inetorgperson)";
$LDAP_size_limit = 100;</screen>

	<para>Une fois le fichier modifié, il faut recharger la configuration du
	service web.</para>

<screen>sudo systemctl reload apache2</screen>

	<para>La consultation de la rubrique <guimenuitem>pages
	blanches</guimenuitem> donne le résultat ci-dessous. L'intérêt de cette
	manipulation est de montrer que l'on peut compléter les attributs d'un
	utilisateur de l'annuaire avec une photo. Cette opération est l'objet des
	questions suivantes.</para>

<mediaobject>
	<imageobject role="html">
	<imagedata fileref='images/white-pages2.png' format='PNG' width='480px'/>
	</imageobject>
	<imageobject role="fo-fop">
	<imagedata fileref='images/white-pages2.png' format='PNG' width='10cm'/>
	</imageobject>
	<textobject>
	<phrase>Copie d'écran trombinoscope</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.ldap.qa/images/white-pages2.png'>
	Copie d'écran trombinoscope - vue complète</link></para>
	</caption>
</mediaobject>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est l'attribut de la classe
	<systemitem>inetorgperson</systemitem> qui correspond à une photo
	d'identité&nbsp;?</phrase></para>

	<para>Rechercher les options de la commande <command>ldapsearch</command>
	qui permettent d'extraire la liste des attributs de la classe
	<systemitem>inetorgperson</systemitem>.</para>
	</question>
	<answer>
	<para>On obtient l'information en deux temps.</para>
	<itemizedlist>
	<listitem>
	<para>On identifie le contexte de la classe recherchée en premier. Voici un
	exemple de requête côté serveur.</para>

<screen>sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// \
	-b "cn=config" | grep -i inetorgperson
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
dn: <emphasis>cn={3}inetorgperson,cn=schema,cn=config</emphasis>
cn: {3}inetorgperson
olcObjectClasses: {0}( 2.16.840.1.113730.3.2.2 NAME 'inetOrgPerson' DESC 'RFC2</screen>
	</listitem>
	<listitem>
	<para>Une fois le contexte connu avec précision, on peut extraire la liste
	des attributs relatifs à la classe
	<systemitem>inetorgperson</systemitem>.</para>

	<para>Dans la liste ci-dessous, on repère l'attribut
	<systemitem>jpegphoto</systemitem> qui correspond à notre besoin.</para>

<screen>sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// \
	-b "cn={3}inetorgperson,cn=schema,cn=config"
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
dn: cn={3}inetorgperson,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: {3}inetorgperson
olcAttributeTypes: {0}( 2.16.840.1.113730.3.1.1 NAME 'carLicense' DESC 'RFC279
 8: vehicle license or registration plate' EQUALITY caseIgnoreMatch SUBSTR cas
 eIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )
olcAttributeTypes: {1}( 2.16.840.1.113730.3.1.2 NAME 'departmentNumber' DESC '
 RFC2798: identifies a department within an organization' EQUALITY caseIgnoreM
 atch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )
olcAttributeTypes: {2}( 2.16.840.1.113730.3.1.241 NAME 'displayName' DESC 'RFC
 2798: preferred name to be used when displaying entries' EQUALITY caseIgnoreM
 atch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SI
 NGLE-VALUE )
olcAttributeTypes: {3}( 2.16.840.1.113730.3.1.3 NAME 'employeeNumber' DESC 'RF
 C2798: numerically identifies an employee within an organization' EQUALITY ca
 seIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.12
 1.1.15 SINGLE-VALUE )
olcAttributeTypes: {4}( 2.16.840.1.113730.3.1.4 NAME 'employeeType' DESC 'RFC2
 798: type of employment for a person' EQUALITY caseIgnoreMatch SUBSTR caseIgn
 oreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )
olcAttributeTypes: {5}( 0.9.2342.19200300.100.1.60 NAME '<emphasis>jpegPhoto</emphasis>' DESC 'RFC2
 798: a JPEG image' SYNTAX 1.3.6.1.4.1.1466.115.121.1.28 )
olcAttributeTypes: {6}( 2.16.840.1.113730.3.1.39 NAME 'preferredLanguage' DESC
  'RFC2798: preferred written or spoken language for a person' EQUALITY caseIg
 noreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.
 15 SINGLE-VALUE )
olcAttributeTypes: {7}( 2.16.840.1.113730.3.1.40 NAME 'userSMIMECertificate' D
 ESC 'RFC2798: PKCS#7 SignedData used to support S/MIME' SYNTAX 1.3.6.1.4.1.14
 66.115.121.1.5 )
olcAttributeTypes: {8}( 2.16.840.1.113730.3.1.216 NAME 'userPKCS12' DESC 'RFC2
 798: personal identity information, a PKCS #12 PFX' SYNTAX 1.3.6.1.4.1.1466.1
 15.121.1.5 )
olcObjectClasses: {0}( 2.16.840.1.113730.3.2.2 NAME 'inetOrgPerson' DESC 'RFC2
 798: Internet Organizational Person' SUP organizationalPerson STRUCTURAL MAY
 ( audio $ businessCategory $ carLicense $ departmentNumber $ displayName $ em
 ployeeNumber $ employeeType $ givenName $ homePhone $ homePostalAddress $ ini
 tials $ jpegPhoto $ labeledURI $ mail $ manager $ mobile $ o $ pager $ photo
 $ roomNumber $ secretary $ uid $ userCertificate $ x500uniqueIdentifier $ pre
 ferredLanguage $ userSMIMECertificate $ userPKCS12 ) )</screen>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe du fichier <acronym>LDIF</acronym> qui
	permet de modifier l'attribut <systemitem>jpegphoto</systemitem> d'un
	utilisateur de l'annuaire&nbsp;?</phrase></para>

	<para>Rechercher un exemple de modification d'attribut avec la commande
	<command>ldapmodify</command>.</para>

	<para>Rechercher aussi un fichier <acronym>JPEG</acronym> qui fasse office
	de photo d'identité.</para>
	</question>
	<answer>
	<para>Tout d'abord, on dépose le fichier <acronym>jpeg</acronym> à utiliser
	dans le dossier <filename class='directory'>/var/tmp</filename> à titre
	d'exemple.</para>

<screen>ls -l /var/tmp/leia.jpg
	-rw-r--r-- 1 etu etu 83837 19 août  03:15 /var/tmp/leia.jpg</screen>

	<para>La syntaxe du fichier <acronym>LDIF</acronym> est relativement simple
	une fois que l'on a bien identifié le contexte.</para>

<screen>cat > leia-photo.ldif &lt;&lt; EOF
dn: uid=leia,ou=people,dc=lab,dc=stri
changetype: modify
add: jpegphoto
jpegphoto:&lt;file:///var/tmp/leia.jpg
EOF</screen>

	<para>Enfin, on applique la modification dans l'annuaire
	<acronym>LDAP</acronym>.</para>

<screen>sudo ldapmodify -x -H ldap:/// -D "cn=admin,dc=lab,dc=stri" -W -f leia-photo.ldif</screen>

	<para>Le résultat est visible sur la copie d'écran de navigateur web
	ci-dessus.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect1>

<sect1 xml:id='sysadm-net.ldap.tls'>
	<title>Sécurisation des échanges avec TLS</title>

	<para>Partant d'un service <acronym>LDAP</acronym> fonctionnel, nous allons
	maintenant sécuriser les échanges entre le serveur et ses clients en
	utilisant la sécurité de couche transport ou <wordasword>Transport Layer
	Security</wordasword> (<acronym>TLS</acronym>).</para>

	<para>Dans ce but, nous devons installer et configurer une autorité de
	certification locale dans ce contexte de travaux pratiques.</para>

	<para>En "situation réelle", on ferait appel à une autorité de certification
	tierce publique comme &url.letsencrypt;.</para>

<sect2 xml:id='sysadm-net.ldap.tls.easyrsa'>
	<title>Génération des certificats avec easyrsa</title>

	<para>Cette étape débute par l'installation du paquet
	<systemitem>easy-rsa</systemitem>, l'initialisation d'une nouvelle autorité
	(<acronym>CA</acronym>) et la génération d'un paire de clés.</para>

	<para>Une fois le paquet <systemitem>easy-rsa</systemitem> installé, toutes
	les opérations de mise en place de l'autorité de certification se font à
	partir d'une session administrateur. C'est la raison de la présence de la
	commande <command>sudo -i</command> ci-dessous.</para>

	<orderedlist>
		<listitem>
		<para>Installation du paquet.</para>

<screen>sudo apt install easy-rsa</screen>
		</listitem>
		<listitem>
		<para>Création de l'arborescence de l'autorité de certification.</para>

<screen>sudo -i
make-cadir ldap-pki
cd ldap-pki</screen>

<screen><prompt>root@ldap-server:~/ldap-pki#</prompt> ls -lAh
total 20K
lrwxrwxrwx 1 root root   27  6 sept. 18:54 easyrsa -> /usr/share/easy-rsa/easyrsa
-rw-r--r-- 1 root root 5,1K  6 sept. 18:54 openssl-easyrsa.cnf
-rw-r--r-- 1 root root 8,9K  6 sept. 18:54 vars
lrwxrwxrwx 1 root root   30  6 sept. 18:54 x509-types -> /usr/share/easy-rsa/x509-types</screen>
		</listitem>
		<listitem>
		<para>Initialisation du gestionnaire de clés.</para>

<screen>./easyrsa init-pki</screen>
		</listitem>
		<listitem>
		<para>Construction de l'autorité de certification.</para>

<screen>./easyrsa build-ca nopass</screen>
		</listitem>
		<listitem>
		<para>Génération des certificats</para>

<screen>./easyrsa build-server-full ldap.lab.stri nopass</screen>
		</listitem>
	</orderedlist>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.ldap.refdocs'>
	<title>documents de référence</title>

<variablelist>
	<varlistentry xml:id='sysadm-net.ldap.refdocs.openldap'>
		<term><citetitle>OpenLDAP software 2.5 administrator's
				guide</citetitle></term>
	<listitem>
	<para>La documentation officielle : &url.openldap.admin-guide; constitue le
	point d'entrée essentiel pour la mise en œuvre du service
	<acronym>LDAP</acronym>.</para>
	</listitem>
	</varlistentry>
</variablelist>
</sect1>
</article>
