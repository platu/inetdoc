<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook V5.0/EN"
    "/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [

<!ENTITY % xi "http://www.w3.org/2001/XInclude">

<!ENTITY % w3centities-f PUBLIC "-//W3C//ENTITIES Combined Set//EN//XML"
    "http://www.w3.org/2003/entities/2007/w3centities-f.ent">
%w3centities-f;

<!ENTITY author     SYSTEM "author.xml">
<!ENTITY legal      SYSTEM "legal.xml">

<!-- urls -->
<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.ent'>
%inetdoc_urls;

<!ENTITY url.frr-documentation
    '<link xmlns="http://docbook.org/ns/docbook"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     xlink:href="https://docs.frrouting.org"><citetitle>FRRouting User
     Guide</citetitle></link>'>
]>

<article xmlns="http://docbook.org/ns/docbook" version="5.0"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xml:id="synthese" xml:lang="fr">

<info>
	<title>Synthèse sur l'interconnexion LAN/WAN</title>

	&author;
	<abstract>
	<para>
	<informaltable frame='none' pgwide='1'>
	<tgroup cols='2' align='left' colsep='0' rowsep='0'>
	<colspec colwidth='1*'/>
	<colspec colwidth='1*'/>
	<tbody>
    <row>
	<entry>
	<inlinemediaobject>
	<imageobject role='html'>
		<imagedata fileref='images/synthese.png' format='PNG' width='480px' scalefit='1'/>
	</imageobject>
	<imageobject role='fo'>
		<imagedata fileref='images/synthese.png' format='PNG' width='7cm' scalefit='1'/>
	</imageobject>
	</inlinemediaobject>
	</entry>
    <entry valign='top'>
        <para>L'objectif de ce dernier document de la série de travaux
        pratiques est de faire la synthèse sur l'interconnexion de réseaux
        locaux (<acronym>LAN</acronym>) et de réseaux étendus
        (<acronym>WAN</acronym>). Côté réseaux étendus, on retrouve les
        sessions <acronym>PPPoE</acronym> vers chaque site distant avec son
        réseau d'extrémité avec un l'hébergement de services représentés par
        les conteneurs <acronym>Incus</acronym>. Côté réseaux locaux, les
        routeurs <wordasword>Hub</wordasword> échangent leurs routes avec le
        protocole de routage dynamique <acronym>OSPF</acronym>. Ces routeurs
        constituent ainsi un réseau de “collecte”. Que l'on soit dans le
        domaine <acronym>LAN</acronym> ou <acronym>WAN</acronym>, on fait un
        usage massif des <acronym>VLAN</acronym>s.</para>
	</entry>
	</row>
	</tbody>
	</tgroup>
	</informaltable>
	</para>
	</abstract>

	<keywordset>
		<keyword>ospf</keyword>
		<keyword>pppoe</keyword>
		<keyword>routing</keyword>
		<keyword>trunk</keyword>
		<keyword>vlan</keyword>
		<keyword>incus</keyword>
	</keywordset>
</info>

<sect1 xml:id='synthese.legal.meta'>
	&legal;

<bridgehead xml:id='infra.tp.meta' renderas='sect2'>Méta-information</bridgehead>

	<para>Ce document est écrit avec <link
	xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link> XML
	sur un système <link xlink:href="http://www.debian.org"><citetitle>Debian
	GNU/Linux</citetitle></link>. Il est disponible en version imprimable au
	format PDF : <link
	xlink:href="https://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>
</sect1>

<?custom-pagebreak?>
<sect1 xml:id='synthese.objectives'>
	<title>Objectifs</title>

    <para>Après avoir réalisé les manipulations présentées dans ce document,
    les étudiants seront capables de&nbsp;:</para>

    <orderedlist>
    <listitem>
    <para>Configurer une topologie réseau Hub &amp; Spoke complexe combinant
    des interconnexions <acronym>LAN</acronym> et
    <acronym>WAN</acronym>.</para>
    </listitem>
    <listitem>
    <para>Mettre en place et configurer des sessions <acronym>PPPoE</acronym>
    entre des routeurs Hub et Spoke.</para>
    </listitem>
    <listitem>
    <para>Implémenter le routage dynamique <acronym>OSPF</acronym> (v2 et v3)
    entre les routeurs Hub.</para>
    </listitem>
    <listitem>
    <para>Configurer la redistribution de routes entre différents
    protocoles&nbsp;: interfaces connectées, noyau et
    <acronym>OSPF</acronym>.</para>
    </listitem>
    <listitem>
    <para>Déployer et configurer des conteneurs pour simuler des réseaux
    d'hébergement distants.</para>
    </listitem>
    </orderedlist>
</sect1>

<sect1 xml:id='synthese.topology'>
	<title>Topologie réseau &amp; plan d'adressage</title>

    <para>La topologie logique globale se présente comme une association de
    deux topologies triangulaires <citetitle>Hub &amp; Spoke</citetitle> dans
    laquelle les routeurs <citetitle>Hub</citetitle> échangent leurs routes via
    le protocole de routage dynamique <acronym>OSPF</acronym> et fournissent
    l'accès Internet aux sites distants <acronym>WAN</acronym>.Elle couvre les
    aspects suivants&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Topologie <citetitle>Hub &amp; Spoke</citetitle> avec
    <acronym>PPPoE</acronym> pour l'interconnexion
    <acronym>WAN</acronym></para>
    </listitem>
    <listitem>
    <para>Filtrage réseau avec
    <application>netfilter/nftables</application></para>
    </listitem>
    <listitem>
    <para>Routage dynamique avec <acronym>OSPF</acronym></para>
    </listitem>
    </itemizedlist>

    <para>L'objectif est de mettre en place une architecture réseau complète et
    sécurisée, combinant des techniques d'interconnexion
    <acronym>WAN</acronym>, de filtrage et de routage dynamique.</para>

	<mediaobject>
		<imageobject role='fo'>
		<imagedata format='PNG' fileref='images/synthese.png' width='17cm' scalefit='1' />
		</imageobject>
		<imageobject role='html'>
		<imagedata format='PNG' fileref='images/synthese.png' width='720px' scalefit='1' />
		</imageobject>
		<textobject>
		<phrase>Topologie logique de synthèse</phrase>
		</textobject>
	</mediaobject>

	<variablelist>
	<varlistentry>
	<term>Routeur Hub</term>
	<listitem>
	<para>Le routeur <citetitle>Hub</citetitle> assure l'interconnexion entre
	les sites distants et le réseau de collecte. Il gère les sessions
	<acronym>PPPoE</acronym> avec les routeurs <citetitle>Spoke</citetitle>
	et annonce les routes vers les réseaux distants via le protocole
	<acronym>OSPF</acronym> aux autres routeurs du réseau de collecte.</para>
    <note>
	<para>Les routeurs
	<citetitle>Hub</citetitle> partagent la même passerelle vers
	l'Internet.</para>
    </note>
	</listitem>
	</varlistentry>
	<varlistentry>
	<term>Routeur Spoke</term>
	<listitem>
	<para>Le routeur <citetitle>Spoke</citetitle> assure l'interconnexion
	entre son réseau d'extrémité représenté par les conteneurs et le routeur
	<citetitle>Hub</citetitle> auprès duquel il s'authentifie pour ouvrir une
	session <acronym>PPPoE</acronym> qui lui permet de joindre tous les autres
	réseaux dont l'Internet.</para>
	</listitem>
	</varlistentry>
	</variablelist>

	<para>Voici un exemple de plan d'adressage associé à la topologie
	ci-dessus. Il est utilisé pour la maquette de démonstration du
	fonctionnement de l'interconnexion réseau.</para>

    <?custom-pagebreak?>
<table xml:id='synthese.mockup.addressing' frame='all' pgwide='1'>
    <title>Plan d'adressage de la maquette « Synthèse sur l'interconnexion
    LAN/WAN »</title>
	<tgroup cols='5' align='left' colsep='1' rowsep='1'>
	<colspec colnum='1' colwidth='1*'/>
	<colspec colnum='2' colwidth='1*'/>
	<colspec colnum='3' colwidth='1.5*'/>
	<colspec colnum='4' colwidth='1*'/>
	<colspec colnum='5' colwidth='2*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333" ?>
		<?dbfo color="#fff" ?>
		<entry>Rôle</entry>
		<entry>VLAN</entry>
		<entry>Type</entry>
		<entry>Liaison</entry>
		<entry>Adresse/Authentification</entry>
	</row>
	</thead>
	<tbody>
		<row>
			<entry morerows='5' valign='middle'>Hub1</entry>
			<entry>120</entry>
			<entry>hosting</entry>
			<entry>-&gt; Internet</entry>
			<entry>
				<systemitem class='ipaddress'>172.20.120.2/23</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>2001:678:3fc:78::2/64</systemitem>
			</entry>
		</row>
		<row>
			<entry>470</entry>
			<entry>collecte</entry>
			<entry>
				<systemitem class='ipaddress'>OSPFv2 id 1.0.0.4</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>OSPFv3 id 1.0.0.6</systemitem>
			</entry>
			<entry><systemitem class='ipaddress'>172.20.70.1/29</systemitem></entry>
		</row>
		<row>
			<entry>471</entry>
			<entry>mgmt lien local</entry>
			<entry>-&gt; Spoke1</entry>
			<entry><systemitem class='ipaddress'>fe80:1d7::1/64</systemitem></entry>
		</row>
		<row>
			<entry>472</entry>
			<entry>data point à point</entry>
			<entry>-&gt; Spoke1</entry>
			<entry><systemitem class='ipaddress'>10.47.2.1:10.47.2.2</systemitem></entry>
		</row>
		<row>
			<entry>473</entry>
			<entry>mgmt lien local</entry>
			<entry>-&gt; Spoke2</entry>
			<entry><systemitem class='ipaddress'>fe80:1d9::1/64</systemitem></entry>
		</row>
		<row>
			<entry>474</entry>
			<entry>data point à point</entry>
			<entry>-&gt; Spoke2</entry>
			<entry><systemitem class='ipaddress'>10.47.4.1:10.47.4.2</systemitem></entry>
		</row>
		<row>
			<entry morerows='2' valign='middle'>Spoke1</entry>
			<entry>471</entry>
			<entry>mgmt lien local</entry>
			<entry>-&gt; Hub1</entry>
			<entry><systemitem class='ipaddress'>fe80:1d7::2/64</systemitem></entry>
		</row>
		<row>
			<entry>472</entry>
			<entry>authentification</entry>
			<entry>-&gt; Hub1</entry>
			<entry align='center'><systemitem>spoke1 / 0r4ng3.1</systemitem></entry>
		</row>
		<row>
			<entry>1</entry>
			<entry>conteneurs</entry>
			<entry>-</entry>
			<entry>
				<systemitem class='ipaddress'>10.0.1.1/24</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>fda0:7a62:1::1/64</systemitem>
			</entry>
		</row>
		<row>
			<entry morerows='2' valign='middle'>Spoke2</entry>
			<entry>473</entry>
			<entry>mgmt lien local</entry>
			<entry>-&gt; Hub1</entry>
			<entry><systemitem class='ipaddress'>fe80:1d9::2/64</systemitem></entry>
		</row>
		<row>
			<entry>474</entry>
			<entry>authentification</entry>
			<entry>-&gt; Hub1</entry>
			<entry align='center'><systemitem>spoke2 / 0r4ng3.2</systemitem></entry>
		</row>
		<row>
			<entry>2</entry>
			<entry>conteneurs</entry>
			<entry>-</entry>
			<entry>
				<systemitem class='ipaddress'>10.0.2.1/24</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>fda0:7a62:2::1/64</systemitem>
			</entry>
		</row>
		<row>
			<entry morerows='5' valign='middle'>Hub2</entry>
			<entry>120</entry>
			<entry>hosting</entry>
			<entry>-&gt; Internet</entry>
			<entry>
				<systemitem class='ipaddress'>172.20.120.3/23</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>2001:678:3fc:78::3/64</systemitem>
			</entry>
		</row>
		<row>
			<entry>470</entry>
			<entry>collecte</entry>
			<entry>
				<systemitem class='ipaddress'>OSPFv2 id 2.0.0.4</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>OSPFv3 id 2.0.0.6</systemitem>
			</entry>
			<entry><systemitem class='ipaddress'>172.20.70.2/29</systemitem></entry>
		</row>
		<row>
			<entry>475</entry>
			<entry>mgmt lien local</entry>
			<entry>-&gt; Spoke3</entry>
			<entry><systemitem class='ipaddress'>fe80:1db::1/64</systemitem></entry>
		</row>
		<row>
			<entry>476</entry>
			<entry>data point à point</entry>
			<entry>-&gt; Spoke3</entry>
			<entry><systemitem class='ipaddress'>10.47.6.1:10.47.6.2</systemitem></entry>
		</row>
		<row>
			<entry>477</entry>
			<entry>mgmt lien local</entry>
			<entry>-&gt; Spoke4</entry>
			<entry><systemitem class='ipaddress'>fe80:1dd::1/64</systemitem></entry>
		</row>
		<row>
			<entry>478</entry>
			<entry>data point à point</entry>
			<entry>-&gt; Spoke4</entry>
			<entry><systemitem class='ipaddress'>10.47.8.1:10.47.8.2</systemitem></entry>
		</row>
		<row>
			<entry morerows='2' valign='middle'>Spoke3</entry>
			<entry>475</entry>
			<entry>mgmt lien local</entry>
			<entry>-&gt; Hub2</entry>
			<entry><systemitem class='ipaddress'>fe80:1db::2/64</systemitem></entry>
		</row>
		<row>
			<entry>476</entry>
			<entry>authentification</entry>
			<entry>-&gt; Hub2</entry>
			<entry align='center'><systemitem>spoke3 / 0r4ng3.3</systemitem></entry>
		</row>
		<row>
			<entry>3</entry>
			<entry>conteneurs</entry>
			<entry>-</entry>
			<entry>
				<systemitem class='ipaddress'>10.0.3.1/24</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>fda0:7a62:3::1/64</systemitem>
			</entry>
		</row>
		<row>
			<entry morerows='2' valign='middle'>Spoke4</entry>
			<entry>477</entry>
			<entry>mgmt lien local</entry>
			<entry>-&gt; Hub2</entry>
			<entry><systemitem class='ipaddress'>fe80:1dd::2/64</systemitem></entry>
		</row>
		<row>
			<entry>478</entry>
			<entry>authentification</entry>
			<entry>-&gt; Hub2</entry>
			<entry align='center'><systemitem>spoke4 / 0r4ng3.4</systemitem></entry>
		</row>
		<row>
			<entry>4</entry>
			<entry>conteneurs</entry>
			<entry>-</entry>
			<entry>
				<systemitem class='ipaddress'>10.0.4.1/24</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>fda0:7a62:4::1/64</systemitem>
			</entry>
		</row>
	</tbody>
	</tgroup>
</table>
</sect1>

<?custom-pagebreak?>
<sect1 xml:id='synthese.hubs'>
	<title>Configurer les Routeurs Hub</title>

    <para>Dans cette section, on s'intéresse aux rôles et fonctionnalités
    suivantes&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Gérer les sessions <acronym>PPPoE</acronym> avec les
    <citetitle>Spoke</citetitle></para>
    </listitem>
    <listitem>
    <para>Filtrer et traduire les adresses sources (<acronym>NAT</acronym>)
    pour le trafic sortant vers l'Internet</para>
    </listitem>
    <listitem>
    <para>Annoncer les routes vers les réseaux distants via
    <acronym>OSPF</acronym></para>
    </listitem>
    </itemizedlist>

<sect2 xml:id='synthese.hubs.pppoe'>
	<title>Configurer les serveurs PPPoE</title>

    <para>Les tâches à réaliser sont&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Activer le routage</para>
    </listitem>
    <listitem>
    <para>Activer la traduction des adresses sources vers l'Internet</para>
    </listitem>
    <listitem>
    <para>Installer le paquet pppoe</para>
    </listitem>
    <listitem>
    <para>Paramétrer le fichier
    <filename>/etc/ppp/pppoe-server-options</filename>.</para>
    </listitem>
    <listitem>
    <para>Créer les unités <application>systemd</application> pour le lancement
    des serveurs <acronym>PPPoE</acronym></para>
    </listitem>
    </itemizedlist>

    <para>Voici un extrait des questions du support de travaux pratiques
    &url.interco.hub-and-spoke;.</para>

    <xi:include href="../interco_03.hub-and-spoke/hub-and-spoke.xml"
    xpointer="element(hub-and-spoke.qandaset.hub)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>
</sect2>

<sect2 xml:id='synthese.hubs.frr'>
    <title>Installer et configurer FRR</title>

    <para>Les tâches à réaliser sont&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Installer et préparer les services
    <application>FRRouting</application></para>
    </listitem>
    <listitem>
    <para>Activer les démons des protocoles <acronym>OSPFv2</acronym> pour
    <acronym>IPv4</acronym> et <acronym>OSPFv3</acronym> pour
    <acronym>IPv6</acronym></para>
    </listitem>
    </itemizedlist>

    <para>Voici un extrait des questions du support de travaux pratiques
    &url.interco.ospf;.</para>

    <qandaset defaultlabel='number'>
    <xi:include href="../interco_05.ospf/ospf.xml"
    xpointer="element(ospf.install-frr.qandaset.div1)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>
    </qandaset>

    <para>Une fois la partie configuration initiale traitée, passons à la
    maquette de la synthèse.</para>

    <qandaset>
    <qandaentry>
    <question>
    <para><phrase>Quel est l'état courant du routage à ce stade de la
    configuration&nbsp;?</phrase></para>

    <para>Afficher les tables de routage des routeurs
    <citetitle>Hub</citetitle> avec les liens <acronym>PPP</acronym>
    actifs. Les échanges via le protocole <acronym>OSPF</acronym> ne sont pas
    encore configurés.</para>
    </question>
    <answer>
    <para>Dans le contexte de la maquette, l'affichage des deux tables de
    routage du routeur <citetitle>Hub numéro 1</citetitle> montre des entrées
    codées avec les clés suivantes.</para>

<screen>sh ip route</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* 0.0.0.0/0 [0/0] via 172.20.120.1, enp0s1.120, 00:00:36<co xml:id='hub-no-ospf.ipv4-default'/>
L>* 10.47.2.1/32 is directly connected, ppp0, 00:00:36<co xml:id='hub-no-ospf.ipv4-ppp0'/>
C>* 10.47.2.2/32 is directly connected, ppp0, 00:00:36
L>* 10.47.4.1/32 is directly connected, ppp1, 00:00:36<co xml:id='hub-no-ospf.ipv4-ppp1'/>
C>* 10.47.4.2/32 is directly connected, ppp1, 00:00:36
C>* 172.20.70.0/29 is directly connected, enp0s1.470, 00:00:36<co xml:id='hub-no-ospf.ipv4-collect'/>
L>* 172.20.70.1/32 is directly connected, enp0s1.470, 00:00:36
C>* 172.20.120.0/23 is directly connected, enp0s1.120, 00:00:36<co xml:id='hub-no-ospf.ipv4-infra'/>
L>* 172.20.120.2/32 is directly connected, enp0s1.120, 00:00:36</screen>

<screen>sh ipv6 route</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* ::/0 [0/1024] via fe80:78::1, enp0s1.120 onlink, 00:31:49<co xml:id='hub-no-ospf.ipv6-default'/>
K>* 2001:678:3fc:78::/64 [0/512] is directly connected, enp0s1.120, 00:31:49
L>* 2001:678:3fc:78:baad:caff:fefe:5/128 is directly connected, enp0s1.120, 00:31:49
C * fe80::/64 is directly connected, enp0s1.120, 00:31:49
C * fe80::/64 is directly connected, enp0s1.474, 00:31:49
C * fe80::/64 is directly connected, enp0s1.471, 00:31:49
C * fe80::/64 is directly connected, enp0s1.472, 00:31:49
C * fe80::/64 is directly connected, enp0s1.473, 00:31:49
C * fe80::/64 is directly connected, enp0s1.470, 00:31:49
C>* fe80::/64 is directly connected, enp0s1, 00:31:49
C>* fe80::7188:100d:7562:f6d/128 is directly connected, ppp0, 00:31:49<co xml:id='hub-no-ospf.ipv6-ppp0'/>
C>* fe80::c00f:a3d0:f2c5:b154/128 is directly connected, ppp1, 00:31:49<co xml:id='hub-no-ospf.ipv6-ppp1'/>
C>* fe80:1d6::/64 is directly connected, enp0s1.470, 00:31:49<co xml:id='hub-no-ospf.ipv6-collect'/>
C>* fe80:1d7::/64 is directly connected, enp0s1.471, 00:31:49
C>* fe80:1d9::/64 is directly connected, enp0s1.473, 00:31:49</screen>

	<calloutlist>
	<callout arearefs='hub-no-ospf.ipv4-default hub-no-ospf.ipv6-default'>
    <para>La route par défaut est marquée <option>K>*</option>
    (<wordasword>kernel</wordasword>) parce qu'elle est importée de la
    configuration système. Elle n'est pas gérée par un service
    <application>FRR</application>.</para>
    </callout>
    <callout arearefs='hub-no-ospf.ipv4-ppp0 hub-no-ospf.ipv4-ppp1 hub-no-ospf.ipv4-infra'>
    <para>Avec <acronym>IPv4</acronym>, toutes les entrées des interfaces
    actives sont marquées <option>C>*</option>
    (<wordasword>connected</wordasword>). Le service
    <application>FRR</application> a importé les entrées du système et peut
    alimenter les démons de protocole de routage dynamique avec ces
    informations.</para>
    </callout>
    <callout arearefs='hub-no-ospf.ipv4-collect hub-no-ospf.ipv6-collect'>
    <para>Le nouveau réseau de collecte qui va servir aux échanges
    <acronym>OSPF</acronym> doit être présent dès maintenant avant d'activer le
    protocole de routage dynamique sur les interfaces.</para>
    </callout>
    <callout arearefs='hub-no-ospf.ipv6-ppp0 hub-no-ospf.ipv6-ppp1 hub-no-ospf.ipv6-collect'>
    <para>Avec <acronym>IPv6</acronym>, les réseaux d'interconnexion ou de
    transit n'utilisent que des adresses de lien local.</para>
    </callout>
    </calloutlist>
    </answer>
    </qandaentry>
    </qandaset>
</sect2>

<sect2 xml:id='synthese.hubs.ospf'>
	<title>Configurer les démons OSPFv2 et OSPFv3</title>

    <para>Les tâches à réaliser sont&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Configurer les identifiants de routeur</para>
    </listitem>
    <listitem>
    <para>Activer <acronym>OSPF</acronym> sur les interfaces du réseau de
    collecte</para>
    </listitem>
    </itemizedlist>

    <para>Voici un jeu de questions extraites du support de travaux pratiques
    &url.interco.ospf;</para>

    <qandaset defaultlabel='number'>
    <xi:include href="../interco_05.ospf/ospf.xml"
    xpointer="element(ospf.protocol-config.qandaset.div2)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>
    </qandaset>

    <para>Pour achever cette partie de la synthèse, il reste à étudier la
    redistribution des routes connectées dans les démons de routage
    <acronym>OSPFv2</acronym> et <acronym>OSPFv3</acronym>.</para>

    <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
    <para><phrase>Quel est l'état des voisins <acronym>OSPF</acronym> à ce
    stade de la configuration&nbsp;?</phrase></para>

    <para>Afficher la liste des voisins <acronym>OSPFv2</acronym>
    <acronym>OSPFv3</acronym> sur l'un des deux routeurs
    <citetitle>Hub</citetitle>.</para>
    </question>
    <answer>
    <para>En se plaçant sur le second routeur <citetitle>Hub</citetitle> de la
    maquette, on obtient les informations suivantes.</para>

<screen>sh ip ospf neighbor</screen>
<screen>Neighbor ID     Pri State     Up Time    Dead Time  Address      Interface              RXmtL RqstL DBsmL
1.0.0.4           1 Full/DR   23.841s      36.142s  172.20.70.1  enp0s1.470:172.20.70.2     0     0     0</screen>

<screen>sh ipv6 ospf6 neighbor</screen>
<screen>Neighbor ID     Pri    DeadTime    State/IfState         Duration I/F[State]
1.0.0.6           1    00:00:30     Full/DR              00:00:29 enp0s1.470[BDR]</screen>

    <note>
    <para>En l'état actuel des échanges <acronym>OSPF</acronym>, l'affichage
    des tables de routage ne montre aucune route apprise via routage dynamique.
    Il est donc nécessaire d'importer les routes des liaisons
    <acronym>PPPoE</acronym> dans la configuration des démons
    <acronym>OSPF</acronym>.</para>
    </note>
    </answer>
    </qandaentry>
    </qandaset>
</sect2>

<sect2 xml:id='synthese.hubs.redistribute'>
	<title>Redistribuer les routes connectées dans OSPF</title>

    <para>Les tâches à réaliser sont&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Configurer la redistribution des routes connectées dans OSPF</para>
    </listitem>
    <listitem>
    <para>Valider la présence des routes <acronym>IPv4</acronym> de transit
    vers les routeurs <citetitle>Spoke</citetitle></para>
    </listitem>
    </itemizedlist>

    <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
    <para><phrase>Quelle est l'instruction qui permet de redistribuer les
    routes connectées dans les démons
    <acronym>OSPF</acronym>&nbsp;?</phrase></para>

    <para>Rechercher les options de l'instruction
    <command>redistribute</command> dans la documentation
    <application>FRR</application> à l'adresse &url.frr-documentation;.</para>
    </question>
    <answer>
    <para>L'instruction <command>redistribute</command> est générique et
    s'emploie dans la configuration de tous les protocoles de routage. Voici un
    extrait de configuration pour chacun des deux démons
    <acronym>OSPF</acronym>.</para>

<screen>sh run ospfd</screen>
<screen>Building configuration...

Current configuration:
!
frr version 10.1.1
frr defaults traditional
hostname hub1
log syslog informational
service integrated-vtysh-config
!
interface enp0s1.470
 ip ospf area 0
exit
!
router ospf
 ospf router-id 1.0.0.4
 log-adjacency-changes detail
 <emphasis>redistribute connected</emphasis>
exit
!
end</screen>

<screen>sh run ospf6d</screen>
<screen>Building configuration...

Current configuration:
!
frr version 10.1.1
frr defaults traditional
hostname hub1
log syslog informational
service integrated-vtysh-config
!
interface enp0s1.470
 ipv6 ospf6 area 0
exit
!
router ospf6
 ospf6 router-id 1.0.0.6
 log-adjacency-changes detail
 <emphasis>redistribute connected</emphasis>
exit
!
end</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Pourquoi choisir la redistribution des routes
    connectées&nbsp;?</phrase></para>

    <para>Il existe de nombreuses solutions pour intégrer des réseaux dans
    <acronym>OSPF</acronym>. Voici deux exemples&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Activer <acronym>OSPF</acronym> sur les interfaces
    <acronym>PPP</acronym></para>
    </listitem>
    <listitem>
    <para>Ajouter les adresses des réseaux de transit vers les routeurs
    <citetitle>Spoke</citetitle>.</para>
    </listitem>
    </itemizedlist>
    </question>
    <answer>
    <para>Cela s'explique par les principes de la topologie <citetitle>Hub
    &amp; Spoke</citetitle>. Un lien <acronym>WAN</acronym> sur lequel on
    établit une session <acronym>PPPoE</acronym> n'a pas de caractère
    permanent. Il faut donc trouver une solution qui permette au protocole de
    routage dynamique <acronym>OSPF</acronym> de fonctionner de façon optimale
    avec un nombre de routeurs <citetitle>Spoke</citetitle> variable.</para>

    <para>Avec la maquette des travaux pratiques, chaque routeur
    <citetitle>Hub</citetitle> est relié à deux routeurs
    <citetitle>Spoke</citetitle>. Dans un contexte plus réaliste, le nombre de
    routeurs <citetitle>Spoke</citetitle> peut varier en fonction de
    l'ouverture ou de la fermeture de sites distants, et le fonctionnement du
    réseau de collecte ne doit pas être impacté par ces variations.</para>

    <para>C'est la raison pour laquelle les variations du nombre de routes
    connectées sont gérées au niveau système avec les services
    <acronym>PPP</acronym>. Les changements sont automatiquement répercutés
    dans la base d'information <application>FRR</application> puis publiés par
    le protocole de routage dynamique <acronym>OSPF</acronym>. La
    redistribution des routes connectées répond parfaitement à ce
    besoin.</para>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment vérifier que la redistribution de route est
    effective&nbsp;?</phrase></para>

    <para>Rechercher les entrées <acronym>OSPF</acronym> dans les tables de
    routage des deux routeurs <citetitle>Hub</citetitle>.</para>
    </question>
    <answer>
    <para>Voici ce que l'on observe sur le premier routeur de la
    maquette.</para>

<screen>sh ip route ospf</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

<emphasis>O>* 10.47.6.2/32 [110/20] via 172.20.70.2, enp0s1.470</emphasis>, weight 1, 00:46:51
<emphasis>O>* 10.47.8.2/32 [110/20] via 172.20.70.2, enp0s1.470</emphasis>, weight 1, 00:46:51
O   172.20.70.0/29 [110/10] is directly connected, enp0s1.470, weight 1, 03:43:32
O   172.20.120.0/23 [110/20] via 172.20.70.2, enp0s1.470, weight 1, 00:46:51</screen>

    <para>Dans le cas du protocole <acronym>IPv6</acronym>, la redistribution
    n'est pas visible puisque les réseaux de transit utilisent uniquement des
    adresses de lien local pour former les adjacences entre routeurs. La
    commande ci-dessous ne produit aucune sortie. Il faut attendre la mise en
    place des réseaux d'hébergement au delà des routeurs
    <citetitle>Spoke</citetitle> pour voir apparaître de nouvelles entrées dans
    la table de routage.</para>

<screen>sh ipv6 route ospf</screen>
    </answer>
    </qandaentry>
    </qandaset>
</sect2>
</sect1>

<sect1 xml:id='synthese.spokes'>
	<title>Configurer les routeurs Spoke</title>

	<para>Les quatre routeurs <wordasword>Spoke</wordasword> de la topologie
	jouent toujours le rôle de routeur d'extrémité.</para>

	<para>Pour les manipulations de configuration de ce rôle, on s'appuie sur
	le support de travaux pratiques&nbsp;:
	&url.interco.pppoe;.</para>

    <para>Dans cette section, on s'intéresse aux rôles et fonctionnalités
    suivantes&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Gérer les sessions <acronym>PPP</acronym> avec les routeurs
    <citetitle>Hub</citetitle></para>
    </listitem>
    <listitem>
    <para>Valider les communications entre routeurs
    <citetitle>Spoke</citetitle></para>
    </listitem>
    </itemizedlist>

<sect2 xml:id='synthese.spokes.ppp'>
    <title>Configurer les clients PPP</title>

    <para>Les tâches à réaliser sont&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Activer le routage</para>
    </listitem>
    <listitem>
    <para>Configurer le protocole <acronym>PPP</acronym></para>
    </listitem>
    </itemizedlist>

    <para>Pour l'activation du routage, on retrouve les mêmes opérations que
    sur les routeurs <citetitle>Hub</citetitle>.</para>

    <xi:include href="../interco_02.pppoe/pppoe.xml"
    xpointer="element(pppoe.spoke.routing.qandaset)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>

    <para>La configuration des “clients” <acronym>PPP</acronym> diffère de
    celle des routeurs <citetitle>Hub</citetitle>.</para>

    <xi:include href="../interco_02.pppoe/pppoe.xml"
    xpointer="element(pppoe.spoke.ppp.qandaset)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>

    <para>Pour visualiser les détails du fonctionnement du
    protocole point à point, voir la section «&nbsp;Traces d'une ouverture de
    session PPPoE&nbsp;» du document «&nbsp;&url.interco.pppoe;&nbsp;».</para>
</sect2>

<sect2 xml:id='synthese.spokes.access'>
    <title>Valider les communications</title>

    <para>Après avoir vérifié que les quatre sessions <acronym>PPP</acronym> de
    la maquette sont actives, on peut lancer une série de tests
    <acronym>ICMP</acronym> suivant deux axes.</para>

    <orderedlist>
    <listitem>
    <para>Accéder à l'Internet depuis chaque routeur
    <citetitle>Spoke</citetitle> avec <acronym>IPv4</acronym>.</para>

    <para>L'accès via <acronym>IPv6</acronym> n'est pas possible sachant
    qu'aucune adresse de type <acronym>ULA</acronym> ou <acronym>GUA</acronym>
    n'est présente sur les routeurs <citetitle>Spoke</citetitle>.</para>

<screen><prompt>etu@spoke4:~$</prompt> ping -qc2 9.9.9.9</screen>
<screen>PING 9.9.9.9 (9.9.9.9) 56(84) bytes of data.

--- 9.9.9.9 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 28.778/29.342/29.907/0.564 ms</screen>
    </listitem>
    <listitem>
    <para>Accéder aux autres routeurs <citetitle>Spoke</citetitle>.</para>

    <para>Le script ci-dessous peut être exécuté sur n'importe quel routeur
    <citetitle>Spoke</citetitle> et permet de vérifier qu'aucun paquet n'est
    perdu.</para>

<screen>for addr in "10.47.2.2" "10.47.4.2" "10.47.6.2" "10.47.8.2"
do
    ping -qc2 $addr
done</screen>
    </listitem>
    </orderedlist>
</sect2>
</sect1>

<sect1 xml:id='synthese.hosting'>
    <title>Ajouter les réseaux de services distants</title>

    <para>Dans cette section, on s'intéresse aux rôles et fonctionnalités
    suivantes&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Configurer un commutateur virtuel avec une interface commutée</para>
    </listitem>
    <listitem>
    <para>Router les réseaux d'hébergement via <acronym>OSPF</acronym></para>
    </listitem>
    </itemizedlist>

<sect2 xml:id='synthese.hosting.ovs'>
    <title>Ajouter un commutateur virtuel</title>

    <para>Voici la liste des questions traitées dans le document
    &url.interco.pppoe;</para>

    <xi:include href="../interco_02.pppoe/pppoe.xml"
    xpointer="element(pppoe.hosting.ovs.qandaset)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>
</sect2>

<sect2 xml:id='synthese.hosting.routing'>
    <title>Router les réseaux d'hébergement depuis les Hubs</title>

    <para>La configuration mise en place dans cette section conditionne le
    routage des réseaux d'hébergement des services des sites distants à
    l'ouverture de session <acronym>PPP</acronym>.</para>

    <qandaset>
    <xi:include href="../interco_03.hub-and-spoke/hub-and-spoke.xml"
    xpointer="element(hub-and-spoke.interconnect.qandadiv)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>

    <qandadiv>
    <qandaentry>
    <question>
    <para><phrase>Comment l'ajout de route vers les réseaux d'hébergement
    est-il répercuté par <application>FRR</application>&nbsp;?</phrase></para>

    <para>Afficher les tables de routage des routeurs
    <citetitle>Hub</citetitle> après avoir relancé les ouvertures de sessions
    <acronym>PPP</acronym> sur les quatre routeurs
    <citetitle>Spoke</citetitle>.</para>
    </question>
    <answer>
    <para>Après redémarrage des services <acronym>PPP</acronym> sur les
    routeurs <citetitle>Spoke</citetitle>, les routes vers les réseaux
    d'hébergement sont marquées <option>K>*</option>. Ce sont des entrées
    appartenant à la catégorie <wordasword>kernel</wordasword>.</para>

    <para>Voici deux extraits des tables de routage du routeur <citetitle>Hub
    numéro 1</citetitle>.</para>

<screen>sh ip route kernel</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* 0.0.0.0/0 [0/0] via 172.20.120.1, enp0s1.120, 07:19:49
<emphasis>K>* 10.0.1.0/24 [0/0] is directly connected, ppp0</emphasis>, 00:19:42
<emphasis>K>* 10.0.2.0/24 [0/0] is directly connected, ppp1</emphasis>, 00:18:21</screen>

<screen>sh ipv6 route kernel</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* ::/0 [0/1024] via fe80:78::1, enp0s1.120 onlink, 07:21:03
K>* 2001:678:3fc:78::/64 [0/512] is directly connected, enp0s1.120, 07:21:03
<emphasis>K>* fda0:7a62:1::/64 [0/1024] is directly connected, ppp0</emphasis>, 00:20:56
<emphasis>K>* fda0:7a62:2::/64 [0/1024] is directly connected, ppp1</emphasis>, 00:19:35</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment redistribuer ces nouvelles routes dans le protocole
    <acronym>OSPF</acronym>&nbsp;?</phrase></para>

    <para>Reprendre la section sur la redistribution des routes connectées en
    l'adaptant à la catégorie <wordasword>kernel</wordasword>.</para>
    </question>
    <answer>
    <para>On ajoute une nouvelle instruction <command>redistribute</command>
    dans les configurations des démons <acronym>OSPF</acronym> de chacun des
    routeurs <citetitle>Hub</citetitle>.</para>

    <para>Voici deux extraits de configuration pour le routeur <citetitle>Hub
    numéro 2</citetitle>.</para>

<screen>sh run ospfd</screen>
<screen>Building configuration...

Current configuration:
!
frr version 10.1.1
frr defaults traditional
hostname hub2
log syslog informational
service integrated-vtysh-config
!
interface enp0s1.470
 ip ospf area 0
exit
!
router ospf
 ospf router-id 2.0.0.4
 log-adjacency-changes detail
 redistribute kernel
 redistribute connected
exit
!
end</screen>

<screen>sh run ospf6d</screen>
<screen>Building configuration...

Current configuration:
!
frr version 10.1.1
frr defaults traditional
hostname hub2
log syslog informational
service integrated-vtysh-config
!
interface enp0s1.470
 ipv6 ospf6 area 0
exit
!
router ospf6
 ospf6 router-id 2.0.0.6
 log-adjacency-changes
 redistribute kernel
 redistribute connected
exit
!
end</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment vérifier que la redistribution de route est
    effective&nbsp;?</phrase></para>

    <para>En affichant les entrées <acronym>OSPF</acronym> des tables de
    routage d'un routeur <citetitle>Hub</citetitle>, on doit voir apparaître
    les réseaux d'hébergement accessibles via le <citetitle>Hub</citetitle>
    opposé.</para>

    <para>Voici deux exemples sur le routeurs <citetitle>Hub numéro
    2</citetitle>.</para>

<screen>sh ip route ospf</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

<emphasis>O>* 10.0.1.0/24 [110/20] via 172.20.70.1, enp0s1.470</emphasis>, weight 1, 00:27:03
<emphasis>O>* 10.0.2.0/24 [110/20] via 172.20.70.1, enp0s1.470</emphasis>, weight 1, 00:27:03
O>* 10.47.2.2/32 [110/20] via 172.20.70.1, enp0s1.470, weight 1, 00:34:51
O>* 10.47.4.2/32 [110/20] via 172.20.70.1, enp0s1.470, weight 1, 00:33:30
O   172.20.70.0/29 [110/10] is directly connected, enp0s1.470, weight 1, 06:22:48
O   172.20.120.0/23 [110/20] via 172.20.70.1, enp0s1.470, weight 1, 03:28:25</screen>

<screen>sh ipv6 route ospf6</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

O   2001:678:3fc:78::/64 [110/20] via fe80::baad:caff:fefe:5, enp0s1.470, weight 1, 00:29:02
<emphasis>O>* fda0:7a62:1::/64 [110/20] via fe80::baad:caff:fefe:5, enp0s1.470</emphasis>, weight 1, 00:29:02
<emphasis>O>* fda0:7a62:2::/64 [110/20] via fe80::baad:caff:fefe:5, enp0s1.470</emphasis>, weight 1, 00:29:02</screen>
    </question>
    </qandaentry>
    </qandadiv>
    </qandaset>
</sect2>

<sect2 xml:id='synthese.hosting.incus'>
    <title>Installer et configurer Incus</title>

    <para>Dans cette section, on s'intéresse aux rôles et fonctionnalités
    suivantes&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Installer le gestionnaire de conteneurs système
    <application>Incus</application></para>
    </listitem>
    <listitem>
    <para>Appliquer une configuration initiale</para>
    </listitem>
    <listitem>
    <para>Configurer l'adressage automatique pour les conteneurs</para>
    </listitem>
    </itemizedlist>

    <para>Pour la partie installation, on reprend les questions du document
    &url.interco.pppoe;.</para>

    <xi:include href="../interco_02.pppoe/pppoe.xml"
    xpointer="element(pppoe.incus.install.qandaset)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>

    <para>Pour la partie configuration initiale, on reprend l'utilisation d'un
    fichier <acronym>YAML</acronym> proposée dans le document
    &url.interco.ospf;.</para>

    <qandaset defaultlabel='number'>
    <xi:include href="../interco_05.ospf/ospf.xml"
    xpointer="element(ospf.containers-network.qandadiv)"
    xmlns:xi='http://www.w3.org/2001/XInclude'/>
    </qandaset>
</sect2>
</sect1>

<sect1 xml:id='synthese.bilan'>
    <title>Bilan et conclusion</title>

    <para>Arrivé à cette étape, la totalité des outils nécessaires à
    l'interconnexion des réseaux <acronym>LAN</acronym> et
    <acronym>WAN</acronym> est en place et il est temps de dresser le bilan
    avec les ultimes tests de communication entre les services des réseaux
    distants.</para>

<sect2 xml:id='synthese.bilan.icmp'>
    <title>Tester toutes les communications</title>

    <para>Après avoir relevé les adresses attribuées aux conteneurs des quatre
    routeurs <citetitle>Spoke</citetitle>, on peut lancer une boucle de tests
    <acronym>ICMP</acronym> pour qualifier les communications.</para>

    <para>Voici un exemple réalisé dans le contexte de la maquette utilisée
    pour rédiger ce document.</para>

    <para>La commande suivante permet de liste les adresses attribuées au
    conteneurs sur chaque réseau d'extrémité.</para>

<screen>incus ls -c 46 -f csv</screen>

    <para>Les résultats au format <acronym>CSV</acronym> peuvent être accumulés
    dans un fichier d'adresses qui sert pour les tests
    <acronym>ICMP</acronym>. Voici un extrait du fichier des adresses de
    conteneurs&nbsp;:</para>

<screen>10.0.1.43 (eth0),fda0:7a62:1:0:216:3eff:fec9:2051 (eth0)
10.0.1.57 (eth0),fda0:7a62:1:0:216:3eff:fe4e:167c (eth0)
10.0.1.174 (eth0),fda0:7a62:1:0:216:3eff:fe18:3562 (eth0)</screen>

    <para>Pour qualifier l'accord de niveau de service ou <wordasword>Service
    Level Agreement</wordasword> (<acronym>SLA</acronym>), on peut utiliser un
    code comme celui du script ci-dessous qui teste la connectivité à partir de
    toutes les adresses fournies.</para>

<screen><![CDATA[#!/bin/bash

# Test if input file exists
if [[ ! -f "$1" ]]; then
    echo "Error: missing or non-existent input file"
    exit 1
fi

file=$1
echo "------------------------------------------------------------"
echo "CSV input file must be generated from the following command:"
echo "   incus ls -c 46 -f csv"
echo "------------------------------------------------------------"

# Declare IPv4 and IPv6 array addresses
declare -a ipv4_addresses
declare -a ipv6_addresses

# Read CSV file content
mapfile -t lines < "$file"

# Extract IP addresses from each line
for line in "${lines[@]}"; do
     IFS=',' read -r ipv4 ipv6 <<< "$line"
     ipv4_addresses+=("${ipv4%% *}")
     ipv6_addresses+=("${ipv6%% *}")
done

echo "Launch pings..."
fail=false
for address in "${ipv4_addresses[@]}" "${ipv6_addresses[@]}"
do
     # Capture ping output
     ping_output=$(ping -qc2 "$address" | tr '\n' ' ')
     # Get packet loss number
     packets_lost=$(echo "$ping_output" |\
        grep -Eo '[[:digit:]]+\% packet loss' |\
        grep -Eo '[[:digit:]]+')

     if [[ $packets_lost != 0 ]]; then
        echo "Test failed : $packets_lost% lost packets for $address"
        fail=true
     else
        echo -n "."
     fi
done

if [[ fail==false ]]; then
        echo "Success!"
fi

exit 0
]]></screen>

    <para>Voici un exemple du résultat d'exécution du script sur la
    maquette.</para>

<screen>bash icmp-tests.sh addresses.csv
------------------------------------------------------------
CSV input file must be generated from the following command:
   incus ls -c 46 -f csv
------------------------------------------------------------
Launch pings...
........................Success!</screen>
</sect2>

<sect2 xml:id='synthese.bilan.routes'>
    <title>Afficher les tables de routage complètes</title>

    <para>Pour faire le bilan sur le routage dynamique avec les protocoles
    <acronym>OSPFv2</acronym> et <acronym>OSPFv3</acronym>, on affiche les
    tables de routage dans lesquelles tous les réseaux doivent figurer.</para>

    <para>En se plaçant sur le routeur <citetitle>Hub numéro 2</citetitle>, on
    obtient les entrées suivantes&nbsp;:</para>

<screen>sh ip route</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* 0.0.0.0/0 [0/0] via 172.20.120.1, enp0s1.120, 20:50:24
<emphasis>O>* 10.0.1.0/24 [110/20] via 172.20.70.1, enp0s1.470</emphasis>, weight 1, 14:53:17
<emphasis>O>* 10.0.2.0/24 [110/20] via 172.20.70.1, enp0s1.470</emphasis>, weight 1, 14:53:17
K>* 10.0.3.0/24 [0/0] is directly connected, ppp0, 14:48:53
K>* 10.0.4.0/24 [0/0] is directly connected, ppp1, 14:48:25
<emphasis>O>* 10.47.2.2/32 [110/20] via 172.20.70.1, enp0s1.470</emphasis>, weight 1, 15:01:05
<emphasis>O>* 10.47.4.2/32 [110/20] via 172.20.70.1, enp0s1.470</emphasis>, weight 1, 14:59:44
L>* 10.47.6.1/32 is directly connected, ppp0, 14:48:53
C>* 10.47.6.2/32 is directly connected, ppp0, 14:48:53
L>* 10.47.8.1/32 is directly connected, ppp1, 14:48:25
C>* 10.47.8.2/32 is directly connected, ppp1, 14:48:25
O   172.20.70.0/29 [110/10] is directly connected, enp0s1.470, weight 1, 20:49:02
C>* 172.20.70.0/29 is directly connected, enp0s1.470, 20:50:24
L>* 172.20.70.2/32 is directly connected, enp0s1.470, 20:50:24
O   172.20.120.0/23 [110/20] via 172.20.70.1, enp0s1.470, weight 1, 17:54:39
C>* 172.20.120.0/23 is directly connected, enp0s1.120, 20:50:24
L>* 172.20.120.3/32 is directly connected, enp0s1.120, 20:50:24</screen>

    <para>Les entrées marquées <option>O>*</option> de la table de routage
    ci-dessus correspondent aux routes apprises via le protocole
    <acronym>OSPF</acronym> qui ont été retenues par le sous-système réseau du
    noyau du routeur. Vu du routeur <citetitle>Hub numéro 2</citetitle>, on
    identifie quatre routes de ce type&nbsp;: deux pour les réseaux
    d'hébergement et deux pour les réseaux de transit. Ces quatre entrées
    correspondent aux routeurs <citetitle>Spoke</citetitle> raccordés au
    <citetitle>Hub numéro 1</citetitle>.</para>

<screen>sh ipv6 route</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* ::/0 [0/1024] via fe80:78::1, enp0s1.120 onlink, 20:53:20
O   2001:678:3fc:78::/64 [110/20] via fe80::baad:caff:fefe:5, enp0s1.470, weight 1, 14:56:06
K>* 2001:678:3fc:78::/64 [0/512] is directly connected, enp0s1.120, 20:53:20
L>* 2001:678:3fc:78:baad:caff:fefe:8/128 is directly connected, enp0s1.120, 20:53:20
O>* fda0:7a62:1::/64 [110/20] via fe80::baad:caff:fefe:5, enp0s1.470, weight 1, 14:56:06
O>* fda0:7a62:2::/64 [110/20] via fe80::baad:caff:fefe:5, enp0s1.470, weight 1, 14:56:06
K>* fda0:7a62:3::/64 [0/1024] is directly connected, ppp0, 14:51:49
K>* fda0:7a62:4::/64 [0/1024] is directly connected, ppp1, 14:51:21
C * fe80::/64 is directly connected, enp0s1.477, 20:53:20
C * fe80::/64 is directly connected, enp0s1.476, 20:53:20
C * fe80::/64 is directly connected, enp0s1.475, 20:53:20
C * fe80::/64 is directly connected, enp0s1.470, 20:53:20
C * fe80::/64 is directly connected, enp0s1.120, 20:53:20
C * fe80::/64 is directly connected, enp0s1.478, 20:53:20
C>* fe80::/64 is directly connected, enp0s1, 20:53:20
<emphasis>C>* fe80::4407:6511:26c1:58d1/128 is directly connected, ppp1</emphasis>, 14:51:21
<emphasis>C>* fe80::551a:aa5f:6325:8f85/128 is directly connected, ppp0</emphasis>, 14:51:49
<emphasis>C>* fe80:1d6::/64 is directly connected, enp0s1.470</emphasis>, 20:53:20
<emphasis>C>* fe80:1db::/64 is directly connected, enp0s1.475</emphasis>, 20:53:20
<emphasis>C>* fe80:1dd::/64 is directly connected, enp0s1.477</emphasis>, 20:53:20</screen>

    <para>Comme on l'a déjà vu, toutes les entrées marquées
    <option>C>*</option> correspondent aux interfaces actives ou connectées. On
    peut afficher le résumé de l'état des interfaces du routeur pour voir la
    correspondance.</para>

<screen> sh int brief</screen>
<screen>Interface       Status  VRF             Addresses
---------       ------  ---             ---------
enp0s1          up      default         fe80::baad:caff:fefe:8/64
enp0s1.120      up      default         172.20.120.3/23
                                        + 2001:678:3fc:78:baad:caff:fefe:8/64
enp0s1.470      up      default         172.20.70.2/29
                                        + fe80:1d6::2/64
enp0s1.475      up      default         + fe80:1db::1/64
enp0s1.476      up      default         fe80::baad:caff:fefe:8/64
enp0s1.477      up      default         + fe80:1dd::1/64
enp0s1.478      up      default         fe80::baad:caff:fefe:8/64
lo              up      default
ppp0            up      default         10.47.6.1/32
                                        fe80::1cd0:13ee:bdd1:22bb/128
ppp1            up      default         10.47.8.1/32
                                        fe80::7993:fc0f:f5c8:d0c4/128</screen>
</sect2>

<?custom-pagebreak?>
<sect2 xml:id='synthese.bilan.conclusion'>
    <title>Pour conclure...</title>

    <para>Maintenant que l'on a validé l'ensemble des échanges entre les
    conteneurs situés aux extrémités de la topologie d'interconnexion de
    réseaux, on peut passer à la conclusion.</para>

    <para>Ce dernier document de la série des travaux pratiques fournit une
    synthèse détaillée de tous les modes d'interconnexion de réseaux locaux
    (<acronym>LAN</acronym>) et étendus (<acronym>WAN</acronym>) en utilisant
    des protocoles comme <acronym>PPPoE</acronym> et <acronym>OSPF</acronym>.
    Il couvre les principes de configuration des routeurs d'une architecture
    <citetitle>Hub &amp; Spoke</citetitle>, l’installation et la configuration
    de la solution <application>FRRouting</application> avec la mise en place
    du routage dynamique <acronym>OSPF</acronym> pour <acronym>IPv4</acronym>
    et <acronym>IPv6</acronym>.</para>

    <para>On peut considérer que nous sommes arrivés à la limite de l'étude des
    interconnexions de réseaux sans automatisation. Pour aller plus loin,
    l'automatisation ainsi que l'intégration et le déploiement continu
    permettraient de déployer et gérer ces configurations à grande échelle,
    réduisant ainsi les erreurs manuelles et améliorant l'efficacité
    opérationnelle des réseaux d’entreprise.</para>
</sect2>
</sect1>
</article>
