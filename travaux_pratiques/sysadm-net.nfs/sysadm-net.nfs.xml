<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook V5.0/EN"
    "/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [

<!ENTITY author		SYSTEM "author.xml">
<!ENTITY legal		SYSTEM "legal.xml">

<!ENTITY url.nfs.howto
    '<link xmlns="http://docbook.org/ns/docbook"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     xlink:href="http://nfs.sourceforge.net/nfs-howto/"><citetitle>Linux
     NFS-HOWTO</citetitle></link>'>

<!ENTITY url.nfsv4.config
    '<link xmlns="http://docbook.org/ns/docbook"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     xlink:href="https://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration_fr"><citetitle>Nfsv4
     configuration</citetitle></link>'>

<!ENTITY url.intelmarketresearch
    '<link xmlns="http://docbook.org/ns/docbook"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     xlink:href="https://www.intelmarketresearch.com/network-file-system-2025-2032-860-4274">INTELMARKET
     RESEARCH</link>'>

<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.ent'>
%inetdoc_urls;

<!-- A copy of http://www.w3.org/2003/entities/2007/w3centities-f.ent is at:
/usr/local/share -->
<!ENTITY % w3centities-f PUBLIC "-//W3C//ENTITIES Combined Set//EN//XML"
	"/usr/local/share/w3centities-f.ent">
%w3centities-f;
]>

<article xmlns="http://docbook.org/ns/docbook" version="5.0"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xml:id="sysadm-net.nfs" xml:lang="fr">

<info>
	<title>Introduction au système de fichiers réseau NFSv4</title>

	&author;
	<abstract>
    <para>L'objectif de ce support de travaux pratiques est d'étudier le
    système de fichiers réseau <acronym>NFS</acronym>. Il illustre les accès en
    «&nbsp;mode fichier&nbsp;» à une unité de stockage réseau. Ce mode d'accès
    correspond à un stockage de type <acronym>NAS</acronym>
    (<wordasword>Network Attached Storage</wordasword>). Le document commence
    par l'étude du principe de fonctionnement des appels de fonctions
    <acronym>RPC</acronym> (<wordasword>Remote Procedure Call</wordasword>),
    puis se poursuit avec la configuration d'un serveur <acronym>NFS</acronym>
    qui exporte une arborescence de comptes utilisateurs. Côté client, les
    accès au système de fichiers réseau <acronym>NFS</acronym> sont étudiés
    selon deux modes distincts&nbsp;: le montage manuel, puis
    l'automontage.</para>
    </abstract>

    <keywordset>
    <keyword>NAS</keyword>
    <keyword>NFSv4</keyword>
    <keyword>autofs</keyword>
    <keyword>mount</keyword>
    <keyword>automount</keyword>
    <keyword>debian</keyword>
    <keyword>linux</keyword>
    <keyword>RPC</keyword>
    </keywordset>
</info>

<sect1 xml:id='sysadm-net.nfs.legal.meta'>
	&legal;
	<bridgehead xml:id='sysadm-net.nfs.meta'
	renderas='sect2'>Méta-information</bridgehead>

	<para>Ce document est écrit avec <link
	xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link>
	XML sur un système <link
	xlink:href="https://www.debian.org"><citetitle>Debian
	GNU/Linux</citetitle></link>. Il est disponible en version imprimable au
	format PDF&nbsp;: <link
	xlink:href="https://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>
</sect1>

<?custom-pagebreak?>
<sect1 xml:id='sysadm-net.nfs.plan'>
	<title>Topologie, scénario et plan d'adressage</title>

	<bridgehead xml:id='sysadm-net.nfs.logical-topology'
	renderas='sect2'>Topologie logique</bridgehead>

	<para>Les manipulations présentées dans ce support utilisent un domaine de
	diffusion unique (<acronym>VLAN</acronym>) dans lequel on trouve au moins
	deux systèmes virtuels ou physiques avec deux rôles distincts.</para>

	<itemizedlist>
	<listitem>
	<para>Le système <emphasis>serveur exporte</emphasis> une arborescence de
	son système de fichiers local vers les clients.</para>
	</listitem>
	<listitem>
    <para>Le ou les systèmes <emphasis>clients montent</emphasis> le système de
    fichiers réseau sur une arborescence locale.</para>
	</listitem>
	</itemizedlist>

<mediaobject>
	<imageobject role='fo'>
	<imagedata fileref='images/nfs-logical-topology.png' format='PNG' contentwidth='15cm' width='15.5cm'/>
	</imageobject>
	<imageobject role='html'>
	<imagedata fileref='images/nfs-logical-topology.png' format='PNG' contentwidth='700px' scalefit='1'/>
	</imageobject>
	<textobject>
	<phrase>Topologie logique</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.nfs.qa/images/nfs-logical-topology.png'>Topologie
	logique - vue complète</link></para>
	</caption>
</mediaobject>

	<bridgehead xml:id='sysadm-net.nfs.scenario'
	renderas='sect2'>Scénario</bridgehead>

    <para>Les manipulations décrites dans ce document illustrent les
    fonctionnalités offertes par le protocole <acronym>NFS</acronym>. Le
    séquencement des opérations à réaliser lors de la séance de travaux
    pratiques est décrit dans le tableau ci-dessous. Après le traitement de la
    première partie commune, les deux systèmes jouent un rôle distinct. Le rôle
    client accède à l'arborescence partagée ou exportée par le rôle
    serveur.</para>

	<table frame='all' pgwide='1'>
	<title>Attribution des rôles NFS</title>
	<tgroup cols='2' align='left' colsep='1' rowsep='1'>
	<colspec colnum='1' colname='c1' colwidth='1*'/>
	<colspec colnum='2' colname='c2' colwidth='1*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333"&nbsp;?>
		<?dbfo color="#fff"&nbsp;?>
	<entry>Client</entry>
	<entry>Serveur</entry>
	</row>
	</thead>
	<tbody>
	<row>
    <entry namest='c1' nameend='c2' align='center'>Identifiez du mécanisme des
    appels <acronym>RPC</acronym>. Installez et configurez les paquets
    communs.</entry>
	</row>
	<row>
    <entry>Identifiez des services disponibles sur le serveur. Créez un compte
    local sans répertoire utilisateur.</entry>
    <entry>Installez le paquet spécifique au serveur et configurez le service
    en fonction de l'arborescence à exporter.</entry>
	</row>
	<row>
    <entry namest='c1' nameend='c2' align='center'>Validez l'accès au système
    de fichiers réseau avec capture de trafic.</entry>
	</row>
	<row>
    <entry>Installez le paquet spécifique et configurez le service
    d'automontage des répertoires utilisateurs.</entry>
	<entry>&nbsp;</entry>
	</row>
	</tbody>
	</tgroup>
	</table>

    <para>De nombreuses questions peuvent être traitées à l'aide du document de
    référence &url.nfsv4.config; pour ces travaux pratiques. Il faut toutefois
    faire correspondre les configurations décrites dans ce document avec celles
    proposées par les paquets de la distribution Debian GNU/Linux.</para>

<?custom-pagebreak?>
	<bridgehead xml:id='sysadm-net.nfs.addressing'
	renderas='sect2'>Plan d'adressage</bridgehead>

	<para>Partant de la topologie présentée ci-dessus, on utilise un plan
	d'adressage pour chacun des rôles <acronym>iSCSI</acronym>.</para>

	<para>Le tableau ci-dessous correspond au plan d'adressage de la maquette
	qui a servi à traiter les questions des sections suivantes. Lors des
	séances de travaux pratiques, un plan d'adressage spécifique est fourni à
	chaque binôme d'étudiants. Il faut se référer au document
	&url.infra.moodle;.</para>

	<table xml:id='sysadm-net.nfs.mockup-addressing' frame='all' pgwide='1'>
        <title>Plan d'adressage de la maquette « Introduction au système de
        fichiers réseau NFSv4 »</title>
	<tgroup cols='4'>
	<colspec colnum='1' colwidth='1*'/>
	<colspec colnum='2' colwidth='1*'/>
	<colspec colnum='3' colwidth='3*'/>
	<colspec colnum='4' colwidth='1*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333"&nbsp;?>
		<?dbfo color="#fff"&nbsp;?>
		<entry>Rôle</entry>
		<entry>VLAN</entry>
		<entry>Adresses IP</entry>
		<entry>Interface tap</entry>
	</row>
	</thead>
	<tbody>
	<row>
		<entry>
		Client NFS
		</entry>
		<entry>101</entry>
		<entry>
		<systemitem class='ipaddress'>172.28.101.6/24</systemitem><?custom-linebreak?>
		<systemitem class='ipaddress'>2001:678:3fc:65:baad:caff:fefe:6/64</systemitem>
		</entry>
		<entry>6</entry>
	</row>
	<row>
		<entry>
		Serveur NFS
		</entry>
		<entry>101</entry>
		<entry>
		<systemitem class='ipaddress'>172.28.101.5/24</systemitem><?custom-linebreak?>
		<systemitem class='ipaddress'>2001:678:3fc:65:baad:caff:fefe:5/64</systemitem>
		</entry>
		<entry>5</entry>
	</row>
	</tbody>
	</tgroup>
	</table>

	<para>Avant de traiter les questions des sections suivantes, il faut
	rechercher dans le document &url.infra.moodle; les éléments nécessaires au
	raccordement des machines virtuelles ou physiques.</para>
</sect1>

<sect1 xml:id='sysadm-net.nfs.protocol'>
	<title>Protocole NFSv4</title>

	<para>Cette section reprend les éléments spécifiques au protocole
	<acronym>NFS</acronym> introduits lors de la présentation
	&url.net-fs;.</para>

    <para>Développé à l'origine par Sun Microsystems en 1984, le
    <wordasword>Network File System</wordasword> (<acronym>NFS</acronym>) est
    un protocole de système de fichiers distribué. Il permet de partager des
    fichiers de manière transparente entre les systèmes hôtes d'un réseau.
    Cette technologie s'est imposée comme un standard de fait dans le monde
    Unix pour l'accès aux fichiers distants dans les infrastructures
    d'entreprise.</para>

    <para>Plusieurs versions du protocole de système de fichiers réseau
    <acronym>NFS</acronym> sont disponibles. Chacune correspond à une
    «&nbsp;époque&nbsp;» ou à un cas d'usage. Le schéma ci-dessous illustre la
    répartition des fonctionnalités de la version 4 entre les espaces noyau et
    utilisateur.</para>

    <mediaobject>
	<imageobject role='fo'>
    <imagedata fileref='images/NFSv4.Schema.png' format='PNG' contentwidth='10cm' width='10.5cm'/>
    </imageobject>
	<imageobject role='html'>
    <imagedata fileref='images/NFSv4.Schema.png' format='PNG' contentwidth='640px' scalefit='1'/>
    </imageobject>
    <textobject>
    <phrase>Architecture NFSv4 Linux</phrase>
    </textobject>
	<caption>
    <para><link xmlns="http://docbook.org/ns/docbook"
    xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.nfs/images/.NFSv4.Schemapng'>Architecture
    NFS - vue complète</link></para>
	</caption>
    </mediaobject>

    <sect2 xml:id='sysadm-net.nfs.protocol.arch'>
    <title>Architecture NFSv4.2</title>

    <para><acronym>NFSv4.2</acronym> repose sur une architecture unifiée qui
    combine les espaces utilisateur et noyau, avec une communication
    strictement sur le port TCP/2049. Cette architecture inclut&nbsp;:</para>

    <variablelist>
    <varlistentry>
        <term>idmapd</term>
        <listitem>
        <para>Service d’association des identifiants utilisateurs (UID/GID)
        entre systèmes hétérogènes. Les UID/GID sont représentés sous forme de
        chaînes, ce qui garantit une indépendance totale des correspondances
        entre systèmes via le service idmapd.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>nfsd</term>
        <listitem>
        <para>Le démon serveur est traité dans le noyau. Il maintient pour
        chaque client une arborescence virtuelle cohérente. Il n'est donc plus
        nécessaire d'exporter les sous-arborescences séparément&nbsp;: tout
        point accessible permet la navigation sur tous les niveaux
        inférieurs.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>mount</term>
        <listitem>
        <para>Outil de montage du système de fichiers exporté.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>ACLs POSIX/NFS</term>
        <listitem>
        <para>Prise en charge native des contrôles d’accès.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>RPCSEC_GSS et Kerberos</term>
        <listitem>
        <para>Authentification cryptographique forte et protection contre
        l'usurpation.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Opérations composées (<wordasword>compound operations</wordasword>)</term>
        <listitem>
        <para>Le regroupement des opérations atomiques en une seule requête
        permet de réduire la latence et le trafic.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Copie côté serveur (<wordasword>Server-Side Copy</wordasword>)</term>
        <listitem>
        <para>NFSv4.2 permet de copier des fichiers directement sur le serveur,
        sans transiter par le client, ce qui élimine le trafic réseau redondant
        pour les opérations en volume
        (<wordasword>bulk-data</wordasword>).</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term><wordasword>Sparse Files</wordasword> et gestion avancée de
        l'espace</term>
        <listitem>
        <para>Le support natif des fichiers dispersés et les opérations
        ALLOCATE/DEALLOCATE optimisent la réservation et la dissémination de
        l'espace de stockage afin d'assurer une gestion efficace des
        ressources.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Parallélisation pNFS</term>
        <listitem>
        <para>Cette extension du protocole permet d'accéder de manière
        distribuée et simultanée aux données sur plusieurs serveurs ou chemins,
        assurant ainsi une évolutivité et des performances linéaires en
        fonction du nombre de serveurs et d'interfaces réseau.</para>
        </listitem>
    </varlistentry>
    </variablelist>
    </sect2>

    <sect2 xml:id='sysadm-net.nfs.protocol.sec'>
    <title>Sécurité NFSv4.2</title>

    <para>À l'instar de son concurrent, le système de fichiers SMB, la
    sécurisation des échanges de données en transit a beaucoup progressé. Voici
    une liste des fonctions les plus importantes&nbsp;:</para>

    <variablelist>
    <varlistentry>
        <term>Labeled NFS</term>
        <listitem>
        <para>Intégration native avec SELinux pour une gestion des labels de
        sécurité par fichier.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Chiffrement TLS&nbsp;: NFSv4.2 over TLS</term>
        <listitem>
        <para>Depuis 2022, il est possible d'utiliser le chiffrement TLS de
        bout en bout pour l'ensemble des communications NFS, grâce à la norme
        RPC-over-TLS (RFC 9289).</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>TLS 1.3 obligatoire</term>
        <listitem>
        <para>TLS 1.3 renforce la sécurité des communications en réduisant le
        nombre d'échanges nécessaires pour établir une session chiffrée. Il
        supprime les algorithmes obsolètes, limite les risques d'attaques et
        garantit une confidentialité accrue grâce au chiffrement des
        négociations.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Authentification par certificats x509</term>
        <listitem>
        <para>Certificats serveurs et clients pour l'identification mutuelle et
        le chiffrement de bout en bout.</para>
        </listitem>
    </varlistentry>
    </variablelist>
    </sect2>

    <sect2 xml:id='sysadm-net.nfs.protocol.innov'>
    <title>Adoption NFSv4.2 et innovations</title>

    <para>Selon l'étude réalisée par &url.intelmarketresearch;, le marché des
    systèmes de fichiers réseau affiche une croissance remarquable, avec un
    chiffre d'affaires évalué à 5,13 milliards de dollars en 2024, puis à 11,24
    milliards de dollars en 2032, soit un taux de croissance annuel composé
    (TCAC) de 12,8&nbsp;%. Cette expansion s'explique notamment par l'adoption
    massive du cloud computing. <acronym>NFSv4.2</acronym> s'est imposé comme
    une solution de choix dans cet écosystème, avec une augmentation de 28 %
    des déploiements NFS dans les environnements cloud d'une année sur l'autre
    en 2023. Les principaux fournisseurs de services cloud, comme Amazon Web
    Services (AWS) avec EFS, Microsoft Azure avec ses implémentations NFS ou
    encore Google Cloud Platform avec Filestore, ont massivement adopté NFSv4.2
    pour leurs offres de stockage géré.</para>

    <para>NFSv4.2 révolutionne les cas d'usage traditionnels grâce à ses
    capacités parallèles avec pNFS (Parallel NFS), qui sont particulièrement
    adaptées aux charges de travail d'intelligence artificielle et de calcul
    haute performance. Le protocole trouve de nouveaux débouchés dans
    l'orchestration de conteneurs avec Kubernetes, où il s'intègre nativement
    via les StorageClass pour fournir un stockage dynamique partagé.</para>
    </sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.common'>
    <title>Configurer les fonctions communes au client et au serveur
    NFS</title>

    <para>Plusieurs services communs doivent être actifs pour que les accès au
    système de fichiers réseau <acronym>NFS</acronym> soient utilisables. Le
    mécanisme de gestion des appels de procédures distantes, appelé
    <acronym>RPC</acronym> pour <wordasword>Remote Procedure Call</wordasword>,
    constitue le point de départ de la mise en œuvre de ces services.</para>

<sect2 xml:id='sysadm-net.nfs.common.rpc'>
	<title>Gérer des appels RPC</title>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Quel est le paquet qui fournit le service de gestion des
    appels de procédure distants RPC&nbsp;?</phrase></para>

    <para>Recherchez les noms de paquets qui contiennent la chaîne
    'rpc'. Installez le paquet identifié.</para>
	</question>
	<answer>
<screen>apt search --names-only ^rpc</screen>
<screen><emphasis>rpcbind</emphasis>/testing,now 1.2.7-1 amd64 [installé, automatique]
  conversion de numéros de programmes RPC en adresses universelles

rpcsvc-proto/testing,now 1.4.3-1 amd64 [installé, automatique]
  RPC protocol compiler and definitions</screen>

    <para>À la lecture de la liste ci-dessus, c'est le paquet
    <application>rpcbind</application> qu'il faut installer.</para>

<screen>sudo apt install rpcbind</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Quel est le numéro de port utilisé par le service&nbsp;?
    Comment fonctionne le service en écoute sur ce numéro de
    port&nbsp;?</phrase></para>

	<itemizedlist>
	<listitem>
    <para>Listez les processus actifs sur le système dont le nom contient la
    chaîne 'rpc'.</para>
	</listitem>
	<listitem>
	<para>Affichez le numéro de port en écoute correspondant à ce service.</para>
	</listitem>
	<listitem>
    <para>Consultez les pages de manuels de la commande
    <command>rpcbind</command>.</para>
	</listitem>
	</itemizedlist>
	</question>
	<answer>
	<itemizedlist>
	<listitem>
    <para>Listez des processus actifs en isolant la chaîne
    <literal>'rpcbind'</literal>.</para>

<screen>pgrep -a rpcbind</screen>
<screen>514 /usr/sbin/rpcbind -f -w</screen>
	</listitem>
	<listitem>
    <para>Identifiez le ou les numéros de ports en écoute en utilisant les
    commandes <command>lsof</command> et/ou <command>ss</command>.</para>

    <para>Commençons par la commande <command>lsof</command>&nbsp;:</para>

<screen>sudo apt install lsof</screen>

<screen>sudo lsof -i | grep [rpc]bind</screen>
<screen>rpcbind    514            _rpc   4u  IPv4   5424      0t0  TCP *:sunrpc (LISTEN)
rpcbind    514            _rpc   5u  IPv4   7361      0t0  UDP *:sunrpc
rpcbind    514            _rpc   6u  IPv6   4250      0t0  TCP *:sunrpc (LISTEN)
rpcbind    514            _rpc   7u  IPv6   6274      0t0  UDP *:sunrpc</screen>

    <para>Recherchez la correspondance entre numéro de port et nom de service
    en consultant le fichier <filename>/etc/services</filename>.</para>

<screen>grep sunrpc /etc/services</screen>
<screen>sunrpc          111/tcp         portmapper      # RPC 4.0 portmapper
sunrpc          111/udp         portmapper</screen>

    <para>Passons à la commande <command>ss</command> pour effectuer la même
    recharche&nbsp;:</para>

<screen>sudo ss -lntup | grep rpcbind</screen>
<screen>udp   UNCONN 0      0            0.0.0.0:111        0.0.0.0:*    users:(("rpcbind",pid=514,fd=5),("systemd",pid=1,fd=193))
udp   UNCONN 0      0               [::]:111           [::]:*    users:(("rpcbind",pid=514,fd=7),("systemd",pid=1,fd=195))
tcp   LISTEN 0      4096         0.0.0.0:111        0.0.0.0:*    users:(("rpcbind",pid=514,fd=4),("systemd",pid=1,fd=192))
tcp   LISTEN 0      4096            [::]:111           [::]:*    users:(("rpcbind",pid=514,fd=6),("systemd",pid=1,fd=194))</screen>

	<para>Le principe de fonctionnement des appels de procédure distants veut
	que tous ces appels soient reçus sur un numéro de port unique&nbsp;:
	<literal>sunrpc/111</literal>. Ces appels, une fois identifiés, sont
	transmis aux programmes concernés pour être traités.</para>
	</listitem>
	<listitem>
    <para>Recherchez dans la section <literal>DESCRIPTION</literal> des pages
    de manuels du service <application>rpcbind</application>, les informations
    sur son fonctionnement.</para>

<screen>man rpcbind</screen>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est a commande qui permet de lister les services
	accessibles via un appel <acronym>RPC</acronym>&nbsp;? À quel paquet
	appartient cette commande&nbsp;?</phrase></para>

	<para>Recherchez dans le support &url.nfs.howto; et dans la liste des
	fichiers du paquet sélectionné pour la gestion des appels
	<acronym>RPC</acronym>.</para>

    <para>Recherchez dans les pages de manuels de la commande l'option
    d'affichage la plus synthétique.</para>
	</question>
	<answer>
    <para>La commande présentée dans le support &url.nfs.howto; est appelée
    <command>rpcinfo</command>. Vérifiez sa présence sur le système serveur
    et/ou client.</para>

<screen>dpkg -S $(which rpcinfo)</screen>
<screen>rpcbind: /usr/bin/rpcinfo</screen>

    <para>Ouvrez les pages de manuels de la commande <command>rpcinfo</command>
    et recherchez l'option <option>-s</option> qui permet d'obtenir la
    présentation la plus synthétique des services accessibles par appel
    <acronym>RPC</acronym>.</para>

<screen>rpcinfo -s</screen>
<screen>   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser</screen>

    <para>La copie d'écran ci-dessus montre que le gestionnaire d'appel
    <systemitem>portmapper</systemitem> est le seul service ouvert en l'état
    actuel de la configuration.</para>

    <para>Relevez la liste des versions du service supportées ainsi que l'ordre
    de priorité associé.</para>

    <para>Les versions disponibles pour le protocole <acronym>NFS</acronym>
    sont&nbsp;: 2, 3 et 4.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Donnez deux exemples d'exécution de la commande pour lister
	le(s) service(s) ouvert sur le système local puis sur le système
	voisin.</phrase></para>

	<para>Reprenez la commande utilisée dans la question précédente en
	indiquant l'adresse <acronym>IPv4</acronym> ou <acronym>IPv6</acronym> du
	système voisin.</para>
	</question>
	<answer>
    <para>Testez différentes adresses <acronym>IP</acronym> pour intérroger les
    systèmes client et serveur.</para>

    <itemizedlist>
    <listitem>
    <para>Lancez une requête sur le système local.</para>

<screen>rpcinfo -s localhost</screen>
<screen>   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser</screen>
    </listitem>
    <listitem>
    <para>Lancez une requête sur le système voisin.</para>

<screen>rpcinfo -s fe80::baad:caff:fefe:5</screen>
<screen>   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser</screen>
    </listitem>
    </itemizedlist>

    <para>Ces copies d'écran montrent la même liste de services. Les
    configurations sur les deux hôtes sont donc identiques à ce stade de la
    configuration.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Réalisez une capture à l'aide de l'analyseur réseau lors de
	l'exécution de la commande et relevez&nbsp;: le protocole de transport
	utilisé, les numéros de ports caractéristiques de cette transaction ainsi
	que le nom de la procédure <acronym>RPC</acronym> utilisée.</phrase></para>

<screen>système 1                                       système 2
----------------------------------------------------------
 &lt;commande&gt;       --- requête ---&gt;            &lt;processus&gt;

                  &lt;-- réponse ----</screen>

<note>
    <para>Pour effectuer des captures de trafic réseau en mode console, deux
    applications sont à notre disposition&nbsp;:
    <application>tshark</application> et <application>termshark</application>.
    Pour limiter la taille des captures d'écran, on privilégie l'utilisation de
    <application>tshark</application>.</para>

    <para>Pour utiliser l'une ou l'autre de ces applications en tant
    qu'utilisateur standard, il faut appartenir au groupe système
    <systemitem>wireshark</systemitem>. Pour ajouter le compte
    <systemitem>etu</systemitem> au groupe <systemitem>wireshark</systemitem>,
    on exécute l'instruction <userinput>sudo adduser etu wireshark</userinput>.
    Il ne faut pas oublier de se déconnecter, puis de se reconnecter pour
    bénéficier de cette attribution.</para>
</note>
	</question>
	<answer>
    <para>Lancez une capture de trafic basée sur les adresses de lien local
    <acronym>IPv6</acronym> pour obtenir l'affichage le plus simple.</para>

    <itemizedlist>
    <listitem>
    <para>Lancez la capture sur le premier système.</para>
<screen>tshark -i enp0s1 -f "host fe80::baad:caff:fefe:5"</screen>
    </listitem>
    <listitem>
    <para>Lancez la commande <command>rpcinfo</command> sur le second
    système.</para>
<screen>rpcinfo -s fe80::baad:caff:fefe:6</screen>
<screen>   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser</screen>
    </listitem>
    <listitem>
    <para>Relevez les résultats de capture sur le premier système.</para>
<screen>Capturing on 'enp0s1'
    1 0.000000000 fe80::baad:caff:fefe:5 → fe80::baad:caff:fefe:6 Portmap 102 V3 DUMP Call
    2 0.000390802 fe80::baad:caff:fefe:6 → fe80::baad:caff:fefe:5 Portmap 746 V3 DUMP Reply (Call In 1)</screen>
    </listitem>
    </itemizedlist>

    <para>Reprenez la même démarche en utilisant une adresse globale pour faire
    apparaître l'utilisation de la couche transport.</para>

<screen>tshark -i enp0s1 -f "host 2001:678:3fc:65:baad:caff:fefe:5"</screen>
<screen>Capturing on 'enp0s1'
2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 TCP 94 50522 → 111 [SYN] Seq=0 Win=64800 Len=0 MSS=1440 SACK_PERM TSval=2127598301 TSecr=0 WS=128
2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 TCP 94 111 → 50522 [SYN, ACK] Seq=0 Ack=1 Win=64260 Len=0 MSS=1440 SACK_PERM TSval=4291415952 TSecr=2127598301 WS=128
2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 TCP 86 50522 → 111 [ACK] Seq=1 Ack=1 Win=64896 Len=0 TSval=2127598302 TSecr=4291415952
2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 Portmap 130 V3 DUMP Call
2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 TCP 86 111 → 50522 [ACK] Seq=1 Ack=45 Win=64256 Len=0 TSval=4291415953 TSecr=2127598302
2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 Portmap 774 V3 DUMP Reply (Call In 4)
2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 TCP 86 50522 → 111 [ACK] Seq=45 Ack=689 Win=64256 Len=0 TSval=2127598303 TSecr=4291415954
2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 TCP 86 50522 → 111 [FIN, ACK] Seq=45 Ack=689 Win=64256 Len=0 TSval=2127598303 TSecr=4291415954
2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 TCP 86 111 → 50522 [FIN, ACK] Seq=689 Ack=46 Win=64256 Len=0 TSval=4291415954 TSecr=2127598303
2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 TCP 86 50522 → 111 [ACK] Seq=46 Ack=690 Win=64256 Len=0 TSval=2127598303 TSecr=4291415954</screen>

    <para>Cette copie d'écran montre que&nbsp;:</para>
	<itemizedlist>
	<listitem>
	<para>Le protocole de couche transport utilisé est
	<acronym>TCP</acronym>.</para>
	</listitem>
	<listitem>
	<para>Le numéro de port utilisé correspond bien au service enregistré
	<systemitem>sunrpc/111</systemitem>.</para>
	</listitem>
	<listitem>
	<para>Le sous-programme distant appelé est&nbsp;: <option>Portmap V3
	DUMP Call</option>.</para>
	</listitem>
	</itemizedlist>

    <para>Affichez les détails de la transaction <acronym>RPC</acronym> en
    enregistrant la capture de trafic dans un fichier.</para>

    <itemizedlist>
    <listitem>
    <para>Utilisez l'option <option>-w</option> pour l'enregistrement.</para>

<screen>tshark -i enp0s1 -f "host fe80::baad:caff:fefe:5" <emphasis>-w rpcinfo.pcap</emphasis></screen>
    </listitem>
    <listitem>
    <para>Affichez les détails en précisant le le numéro de trame
    capturée.</para>

<screen>tshark -r /var/tmp/rpcinfo.pcap -V -Y "frame.number == 1"</screen>
<screen>tshark -r /var/tmp/rpcinfo.pcap -V -Y "frame.number == 2"</screen>
    </listitem>
    </itemizedlist>
	</answer>
	</qandaentry>
	</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.nfs.common.package'>
    <title>Installer le paquet NFS commun au client et au serveur</title>

	<qandaset defaultlabel='number' xml:id='sysadm-net.nfs.common-package'>
	<qandaentry xml:id='sysadm-net.nfs.synthese.nfs-common-package'>
	<question>
    <para><phrase>Quel est le paquet commun au client et au serveur
    <acronym>NFS</acronym>&nbsp;? Installez ce paquet et listez les commandes
    fournies par ce paquet.</phrase></para>

	<para>Recherchez dans la liste des paquets disponibles, ceux dont le nom
	débute par <option>nfs</option>.</para>
	</question>
	<answer>
<screen>apt search --names-only ^nfs</screen>
<screen><emphasis>nfs-common</emphasis>/testing,now 1:2.8.3-1+b1 amd64 [installé]
  fichiers de prise en charge NFS communs au client et au serveur</screen>

    <para>Le résultat de la commande de recherche propose une longue liste de
    paquets. Retenez le paquet <systemitem>nfs-common</systemitem> qui utilise
    les fonctions du noyau. Il correspond à l'architecture présentée à la <xref
    linkend='sysadm-net.nfs.protocol' />.</para>

<screen>sudo apt install nfs-common</screen>

	<para>Listez les programmes fournis par ce paquet.</para>

<screen>dpkg -L nfs-common | grep bin</screen>
<screen>/usr/sbin
/usr/sbin/blkmapd
/usr/sbin/<emphasis>mount.nfs</emphasis>
/usr/sbin/mountstats
/usr/sbin/nfsconf
/usr/sbin/nfsidmap
/usr/sbin/nfsiostat
/usr/sbin/nfsstat
/usr/sbin/rpc.gssd
/usr/sbin/rpc.idmapd
/usr/sbin/rpc.statd
/usr/sbin/rpc.svcgssd
/usr/sbin/rpcctl
/usr/sbin/rpcdebug
/usr/sbin/<emphasis>showmount</emphasis>
/usr/sbin/sm-notify
/usr/sbin/start-statd
/usr/sbin/<emphasis>mount.nfs4</emphasis>
/usr/sbin/<emphasis>umount.nfs</emphasis>
/usr/sbin/<emphasis>umount.nfs4</emphasis></screen>

	<para>Dans cette liste, on trouve les commandes de montage, de démontage et
	de suivi d'état du système de fichiers réseau.</para>
	</answer>
	</qandaentry>
	</qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.server'>
	<title>Configurer le serveur NFS</title>

    <para>Le rôle du serveur <acronym>NFS</acronym> est de mettre à disposition
    sur le réseau une partie de son système de fichiers local. On parle
    d'«&nbsp;exportation&nbsp;».</para>

    <para>Conformément à la présentation de la <xref
    linkend='sysadm-net.nfs.protocol' />, on choisit une solution qui utilise
    les fonctions du noyau Linux.</para>

<sect2 xml:id='sysadm-net.nfs.server.exportfs'>
    <title>Exporter une arborescence</title>

    <qandaset defaultlabel='number'>
	<qandaentry>
	<question>
	<para><phrase>Quel est le paquet qui contient les outils nécessaires au
	fonctionnement du serveur <acronym>NFS</acronym>&nbsp;? Installez ce
	paquet.</phrase></para>

	<para>Interrogez les méta données du gestionnaire de paquets pour
	identifier le nom du paquet à installer.</para>
	</question>
	<answer>
    <para>Recherchez la chaîne <literal>nfs.*server</literal> avec le
    gestionnaire de paquets.</para>

<screen>apt search --names-only nfs.*server</screen>
<screen><emphasis>nfs-kernel-server</emphasis>/testing,now 1:2.8.3-1+b1 amd64 [installé]
  gestion du serveur NFS du noyau</screen>
<screen>sudo apt -y install nfs-kernel-server</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est le fichier de configuration principal de gestion des
	exportations <acronym>NFS</acronym>&nbsp;?</phrase></para>

	<para>Recherchez dans le support &url.nfs.howto;.</para>
	</question>
	<answer>
    <para>Quel que soit le protocole utilisé, c'est toujours le fichier
    <filename>/etc/exports</filename> qui est employé. Ce fichier est présenté
    dans le guide &url.nfs.howto;. Le fichier fourni avec le paquet contient
    deux exemples complets de configuration <acronym>NFSv3</acronym> et
    <acronym>NFSv4</acronym> commentés. C'est ce dernier exemple que l'on
    adapte pour répondre aux questions suivantes.</para>

<screen>cat /etc/exports</screen>
<screen># /etc/exports: the access control list for filesystems which may be exported
#               to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#</screen>

<note>
    <para>Pour les tests à venir, les appels aux fonctions de sécurité Kerberos
    sont supprimés.</para>
</note>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.nfs.server.exports'>
	<question>
	<para><phrase>Créez le répertoire <filename
	class='directory'>/home/exports/home</filename>. Quelles sont les
	instructions d'exportation à ajouter au fichier de configuration pour ce
	répertoire&nbsp;?</phrase></para>

    <para>Consultez les supports Linux &url.nfs.howto; et &url.nfsv4.config;.
    Vous pouvez également consulter les pages de manuel fournies avec le paquet
    du serveur <acronym>NFS</acronym>.</para>
	</question>
	<answer>
<screen>sudo mkdir -p /home/exports/home</screen>

    <para>En exploitant la documentation &url.nfsv4.config; et l'exemple de
    configuration fournis dans le fichier de configuration, on applique les
    instructions de configuration suivantes dans le fichier
    <filename>/etc/exports</filename>&nbsp;:</para>

    <para>Ajoutez les instructions d'exportation du dossier à destination de
    vos réseaux <acronym>IPv4</acronym> et <acronym>IPv6</acronym> dans un
    script.</para>

    <para>Les adresses des réseaux <acronym>IPv4</acronym> et
    <acronym>IPv6</acronym> doivent bien sûr être adaptées à votre plan
    d'adressage.</para>

<screen><![CDATA[#!/bin/bash

IPV4_NETWORK=172.28.101.0/24
IPV6_NETWORK=2001:678:3fc:65::/64

cat << EOF > /etc/exports
/home/exports           ${IPV4_NETWORK}(rw,sync,fsid=0,crossmnt,no_subtree_check)
/home/exports/home      ${IPV4_NETWORK}(rw,sync,no_subtree_check)

/home/exports           ${IPV6_NETWORK}(rw,sync,fsid=0,crossmnt,no_subtree_check)
/home/exports/home      ${IPV6_NETWORK}(rw,sync,no_subtree_check)
EOF]]></screen>

    <para>Si le code du script ci-dessus est enregistré dans un fichier appelé
    <filename>basic-nfs-exports.sh</filename>, on peut lancer la création du
    nouveau fichier <filename>/etc/exports</filename> avec l'instruction
    suivante&nbsp;:</para>

<screen>sudo bash basic-nfs-exports.sh</screen>

	<para>Les options entre parenthèses sont documentées dans les pages de
	manuels <systemitem>exports</systemitem>&nbsp;: <userinput>man 5
	exports</userinput>. Les éléments de la liste suivante sont extraits de
	cette documentation.</para>

	<itemizedlist>
	<listitem>
    <para><literal>rw</literal>&nbsp;: autorise les requêtes en lecture et en
    écriture sur le volume <acronym>NFS</acronym>. Le comportement par défaut
    consiste à interdire toute requête susceptible de modifier le système de
    fichiers.</para>
	</listitem>
	<listitem>
	<para><literal>sync</literal>&nbsp;: ne répondre aux requêtes qu'après
	l'exécution de tous les changements sur le support réel.</para>
	</listitem>
	<listitem>
    <para><literal>fsid=0</literal>&nbsp;: avec <acronym>NFSv4</acronym>, un
    système de fichiers particulier est la racine de tous les systèmes de
    fichiers partagés. Il est défini par <option>fsid=root</option> ou
    <option>fsid=0</option>, qui signifient exactement la même chose.</para>
	</listitem>
	<listitem>
    <para><literal>crossmnt</literal>&nbsp;: cette option permet aux clients de
    se déplacer du système de fichiers marqué <option>crossmnt</option> vers
    les systèmes de fichiers partagés montés dessus. Voir l'option
    <acronym>nohide</acronym>.</para>
	</listitem>
	<listitem>
    <para><literal>no_subtree_check</literal>&nbsp;: cette option neutralise la
    vérification des sous-répertoires, ce qui a des implications subtiles en
    matière de sécurité, mais peut améliorer la fiabilité dans certains cas. Si
    un sous-répertoire d'un système de fichiers est partagé, mais que le
    système de fichiers ne l'est pas, alors, à chaque requête
    <acronym>NFS</acronym>, le serveur doit non seulement vérifier que le
    fichier accédé se trouve dans le système de fichiers approprié (ce qui est
    facile), mais aussi qu'il se trouve dans l'arborescence partagée (ce qui
    est plus compliqué). Cette vérification s'appelle
    <systemitem>subtree_check</systemitem>.</para>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.nfs.server.service'>
	<question>
    <para><phrase>Comment l'exportation <acronym>NFS</acronym> effective&nbsp;?
    Comment vérifier que les paramètres actifs sont
    corrects&nbsp;?</phrase></para>

	<para>Recherchez dans la liste des outils fournis avec le paquet
	<systemitem>nfs-kernel-server</systemitem> la commande qui permet de
	connaître l'état courant des exportations <acronym>NFS</acronym>.</para>
	</question>
	<answer>
	<para>On identifie la commande <command>exportfs</command> dans la liste
	des binaires fournis avec le paquet serveur <acronym>NFS</acronym>.</para>

<screen>dpkg -L nfs-kernel-server | grep bin</screen>
<screen>/usr/sbin
<emphasis>/usr/sbin/exportfs</emphasis>
/usr/sbin/fsidd
/usr/sbin/nfsdcld
/usr/sbin/nfsdclddb
/usr/sbin/nfsdclnts
/usr/sbin/nfsdctl
/usr/sbin/nfsref
/usr/sbin/rpc.mountd
/usr/sbin/rpc.nfsd</screen>

<important>
    <para>Il est essentiel de redémarrer le service concerné après chaque
    modification d'un fichier de configuration.</para>
</important>

<screen>sudo systemctl restart nfs-server</screen>

<screen>systemctl status nfs-server</screen>
<screen>● nfs-server.service - NFS server and services
     Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; enabled; preset: enabled)
     Active: active (exited) since Mon 2025-09-15 08:56:44 CEST; 27s ago
 Invocation: 9056b4826f4d4be688cb4ee9f1490f23
       Docs: man:rpc.nfsd(8)
             man:exportfs(8)
    Process: 2495 ExecStartPre=/usr/sbin/exportfs -r (code=exited, status=0/SUCCESS)
    Process: 2496 ExecStart=/bin/sh -c /usr/sbin/nfsdctl autostart || /usr/sbin/rpc.nfsd (code=exited, status=0/SUCCESS)
   Main PID: 2496 (code=exited, status=0/SUCCESS)
   Mem peak: 2.3M
        CPU: 38ms

sept. 15 08:56:44 srvr systemd[1]: Starting nfs-server.service - NFS server and services...
sept. 15 08:56:44 srvr sh[2498]: nfsdctl: lockd configuration failure
sept. 15 08:56:44 srvr systemd[1]: Finished nfs-server.service - NFS server and services.</screen>

<note>
    <para>Le message d'erreur à propos du démon <systemitem>lockd</systemitem>
    est sans importance pour la version <acronym>NFSv4</acronym>.</para>
</note>

    <para>Consultez la liste des entrées exportées via <acronym>NFS</acronym>
    avec la commande <command>exportfs</command>.</para>

<screen>sudo exportfs</screen>
<screen>/home/exports   172.28.101.0/24
/home/exports   2001:678:3fc:65::/64
/home/exports/home
                172.28.101.0/24
/home/exports/home
                2001:678:3fc:65::/64</screen>

    <para>Vérifiez que la liste des exportations est visible et identique
    <emphasis>côté client</emphasis> en utilisant la commande
    <command>showmount</command>.</para>

<screen>sudo showmount -e fe80::baad:caff:fefe:5</screen>
<screen>Export list for fe80::baad:caff:fefe:5:
/home/exports/home 2001:678:3fc:65::/64,172.28.101.0/24
/home/exports      2001:678:3fc:65::/64,172.28.101.0/24</screen>
	</answer>
	</qandaentry>
    </qandaset>
</sect2>

<sect2 xml:id='sysadm-net.nfs.server.ahome'>
    <title>utiliser la même arborescence entre clients et serveur</title>

    <para>Il est impératif d'assurer la cohérence du nommage des arborescences
    entre les clients et le serveur. Cela évite toute confusion entre les
    différents interlocuteurs, d'un point de vue administration et
    support.</para>

    <para>Il faut également garantir l'évolutivité en utilisant un point de
    montage dédié côté serveur. Ainsi, il est possible de déplacer ou de migrer
    le volume de stockage du serveur sans impacter les clients.</para>

    <qandaset defaultlabel='number'>
	<qandaentry xml:id='sysadm-net.nfs.server.ahome.fsid'>
	<question>
    <para><phrase>Quel est le rôle du répertoire <filename
    class='directory'>/home/exports/</filename> dans l'exportation
    <acronym>NFS</acronym>&nbsp;?</phrase></para>

    <para>Recherchez la signification du paramètre <option>fsid=0</option> dans
    les supports &url.nfs.howto; et &url.nfsv4.config;.</para>
	</question>
	<answer>
    <para>On peut établir une analogie entre un serveur Web et un serveur NFS.
    L'option <option>fsid=0</option> de la configuration du serveur NFS permet
    de <emphasis>définir une racine de montage</emphasis>, à l'instar d'un
    serveur Web. Le paramètre de configuration <option>DocumentRoot
    /var/www</option> du serveur Apache désigne la racine à partir de laquelle
    les pages Web publiées sont référencées. Cette racine est indépendante de
    l'arborescence du système de fichiers local du serveur.</para>

    <para>Dans les deux cas, les clients des serveurs Web ou NFS n'ont aucune
    connaissance de l'arborescence de stockage du serveur.</para>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment créer le point de montage logique <filename
    class='directory'>/ahome</filename>&nbsp;?</phrase></para>

    <para>Recherchez, dans les pages de manuels de la commande
    <command>mount</command>, les informations sur l'option
    <option>bind</option>.</para>

    <para>Complétez le fichier système qui contient la liste des montages
    statiques et activez le nouveau montage du nouveau dossier <filename
    class='directory'>/ahome</filename>.</para>
    </question>
    <answer>
	<para>Dans le cadre de ces travaux pratiques, les répertoires
	utilisateurs doivent être référencés à partir d'une racine nommée <filename
    class='directory'>/ahome/</filename>. Ce nom logique doit rester constant,
    même si les volumes de stockage physique migrent, se déplacent, sont
    étendus, etc.</para>

    <para>L'utilisation d'un montage local avec l'option <option>bind</option>
    de la commande <command>mount</command> permet de mettre en cohérence
    l'arborescence du serveur et de ses clients. Ainsi, le répertoire <filename
    class='directory'>/ahome/</filename> présente les mêmes objets, que l'on
    soit connecté au serveur ou à un client. Le schéma de nommage est donc
    cohérent.</para>

	<para>Créez le répertoire de montage.</para>

<screen>sudo mkdir /ahome</screen>

    <para>Associez le répertoire exporté par le service NFS au point de
    montage.</para>

<screen>sudo mount --bind /home/exports/home /ahome</screen>

    <para>Enregistrez ce montage dans la configuration système permanente en
    éditant le fichier <filename>/etc/fstab</filename>.</para>

<screen>cat &lt;&lt; EOF | sudo tee -a /etc/fstab

/home/exports/home     /ahome  none    defaults,bind    0    0
EOF</screen>

    <para>Vérifiez l'ajout de la nouvelle entrée dans le fichier
    <filename>/etc/fstab</filename>.</para>

<screen>grep -v ^# /etc/fstab</screen>
<screen>PARTUUID=95ed2e41-f56c-4cc0-a79e-c93a07e93c79 / ext4 rw,discard,errors=remount-ro,x-systemd.growfs 0 1
PARTUUID=71f5d30c-8e21-4372-81f6-11eb66815669 /boot/efi vfat defaults,umask=077 0 2

<emphasis>/home/exports/home     /ahome  none    defaults,bind    0    0</emphasis></screen>

    <para>Activez le nouveau point de montage.</para>

<screen>sudo mount -a</screen>
	</answer>
	</qandaentry>
    </qandaset>
</sect2>


<sect2 xml:id='sysadm-net.nfs.server.user'>
    <title>Créer un compte utilisateur sur le serveur</title>

    <para>Dans cette section, vous créez un compte utilisateur local sur le
    serveur ainsi qu'un fichier lui appartenant. L'objectif est de préparer
    l'analyse de la correspondance entre les valeurs <option>UID</option> et
    <option>GID</option> entre le client et le serveur NFS. Voir <xref
    linkend='sysadm-net.nfs.idmapd'/>.</para>

    <qandaset>
	<qandaentry>
	<question>
    <para><phrase>Comment créer un compte utilisateur local baptisé
    <systemitem>etu-nfs</systemitem> avec un répertoire utilisateur situé sous
    la racine <filename
    class='directory'>/ahome</filename>&nbsp;?</phrase></para>

    <para>Recherchez dans les paramètres de la commande
    <command>adduser</command> celui qui permet de désigner le répertoire
    utilisateur.</para>
	</question>
	<answer>
    <para>Créez le compte utilisateur en utilisant l'option
    <option>--home</option>.</para>

<screen>sudo adduser --home /ahome/etu-nfs etu-nfs</screen>
<screen>Nouveau mot de passe :
Retapez le nouveau mot de passe :
passwd : mot de passe mis à jour avec succès
Modifier les informations associées à un utilisateur pour etu-nfs
Entrer la nouvelle valeur, ou appuyer sur ENTER pour la valeur par défaut
        NOM []: NFS user
        Numéro de chambre []:
        Téléphone professionnel []:
        Téléphone personnel []:
        Autre []:
Is the information correct? [Y/n]</screen>

    <para>Affichez les attributs du compte utilisateur créé.</para>

<screen>getent passwd etu-nfs</screen>
<screen>etu-nfs:x:1002:1002:NFS user,,,:/ahome/etu-nfs:/bin/bash</screen>

    <para>Les valeurs numériques des identifiants
    <systemitem>uid/gid</systemitem> jouent un rôle important dans la suite des
    manipulations. Voir <xref linkend='sysadm-net.nfs.idmapd'/>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment créer un fichier avec l'identité de l'utilisateur
    <systemitem>etu-nfs</systemitem> côté serveur&nbsp;?</phrase></para>

    <para>Recherchez comment utiliser la commande <command>su</command> ou
    <command>login</command> pour prendre l'identité du nouvel
    utilisateur.</para>
	</question>
	<answer>
    <para>Utilisez l'une des deux commandes suivantes pour prendre l'identité
    de l'utilisateur <systemitem>etu-nfs</systemitem>.</para>

    <itemizedlist>
    <listitem>
    <para><userinput>sudo login</userinput></para>
    </listitem>
    <listitem>
    <para><userinput>su - etu-nfs</userinput></para>
    </listitem>
    </itemizedlist>

    <para>Prenez l'identité de l'utilisateur
    <systemitem>etu-nfs</systemitem>.</para>

<screen>su - etu-nfs</screen>
<screen>Mot de passe :</screen>
<screen>id</screen>
<screen>uid=1002(etu-nfs) gid=1002(etu-nfs) groupes=1002(etu-nfs),100(users)</screen>

    <para>Vérifiez que le chemin du répertoire utilisateur est correct.</para>

<screen>pwd</screen>
<screen>/ahome/etu-nfs</screen>

    <para>Créez un fichier texte dans le répertoire utilisateur et affichez son
    masque de permissions.</para>

<screen>echo "This file is mine" > myTextFile</screen>
<screen>ls -lAh myTextFile</screen>
<screen>-rw-rw-r-- 1 etu-nfs etu-nfs 18 15 sept. 15:00 myTextFile</screen>

    <para>Vous pouvez revenir à l'identité précédente en quittant la session
    avec la commande <command>exit</command>.</para>
	</answer>
	</qandaentry>
    </qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.client'>
	<title>Configurer le client NFS</title>

    <para>Le rôle du client est d'intégrer un accès au système de fichiers d'un
    hôte distant dans son arborescence locale. On parle de «&nbsp;montage
    NFS&nbsp;». Dans un premier temps, on teste les opérations de montage
    manuel. Ces tests ne peuvent bien sûr aboutir que si une arborescence a été
    exportée par un serveur.</para>

    <para>Ensuite, on teste les opérations de montage automatisées, ou
    <emphasis>automontage</emphasis> avec le service
    <systemitem>autofs</systemitem>.</para>

<warning>
    <para>Attention ! Les montages manuels et les automontages ne sont pas
    compatibles Assurez-vous d'avoir libéré tous les montages statiques avant
    de démarrer le service <systemitem>autofs</systemitem>.</para>
</warning>

<sect2 xml:id='sysadm-net.nfs.client.manual'>
	<title>Tester les montages/démontages manuels NFS</title>

    <qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Quelle est la commande qui permet de tester la disponibilité
    du service de montage <acronym>NFS</acronym> sur un client
    distant&nbsp;?</phrase></para>

    <para>Reprenez la commande qui affiche les listes des procédures distantes
    disponibles. Elle a été utilisée dans la section <xref
    linkend='sysadm-net.nfs.common' />.</para>
	</question>
	<answer>
    <para>Affichez la liste des procédures disponibles sur le serveur depuis le
    client NFS.</para>

<screen>rpcinfo -s fe80::baad:caff:fefe:5</screen>
<screen>   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser
    100024  1         tcp6,udp6,tcp,udp                status      104
    100005  3,2,1     tcp6,udp6,tcp,udp                <emphasis>mountd</emphasis>      superuser
    100003  4,3       tcp6,tcp                         nfs         superuser
    100227  3         tcp6,tcp                         nfs_acl     superuser
    100021  4,3,1     tcp6,udp6,tcp,udp                nlockmgr    superuser</screen>

    <para>Relativement aux résultats obtenus dans la section <xref
    linkend='sysadm-net.nfs.common' />, la liste des services accessibles via
    <acronym>RPC</acronym> sur le serveur <acronym>NFS</acronym> s'est étoffée
    et le service de montage <systemitem>mountd</systemitem> apparaît
    clairement.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.nfs.client.manual.exports'>
	<question>
    <para><phrase>Quelle est la commande qui permet d'afficher l'arborescence
    disponible à l'exportation depuis le serveur
    <acronym>NFS</acronym>&nbsp;?</phrase></para>

    <para>Recherchez la commande dans la liste des commandes du paquet de
    service <acronym>NFS</acronym> commun au client et au serveur.</para>

    <para>Recherchez l'option de cette commande qui affiche la liste des
    exportations.</para>
	</question>
	<answer>
    <para>Affichez la liste des commandes du paquet
    <systemitem>nfs-common</systemitem> et identifiez celles qui sont relatives
    aux montages.</para>

<screen>dpkg -L nfs-common | egrep 'bin.*mount'</screen>
<screen>/usr/sbin/mount.nfs
/usr/sbin/mountstats
/usr/sbin/<emphasis>showmount</emphasis>
/usr/sbin/mount.nfs4
/usr/sbin/umount.nfs
/usr/sbin/umount.nfs4</screen>

    <para>Recherchez dans les pages de manuels de la commande
    <command>showmount</command>, l'option qui permet d'obtenir la liste des
    exportations.</para>

<screen>sudo showmount <emphasis>-e</emphasis> fe80::baad:caff:fefe:5
Export list for fe80::baad:caff:fefe:5:
/home/exports/home 2001:678:3fc:65::/64,172.28.101.0/24
/home/exports      2001:678:3fc:65::/64,172.28.101.0/24</screen>

    <para>Les résultats affichés par la commande <command>showmount</command>
    avec l'option <option>-e</option> supposent que le serveur
    <acronym>NFS</acronym> a déjà été configuré pour exporter le dossier
    <filename class='directory'>/home</filename>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour les opérations de
	montage manuel&nbsp;? À quel paquet appartient cette commande&nbsp;? Cette
	commande est-elle exclusivement liée au protocole
	<acronym>NFS</acronym>&nbsp;?</phrase></para>

    <para>consultez le support &url.nfs.howto;, interrogez la base de données
    des paquets et recherchez dans les listes de fichiers fournis avec de
    paquet choisi.</para>
	</question>
	<answer>
    <para>Recherchez les exemples d'utilisation de la commande
    <command>mount</command> dans la documentation &url.nfs.howto;.</para>

    <para>Recherchez ensuite cette commande dans la liste des noms de paquets
    de la distribution.</para>

<screen>apt search --names-only ^mount$</screen>
<screen>mount/testing,now 2.41.1-3 amd64 [installé]
  outils pour monter et manipuler des systèmes de fichiers</screen>

    <para>Le paquet est déjà installé. Listez les commandes liées au
    montage.</para>

<screen>dpkg -L mount | grep 'bin.*mount'</screen>
<screen><emphasis>/usr/bin/mount</emphasis>
/usr/bin/umount</screen>

    <para>Consultez les pages de manuels de la commande&nbsp;:
    <userinput>man mount</userinput>.</para>

    <para>La commande <command>mount</command> traite l'ensemble des opérations
    de montage pour tous les systèmes de fichiers disponibles sur le système,
    dont NFS.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment réaliser un montage manuel de l'arborescence du
    serveur <acronym>NFS</acronym> dans le répertoire <filename
    class='directory'>/ahome</filename> du client&nbsp;?</phrase></para>

    <para>Créez le répertoire <filename
    class='directory'>/ahome</filename>.</para>

    <para>Recherchez dans le document &url.nfs.howto; la syntaxe de la commande
    de montage manuel.</para>

    <para>Lancez la commande de montage et affichez les propriétés de ce
    montage.</para>
	</question>
	<answer>
    <para>Créez le répertoire <filename
    class='directory'>/ahome</filename>&nbsp;:</para>

<screen>sudo mkdir /ahome</screen>

    <para>Montez l'arborescence du serveur dans ce dossier après avoir ajouté
    l'adresse et le nom de ce serveur dans le fichier
    <filename>/etc/hosts</filename>.</para>

<screen>echo "2001:678:3fc:65:baad:caff:fefe:5 nfs-server" | \
    sudo tee -a /etc/hosts</screen>

<screen>sudo mount nfs-server:/home /ahome</screen>

    <para>Affichez les propriétés du montage.</para>

<screen>mount | grep nfs
nfs-server:/home on /ahome type nfs4
    (rw,relatime,vers=4.2,rsize=131072,wsize=131072,namlen=255,hard,fatal_neterrors=none,proto=tcp6,
    timeo=600,retrans=2,sec=sys,clientaddr=2001:678:3fc:65:baad:caff:fefe:6,
    local_lock=none,addr=2001:678:3fc:65:baad:caff:fefe:5)</screen>

    <para>Repérez les adresses du client et du serveur dans la copie d'écran
    ci-dessus.</para>

    <para>Dans l'exemple ci-dessus&nbsp;:</para>
    <itemizedlist>
    <listitem>
    <para>Adresse du serveur&nbsp;:
    <systemitem>2001:678:3fc:65:baad:caff:fefe:5</systemitem></para>
    </listitem>
    <listitem>
    <para>Adresse du client&nbsp;:
    <systemitem>2001:678:3fc:65:baad:caff:fefe:6</systemitem></para>
    </listitem>
    </itemizedlist>

    <para>Voici une interprétation résumée des propriétés du montage.</para>

    <itemizedlist>
    <listitem>
    <para>Il s'agit d'un montage <acronym>NFSv4.2</acronym> en lecture/écriture
    utilisant <acronym>IPv6</acronym>, optimisé à la fois pour la compatibilité
    et la vitesse, avec des tailles de tampon importantes.</para>
    </listitem>
    <listitem>
    <para>L'option <option>hard</option> indique que les applications seront
    mises en attente plutôt que d'échouer si le serveur <acronym>NFS</acronym>
    devient temporairement inaccessible.</para>
    </listitem>
    <listitem>
    <para>La sécurité repose sur les identifiants utilisateur du système local,
    et non sur un cryptage ou une authentification.</para>
    </listitem>
    <listitem>
    <para>La taille du tampon de lecture/écriture (131 072 octets) vise à
    obtenir un débit optimal.</para>
    </listitem>
    <listitem>
    <para>L'utilisation de l'option <option>local_lock=none</option> peut avoir
    un impact sur les applications nécessitant le verrouillage de
    fichiers.</para>
    </listitem>
    </itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment lancer une capture de trafic avec
    <command>tshark</command> sur le serveur avant d'exécuter la commande
    <command>ls -lAh /ahome</command> sur le client&nbsp;?</phrase> Comment
    interpréter les informations capturées&nbsp;?</para>
	</question>
	<answer>
    <orderedlist>
	<listitem>
    <para>Lancez la capture de trafic côté serveur
    <acronym>NFS</acronym>.</para>

<screen>tshark -i enp0s1 -f "host 2001:678:3fc:65:baad:caff:fefe:6" -w nfs-list.pcap</screen>

    <para>L'adresse d'hôte sélectionnée est celle du client
    <acronym>NFS</acronym>.</para>
	</listitem>
	<listitem>
	<para>Exécutez la commande <command>ls -lAh /ahome</command> côté client
	<acronym>NFS</acronym>.</para>
	</listitem>
	<listitem>
	<para>Arrêtez la capture côté serveur avec Ctrl+C.</para>
	</listitem>
	</orderedlist>

    <para>Affichez la liste des trames capturées.</para>

<screen>tshark -r nfs-list.pcap</screen>
<screen>1 0.000000000 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 258 V4 Call GETATTR FH: 0xcd09674b
2 0.001127472 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 330 V4 Reply (Call In 1) GETATTR
3 0.001849966 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 TCP 86 677 → 2049 [ACK] Seq=173 Ack=245 Win=501 Len=0 TSval=2629983171 TSecr=2710409161
4 0.002436129 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 258 V4 Call GETATTR FH: 0xcd09674b
5 0.002549903 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 330 V4 Reply (Call In 4) GETATTR
6 0.002889220 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 258 V4 Call GETATTR FH: 0x8854dd26
7 0.002962282 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 330 V4 Reply (Call In 6) GETATTR
8 0.044790234 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 TCP 86 677 → 2049 [ACK] Seq=517 Ack=733 Win=501 Len=0 TSval=2629983214 TSecr=2710409163</screen>

    <para>Interprétiez les transactions NFS&nbsp;:</para>
    <itemizedlist>
    <listitem>
    <para>L'opération <option>GETATTR</option> apparaît plusieurs fois.</para>
    <para>Ce comportement du client <acronym>NFS</acronym> est caractéristique
    lorsque la mise en cache des attributs est minimisée. En effet, la commande
    <command>ls -lAh /ahome</command> requiert des données à jour.</para>
    </listitem>
    <listitem>
    <para>L'appel GETATTR NFS v4 permet de demander les attributs d'un fichier
    ou d'un répertoire.</para>
    </listitem>
    <listitem>
    <para>La réponse GETATTR NFS v4 contient les attributs demandés.</para>
    </listitem>
    </itemizedlist>

    <para>Notez qu'il est possible d'afficher tous les détails d'une trame
    capturée. Voici un exemple pour la trame numéro 5.</para>

<screen>tshark -r nfs-list.pcap -Y "frame.number == 5" -V</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Quelles <emphasis>seraient</emphasis> les opérations à
    effectuer pour rendre le montage <acronym>NFS</acronym> statique
    permanent&nbsp;?</phrase></para>

	<para>Recherchez le fichier de configuration système responsable des
	montages statiques des partitions.</para>

	<para><emphasis>Il est inutile de modifier le fichier de configuration du système
	sachant que l'on change de méthode de montage dans la section
	suivante.</emphasis></para>
	</question>
	<answer>
    <para>Il faudrait éditer le fichier <filename>/etc/fstab</filename> pour
    effectuer un montage statique à chaque initialisation du système. Voici un
    exemple de ligne à insérer à la fin du fichier.</para>

<screen>nfs-server:/home   /ahome   nfs4    0   0</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour
	<emphasis>démonter</emphasis> le dossier <filename
	class='directory'>/ahome</filename>&nbsp;?</phrase></para>

	<para>Recherchez cette commande dans la liste des outils fournis avec le
	paquet <systemitem>mount</systemitem>.</para>
	</question>
	<answer>
    <para>Utilisez la commande <command>umount</command> pour
    &laquo;&nbsp;détacher&nbsp;&raquo; un dispositif de stockage du système de
    fichiers.</para>

<screen>sudo umount /ahome</screen>

<screen>mount | grep nfs</screen>
    <para>Cette dernière commande ne produit aucun résultat. Il n'y a plus de
    montage <acronym>NFS</acronym> sur le client.</para>
	</answer>
	</qandaentry>
    </qandaset>
</sect2>

<sect2 xml:id='sysadm-net.nfs.client.user'>
	<title>Créer un compte utilisateur sur le client NFS</title>

    <para>Comme il n'existe pas de gestion centralisée des identités pour les
    manipulations de ce support de travaux pratiques, on utilise un artifice
    permettant de faire correspondre les identifiants
    <systemitem>UID/GID</systemitem> entre le client et le serveur
    <acronym>NFS</acronym>&nbsp;: la création de deux comptes utilisateurs
    ayant les mêmes valeurs pour ces identifiants.</para>

    <para>On a déjà créé le compte utilisateur sur le serveur. Voir la <xref
    linkend='sysadm-net.nfs.server.user' />. À la suite de cette création de
    compte, on a relevé les attributs suivants&nbsp;:</para>

<screen>etu-nfs:x:1002:1002:NFS user,,,:/ahome/etu-nfs:/bin/bash</screen>

    <para>Il s'agit maintenant de réaliser l'opération symétrique sur le
    client.</para>

    <qandaset>
	<qandaentry>
	<question xml:id='sysadm-net.nfs.client.auto.user'>
	<para><phrase>Comment créer un compte utilisateur local baptisé
	<systemitem>etu-nfs</systemitem> avec un répertoire utilisateur situé sous
	la racine <filename class='directory'>/ahome</filename> dont les fichiers
	et répertoires sont placés sur le serveur
	<acronym>NFS</acronym>&nbsp;?</phrase></para>

    <para>Consultez les pages de manuels de la commande
    <command>adduser</command> et recherchez les options relatives au
    répertoire utilisateur.</para>
	</question>
	<answer>
    <para>Les deux options utiles pour traiter la question sont
    <option>--home</option> qui permet de désigner le répertoire utilisateur
    dans l'arborescence système et <option>--no-create-home</option> qui évite
    la création de ce répertoire sur le système local.</para>

<screen>sudo adduser --no-create-home --home /ahome/etu-nfs etu-nfs</screen>
<screen><emphasis>warn: The home dir /ahome/etu-nfs you specified can't be accessed: No such file or directory</emphasis>

Nouveau mot de passe :
Retapez le nouveau mot de passe :
passwd : mot de passe mis à jour avec succès
Modifier les informations associées à un utilisateur pour etu-nfs
Entrer la nouvelle valeur, ou appuyer sur ENTER pour la valeur par défaut
        NOM []: Etudiant NFS
        Numéro de chambre []:
        Téléphone professionnel []:
        Téléphone personnel []:
        Autre []:
Is the information correct? [Y/n]</screen>

    <para>Vérifiez que les identifiants <systemitem>UID/GID</systemitem> ont
    les mêmes valeurs que pour le compte créé sur le serveur.</para>

<screen>getent passwd etu-nfs</screen>
<screen>etu-nfs:x:1002:1002:Etudiant NFS,,,:/ahome/etu-nfs:/bin/bash</screen>
	</answer>
	</qandaentry>
    </qandaset>

    <para>Notez que les chemins qui désignent les répertoires utilisateurs des
    deux comptes sont aussi identiques. Le schéma de nommage entre client et
    serveur est cohérent.</para>

	<para>Les identifiants numériques <systemitem>UID/GID</systemitem> jouent
	un rôle important dans la suite des manipulations. Voir <xref
	linkend='sysadm-net.nfs.idmapd'/>.</para>
</sect2>

<sect2 xml:id='sysadm-net.nfs.client.autofs'>
	<title>Automatiser les montages/démontage NFS avec autofs</title>

    <para>Dans cette section, nous reprenons le processus de montage précédent
    en utilisant le service d'automontage. L'objectif est de rendre les
    opérations d'accès au système de fichiers réseau totalement transparentes
    pour l'utilisateur&nbsp;; le montage manuel doit donc être évité autant que
    possible.</para>

    <para>Plusieurs implémentations de ce service sont disponibles. Nous nous
    limiterons ici au logiciel utilisant les fonctions du noyau Linux.</para>

    <qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Quel est le paquet qui correspond au service d'automontage
    associé au noyau&nbsp;?</phrase></para>

    <para>Recherchez les mots clé <command>automount</command> et
    <literal>noyau</literal> dans les descriptions du gestionnaire de
    paquets.</para>

    <para>Installez le paquet identifié.</para>
	</question>
	<answer>
<screen>apt -o "Apt::Cmd::Disable-Script-Warning=1" \
  search automount noyau | cat</screen>
<screen>En train de trier…
Recherche en texte intégral…
autodir/testing 0.99.9-18+b1 amd64
  crée automatiquement les répertoires home et group pour les comptes LDAP/NIS/SQL et locaux

<emphasis>autofs</emphasis>/testing 5.1.9-1.2+b2 amd64
  <emphasis>montage automatique pour Linux basé sur le noyau</emphasis>

autofs-hesiod/testing 5.1.9-1.2+b2 amd64
  gestion de la carte Hesiod pour autofs

autofs-ldap/testing 5.1.9-1.2+b2 amd64
  gestion des schémas LDAP pour autofs</screen>

    <para>Installez le paquet <systemitem>autofs</systemitem>.</para>

<screen>sudo apt -y install autofs</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quels sont les fichiers de configuration du service
	d'automontage à éditer ou créer pour que l'utilisateur
	<systemitem>etu-nfs</systemitem> ait accès à ses données
	personnelles&nbsp;?</phrase></para>

    <para>Utilisez la catégorie 5 des pages de manuels du service
    <systemitem>autofs</systemitem> pour obtenir des exemples de
    configuration.</para>

<screen>man 5 autofs</screen>

    <para>Consultez aussi la page du fichier principal de configuration du
    service&nbsp;:<filename>/etc/auto.master</filename>.</para>

<screen>man auto.master</screen>
	</question>
	<answer>
    <para>Le montage indirect avec <systemitem>autofs</systemitem> consiste à
    créer un point de montage parent (par exemple <filename
    class='directory'>/ahome</filename>), sous lequel chaque sous-répertoire
    demandé (par exemple <filename class='directory'>/ahome/etu-nfs</filename>)
    est monté dynamiquement à la demande. Cette approche centralise la gestion
    des accès tout en restant flexible pour de nombreux partages. Dans notre
    contexte, les partages correspondent aux répertoires utilisateurs.</para>

    <para>Définissez la racine de montage <filename
    class='directory'>/ahome</filename> dans un fichier de configuration placé
    dans le dossier <filename class='directory'>/etc/auto.master.d/</filename>.
    Cette racine de montage pointe vers le fichier de configuration dédié au
    montage automatique des répertoires des utilisateurs.</para>

	<orderedlist>
	<listitem>
    <para>Créez le fichier
    <filename>/etc/auto.master.d/ahome.autofs</filename>.</para>

<screen>echo "/ahome  /etc/auto.home" | \
sudo tee /etc/auto.master.d/ahome.autofs</screen>
	</listitem>
	<listitem>
    <para>Créez le fichier <filename>/etc/auto.home</filename> contenant les
    attributs des montages dynamiques. Ce fichier utilise une syntaxe
    particulière permettant de monter le système de fichiers du serveur de
    manière générique, quel que soit le nombre de comptes utilisateurs.</para>

<screen>echo "*    -fstype=nfs4,hard    nfs-server:/home/&amp;" | \
sudo tee /etc/auto.home</screen>
	<itemizedlist>
	<listitem>
    <para>Le symbole <keycap>*</keycap> qui se substitue au nom
    d'utilisateur&nbsp;: <systemitem>etu-nfs</systemitem> dans notre
    exemple.</para>
	</listitem>
	<listitem>
	<para>Le paramètre <option>-fstype=nfs4</option> correspond à une
	option de montage qui privilégie la version 4 du protocole
	<acronym>NFS</acronym>.</para>
	</listitem>
    <listitem>
    <para>Le paramètre <option>hard</option> évite la perte de données en cas
    de déconnexion.</para>
    </listitem>
	<listitem>
    <para>Le nom <systemitem>nfs-server</systemitem> correspond à l'adresse
    <acronym>IP</acronym> enregistrée dans le fichier
    <filename>/etc/hosts</filename>.</para>
	</listitem>
	<listitem>
    <para>Le répertoire <filename class='directory'>/home/</filename>
    correspond à <link linkend='sysadm-net.nfs.server.exports'>l'exportation
    <acronym>NFS</acronym> sur le serveur.</link> Le répertoire <filename
    class='directory'>/home/</filename> est situé sous la racine d'exportation
    qui est uniquement connue du serveur.</para>
	</listitem>
	<listitem>
	<para>Le symbole <keycap>&amp;</keycap> indique la répétition du premier
	paramètre&nbsp;: le nom d'utilisateur.</para>
	</listitem>
	</itemizedlist>
	</listitem>
	<listitem>
    <para>Redémarrez le service pour prendre en compte les nouveaux fichiers de
    configuration.</para>

<screen>sudo systemctl restart autofs</screen>

    <para>Vérifiez l'état du service.</para>

<screen>systemctl status autofs</screen>
<screen>● autofs.service - Automounts filesystems on demand
     Loaded: loaded (/usr/lib/systemd/system/autofs.service; enabled; preset: enabled)
     Active: <emphasis>active (running)</emphasis> since Tue 2025-09-16 15:35:47 CEST; 12min ago
 Invocation: ef692b3649d94f6886ae130452e62ffd
       Docs: man:autofs(8)
    Process: 10230 ExecStart=/usr/sbin/automount $OPTIONS --pid-file /var/run/autofs.pid (code=exited, status=0/SUCCESS)
   Main PID: 10231 (automount)
      Tasks: 5 (limit: 973)
     Memory: 2.4M (peak: 3.5M)
        CPU: 81ms
     CGroup: /system.slice/autofs.service
             └─10231 /usr/sbin/automount --pid-file /var/run/autofs.pid

sept. 16 15:35:47 clnt systemd[1]: Starting autofs.service - Automounts filesystems on demand...
sept. 16 15:35:47 clnt (utomount)[10230]: autofs.service: Referenced but unset environment variable evaluates to an empty string: OPTIONS
sept. 16 15:35:47 clnt systemd[1]: Started autofs.service - Automounts filesystems on demand.</screen>

    <para>Le service est actif et aucune erreur de syntaxe n'a été détectée
    dans ses fichiers de configuration.</para>
	</listitem>
	</orderedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les conditions à respecter sur le client et le
	serveur <acronym>NFS</acronym> pour que l'utilisateur
	<systemitem>etu-nfs</systemitem> ait la capacité à écrire dans son
	répertoire personnel&nbsp;?</phrase></para>

	<para>Recherchez les attributs d'un compte utilisateur qui correspondent
	aux propriétés des objets d'un système de fichiers au sens général.</para>
	</question>
	<answer>

<screen>getent passwd etu-nfs</screen>
<screen>etu-nfs:x:1002:1002:Etudiant NFS,,,:/ahome/etu-nfs:/bin/bash</screen>

    <para>Les identifiants numériques <systemitem>UID/GID</systemitem> doivent
    nécessairement être identiques sur le client et le serveur
    <acronym>NFS</acronym>. Toute la gestion des droits sur le système de
    fichiers en dépend.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment valider le fonctionnement du service de montage
    dynamique des répertoires utilisateurs&nbsp;?</phrase></para>

    <para>Recherchez le moyen d'ouvrir une session avec l'identité de l'utilisateur
    <systemitem>etu-nfs</systemitem> pour utiliser son répertoire <filename
    class='directory'>/ahome/etu-nfs/</filename>.</para>

    <para>Vérifiez que le montage <acronym>NFS</acronym> est bien utilisé avec
    les commandes <command>mount</command> et <command>df</command> par
    exemple.</para>
	</question>
	<answer>
    <para>Comme lors du test effectué côté serveur, utilisez l'une des deux
    commandes suivantes pour prendre l'identité de l'utilisateur
    <systemitem>etu-nfs</systemitem>.</para>

    <itemizedlist>
    <listitem>
    <para><userinput>sudo login</userinput></para>
    </listitem>
    <listitem>
    <para><userinput>su - etu-nfs</userinput></para>
    </listitem>
    </itemizedlist>

    <para>Prenez l'identité de l'utilisateur
    <systemitem>etu-nfs</systemitem>.</para>

<screen>su - etu-nfs</screen>
<screen>Mot de passe :
etu-nfs@clnt:~$</screen>

    <para>Vérifiez que le répertoire courant est bien celui de
    l'utilisateur.</para>

<screen>pwd
/ahome/etu-nfs</screen>

    <para>Affichez les propriétés du montage <acronym>NFS</acronym>.</para>

<screen>mount | grep nfs</screen>
<screen>nfs-server:/home/etu-nfs on /ahome/etu-nfs type nfs4 (rw,relatime,vers=4.2,rsize=131072,wsize=131072,
    namlen=255,hard,fatal_neterrors=none,proto=tcp6,timeo=600,retrans=2,sec=sys,
    clientaddr=2001:678:3fc:65:baad:caff:fefe:6,local_lock=none,addr=2001:678:3fc:65:baad:caff:fefe:5)</screen>

    <para>Affichez les informations sur l'espace de stockage disponible.</para>

<screen>df -hT | grep nfs</screen>
<screen>nfs-server:/home/etu-nfs nfs4       118G    3,3G  109G   3% /ahome/etu-nfs</screen>
	</answer>
	</qandaentry>
    </qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.idmapd'>
	<title>Gérer les droits sur le système de fichiers NFS</title>

    <para>C'est le démon <systemitem>idmapd</systemitem> qui est utilisé avec
    <acronym>NFSv4.2</acronym> pour traduire les identifiants d'utilisateurs et
    de groupes entre serveurs et clients. À la différence des versions
    précédentes, <acronym>NFSv4</acronym> utilise des noms symboliques (du type
    user@domaine) plutôt que des <systemitem>UID/GID</systemitem> numériques.
    Ce démon assure donc la cohérence des permissions en associant correctement
    ces identités aux comptes locaux. Sans lui, les droits d'accès pourraient
    être incohérents, ce qui entraînerait des problèmes de sécurité et
    d'utilisation.</para>

    <para>De plus, un compte utilisateur <systemitem>etu-nfs</systemitem> avec
    les mêmes identifiants <systemitem>UID/GID</systemitem> existe sur le
    serveur et le client.</para>

<sect2 xml:id='sysadm-net.nfs.idmapd.hosts'>
	<title>Ajouter une résolution de noms d'hôtes basique</title>

    <para>Comme le démon <systemitem>idmapd</systemitem> utilise un nom de
    domaine, nous devons compléter la configuration du serveur et du client
    <acronym>NFS</acronym> pour avancer dans les tests.</para>

    <para>Le nom de domaine choisi pour ces manipulations est&nbsp;:
    <systemitem>lab.local</systemitem>.</para>

    <qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Comment compléter la configuration du client et du serveur
    <acronym>NFS</acronym> pour obtenir une résolution local de nom
    d'hôtes&nbsp;?</phrase></para>

    <para>Consultez les pages de manuels de la table de recherche statique des
    noms d'hôtes&nbsp;: <userinput>man hosts</userinput>.</para>

    <para>Codez un script qui ajoute les enregistrements du client et du
    serveur dans le fichier <filename>/etc/hosts</filename>.</para>
	</question>
	<answer>
    <para>En consultant les pages de manuels vous obtenez le format des deux
    enregistrements à insérer dans le fichier
    <filename>/etc/hosts</filename>.</para>

<screen>[IP address] [name] [name].[domain]</screen>

    <para>Créez un script qui ajoute les deux enregistrements du client et du
    serveur <acronym>NFS</acronym> en utilisant vos propres adresses.</para>

<screen><![CDATA[cat << 'EOF' > update-hosts.sh
#!/bin/bash

DOMAIN="lab.local"
HOSTS_FILE="/etc/hosts"
CLIENT_IP="2001:678:3fc:65:baad:caff:fefe:6"
CLIENT_NAME="nfs-client"
SERVER_IP="2001:678:3fc:65:baad:caff:fefe:5"
SERVER_NAME="nfs-server"

# Remove client previous record
if grep -q "${CLIENT_IP}" "${HOSTS_FILE}"; then
    sed -i "/${CLIENT_IP}.*/d" "${HOSTS_FILE}"
fi

echo "${CLIENT_IP} ${CLIENT_NAME} ${CLIENT_NAME}.${DOMAIN}" >> "${HOSTS_FILE}"

# Remove server previous record
if grep -q "${SERVER_IP}" "${HOSTS_FILE}"; then
    sed -i "/${SERVER_IP}.*/d" "${HOSTS_FILE}"
fi

echo "${SERVER_IP} ${SERVER_NAME} ${SERVER_NAME}.${DOMAIN}" >> "${HOSTS_FILE}"

exit 0
EOF

sudo bash update-hosts.sh]]></screen>

    <para>Exécutez ce code sur les deux hôtes client et serveur
    <acronym>NFS</acronym>.</para>

    <para>Vérifiez que la résolution des noms d'hôtes est fonctionnelle.</para>

<screen>for h in nfs-client nfs-server; do
    ping -qc3 $h
done</screen>
<screen>PING nfs-client (2001:678:3fc:65:baad:caff:fefe:6) 56 data bytes

--- nfs-client ping statistics ---
3 packets transmitted, 3 received, <emphasis>0% packet loss</emphasis>, time 2027ms
rtt min/avg/max/mdev = 0.478/5.423/15.125/6.860 ms
PING nfs-server (2001:678:3fc:65:baad:caff:fefe:5) 56 data bytes

--- nfs-server ping statistics ---
3 packets transmitted, 3 received, <emphasis>0% packet loss</emphasis>, time 2043ms
rtt min/avg/max/mdev = 0.031/0.048/0.058/0.012 ms</screen>
	</answer>
	</qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment compléter la configuration du démon
    <systemitem>idmapd</systemitem> pour utiliser le nom de domaine
    défini&nbsp;?</phrase></para>

    <para>Consultez les pages de manuels du démon (<userinput>man
    idmapd</userinput>) et identifiez le fichier de configuration à
    éditer.</para>

    <para>Ajoutez le nom de domaine <systemitem>lab.local</systemitem> dans le
    fichier de configuration et redémarrez le service sur le serveur
    <acronym>NFS</acronym>.</para>
    </question>
    <answer>
    <para>Le fichier de configuration à éditer est&nbsp;:
    <filename>/etc/idmapd.conf</filename>.</para>

    <para>Éditez le fichier en ajoutant le nom de domaine. Voici un
    exemple&nbsp;:</para>

<screen>[General]

Verbosity = 1
# set your own domain here, if it differs from FQDN minus hostname
# Domain = localdomain
Domain = lab.local

[Mapping]

Nobody-User = nobody
Nobody-Group = nogroup</screen>

    <para>Redémarrez le service sur le serveur <acronym>NFS</acronym>.</para>

<screen>sudo systemctl restart nfs-idmapd.service</screen>
<screen>systemctl status nfs-idmapd.service</screen>
<screen>● nfs-idmapd.service - NFSv4 ID-name mapping service
     Loaded: loaded (/usr/lib/systemd/system/nfs-idmapd.service; static)
     Active: <emphasis>active (running)</emphasis> since Thu 2025-09-18 09:04:52 CEST; 8s ago
 Invocation: b4c5fa9d86c94d58a5599d5bffa839ce
       Docs: man:idmapd(8)
    Process: 3574 ExecStart=/usr/sbin/rpc.idmapd (code=exited, status=0/SUCCESS)
   Main PID: 3576 (rpc.idmapd)
      Tasks: 1 (limit: 973)
     Memory: 512K (peak: 2M)
        CPU: 16ms
     CGroup: /system.slice/nfs-idmapd.service
             └─3576 /usr/sbin/rpc.idmapd

sept. 18 09:04:52 srvr systemd[1]: Starting nfs-idmapd.service - NFSv4 ID-name mapping service...
sept. 18 09:04:52 srvr rpc.idmapd[3576]: Setting log level to 1
sept. 18 09:04:52 srvr rpc.idmapd[3576]: <emphasis>libnfsidmap: using domain: lab.local</emphasis>
sept. 18 09:04:52 srvr rpc.idmapd[3576]: libnfsidmap: Realms list: 'LAB.LOCAL'
sept. 18 09:04:52 srvr rpc.idmapd[3576]: libnfsidmap: loaded plugin /usr/lib/x86_64-linux-gnu/libnfsidmap/nsswitch.so for method nsswitch
sept. 18 09:04:52 srvr systemd[1]: Started nfs-idmapd.service - NFSv4 ID-name mapping service.</screen>
    </answer>
    </qandaentry>
    </qandaset>
</sect2>

<sect2 xml:id='sysadm-net.nfs.idmapd.tests'>
    <title>Tester les identifiants et les échanges entre le serveur et le
    client NFS</title>

    <qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Comment créer des objets avec des valeurs
    <systemitem>UID/GID</systemitem> différentes de celles du compte
    <systemitem>etu-nfs</systemitem> dans son répertoire
    utilisateur&nbsp;?</phrase></para>

    <para>Créez des fichiers dans le répertoire utilisateur du compte
    <systemitem>etu-nfs</systemitem> sur le serveur et testez l'accès à ces
    mêmes fichiers sur le client.</para>

    <para>Utilisez la commande <command>chown</command> pour attribuer les
    valeurs <systemitem>UID/GID</systemitem>.</para>
	</question>
	<answer>
    <para>Placez vous côté serveur pour créer deux fichiers textes distincts.
    Le premier doit appartenir au compte <systemitem>etu-nfs</systemitem> et le
    second doit avoir des identifiants qui ne correspondent à aucun compte
    existant.</para>

    <orderedlist>
    <listitem>
    <para>Créez le fichier dont <systemitem>etu-nfs</systemitem> est
    propriétaire.</para>

<screen>echo "This file belongs to etu-nfs" | sudo tee /ahome/etu-nfs/ThisOneIsMine
sudo chown etu-nfs:etu-nfs /ahome/etu-nfs/ThisOneIsMine</screen>
    </listitem>
    <listitem>
    <para>Créez le fichier avec des identifiants
    &laquo;&nbsp;inconnus&nbsp;&raquo;.</para>

<screen>echo "This file belongs to no-one" | sudo tee /ahome/etu-nfs/ThisOneIs-NOT-Mine
sudo chown 2000:2000 /ahome/etu-nfs/ThisOneIs-NOT-Mine</screen>
    </listitem>
    </orderedlist>

    <para>Affichez la liste des objets contenus dans le répertoire utilisateur
    du compte <systemitem>etu-nfs</systemitem>.</para>

<screen>sudo ls -lh /ahome/etu-nfs/</screen>
<screen>total 12K
-rw-rw-r-- 1 etu-nfs etu-nfs 18 15 sept. 15:00 myTextFile
-rw-r--r-- 1 etu-nfs etu-nfs 29 18 sept. 14:19 ThisOneIsMine
-rw-r--r-- 1    2000    2000 28 18 sept. 14:25 ThisOneIs-NOT-Mine</screen>

    <para>Le fait que les valeurs <systemitem>UID/GID</systemitem>
    <literal>2000</literal> apparaissent sous forme numérique prouve qu'aucune
    identité connue du système n'est associée.</para>

	<para>Côté client, les objets créés sont biens visibles et la vue réseau du
	système de fichiers <acronym>NFS</acronym> passe par une correspondance des
	propriétaires.</para>

    <para>Placez vous maintenant côté client <acronym>NFS</acronym> et prenez
    l'identité <systemitem>etu-nfs</systemitem>.</para>

    <para>Vérifiez que le répertoire courant est celui de l'utilisateur
    <systemitem>etu-nfs</systemitem> et que les identifiants courants
    correspondent bien à cette identité.</para>

<screen>pwd</screen>
<screen>/ahome/etu-nfs</screen>

<screen>id</screen>
<screen>uid=1002(etu-nfs) gid=1002(etu-nfs) groupes=1002(etu-nfs),100(users)</screen>

    <para>Affichez la liste des objets présents dans ce répertoire et vérifiez
    qu'elle est identique à celle obtenue sur le serveur.</para>

<screen>ls -lh</screen>
<screen>total 12K
-rw-rw-r-- 1 etu-nfs etu-nfs 18 15 sept. 15:00 myTextFile
-rw-r--r-- 1 etu-nfs etu-nfs 29 18 sept. 14:19 ThisOneIsMine
-rw-r--r-- 1    2000    2000 28 18 sept. 14:25 ThisOneIs-NOT-Mine</screen>

    <para>Testez l'affichage et la modification du contenu des deux fichiers
    créés précédemment.</para>

    <orderedlist>
    <listitem>
    <para>Affichez et modifiez le premier fichier.</para>

<screen>cat ThisOneIsMine</screen>
<screen>This file belongs to etu-nfs</screen>

    <para>Ce fichier appartient bien à <systemitem>etu-nfs</systemitem> et
    cette identité a tous les droits sur cet objet.</para>

<screen>echo "ID etu-nfs owns it" >> ThisOneIsMine</screen>
<screen>cat ThisOneIsMine</screen>
<screen>This file belongs to etu-nfs
ID etu-nfs owns it</screen>

    <para>L'écriture dans le fichier s'est faite avec succès.</para>
    </listitem>
    <listitem>
    <para>Essayez d(afficher et de modifier le second fichier.</para>

<screen>cat ThisOneIs-NOT-Mine</screen>
<screen>This file belongs to no-one</screen>

    <para>L'affichage fonctionne puisque la lecture (bit 'r' le plus à droite
    du masque des permissions) est autorisée pour tout le monde.</para>

<screen>echo "ID etu-nfs is trying to edit this file" >>ThisOneIs-NOT-Mine
-bash: ThisOneIs-NOT-Mine: Permission non accordée</screen>

    <para>L'écriture échoue puisque seul l'utilisateur avec l'identifiant
    <literal>2000</literal> a le droit d'écriture.</para>
    </listitem>
    </orderedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment Réaliser une capture de trafic réseau côté serveur
    pendant que l'utilisateur génère un fichier texte assez volumineux dans son
    répertoire utilisateur&nbsp;?</phrase></para>

    <orderedlist>
    <listitem>
    <para>Lancez la capture de trafic côté serveur avec
    <command>tshark</command> en suivant la même méthode que lors des questions
    précédentes.</para>
    </listitem>
    <listitem>
    <para>Lancez une commande de création d'un fichier texte dans le répertoire
    utilisateur <filename class='directory'>/ahome/etu-nfs/</filename> côté
    client.</para>
    </listitem>
    <listitem>
    <para>Recherchez la syntaxe de la commande <command>tshark</command> qui
    permet d'extraire la charge utile de la capture de trafic
    <acronym>NFS</acronym>.</para>
    </listitem>
    <listitem>
    <para>Affichez le résultat de l'extraction de cette charge utile côté
    serveur.</para>
    </listitem>
    </orderedlist>
	</question>
    <answer>
    <para>Commencez par lancer la capture de trafic côté serveur.</para>

<screen>tshark -i enp0s1 -f "host 2001:678:3fc:65:baad:caff:fefe:6" -w nfs-payload.pcap</screen>

    <para>Passez côté client et lancer une commande de création de fichier
    texte.</para>

<screen>man man > man.txt</screen>

    <para>Revenez côté serveur et arrêtez la capture de trafic avec
    <keycap>Crtl+C</keycap>.</para>

    <para>Listez les trames capturées dans le fichier
    <filename>nfs-payload.pcap</filename>.</para>

<screen>tshark -r nfs-cat.pcap -Y nfs</screen>
<screen>tshark -r nfs-cat.pcap -Y nfs
    1 0.000000000 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 242 V4 Call ACCESS FH: 0xb51c8f4e, [Check: RD MD XT XE]
    2 0.000290656 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 194 V4 Reply (Call In 1) ACCESS, [Access Denied: XE], [Allowed: RD MD XT]
    4 0.001205086 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 250 V4 Call GETATTR FH: 0xb51c8f4e
    5 0.001456394 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 286 V4 Reply (Call In 4) GETATTR
    7 7.527683269 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 378 V4 Call OPEN DH: 0x8854dd26/man.txt
    8 7.529921152 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 450 V4 Reply (Call In 7) OPEN StateID: 0x0bf9
   10 7.578515596 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 250 V4 Call GETATTR FH: 0x8854dd26
   11 7.578658561 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 330 V4 Reply (Call In 10) GETATTR
   13 7.591854994 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 338 V4 Call OPEN DH: 0x8854dd26/fr.tmac
   14 7.591993162 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 186 V4 Reply (Call In 13) OPEN Status: NFS4ERR_NOENT
   15 7.593573743 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 342 V4 Call OPEN DH: 0x8854dd26/trans.tmac
   16 7.593714256 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 186 V4 Reply (Call In 15) OPEN Status: NFS4ERR_NOENT
   17 7.594754074 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 342 V4 Call OPEN DH: 0x8854dd26/latin9.tmac
   18 7.594834919 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 186 V4 Reply (Call In 17) OPEN Status: NFS4ERR_NOENT
   19 7.596065068 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 342 V4 Call OPEN DH: 0x8854dd26/hyphen.fr
   20 7.596201636 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 186 V4 Reply (Call In 19) OPEN Status: NFS4ERR_NOENT
   25 7.624835600 <emphasis>2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 10842 V4 Call WRITE StateID: 0x0e54 Offset: 0 Len: 39113</emphasis>
   27 7.628251090 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 274 V4 Reply (Call In 25) WRITE
   28 7.630402438 2001:678:3fc:65:baad:caff:fefe:6 → 2001:678:3fc:65:baad:caff:fefe:5 NFS 274 V4 Call CLOSE StateID: 0x0bf9
   29 7.630513322 2001:678:3fc:65:baad:caff:fefe:5 → 2001:678:3fc:65:baad:caff:fefe:6 NFS 266 V4 Reply (Call In 28) CLOSE</screen>

    <para>Dans l'exemple ci-dessus, on repère l'écriture d'un nombre d'octets
    assez important sur la trame numéro 25.</para>

    <para>Procédez à l'extraction de la charge utile contenue dans le fichier de capture.</para>

<screen>tshark -r nfs-cat.pcap -Y nfs -T fields -e nfs.data |\
    tr -d '\n:' |\
    xxd -r -ps > out.bin</screen>

    <para>Affichez les premières ligne du fichier d'extraction
    <filename>out.bin</filename>.</para>

<screen>head -n 10 out.bin</screen>
<screen>MAN(1)                 Utilitaires de l'afficheur des pages de manuel      MAN(1)

NOM
       man - Interface de consultation des manuels de référence du système

SYNOPSIS
       man [options de man] [[section] page ...] ...
       man -k [options d'apropos] expression_rationnelle ...
       man -K [options de man] [section] term ...
       man -f [options de whatis] page ...</screen>

    <para>C'est la catastrophe&nbsp;! Le trafic <acronym>NFS</acronym> entre le
    serveur et le client circule en clair sur le réseau et il vraiment très
    facile de l'intercepter.</para>
    </answer>
	</qandaentry>
    </qandaset>

    <para>Il est temps de passer à la sécurisation des échanges entre le
    serveur <acronym>NFS</acronym> et ses clients.</para>
    </sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.sec'>
	<title>Sécuriser les transactions NFS</title>

    <para>L'objectif des manipulations de cette section est d'offrir un niveau
    de protection élevé contre les tentatives d'interception de trafic et
    d'usurpation d'identité dans les échanges entre le serveur
    <acronym>NFS</acronym> et son client de test.</para>

    <para>La représentation graphique de la <xref
    linkend='sysadm-net.nfs.protocol' /> fait apparaître plusieurs briques de
    sécurité intégrées au protocole <acronym>NFSv4.2</acronym>. Nous devons
    choisir celles qui permettent d'atteindre un niveau de sécurité
    satisfaisant.</para>

    <sect2 xml:id='sysadm-net.nfs.sec.func'>
        <title>Choisir les outils de sécurisation</title>

    <para>Pour respecter les bonnes pratiques, nous devons utiliser le
    protocole <application>Kerberos V5</application>, qui permet d'établir une
    authentification mutuelle entre un client et un serveur avant la
    transmission des données du système de fichiers partagé.</para>

    <para>La configuration de <application>Kerberos V5</application> avec
    <acronym>NFSv4.2</acronym> nécessite&nbsp;:</para>
    <itemizedlist>
    <listitem>
    <para>Un serveur <acronym>KDC</acronym> (<wordasword>Key Distribution
    Center</wordasword>) correctement configuré.</para>
    </listitem>
    <listitem>
    <para>Des certificats et principaux de service appropriés pour le serveur
    <acronym>NFS</acronym>, le client et les utilisateurs.</para>
    </listitem>
    <listitem>
    <para>Une synchronisation temporelle précise entre tous les systèmes.</para>
    </listitem>
    </itemizedlist>

    <para>Les pages de manuel (<userinput>man 5 exports</userinput>) détaillent
    les paramètres de l'option <option>sec=</option>, suivie d'une liste de
    types de sécurité délimités par des deux-points. Cette option limite
    l'exportation aux clients utilisant ces types. Les types de sécurité
    disponibles sont les suivants&nbsp;:</para>

    <variablelist>
    <varlistentry>
    <term>sys</term>
    <listitem>
    <para>C'est cette valeur par défaut, sans sécurité cryptographique, qui a
    été utilisée pour toutes les manipulations des sections précédentes.
    L'interception du trafic avec l'outil <command>tshark</command> a révélé
    que les données contenues dans les échanges <acronym>NFS</acronym>
    pouvaient être lues par un tiers.</para>
    </listitem>
    </varlistentry>
    <varlistentry>
    <term>krb5</term>
    <listitem>
    <para>À ce niveau, seule l'authentification est assurée. La vérification
    cryptographique de l'identité des utilisateurs empêche toute
    usurpation.</para>
    </listitem>
    </varlistentry>
    <varlistentry>
    <term>krb5i</term>
    <listitem>
    <para>Cette option ajoute le contrôle d'intégrité à l'authentification. On
    s'assure ainsi que les données échangées n'ont pas été modifiées pendant
    leur transit.</para>
    </listitem>
    </varlistentry>
    <varlistentry>
    <term>krb5p</term>
    <listitem>
    <para>Il s'agit du niveau de sécurité le plus élevé, car il allie
    authentification, intégrité et confidentialité, garantissant ainsi que les
    données échangées restent secrètes.</para>
    </listitem>
    </varlistentry>
    </variablelist>

    <para>Pour la négociation du type de sécurité entre le serveur et les
    clients, l'ordre est important&nbsp;: les types préférés doivent être
    listés en premier.</para>

    <para>Le choix retenu pour la configuration à mettre en place est&nbsp;:
    <option>sec=krb5p</option>.</para>

    <para>L'API <acronym>GSS-API</acronym>, via le
    <wordasword>framework</wordasword> <acronym>RPCSEC_GSS</acronym>, fournit
    une abstraction des mécanismes de sécurité en offrant la possibilité
    d'utiliser différents protocoles (Kerberos, SPKM) via une interface
    unifiée. Elle permet également de négocier de manière transparente les
    capacités de sécurité entre le client et le serveur.</para>

    <para>Nous n'avons pas de choix de configuration à faire pour cette brique
    de la pile du protocole <acronym>NFSv4.2</acronym>.</para>

    <para>L'utilisation de TLS sur RPC (<wordasword>RPC-over-TLS</wordasword>
    selon la RFC 9289) en complément de <application>Kerberos</application>
    apporte des avantages considérables, avec une protection indépendante au
    niveau de la couche de transport&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>Le chiffrement au niveau de la couche transport protège tous les
    protocoles qui utilisent <acronym>RPC</acronym>, dont
    <application>rpcbind</application>.</para>
    </listitem>
    <listitem>
    <para>La protection contre les attaques de surveillance systématique et
    continue des flux réseau qui permettent d'exploiter les métadonnées.</para>
    </listitem>
    <listitem>
    <para>Le chiffrement opportuniste permettant la coexistence avec des
    systèmes non TLS.</para>
    </listitem>
    </itemizedlist>

    <para>Pour conclure cette partie, on aboutit à la répartition des rôles
    suivante&nbsp;:</para>

    <variablelist>
    <varlistentry>
        <term>TLS</term>
        <listitem>
        <para>Authentification des hôtes et chiffrement des appels
        <acronym>RPC</acronym> dans la couche transport.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Kerberos</term>
        <listitem>
        <para>Authentification des utilisateurs, chiffrement et contrôle
        d'accès des transactions <acronym>NFS</acronym>.</para>
        </listitem>
    </varlistentry>
    </variablelist>

    <para>Cette séparation permet de mettre en place une architecture de
    sécurité en profondeur plus robuste.</para>
    </sect2>

    <sect2 xml:id='sysadm-net.nfs.sec.conf'>
        <title>Modifier les configurations du serveur et du client</title>

    <para>Avant d'aborder la mise en place des outils de sécurité, commençons
    par adapter les configurations de l'exportation par le serveur et du
    service <application>autofs</application> du client.</para>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Quelles sont les modifications à apporter au fichier
    <filename>/etc/exports</filename> du serveur <acronym>NFS</acronym> pour
    activer les fonctions de sécurité choisies&nbsp;?</phrase></para>

    <para>Recherchez dans les pages de manuel les options à ajouter.</para>
	</question>
	<answer>
    <para>Consultez le manuel avec&nbsp;: <userinput>man 5 exports</userinput>
    et identifiez les paramètres utiles relativement aux choix retenus.</para>

    <para>Créez un nouveau script de génération du fichier
    <filename>/etc/exports</filename>.</para>

<screen><![CDATA[#!/bin/bash

IPV4_NETWORK=172.28.101.0/24
IPV6_NETWORK=2001:678:3fc:65::/64

cat << EOF > /etc/exports
/home/exports           ${IPV4_NETWORK}(rw,sync,fsid=0,crossmnt,no_subtree_check,sec=krb5p,xprtsec=tls:mtls)
/home/exports/home      ${IPV4_NETWORK}(rw,sync,no_subtree_check,sec=krb5p,xprtsec=tls:mtls)

/home/exports           ${IPV6_NETWORK}(rw,sync,fsid=0,crossmnt,no_subtree_check,sec=krb5p,xprtsec=tls:mtls)
/home/exports/home      ${IPV6_NETWORK}(rw,sync,no_subtree_check,sec=krb5p,xprtsec=tls:mtls)
EOF]]></screen>

    <para>Relativement à la configuration initiale, les deux options ajoutées
    sont&nbsp;:</para>

    <itemizedlist>
    <listitem>
    <para>sec=krb5p</para>
    </listitem>
    <listitem>
    <para>xprtsec=tls:mtls</para>
    </listitem>
    </itemizedlist>

    <para>Si le code du script ci-dessus est enregistré dans un fichier appelé
    <filename>secure-nfs-exports.sh</filename>, on peut lancer la création du
    nouveau fichier <filename>/etc/exports</filename>.</para>

    <para>Créez une copie de sauvegarde de la version actuelle du fichier
    <filename>/etc/exports</filename>.</para>

<screen>sudo cp /etc/exports /etc/exports.backup</screen>

    <para>Générez la nouvelle version du fichier de configuration de
    l'exportation.</para>

<screen>sudo bash secure-nfs-exports.sh</screen>

    <para>Redémarrez le service pour que la nouvelle configuration soit prise
    en charge.</para>

<screen>sudo systemctl restart nfs-server</screen>

    <para>Vérifiez que le service est bien actif et sans erreur de
    configuration.</para>

<screen>systemctl status nfs-server</screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
    <para><phrase>Quelles sont les modifications à apporter aux fichiers de
    configuration du service <application>autofs</application> du client
    <acronym>NFS</acronym> pour activer les fonctions de sécurité
    choisies&nbsp;?</phrase></para>

    <para>Recherchez dans les pages de manuel les options à ajouter.</para>
    </question>
    <answer>
    <para>Consultez les pages des manuels du service
    <application>autofs</application>. Par exemple&nbsp;: <userinput>man 5
    autofs</userinput>.</para>

    <para>Comme l'objectif est de reproduire le jeu d'options du serveur, on
    doit retrouver les mêmes éléments que dans la question précédente.</para>

    <para>Créez une copie de sauvegarde des fichiers actuels.</para>

<screen>sudo cp /etc/auto.master.d/ahome.autofs /etc/auto.master.d/ahome.autofs.backup</screen>

<screen>sudo cp /etc/auto.home /etc/auto.home.backup</screen>

    <para>Créez les nouvelles version de ces fichiers.</para>

<screen>echo "/ahome  /etc/auto.home --timeout=300" | \
    sudo tee /etc/auto.master.d/ahome.autofs</screen>

<screen>echo "*    -fstype=nfs4,hard,sec=krb5p,xprtsec=mtls,nosuid,nodev,_netdev    nfs-server.lab.local:/home/&amp;" | \
    sudo tee /etc/auto.home</screen>

    <para>On retrouve les mêmes options que sur le serveur auxquelles on a
    ajouté les paramètres suivants.</para>

    <itemizedlist>
    <listitem>
    <para><option>sec=krb5p</option>&nbsp;: version Kerberos présentée dans la
    section précédente.</para>
    </listitem>
    <listitem>
    <para><option>xprtsec=mtls</option>&nbsp;: authentification
    <acronym>TLS</acronym> mutuelle.</para>
    </listitem>
    <listitem>
    <para><option>nosuid</option>&nbsp;: désactive l'interprétation des bits
    <systemitem>SUID/SGID</systemitem>.</para>
    </listitem>
    <listitem>
    <para><option>nodev</option>&nbsp;: ignore les fichiers de
    périphériques.</para>
    </listitem>
    <listitem>
    <para><option>_netdev</option>&nbsp;: signale à
    <systemitem>systemd</systemitem> que le montage doit attendre que le réseau
    soit disponible.</para>
    </listitem>
    </itemizedlist>

    <para>Redémarrez le service pour que la nouvelle configuration soit prise
    en charge.</para>

<screen>sudo systemctl restart autofs</screen>

    <para>Vérifiez que le service est bien actif et sans erreur de
    configuration.</para>

<screen>systemctl status autofs</screen>
    </answer>
    </qandaentry>
    </qandaset>
    </sect2>

    <sect2 xml:id='sysadm-net.nfs.sec.krb5'>
        <title>Installer et configurer Kerberos</title>

    <para>Maintenant que les options d'exportation et de montage dynamiques
    doivent utiliser <application>Kerberos</application>, il faut configurer le
    serveur <acronym>KDC</acronym> et son client.  Les rôles serveur et client
    sont conservés&nbsp;: le serveur <acronym>NFS</acronym> est également le
    serveur <acronym>KDC</acronym>.</para>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Quels sont les paquets à installer pour configurer le serveur
    <acronym>KDC</acronym>&nbsp;?</phrase></para>

    <para>Recherchez la liste des paquets dont le nom débute par
    <literal>krb5</literal>.</para>
    </question>
    <answer>
    <para>Lancez la recherche avec le gestionnaire de paquets.</para>

<screen>apt search --names-only ^krb5</screen>

    <para>On obtient ainsi une liste d'une vingtaine de paquets. Affichez les
    informations de chaque paquet pour décider s'il faut le retenir dans le
    contexte d'un serveur <acronym>KDC</acronym>.</para>

<screen>apt show krb5-kdc | grep -A5 "This package"</screen>

<screen> This package contains the Kerberos key server (KDC).  The KDC manages all
 authentication credentials for a Kerberos realm, holds the master keys
 for the realm, and responds to authentication requests.  This package
 should be installed on both master and slave KDCs.</screen>

    <para>Répétez cette opération pour les autres paquets de la liste.</para>

    <para>Installez les paquets suivants&nbsp;:</para>

<screen>sudo apt install krb5-kdc krb5-admin-server krb5-user</screen>

    <para>Lors de l'installation de ces paquets, une série de questions
    apparaît. Voici ce qu'il faut saisir pour rester conforme au contexte de
    ces manipulations.</para>

    <itemizedlist>
    <listitem>
    <para><literal>Default Kerberos version 5 realm</literal>&nbsp;:
    <emphasis>LAB.LOCAL</emphasis></para>
    </listitem>
    <listitem>
    <para><literal>Kerberos servers for your realm</literal>&nbsp;:
    <emphasis>nfs-server.lab.local</emphasis></para>
    </listitem>
    <listitem>
    <para><literal>Administrative server for your Kerberos
    realm</literal>&nbsp;: <emphasis>nfs-server.lab.local</emphasis></para>
    </listitem>
    </itemizedlist>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment créer et définir le mot de passe d'administration du
    nouveau royaume Kerberos&nbsp;?</phrase></para>

    <para>Lancez une recherche dans les pages de manuels.</para>

    <para>recherchez les options de la commande <command>openssl</command> qui
    permettent de générer un mot de passe suffisamment solide.</para>
    </question>
    <answer>
    <para>Lancez une recherche par mot clé dans les pages de manuels.</para>

<screen>man -k kerberos | grep realm</screen>
<screen>krb5_newrealm (8)    - Create a new Kerberos Realm</screen>

<screen>man krb5_newrealm</screen>

    <para>Générez le mot de passe de l'administrateur Kerberos.</para>

<screen>openssl rand -base64 8 > krb-admin.password</screen>
<screen>chmod 600 krb-admin.password</screen>
<screen>cat krb-admin.password</screen>

    <para>Copiez le mot de passe et Lancez la commande
    <command>krb5_newrealm</command></para>

<screen>sudo sudo krb5_newrealm</screen>
<screen>This script should be run on the master KDC/admin server to initialize
a Kerberos realm.  It will ask you to type in a master key password.
This password will be used to generate a key that is stored in
/etc/krb5kdc/stash.  You should try to remember this password, but it
is much more important that it be a strong password than that it be
remembered.  However, if you lose the password and /etc/krb5kdc/stash,
you cannot decrypt your Kerberos database.
Initializing database '/var/lib/krb5kdc/principal' for realm 'LAB.LOCAL',
master key name 'K/M@LAB.LOCAL'
You will be prompted for the database Master Password.
It is important that you NOT FORGET this password.</screen>
<screen>Enter KDC database master key: <emphasis>Collez le mot de passe</emphasis></screen>
<screen>Re-enter KDC database master key to verify: <emphasis>Collez le mot de passe à nouveau</emphasis></screen>
<screen>Now that your realm is set up you may wish to create an administrative
principal using the addprinc subcommand of the kadmin.local program.
Then, this principal can be added to /etc/krb5kdc/kadm5.acl so that
you can use the kadmin program on other computers.  Kerberos admin
principals usually belong to a single user and end in /admin.  For
example, if jruser is a Kerberos administrator, then in addition to
the normal jruser principal, a jruser/admin principal should be
created.

Don't forget to set up DNS information so your clients can find your
KDC and admin servers.  Doing so is documented in the administration
guide.</screen>

    <para>Redémarrez le service <application>Kerberos</application>.</para>

<screen>sudo systemctl restart krb5-kdc</screen>

    <para>Vérifiez l'état du service.</para>

<screen>systemctl status krb5-kdc</screen>
    </answer>
    </qandaentry>

    </qandaset>
    </sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.refdocs'>
	<title>Documents de référence</title>

<variablelist>
	<varlistentry xml:id='sysadm-net.nfs.fs'>
    <term><citetitle>Systèmes de fichiers réseau</citetitle></term>
	<listitem>
	<para>&url.net-fs;&nbsp;: présentation des modes de fonctionnement des
	systèmes de fichiers réseau <acronym>NFS</acronym> &amp;
	<acronym>CIFS</acronym>.</para>
	</listitem>
	</varlistentry>

	<varlistentry xml:id='sysadm-net.nfs.howto'>
	<term><citetitle>Linux NFS-HOWTO</citetitle></term>
	<listitem>
	<para>&url.nfs.howto;&nbsp;: documentation historique complète sur la
	configuration  d'un serveur et d'un client <acronym>NFS</acronym> jusqu'à
	la version 3 inclue.</para>
	</listitem>
	</varlistentry>

	<varlistentry xml:id='sysadm-net.nfsv4.config'>
	<term><citetitle>Nfsv4 configuration</citetitle></term>
	<listitem>
	<para>&url.nfsv4.config;&nbsp;: traduction française extraite des pages du
	projet <acronym>CITI</acronym> de l'université du Michigan.</para>
	</listitem>
	</varlistentry>
</variablelist>
</sect1>
</article>
