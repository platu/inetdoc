<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE article [

<!ENTITY author		SYSTEM "author.xml">
<!ENTITY legal		SYSTEM "legal.xml">

<!ENTITY url.nfs.howto
    '<link xmlns="http://docbook.org/ns/docbook"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     xlink:href="http://nfs.sourceforge.net/nfs-howto/"><citetitle>Linux
     NFS-HOWTO</citetitle></link>'>

<!ENTITY url.nfsv4.config
    '<link xmlns="http://docbook.org/ns/docbook"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     xlink:href="https://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration_fr"><citetitle>Nfsv4
     configuration</citetitle></link>'>

<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.xml'>
%inetdoc_urls;

<!-- A copy of http://www.w3.org/2003/entities/2007/w3centities-f.ent is at:
/usr/local/share -->
<!ENTITY % w3centities-f PUBLIC "-//W3C//ENTITIES Combined Set//EN//XML"
	"/usr/local/share/w3centities-f.ent">
%w3centities-f;
]>

<article xmlns="http://docbook.org/ns/docbook" version="5.0"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xml:id="sysadm-net.nfs" xml:lang="fr">

<info>
	<title>Introduction au système de fichiers réseau NFSv4</title>

	&author;
	<abstract>
    <para>L'objectif de ce support de travaux pratiques est d'étudier le
    système de fichiers réseau <acronym>NFS</acronym>. Il illustre les accès en
    «&nbsp;mode fichier&nbsp;» à une unité de stockage réseau. Ce mode d'accès
    correspond à un stockage de type <acronym>NAS</acronym>
    (<wordasword>Network Attached Storage</wordasword>). Le document commence
    par l'étude du principe de fonctionnement des appels de fonctions
    <acronym>RPC</acronym> (<wordasword>Remote Procedure Call</wordasword>),
    puis se poursuit avec la configuration d'un serveur <acronym>NFS</acronym>
    qui exporte une arborescence de comptes utilisateurs. Côté client, les
    accès au système de fichiers réseau <acronym>NFS</acronym> sont étudiés
    selon deux modes distincts&nbsp;: le montage manuel, puis
    l'automontage.</para>
    </abstract>

    <keywordset>
    <keyword>NAS</keyword>
    <keyword>NFSv4</keyword>
    <keyword>autofs</keyword>
    <keyword>mount</keyword>
    <keyword>automount</keyword>
    <keyword>debian</keyword>
    <keyword>linux</keyword>
    <keyword>RPC</keyword>
    </keywordset>
</info>

<sect1 xml:id='sysadm-net.nfs.legal.meta'>
	&legal;
	<bridgehead xml:id='sysadm-net.nfs.meta'
	renderas='sect2'>Méta-information</bridgehead>

	<para>Ce document est écrit avec <link
	xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link>
	XML sur un système <link
	xlink:href="https://www.debian.org"><citetitle>Debian
	GNU/Linux</citetitle></link>. Il est disponible en version imprimable au
	format PDF&nbsp;: <link
	xlink:href="https://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>
</sect1>

<?custom-pagebreak?>
<sect1 xml:id='sysadm-net.nfs.plan'>
	<title>Topologie, scénario et plan d'adressage</title>

	<bridgehead xml:id='sysadm-net.nfs.logical-topology'
	renderas='sect2'>Topologie logique</bridgehead>

	<para>Les manipulations présentées dans ce support utilisent un domaine de
	diffusion unique (<acronym>VLAN</acronym>) dans lequel on trouve au moins
	deux systèmes virtuels ou physiques avec deux rôles distincts.</para>

	<itemizedlist>
	<listitem>
	<para>Le système <emphasis>serveur exporte</emphasis> une arborescence de
	son système de fichiers local vers les clients.</para>
	</listitem>
	<listitem>
    <para>Le ou les systèmes <emphasis>clients montent</emphasis> le système de
    fichiers réseau sur une arborescence locale.</para>
	</listitem>
	</itemizedlist>

<mediaobject>
	<imageobject role='fo'>
	<imagedata fileref='images/nfs-logical-topology.png' format='PNG' contentwidth='15cm' width='15.5cm'/>
	</imageobject>
	<imageobject role='html'>
	<imagedata fileref='images/nfs-logical-topology.png' format='PNG' contentwidth='700px' scalefit='1'/>
	</imageobject>
	<textobject>
	<phrase>Topologie logique</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.nfs.qa/images/nfs-logical-topology.png'>Topologie
	logique - vue complète</link></para>
	</caption>
</mediaobject>

	<bridgehead xml:id='sysadm-net.nfs.scenario'
	renderas='sect2'>Scénario</bridgehead>

    <para>Les manipulations décrites dans ce document illustrent les
    fonctionnalités offertes par le protocole <acronym>NFS</acronym>. Le
    séquencement des opérations à réaliser lors de la séance de travaux
    pratiques est décrit dans le tableau ci-dessous. Après le traitement de la
    première partie commune, les deux systèmes jouent un rôle distinct. Le rôle
    client accède à l'arborescence partagée ou exportée par le rôle
    serveur.</para>

	<table frame='all' pgwide='1'>
	<title>Attribution des rôles NFS</title>
	<tgroup cols='2' align='left' colsep='1' rowsep='1'>
	<colspec colnum='1' colname='c1' colwidth='1*'/>
	<colspec colnum='2' colname='c2' colwidth='1*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333"&nbsp;?>
		<?dbfo color="#fff"&nbsp;?>
	<entry>Client</entry>
	<entry>Serveur</entry>
	</row>
	</thead>
	<tbody>
	<row>
    <entry namest='c1' nameend='c2' align='center'>Identifiez du mécanisme des
    appels <acronym>RPC</acronym>. Installez et configurez les paquets
    communs.</entry>
	</row>
	<row>
    <entry>Identifiez des services disponibles sur le serveur. Créez un compte
    local sans répertoire utilisateur.</entry>
    <entry>Installez le paquet spécifique au serveur et configurez le service
    en fonction de l'arborescence à exporter.</entry>
	</row>
	<row>
    <entry namest='c1' nameend='c2' align='center'>Validez l'accès au système
    de fichiers réseau avec capture de trafic.</entry>
	</row>
	<row>
    <entry>Installez le paquet spécifique et configurez le service
    d'automontage des répertoires utilisateurs.</entry>
	<entry>&nbsp;</entry>
	</row>
	</tbody>
	</tgroup>
	</table>

    <para>De nombreuses questions peuvent être traitées à l'aide du document de
    référence &url.nfsv4.config; pour ces travaux pratiques. Il faut toutefois
    faire correspondre les configurations décrites dans ce document avec celles
    proposées par les paquets de la distribution Debian GNU/Linux.</para>

<?custom-pagebreak?>
	<bridgehead xml:id='sysadm-net.nfs.addressing'
	renderas='sect2'>Plan d'adressage</bridgehead>

	<para>Partant de la topologie présentée ci-dessus, on utilise un plan
	d'adressage pour chacun des rôles <acronym>iSCSI</acronym>.</para>

	<para>Le tableau ci-dessous correspond au plan d'adressage de la maquette
	qui a servi à traiter les questions des sections suivantes. Lors des
	séances de travaux pratiques, un plan d'adressage spécifique est fourni à
	chaque binôme d'étudiants. Il faut se référer au document
	&url.infra.moodle;.</para>

	<table xml:id='sysadm-net.nfs.mockup-addressing' frame='all' pgwide='1'>
        <title>Plan d'adressage de la maquette « Introduction au système de
        fichiers réseau NFSv4 »</title>
	<tgroup cols='4'>
	<colspec colnum='1' colwidth='1*'/>
	<colspec colnum='2' colwidth='1*'/>
	<colspec colnum='3' colwidth='3*'/>
	<colspec colnum='4' colwidth='1*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333"&nbsp;?>
		<?dbfo color="#fff"&nbsp;?>
		<entry>Rôle</entry>
		<entry>VLAN</entry>
		<entry>Adresses IP</entry>
		<entry>Interface tap</entry>
	</row>
	</thead>
	<tbody>
	<row>
		<entry>
		Client NFS
		</entry>
		<entry>101</entry>
		<entry>
		<systemitem class='ipaddress'>172.28.101.6/24</systemitem><?custom-linebreak?>
		<systemitem class='ipaddress'>2001:678:3fc:65:baad:caff:fefe:6/64</systemitem>
		</entry>
		<entry>6</entry>
	</row>
	<row>
		<entry>
		Serveur NFS
		</entry>
		<entry>101</entry>
		<entry>
		<systemitem class='ipaddress'>172.28.101.5/24</systemitem><?custom-linebreak?>
		<systemitem class='ipaddress'>2001:678:3fc:65:baad:caff:fefe:5/64</systemitem>
		</entry>
		<entry>5</entry>
	</row>
	</tbody>
	</tgroup>
	</table>

	<para>Avant de traiter les questions des sections suivantes, il faut
	rechercher dans le document &url.infra.moodle; les éléments nécessaires au
	raccordement des machines virtuelles ou physiques.</para>
</sect1>

<sect1 xml:id='sysadm-net.nfs.protocol'>
	<title>Protocole NFSv4</title>

	<para>Cette section reprend les éléments spécifiques au protocole
	<acronym>NFS</acronym> introduits lors de la présentation
	&url.net-fs;.</para>

    <para>Développé à l'origine par Sun Microsystems en 1984, le
    <wordasword>Network File System</wordasword> (<acronym>NFS</acronym>) est
    un protocole de système de fichiers distribué. Il permet de partager des
    fichiers de manière transparente entre les systèmes hôtes d'un réseau.
    Cette technologie s'est imposée comme un standard de fait dans le monde
    Unix pour l'accès aux fichiers distants dans les infrastructures
    d'entreprise.</para>

    <para>Plusieurs versions du protocole de système de fichiers réseau
    <acronym>NFS</acronym> sont disponibles. Chacune correspond à une
    «&nbsp;époque&nbsp;» ou à un cas d'usage. Le schéma ci-dessous illustre la
    répartition des fonctionnalités de la version 4 entre les espaces noyau et
    utilisateur.</para>

    <mediaobject>
	<imageobject role='fo'>
    <imagedata fileref='images/NFSv4.Schema.png' format='PNG' contentwidth='10cm' width='10.5cm'/>
    </imageobject>
	<imageobject role='html'>
    <imagedata fileref='images/NFSv4.Schema.png' format='PNG' contentwidth='640px' scalefit='1'/>
    </imageobject>
    <textobject>
    <phrase>Architecture NFSv4 Linux</phrase>
    </textobject>
	<caption>
    <para><link xmlns="http://docbook.org/ns/docbook"
    xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.nfs/images/.NFSv4.Schemapng'>Architecture
    NFS - vue complète</link></para>
	</caption>
    </mediaobject>

    <sect2 xml:id='sysadm-net.nfs.protocol.arch'>
    <title>Architecture NFSv4.2</title>

    <para><acronym>NFSv4.2</acronym> repose sur une architecture unifiée qui
    combine les espaces utilisateur et noyau, avec une communication
    strictement sur le port TCP/2049. Cette architecture inclut&nbsp;:</para>

    <variablelist>
    <varlistentry>
        <term>idmapd</term>
        <listitem>
        <para>Service d’association des identifiants utilisateurs (UID/GID)
        entre systèmes hétérogènes. Les UID/GID sont représentés sous forme de
        chaînes, ce qui garantit une indépendance totale des correspondances
        entre systèmes via le service idmapd.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>nfsd</term>
        <listitem>
        <para>Le démon serveur est traité dans le noyau. Il maintient pour
        chaque client une arborescence virtuelle cohérente. Il n'est donc plus
        nécessaire d'exporter les sous-arborescences séparément&nbsp;: tout
        point accessible permet la navigation sur tous les niveaux
        inférieurs.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>mount</term>
        <listitem>
        <para>Outil de montage du système de fichiers exporté.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>ACLs POSIX/NFS</term>
        <listitem>
        <para>Prise en charge native des contrôles d’accès.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>RPCSEC_GSS et Kerberos</term>
        <listitem>
        <para>Authentification cryptographique forte et protection contre
        l'usurpation.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Opérations composées (<wordasword>compound operations</wordasword>)</term>
        <listitem>
        <para>Le regroupement des opérations atomiques en une seule requête
        permet de réduire la latence et le trafic.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Copie côté serveur (<wordasword>Server-Side Copy</wordasword>)</term>
        <listitem>
        <para>NFSv4.2 permet de copier des fichiers directement sur le serveur,
        sans transiter par le client, ce qui élimine le trafic réseau redondant
        pour les opérations en volume
        (<wordasword>bulk-data</wordasword>).</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term><wordasword>Sparse Files</wordasword> et gestion avancée de
        l'espace</term>
        <listitem>
        <para>Le support natif des fichiers dispersés et les opérations
        ALLOCATE/DEALLOCATE optimisent la réservation et la dissémination de
        l'espace de stockage afin d'assurer une gestion efficace des
        ressources.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Parallélisation pNFS</term>
        <listitem>
        <para>Cette extension du protocole permet d'accéder de manière
        distribuée et simultanée aux données sur plusieurs serveurs ou chemins,
        assurant ainsi une évolutivité et des performances linéaires en
        fonction du nombre de serveurs et d'interfaces réseau.</para>
        </listitem>
    </varlistentry>
    </variablelist>
    </sect2>

    <sect2 xml:id='sysadm-net.nfs.protocol.sec'>
    <title>Sécurité NFSv4.2</title>

    <para>À l'instar de son concurrent, le système de fichiers SMB, la
    sécurisation des échanges de données en transit a beaucoup progressé. Voici
    une liste des fonctions les plus importantes&nbsp;:</para>

    <variablelist>
    <varlistentry>
        <term>Labeled NFS</term>
        <listitem>
        <para>Intégration native avec SELinux pour une gestion des labels de
        sécurité par fichier.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Chiffrement TLS&nbsp;: NFSv4.2 over TLS</term>
        <listitem>
        <para>Depuis 2022, il est possible d'utiliser le chiffrement TLS de
        bout en bout pour l'ensemble des communications NFS, grâce à la norme
        RPC-over-TLS (RFC 9289).</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>TLS 1.3 obligatoire</term>
        <listitem>
        <para>TLS 1.3 renforce la sécurité des communications en réduisant le
        nombre d'échanges nécessaires pour établir une session chiffrée. Il
        supprime les algorithmes obsolètes, limite les risques d'attaques et
        garantit une confidentialité accrue grâce au chiffrement des
        négociations.</para>
        </listitem>
    </varlistentry>
    <varlistentry>
        <term>Authentification par certificats x509</term>
        <listitem>
        <para>Certificats serveurs et clients pour l'identification mutuelle et
        le chiffrement de bout en bout.</para>
        </listitem>
    </varlistentry>
    </variablelist>
    </sect2>

    <sect2 xml:id='sysadm-net.nfs.protocol.innov'>
    <title>Adoption NFSv4.2 et innovations</title>

    <para>Le marché des systèmes de fichiers réseau affiche une croissance
    remarquable, avec un chiffre d'affaires évalué à 5,13 milliards de dollars
    en 2024, puis à 11,24 milliards de dollars en 2032, soit un taux de
    croissance annuel composé (TCAC) de 12,8 %. Cette expansion s'explique
    notamment par l'adoption massive du cloud computing. NFSv4.2 s'est imposé
    comme une solution de choix dans cet écosystème, avec une augmentation de
    28 % des déploiements NFS dans les environnements cloud d'une année sur
    l'autre en 2023. Les principaux fournisseurs de services cloud, comme
    Amazon Web Services (AWS) avec EFS, Microsoft Azure avec ses
    implémentations NFS ou encore Google Cloud Platform avec Filestore, ont
    massivement adopté NFSv4.2 pour leurs offres de stockage géré.</para>

    <para>NFSv4.2 révolutionne les cas d'usage traditionnels grâce à ses
    capacités parallèles avec pNFS (Parallel NFS), qui sont particulièrement
    adaptées aux charges de travail d'intelligence artificielle et de calcul
    haute performance. Le protocole trouve de nouveaux débouchés dans
    l'orchestration de conteneurs avec Kubernetes, où il s'intègre nativement
    via les StorageClass pour fournir un stockage dynamique partagé.</para>
    </sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.common'>
    <title>Configurer les fonctions communes au client et au serveur
    NFS</title>

    <para>Plusieurs services communs doivent être actifs pour que les accès au
    système de fichiers réseau <acronym>NFS</acronym> soient utilisables. Le
    mécanisme de gestion des appels de procédures distantes, appelé
    <acronym>RPC</acronym> pour <wordasword>Remote Procedure Call</wordasword>,
    constitue le point de départ de la mise en œuvre de ces services.</para>

<sect2 xml:id='sysadm-net.nfs.common.rpc'>
	<title>Gérer des appels RPC</title>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Quel est le paquet qui fournit le service de gestion des
    appels de procédure distants RPC&nbsp;?.</phrase></para>

    <para>Recherchez les noms de paquets qui contiennent la chaîne
    'rpc'. Installez le paquet identifié.</para>
	</question>
	<answer>
<screen>apt search --names-only ^rpc</screen>
<screen><emphasis>rpcbind</emphasis>/testing,now 1.2.7-1 amd64 [installé, automatique]
  conversion de numéros de programmes RPC en adresses universelles

rpcsvc-proto/testing,now 1.4.3-1 amd64 [installé, automatique]
  RPC protocol compiler and definitions</screen>

    <para>À la lecture de la liste ci-dessus, c'est le paquet
    <application>rpcbind</application> qu'il faut installer.</para>

<screen>sudo apt install rpcbind</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Quel est le numéro de port utilisé par le service&nbsp;?
    Comment fonctionne le service en écoute sur ce numéro de
    port&nbsp;?</phrase></para>

	<itemizedlist>
	<listitem>
    <para>Listez les processus actifs sur le système dont le nom contient la
    chaîne 'rpc'.</para>
	</listitem>
	<listitem>
	<para>Affichez le numéro de port en écoute correspondant à ce service.</para>
	</listitem>
	<listitem>
    <para>Consultez les pages de manuels de la commande
    <command>rpcbind</command>.</para>
	</listitem>
	</itemizedlist>
	</question>
	<answer>
	<itemizedlist>
	<listitem>
    <para>Listez des processus actifs en isolant la chaîne
    <literal>'rpcbind'</literal>.</para>

<screen>pgrep -a rpcbind</screen>
<screen>514 /usr/sbin/rpcbind -f -w</screen>
	</listitem>
	<listitem>
    <para>Identifiez le ou les numéros de ports en écoute en utilisant les
    commandes <command>lsof</command> et/ou <command>ss</command>.</para>

    <para>Commençons par la commande <command>lsof</command>&nbsp;:</para>

<screen>sudo apt install lsof</screen>

<screen>sudo lsof -i | grep rpc[b]ind
rpcbind   2096        _rpc    4u  IPv4  18957      0t0  TCP *:sunrpc (LISTEN)
rpcbind   2096        _rpc    5u  IPv4    713      0t0  UDP *:sunrpc
rpcbind   2096        _rpc    6u  IPv6   1752      0t0  TCP *:sunrpc (LISTEN)
rpcbind   2096        _rpc    7u  IPv6  20601      0t0  UDP *:sunrpc</screen>

	<para>On obtient la correspondance entre numéro de port et nom de service
	en consultant le fichier <filename>/etc/services</filename>.</para>

<screen>grep sunrpc /etc/services
sunrpc          111/tcp         portmapper      # RPC 4.0 portmapper
sunrpc          111/udp         portmapper</screen>

	<para>Le principe de fonctionnement des appels de procédure distants veut
	que tous ces appels soient reçus sur un numéro de port unique&nbsp;:
	<literal>sunrpc/111</literal>. Ces appels, une fois identifiés, sont
	transmis aux programmes concernés pour être traités.</para>
	</listitem>
	<listitem>
	<para>Les pages de manuels des applications utilisées.</para>

<screen>man rpcbind</screen>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est a commande qui permet de lister les services
	accessibles via un appel <acronym>RPC</acronym>&nbsp;? À quel paquet
	appartient cette commande&nbsp;?</phrase></para>

	<para>Rechercher dans le support &url.nfs.howto; et dans la liste des
	fichiers du paquet sélectionné pour la gestion des appels
	<acronym>RPC</acronym>.</para>
	</question>
	<answer>
	<para>La commande présentée dans le support &url.nfs.howto; est appelée
	<command>rpcinfo</command>. On vérifie sa présence sur le système étudié de
	la façon suivante.</para>

<screen>dpkg -S $(which rpcinfo)
rpcbind: /usr/sbin/rpcinfo</screen>

	<para>C'est l'option <option>-s</option> qui permet d'obtenir la
	présentation la plus synthétique des services accessibles par appel
	<acronym>RPC</acronym>.</para>

<screen>rpcinfo -s
   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser</screen>

	<para>La copie d'écran ci-dessus montre que le gestionnaire d'appel
	<systemitem>portmapper</systemitem> est le seul service ouvert. On relève
	l'ordre de priorité des différentes versions du service supportées par le
	système ainsi que les versions des protocoles de couche transport.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Donner deux exemples d'exécution de la commande pour lister
	le(s) service(s) ouvert sur le système local puis sur le système
	voisin.</phrase></para>

	<para>Reprendre la commande utilisée dans la question précédente en
	indiquant l'adresse <acronym>IPv4</acronym> ou <acronym>IPv6</acronym> du
	système voisin.</para>
	</question>
	<answer>
	<para>L'exemple d'exécution de la commande en local est donné dans la copie
	d'écran de la question précédente. Pour connaître les services accessibles
	sur un autre poste, on utilise la même commande suivie de l'adresse
	<acronym>IP</acronym> de cet hôte.</para>

<screen>rpcinfo -s 192.168.51.194
   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser</screen>

<screen>rpcinfo -s fe80::baad:caff:fefe:2
   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser</screen>

	<para>Ces copies d'écran montrent la même liste de paramètres que lors de
	l'exécution de la commande en local. Les configurations sur les deux hôtes
	sont donc identiques à ce stade de la configuration.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Réaliser une capture à l'aide de l'analyseur réseau lors de
	l'exécution de la commande et relever&nbsp;: le protocole de transport
	utilisé, les numéros de ports caractéristiques de cette transaction ainsi
	que le nom de la procédure <acronym>RPC</acronym> utilisée.</phrase></para>

<screen>système 1                                       système 2
----------------------------------------------------------
 &lt;commande&gt;       --- requête ---&gt;            &lt;processus&gt;

                  &lt;-- réponse ----</screen>
	</question>
	<answer>
	<para>Voici un exemple de capture en mode console qui donne les éléments
	demandés.</para>

<note>
	<para>Pour effectuer des captures de trafic réseau en mode console, on
	dispose de deux applications&nbsp;: <application>tshark</application> et
	<application>termshark</application>. Pour limiter les dimensions des
	copies d'écran, on privilégie l'utilisation de
	<application>tshark</application>.</para>

	<para>Pour utiliser l'une ou l'autre des deux applications en tant
	qu'utilisateur normal, il est nécessaire d'appartenir au groupe
	<systemitem>wireshark</systemitem>. Pour ajouter le compte
	<systemitem>etu</systemitem> au groupe système, on exécute l'instruction
	<userinput>sudo adduser etu wireshark</userinput>. Il ne faut pas oublier
	de se déconnecter puis se reconnecter pour bénéficier de l'attribution au
	groupe.</para>
</note>

	<para>Pour une requête <acronym>IPv4</acronym>, on obtient&nbsp;:</para>

<screen>tshark -i enp0s1
Capturing on 'enp0s1'
192.168.51.195 → 192.168.51.194 TCP 74 53284 → 111 [SYN] Seq=0
192.168.51.194 → 192.168.51.195 TCP 74 111 → 53284 [SYN, ACK] Seq=0 Ack=1
192.168.51.195 → 192.168.51.194 TCP 66 53284 → 111 [ACK] Seq=1 Ack=1
192.168.51.195 → 192.168.51.194 Portmap 110 V3 DUMP Call
192.168.51.194 → 192.168.51.195 TCP 66 111 → 53284 [ACK] Seq=1 Ack=45
192.168.51.194 → 192.168.51.195 Portmap 754 V3 DUMP Reply (Call In 4)
192.168.51.195 → 192.168.51.194 TCP 66 53284 → 111 [ACK] Seq=45 Ack=689
192.168.51.195 → 192.168.51.194 TCP 66 53284 → 111 [FIN, ACK] Seq=45 Ack=689
192.168.51.194 → 192.168.51.195 TCP 66 111 → 53284 [FIN, ACK] Seq=689 Ack=46
192.168.51.195 → 192.168.51.194 TCP 66 53284 → 111 [ACK] Seq=46 Ack=690</screen>

	<para>Pour une requête <acronym>IPv6</acronym> avec l'adresse unique, on
	obtient&nbsp;:</para>

<screen>tshark -i enp0s1
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 TCP 94 51134 → 111 [SYN] Seq=0
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 94 111 → 51134 [SYN, ACK] Seq=0 Ack=1
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 TCP 86 51134 → 111 [ACK] Seq=1 Ack=1
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 Portmap 130 V3 DUMP Call
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 111 → 51134 [ACK] Seq=1 Ack=45
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 Portmap 774 V3 DUMP Reply (Call In 4)
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 TCP 86 51134 → 111 [ACK] Seq=45 Ack=689
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 TCP 86 51134 → 111 [FIN, ACK] Seq=45 Ack=689
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 111 → 51134 [FIN, ACK] Seq=689 Ack=46
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 TCP 86 51134 → 111 [ACK] Seq=46 Ack=690</screen>

	<itemizedlist>
	<listitem>
	<para>Le protocole de couche transport utilisé est
	<acronym>TCP</acronym>.</para>
	</listitem>
	<listitem>
	<para>Le numéro de port utilisé correspond bien au service enregistré
	<systemitem>sunrpc/111</systemitem>.</para>
	</listitem>
	<listitem>
	<para>Le sous-programme distant appelé est&nbsp;: <option>Portmap V3
	DUMP Call</option>.</para>
	</listitem>
	</itemizedlist>

	<para>Pour une requête <acronym>IPv6</acronym> avec l'adresse de lien
	local, on obtient&nbsp;:</para>

<screen>tshark -i enp0s1 -f "! port 22"
Capturing on 'enp0s1'
    1 0.000000000 fe80::baad:caff:fefe:3 → fe80::baad:caff:fefe:2 Portmap 102 V3 DUMP Call
    2 0.000265556 fe80::baad:caff:fefe:2 → fe80::baad:caff:fefe:3 Portmap 746 V3 DUMP Reply (Call In 1)
2 packets captured</screen>

	<para>Ici, le protocole de couche transport utilisé est
	<acronym>UDP</acronym>. Comme <acronym>UDP</acronym> est non orienté
	connexion, on ne relève aucune trace d'ouverture ou de fermeture de
	connexion.</para>

	<para>On remarque que la copie d'écran ci-dessus utilise une syntaxe de
	capture qui permet de filtrer tous les segments qui font appel au port
	numéro <option>22</option> qui correspond au service
	<acronym>SSH</acronym>.</para>

<screen>tshark -i enp0s1 -f "! port 22"</screen>

	<para>Pour exploiter toutes les informations du trafic capturé, il est
	conseillé de stocker les résultats dans un fichier à l'aide de la syntaxe
	suivante.</para>

<screen>tshark -i enp0s1 -f "! port 22" -w /var/tmp/rpcbind.pcap
Capturing on 'enp0s1'
3 ^C</screen>

	<para>Dans ce dernier cas, seul le compte des trames capturées apparaît à
	la console.</para>

	<para>On peut alors transférer le fichier de capture via la commande
	<command>scp</command> pour une exploitation via l'interface graphique de
	<application>Wireshark</application> ou afficher les détails directement à
	la console. Dans l'exemple ci-dessous, on affiche toutes les informations
	relatives à la première trame capturée.</para>

<screen>tshark -r /var/tmp/rpcbind.pcap -V -Y "frame.number == 1"</screen>
	</answer>
	</qandaentry>
	</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.nfs.common.statd'>
	<title>Gestion des paquets NFS</title>

	<qandaset defaultlabel='number' xml:id='sysadm-net.nfs.common-package'>
	<qandaentry xml:id='sysadm-net.nfs.synthese.nfs-common-package'>
	<question>
	<para><phrase>Quel est le paquet commun au client et au serveur&nbsp;?
	Identifier le jeu de commandes fournies par ce paquet.</phrase></para>

	<para>Rechercher dans la liste des paquets disponibles, ceux dont le nom
	débute par <option>nfs</option>.</para>
	</question>
	<answer>
<screen>aptitude search ?name"(^nfs)" | grep -v ganesha
v  nfs-client -
p  <emphasis>nfs-common</emphasis> - NFS support files common to client and server
p  nfs-kernel-server - support for NFS kernel server
v  nfs-server -
p  nfs4-acl-tools - Commandline and GUI ACL utilities for the NFSv4 client
p  nfstrace - NFS tracing/monitoring/capturing/analyzing tool
p  nfstrace-doc - NFS tracing/monitoring/capturing/analyzing tool (documentation)
p  nfswatch - Program to monitor NFS traffic for the console</screen>

	<para>Dans la liste ci-dessus, on identifie le paquet
	<systemitem>nfs-common</systemitem> qui correspond bien aux fonctions
	communes au client et au serveur <acronym>NFS</acronym>.</para>

<screen>sudo apt install nfs-common</screen>

	<para>Une fois le paquet installé, la liste des programmes fournis par ce
	paquet est extraite de la liste de ses fichiers à l'aide de la commande
	suivante.</para>

<screen>dpkg -L nfs-common | grep bin
/sbin
/sbin/mount.nfs
/sbin/osd_login
/sbin/rpc.statd
/sbin/showmount
/sbin/sm-notify
/usr/sbin
/usr/sbin/blkmapd
/usr/sbin/mountstats
/usr/sbin/nfsidmap
/usr/sbin/nfsiostat
/usr/sbin/nfsstat
/usr/sbin/rpc.gssd
/usr/sbin/rpc.idmapd
/usr/sbin/rpc.svcgssd
/usr/sbin/rpcdebug
/usr/sbin/start-statd
/sbin/mount.nfs4
/sbin/umount.nfs
/sbin/umount.nfs4</screen>

	<para>Dans cette liste, on trouve les commandes de montage, de démontage et
	de suivi d'état du système de fichiers réseau.</para>
	</answer>
	</qandaentry>
	</qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.server'>
	<title>Configuration du serveur NFS</title>

	<para>Le rôle du serveur <acronym>NFS</acronym> est de mettre à disposition
	sur le réseau une partie de son arborescence locale de système de fichiers.
	On parle d'«exportation».</para>

<note>
	<para>Il existe plusieurs implémentations libres de serveur
	<acronym>NFS</acronym>. On se limite ici à l'utilisation du logiciel lié au
	noyau Linux.</para>
</note>

<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
	<para><phrase>Quel est le paquet qui contient les outils nécessaires au
	fonctionnement du serveur <acronym>NFS</acronym>&nbsp;? Installez ce
	paquet.</phrase></para>

	<para>Interroger les méta données du gestionnaire de paquets pour
	identifier le nom du paquet à installer.</para>
	</question>
	<answer>
	<para>La recherche des mots clés <option>nfs</option> et
	<option>server</option> donne les résultats suivants.</para>

<screen>aptitude search '?and(nfs, server)'
p   <emphasis>nfs-kernel-server</emphasis>      - support for NFS kernel server
v   nfs-server</screen>

	<para>Les informations données par la commande
	<userinput>apt show nfs-kernel-server</userinput>
	permettent de confirmer qu'il s'agit bien du paquet à installer.</para>

<screen>sudo apt -y install nfs-kernel-server</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est le fichier de configuration principal de gestion des
	exportations <acronym>NFS</acronym>&nbsp;?</phrase></para>

	<para>Rechercher dans le support &url.nfs.howto;.</para>
	</question>
	<answer>
	<para>Quelles que soient les versions du protocole, c'est toujours le
	fichier <filename>/etc/exports</filename> qui est utilisé. Ce fichier est
	présenté dans le support &url.nfs.howto;. Le fichier livré avec le paquet
	contient, en commentaires, deux exemples complets de configuration
	<acronym>NFSv3</acronym> et <acronym>NFSv4</acronym>. C'est ce dernier
	exemple que l'on adapte pour traiter les questions suivantes.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.nfs.server.exports'>
	<question>
	<para><phrase>Créer le répertoire <filename
	class='directory'>/home/exports/home</filename>. Quelles sont les
	instructions d'exportation à ajouter au fichier de configuration pour ce
	répertoire&nbsp;?</phrase></para>

	<para>Rechercher dans les supports &url.nfs.howto; et &url.nfsv4.config;.
	On peut aussi utiliser les pages de manuels fournies avec le paquet du
	serveur <acronym>NFS</acronym>.</para>
	</question>
	<answer>
	<para>En exploitant la documentation &url.nfsv4.config; et l'exemple donné
	dans le fichier de configuration, on applique les instructions de
	configuration suivantes dans le fichier
	<filename>/etc/exports</filename>.</para>

<screen>sudo mkdir -p /home/exports/home</screen>

<screen>cat &lt;&lt; EOF | sudo tee -a /etc/exports
/home/exports           192.168.51.192/27(rw,sync,fsid=0,crossmnt,no_subtree_check)
/home/exports/home      192.168.51.192/27(rw,sync,no_subtree_check)
EOF</screen>

<screen>cat &lt;&lt; EOF | sudo tee -a /etc/exports
/home/exports           2001:678:3fc:1f5::/64(rw,sync,fsid=0,crossmnt,no_subtree_check)
/home/exports/home      2001:678:3fc:1f5::/64(rw,sync,no_subtree_check)
EOF</screen>

	<para>Bien sûr, les adresses des réseaux <acronym>IPv4</acronym> et/ou
	<acronym>IPv6</acronym> doivent être adaptées au contexte.</para>

	<para>Les options entre parenthèses sont documentées dans les pages de
	manuels <systemitem>exports</systemitem>&nbsp;: <userinput>man 5
	exports</userinput>. Les éléments de la liste suivante sont extraits de
	cette documentation.</para>

	<itemizedlist>
	<listitem>
	<para><literal>rw</literal>&nbsp;: autoriser les requêtes en lecture et en
	écriture sur le volume <acronym>NFS</acronym>. Le comportement par défaut
	est d'interdire toute requête qui modifierait le système de
	fichiers.</para>
	</listitem>
	<listitem>
	<para><literal>sync</literal>&nbsp;: ne répondre aux requêtes qu'après
	l'exécution de tous les changements sur le support réel.</para>
	</listitem>
	<listitem>
	<para><literal>fsid=0</literal>&nbsp;: avec NFSv4, un système de
	fichiers particulier est la racine de tous les systèmes de fichiers
	partagés. Il est défini par fsid=root ou fsid=0, qui veulent tous deux
	dire exactement la même chose.</para>
	</listitem>
	<listitem>
	<para><literal>crossmnt</literal>&nbsp;: cette option permet aux
	clients de se déplacer du système de fichiers marqué
	<literal>crossmnt</literal> aux systèmes de fichiers partagés montés
	dessus. Voir l'option <acronym>nohide</acronym>.</para>
	</listitem>
	<listitem>
	<para><literal>no_subtree_check</literal>&nbsp;: cette option neutralise la
	vérification de sous-répertoires, ce qui a des subtiles implications au
	niveau de la sécurité, mais peut améliorer la fiabilité dans certains cas.
	Si un sous-répertoire dans un système de fichiers est partagé, mais que le
	système de fichiers ne l'est pas, alors chaque	fois qu'une requête
	<acronym>NFS</acronym> arrive, le serveur doit non seulement vérifier que
	le fichier accédé est dans le système de fichiers approprié (ce qui est
	facile), mais aussi qu'il est dans l'arborescence partagée (ce qui est plus
	compliqué). Cette vérification s'appelle subtree_check.</para>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.nfs.server.service'>
	<question>
	<para><phrase>Comment rendre la configuration d'exportation
	<acronym>NFS</acronym> effective&nbsp;? Comment vérifier que les paramètres
	actifs sont corrects&nbsp;?</phrase></para>

	<para>Rechercher dans la liste des outils fournis avec le paquet
	<systemitem>nfs-kernel-server</systemitem> la commande qui permet de
	connaître l'état courant des exportations <acronym>NFS</acronym>.</para>
	</question>
	<answer>
	<para>On identifie la commande <command>exportfs</command> dans la liste
	des binaires fournis avec le paquet serveur <acronym>NFS</acronym>.</para>

<screen>dpkg -L nfs-kernel-server | grep bin
/sbin
/sbin/nfsdcltrack
/usr/sbin
<emphasis>/usr/sbin/exportfs</emphasis>
/usr/sbin/rpc.mountd
/usr/sbin/rpc.nfsd</screen>

	<para>Après chaque modification d'un fichier de configuration, il ne faut
	surtout pas oublier de relancer le service correspondant.</para>

<screen>sudo systemctl restart nfs-kernel-server</screen>

<screen>systemctl status nfs-kernel-server
● nfs-server.service - NFS server and services
     Loaded: loaded (/lib/systemd/system/nfs-server.service; enabled; vendor preset: enabled)
     Active: <emphasis>active</emphasis> (exited) since Sun 2021-08-29 15:47:25 CEST; 10s ago
    Process: 7699 ExecStartPre=/usr/sbin/exportfs -r (code=exited, status=0/SUCCESS)
    Process: 7700 ExecStart=/usr/sbin/rpc.nfsd $RPCNFSDARGS (code=exited, status=0/SUCCESS)
   Main PID: 7700 (code=exited, status=0/SUCCESS)
        CPU: 8ms

août 29 15:47:24 server-nfs systemd[1]: Starting NFS server and services...
août 29 15:47:25 server-nfs systemd[1]: Finished NFS server and services.</screen>

	<para>Enfin, on consulte la liste des entrées exportées via <acronym>NFS</acronym>.</para>

<screen>sudo exportfs
/home/exports   192.168.51.192/27
/home/exports   2001:678:3fc:1f5::/64
/home/exports/home
                192.168.51.192/27
/home/exports/home
                2001:678:3fc:1f5::/64</screen>

	<para>Cette dernière liste est identique à celle produite par la commande
	<command>showmount</command> côté client <acronym>NFS</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.nfs.server.local-mount'>
	<question>
	<para><phrase>Qu'est-ce qui distingue l'exportation d'une arborescence
	entre les versions 3 et 4 du protocole
	<acronym>NFS</acronym>&nbsp;?</phrase></para>

	<para>Rechercher dans les différences relatives à la notion de nommage dans
	les manipulations proposées dans les supports &url.nfs.howto; et
	&url.nfsv4.config;.</para>

	<para>Donner la signification du paramètre <option>fsid=0</option> dans la
	documentation relative à la version 4. Proposer une analogie avec le
	fonctionnement d'un serveur Web.</para>
	</question>
	<answer>
	<para>Au delà des évolutions du protocole, c'est la cohérence du système de
	nommage qui distingue la version 4 du système de fichiers réseau. Il s'agit
	de garantir qu'un objet (fichier ou répertoire) soit représenté de la même
	manière sur un serveur et sur ses clients.</para>

	<para>Dans le contexte de ces travaux pratiques les répertoires
	utilisateurs doivent être référencés à partir d'une racine nommée <filename
	class='directory'>/ahome/</filename>.</para>

	<para>Du point de vue infrastructure, l'utilisation de cette référence de
	nommage unique présente un avantage non négligeable. En effet, les
	répertoires d'exportation tels qu'ils ont été définis dans le fichier
	<filename>/etc/exports</filename> donné ci-dessus désignent un espace de
	stockage physique.</para>

	<para>La racine <filename class='directory'>/ahome/</filename>
	désigne un espace de stockage logique. Ce schéma de nommage logique doit
	rester constant alors que les volumes de stockages physique peuvent migrer
	et se déplacer, être étendus, etc.</para>

	<para>Les différences entre les manipulations proposées dans les supports
	&url.nfs.howto; et &url.nfsv4.config; traduisent les différences de
	conception entre les deux générations du protocole <acronym>NFS</acronym>.
	On peut relever deux paramètres importants sur le serveur.</para>

	<itemizedlist>
	<listitem>
	<para>L'option <option>fsid=0</option>, présente dans le fichier
	<filename>/etc/exports/</filename>, permet de définir une
	<emphasis>racine de montage</emphasis> tout comme on le verrait sur un
	serveur Web. Le paramètre de configuration
	<literal>DocumentRoot /var/www</literal> du serveur
	<citetitle>apache2</citetitle> désigne la racine à partir de laquelle
	les pages Web publiées sont référencées. Cette racine est indépendante
	de l'arborescence du système de fichier local du serveur.</para>
	</listitem>
	<listitem>
	<para>L'utilisation d'un montage local avec l'option
	<option>bind</option> de la commande <command>mount</command> permet de
	mettre en cohérence l'arborescence du serveur et de ses clients. Ainsi,
	le répertoire <filename class='directory'>/ahome/</filename> présente
	les mêmes objets que l'on soit connecté sur le serveur ou sur un
	client. Le schéma de nommage est donc cohérent.</para>

	<para>Le montage local peut se faire manuellement sur le serveur avec
	la syntaxe suivante.</para>

<screen>sudo mkdir /ahome</screen>

<screen>sudo mount --bind /home/exports/home /ahome</screen>

	<para>Une fois la configuration validée, on peut intégrer ce montage
	local dans la configuration système pour que l'opération soit effectuée
	à chaque initialisation. Il faut alors éditer le fichier de
	configuration dédié aux montages des volumes locaux du système&nbsp;:
	<filename>/etc/fstab</filename>.</para>

	<para>Voici comment ajouter l'instruction de montage au fichier
	<filename>/etc/fstab</filename> du serveur <acronym>NFS</acronym>.</para>

<screen>echo "/home/exports/home     /ahome  none    defaults,bind    0    0" | \
sudo tee -a /etc/fstab</screen>

<screen>grep -v ^# /etc/fstab
UUID=8362b3e6-d426-4f1b-93eb-e1efc22f60f4 /       ext4    errors=remount-ro 0    1
UUID=f3e18b95-7430-4fea-ace5-7dd4cea6398a none    swap    sw    0       0
<emphasis>/home/exports/home     /ahome  none    defaults,bind     0       0</emphasis></screen>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question xml:id='sysadm-net.nfs.server.user'>
	<para><phrase>Comment créer un compte utilisateur local baptisé
	<systemitem>etu-nfs</systemitem> avec un répertoire utilisateur situé sous
	la racine <filename
	class='directory'>/ahome</filename>&nbsp;?</phrase></para>
	</question>
	<answer>
	<para>Après consultation des pages de manuels de la commande
	<command>adduser</command>, on dispose des options de création de compte
	respectant le critère énoncé. L'option <option>--home</option> permet de
	désigner le répertoire utilisateur dans l'arborescence système.</para>

<screen>sudo adduser --home /ahome/etu-nfs etu-nfs</screen>

<screen>id etu-nfs
uid=1001(etu-nfs) gid=1001(etu-nfs) groupes=1001(etu-nfs)</screen>

	<para>Les identifiants numériques <systemitem>uid/gid</systemitem> jouent
	un rôle important dans la suite des manipulations. Voir <xref
	linkend='sysadm-net.nfs.perm'/>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question xml:id='sysadm-net.nfs.server.capture'>
	<para><phrase>Créer un fichier texte ayant pour propriétaire l'utilisateur
	<systemitem>etu-nfs</systemitem> côté serveur et visualiser son contenu
	côté client.</phrase></para>

	<para>Réaliser une capture et relever les numéros de ports caractéristiques
	de des transactions de montage. Est-il possible de retrouver le contenu du
	fichier texte dans les données de capture&nbsp;?</para>

	<para>Pour réaliser cette capture, il faut synchroniser les opérations
	entre les systèmes client et serveur. On commence par le lancement du
	l'analyseur réseau puis on visualise le contenu du fichier.</para>
	</question>
	<answer>
	<para>Côté serveur <acronym>NFS</acronym>, on créé le fichier texte puis on
	lance la capture réseau.</para>

<screen><prompt>etu@server-nfs:~$</prompt> su - etu-nfs
Mot de passe :
<prompt>etu-nfs@server-nfs:~$</prompt> echo "This file is mine" > textfile
<prompt>etu-nfs@server-nfs:~$</prompt> exit
déconnexion</screen>

<screen><prompt>etu@server-nfs:~$</prompt> tshark -i enp0s1 -f "! port 22"
Capturing on 'enp0s1'
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 NFS 254 V4 Call GETATTR FH: 0x455db001
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 NFS 330 V4 Reply (Call In 3) GETATTR
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 883 → 2049 [ACK] Seq=169 Ack=245
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 NFS 262 V4 Call ACCESS FH: 0x455db001, [Check: RD LU MD XT DL XAR XAW XAL]
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 NFS 258 V4 Reply (Call In 6) ACCESS, [Allowed: RD LU MD XT DL XAR XAW XAL]
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 883 → 2049 [ACK] Seq=345 Ack=417
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 NFS 254 V4 Call GETATTR FH: 0x455db001
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 NFS 330 V4 Reply (Call In 9) GETATTR
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 883 → 2049 [ACK] Seq=513 Ack=661
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 NFS 278 V4 Call READDIR FH: 0x455db001
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 NFS 1174 V4 Reply (Call In 12) READDIR
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 883 → 2049 [ACK] Seq=705 Ack=1749
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 NFS 254 V4 Call GETATTR FH: 0x455db001
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 NFS 330 V4 Reply (Call In 15) GETATTR
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 883 → 2049 [ACK] Seq=873 Ack=1993
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 NFS 322 V4 Call OPEN DH: 0x6cceef4e/
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 NFS 442 V4 Reply (Call In 18) OPEN StateID: 0x5daa
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 883 → 2049 [ACK] Seq=1109 Ack=2349
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 NFS 270 V4 Call READ StateID: 0x7dca Offset: 0 Len: 18
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 NFS 214 <emphasis>V4 Reply (Call In 21) READ</emphasis>
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 883 → 2049 [ACK] Seq=1293 Ack=2477
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 NFS 262 V4 Call CLOSE StateID: 0x5daa
2001:678:3fc:1f5:baad:caff:fefe:3 → 2001:678:3fc:1f5:baad:caff:fefe:2 NFS 202 V4 Reply (Call In 24) CLOSE
2001:678:3fc:1f5:baad:caff:fefe:2 → 2001:678:3fc:1f5:baad:caff:fefe:3 TCP 86 883 → 2049 [ACK] Seq=1469 Ack=2593</screen>

	<para>Comme dans les opérations de capture réseau précédentes, il est
	préférable de stocker les résultats dans un fichier pour les exploiter
	ultérieurement avec une interface interactive qui permet d'isoler chaque
	champ de protocole.</para>

	<para>Ici, on relève l'utilisation du protocole <acronym>TCP</acronym> en
	couche transport avec le port enregistré <systemitem>2049/nfs</systemitem>.
	Une analyse détaillée de l'appel de procédure <systemitem>READ</systemitem>
	montre que le contenu du fichier texte est bien visible.</para>
	</answer>
	</qandaentry>
</qandaset>
</sect1>

<sect1 xml:id='sysadm-net.nfs.client'>
	<title>Configuration du client NFS</title>

	<para>Le rôle du client est d'intégrer un accès au système de fichiers d'un
	hôte distant dans son arborescence locale. On parle de «montage
	<acronym>NFS</acronym>». Dans un premier temps, on teste les opérations de
	montage manuel. Bien sûr, ces tests ne peuvent aboutir que si une
	arborescence à été exportée par un serveur.</para>

	<para>Ensuite, on teste les opérations de montage automatisées ou
	<emphasis>automontage</emphasis>. Si le serveur <acronym>NFS</acronym>
	n'est pas encore disponible au moment des tests de montage manuel, il faut
	préparer les fichiers de configuration du service d'automontage.</para>

<sect2 xml:id='sysadm-net.nfs.client.manual'>
	<title>Opérations manuelles de (montage|démontage) NFS</title>

<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
	<para><phrase>Quelle est la commande qui permet de tester la disponibilité
	du service de montage <acronym>NFS</acronym> sur un hôte
	distant&nbsp;?</phrase></para>

	<para>Reprendre l'utilisation de la commande qui donne les listes des
	procédures distantes disponibles. Elle a été identifiée dans la section
	précédente.</para>
	</question>
	<answer>
	<para>Relativement aux résultats de la section précédente, la liste des
	services accessibles via <acronym>RPC</acronym> sur le serveur
	<acronym>NFS</acronym> s'est étoffée et le service de montage
	<acronym>NFS</acronym> apparaît clairement.</para>

	<para>Voici un exemple de résultat utilisant l'adresse
	<acronym>IP</acronym> du serveur <acronym>NFS</acronym>.</para>

<screen>rpcinfo -s fe80::baad:caff:fefe:3
   program version(s) netid(s)                         service     owner
    100000  2,3,4     local,udp,tcp,udp6,tcp6          portmapper  superuser
    100005  3,2,1     tcp6,udp6,tcp,udp                <emphasis>mountd</emphasis>      superuser
    100003  4,3       udp6,tcp6,udp,tcp                nfs         superuser
    100227  3         udp6,tcp6,udp,tcp                -           superuser
    100021  4,3,1     tcp6,udp6,tcp,udp                nlockmgr    superuser</screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.nfs.client.manual.exports'>
	<question>
	<para><phrase>Quelle est la commande qui permet d'identifier l'arborescence
	disponible à l'exportation depuis le serveur
	<acronym>NFS</acronym>&nbsp;?</phrase></para>

	<para>Rechercher dans la liste des commandes du paquet de service
	<acronym>NFS</acronym> commun au client et au serveur.</para>
	</question>
	<answer>
	<para>Dans la liste des commandes fournies avec le paquet
	<systemitem>nfs-common</systemitem>, on trouve un programme appelé
	<command>showmount</command>. Après consultation des pages de manuels, on
	relève l'option <option>-e</option> qui permet de consulter l'arborescence
	exportée par un serveur depuis un client. Voici un exemple
	d'exécution.</para>

<screen>sudo showmount -e fe80::baad:caff:fefe:3
Export list for fe80::baad:caff:fefe:3:
/home/exports/home 2001:678:3fc:1f5::/64,192.168.51.192/27
/home/exports      2001:678:3fc:1f5::/64,192.168.51.192/27</screen>

	<para>Les résultats de la copie d'écran ci-dessus supposent que le serveur
	<acronym>NFS</acronym> ait déjà été configurer pour exporter le dossier
	<filename class='directory'>home</filename>.</para>

	<para>La commande <command>showmount</command> ne produit aucun résultat si
	le serveur <acronym>NFS</acronym> n'est pas configuré.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour les opérations de
	montage manuel&nbsp;? À quel paquet appartient cette commande&nbsp;? Cette
	commande est-elle exclusivement liée au protocole
	<acronym>NFS</acronym>&nbsp;?</phrase></para>

	<para>Après avoir consulté le support &url.nfs.howto;, interroger la base
	de données des paquets, rechercher dans le contenus des paquets et
	consulter les pages de manuels.</para>
	</question>
	<answer>
	<para>La documentation indique que c'est la commande
	<command>mount</command> qui nous intéresse. On effectue ensuite les
	recherches avec le gestionnaire de paquets.</para>

<screen>apt search ^mount$
En train de trier... Fait
Recherche en texte intégral... Fait
mount/testing,now 2.37.2-1 amd64  [installé]
  tools for mounting and manipulating filesystems</screen>

<screen>dpkg -L mount | grep bin
/bin
<emphasis>/bin/mount</emphasis>
/bin/umount
/sbin
/sbin/losetup
/sbin/swapoff
/sbin/swapon</screen>

	<para>La commande appartient au paquet du même nom. La consultation des
	pages de manuels <userinput><prompt>$</prompt> man mount</userinput> montre
	que cette commande n'est pas réservée au seul protocole
	<acronym>NFS</acronym> mais à l'ensemble des opérations de montage pour
	tous les systèmes de fichiers utilisables.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Créer le répertoire <filename
	class='directory'>/ahome</filename> destiné à «recevoir» le contenu
	répertoires utilisateurs exportés depuis le serveur <acronym>NFS</acronym>.
	Quelle est la syntaxe de la commande permettant de
	<emphasis>monter</emphasis> le répertoire exporté par le serveur
	<acronym>NFS</acronym> sur ce nouveau répertoire&nbsp;?</phrase></para>

	<para>Rechercher dans le support &url.nfs.howto;.</para>
	</question>
	<answer>
	<para>Exemple avec l'adresse <acronym>IPv6</acronym> du serveur
	<acronym>NFS</acronym>.</para>

<screen>sudo mkdir /ahome</screen>

<screen>sudo mount [2001:678:3fc:1f5:baad:caff:fefe:3]:/home /ahome</screen>

<screen>mount | grep nfs
[2001:678:3fc:1f5:baad:caff:fefe:3]:/home on /ahome type nfs4 \
	(rw,relatime,vers=4.2,rsize=131072,wsize=131072,namlen=255,hard,proto=tcp6,
	timeo=600,retrans=2,sec=sys,clientaddr=2001:678:3fc:1f5:baad:caff:fefe:2,
	local_lock=none,addr=2001:678:3fc:1f5:baad:caff:fefe:3)</screen>

	<para>Exemple avec l'adresse <acronym>IPv4</acronym> du serveur
	<acronym>NFS</acronym>.</para>

<screen>sudo mkdir /ahome</screen>

<screen>sudo mount 192.168.51.195:/home /ahome</screen>

<screen>mount | grep nfs
192.168.51.195:/home on /ahome type nfs4 \
	(rw,relatime,vers=4.2,rsize=131072,wsize=131072,namlen=255,hard,proto=tcp,
	timeo=600,retrans=2,sec=sys,clientaddr=192.168.51.194,
	local_lock=none,addr=192.168.51.195)</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Réaliser une capture lors de l'exécution de la commande
	<command>ls -lAh /ahome</command> et relever les numéros de ports
	caractéristiques de ces transactions. Est-il possible de retrouver les
	informations échangées dans les données de capture&nbsp;?</phrase></para>
	</question>
	<answer>
	<para>La marche à suivre est identique à celle de la <link
	linkend='sysadm-net.nfs.server.capture'>même question côté serveur</link>
	<acronym>NFS</acronym>.</para>

	<orderedlist>
	<listitem>
	<para>On lance la capture de trafic côté serveur
	<acronym>NFS</acronym>.</para>
<screen>tshark -i enp0s1 -f "! port 22" -w /var/tmp/ls-nfs.pcap</screen>
	</listitem>
	<listitem>
	<para>On exécute la commande <command>ls -lAh /ahome</command> côté client
	<acronym>NFS</acronym>.</para>
	</listitem>
	<listitem>
	<para>Retour côté serveur pour exploiter les résultats.</para>
	</listitem>
	</orderedlist>

	<para>L'analyse montre que le protocole <acronym>NFS</acronym> en version 4
	utilise bien le mode <option>COMPOUND</option> de traitement par lot des
	appels de procédure distants <acronym>RPC</acronym>. On ne relève dans
	cette capture que les métadonnées système sur les attributs et les
	permissions relatives à l'arborescence lue.</para>

	<para>Si on reprend la même démarche avec la commande
	<command>cat</command> d'un fichier texte par exemple, le contenu de ce
	fichier apparaît en clair dans la capture de trafic.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles <emphasis>seraient</emphasis> les opérations à
	effectuer pour configurer le système et rendre un montage
	<acronym>NFS</acronym> statique permanent&nbsp;?</phrase></para>

	<para>Rechercher le fichier de configuration système responsable des
	montages statiques des partitions.</para>

	<para>Il est inutile de modifier les fichiers de configuration du système
	sachant que l'on change de méthode de montage dans la section
	suivante.</para>
	</question>
	<answer>
	<para>Il faudrait éditer le fichier <filename>/etc/fstab</filename> pour
	effectuer un montage statique à chaque initialisation du système. On
	pourrait par exemple insérer une ligne du type suivant à la fin du
	fichier.</para>

	<itemizedlist>
	<listitem>
	<para>Avec le protocole <acronym>IPv4</acronym>&nbsp;:</para>
<screen>192.168.51.195:/home   /ahome   nfs4    0   0</screen>
	</listitem>
	<listitem>
	<para>Avec le protocole <acronym>IPv6</acronym>&nbsp;:</para>
<screen>[2001:678:3fc:1f5:baad:caff:fefe:3]:/home   /ahome   nfs4    0   0</screen>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour
	<emphasis>démonter</emphasis> le dossier <filename
	class='directory'>/ahome</filename>&nbsp;?</phrase></para>

	<para>Rechercher cette commande dans la liste des outils forunis avec le
	paquet <systemitem>mount</systemitem>.</para>
	</question>
	<answer>
	<para>C'est la commande <command>umount</command> qu'il faut utiliser pour
	&laquo;détacher&raquo; un dispositif de stockage du système de fichiers.
	Dans le cas de cette section, la syntaxe est la suivante.</para>

<screen>sudo umount /ahome</screen>
	</answer>
	</qandaentry>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.nfs.client.auto'>
	<title>Opérations automatisées de (montage|démontage) NFS</title>

	<para>Dans cette section, on reprend le processus de montage précédent en
	utilisant le service d'automontage. L'objectif étant de rendre les
	opérations d'accès au système de fichiers réseau totalement transparentes
	pour l'utilisateur, le recours au montage manuel doit être évité le plus
	possible.</para>

	<para>Il existe plusieurs implémentations libres pour le service
	d'automontage. On se limite ici au logiciel lié au noyau Linux.</para>

<warning>
	<para>Les montages manuels et le service d'automontage ne font pas bon
	ménage&nbsp;! Il faut absolument démonter tous les systèmes de fichiers
	<acronym>NFS</acronym> avant d'aborder cette partie.</para>
</warning>

<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
	<para><phrase>Quel est le paquet qui contient les outils nécessaires au
	fonctionnement de l'automontage&nbsp;?</phrase></para>

	<para>Rechercher le mot clé <command>automount</command> dans les
	descriptions du gestionnaire de paquets.</para>
	</question>
	<answer>
<screen>aptitude search "?description(automount)"
p   afuse                           - automounting file system implemented in user-space
p   autodir                         - Automatically creates home and group directories
<emphasis>p   autofs                          - kernel-based automounter for Linux</emphasis>
p   autofs-hesiod                   - Hesiod map support for autofs
p   autofs-ldap                     - LDAP map support for autofs
p   fusiondirectory-plugin-autofs   - autofs plugin for FusionDirectory
p   libnss-cache                    - NSS module for using nsscache-generated fi
p   libunix-configfile-perl         - Perl interface to various Unix configurati
p   nsscache                        - asynchronously synchronise local NSS databases
p   pmount                          - mount removable devices as normal user
i   systemd                         - system and service manager
i   systemd-sysv                    - system and service manager - SysV links
p   udevil                          - Alternative storage media interface
p   udiskie                         - automounter for removable media for Python
p   vfu                             - Versatile text-based file-manager</screen>

	<para>Dans le contexte de ces manipulations, c'est le paquet
	<systemitem>autofs</systemitem> qui nous intéresse.</para>

<screen>sudo apt install autofs</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question xml:id='sysadm-net.nfs.client.auto.user'>
	<para><phrase>Comment créer un compte utilisateur local baptisé
	<systemitem>etu-nfs</systemitem> avec un répertoire utilisateur situé sous
	la racine <filename class='directory'>/ahome</filename> dont les fichiers
	et répertoires sont placés sur le serveur
	<acronym>NFS</acronym>&nbsp;?</phrase></para>
	</question>
	<answer>
	<para>Après consultation des pages de manuels de la commande
	<command>adduser</command>, on dispose des options de création de compte
	respectant les deux critères énoncés. L'option <option>--home</option>
	permet de désigner le répertoire utilisateur dans l'arborescence système et
	l'option <option>--no-create-home</option> évite la création de ce
	répertoire sur le système local.</para>

<screen>sudo adduser --no-create-home --home /ahome/etu-nfs etu-nfs
<emphasis>Attention ! Impossible d'accéder au répertoire personnel que vous avez indiqué (/ahome/etu-nfs) : No such file or directory.</emphasis>
Ajout de l'utilisateur « etu-nfs » ...
Ajout du nouveau groupe « etu-nfs » (1001) ...
Ajout du nouvel utilisateur « etu-nfs » (1001) avec le groupe « etu-nfs » ...
<emphasis>Le répertoire personnel « /ahome/etu-nfs » n'a pas été créé.</emphasis>
Nouveau mot de passe :
Retapez le nouveau mot de passe :
passwd: password updated successfully
Changing the user information for etu-nfs
Enter the new value, or press ENTER for the default
        Full Name []: Etudiant NFS
        Room Number []:
        Work Phone []:
        Home Phone []:
        Other []:
Cette information est-elle correcte ? [O/n]</screen>

<screen>id etu-nfs
uid=1001(etu-nfs) gid=1001(etu-nfs) groupes=1001(etu-nfs)</screen>

	<para>Les identifiants numériques <systemitem>uid/gid</systemitem> jouent
	un rôle important dans la suite des manipulations. Voir <xref
	linkend='sysadm-net.nfs.perm'/>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quels sont les fichiers de configuration du service
	d'automontage à éditer ou créer pour que l'utilisateur
	<systemitem>etu-nfs</systemitem> ait accès à ses données
	personnelles&nbsp;?</phrase></para>

	<para>Utiliser les fichiers exemples fournis avec le paquet, les pages de
	manuels associées et créer un fichier spécifique pour la gestion des
	comptes utilisateurs.</para>
	</question>
	<answer>
	<para>La liste des fichiers du paquet <systemitem>autofs</systemitem>
	montre qu'il existe une page de manuel consacrée au fichier principal de
	configuration du service&nbsp;: <filename>/etc/auto.master</filename>. Ces
	informations permettent de configurer un point de montage au dessous duquel
	doivent se trouver les répertoires utilisateurs. Ces derniers utilisent un
	fichier de configuration propre&nbsp;:
	<filename>/etc/auto.home</filename>.</para>

	<orderedlist>
	<listitem>
	<para>On définit la racine de montage <filename
	class='directory'>/ahome</filename> dans le fichier de configuration
	principal <filename>/etc/auto.master</filename>. Cette racine de
	montage pointe vers le fichier de configuration dédié au montage
	automatique des répertoires des utilisateurs.</para>

	<para>Après analyse des commentaires présents dans le fichier
	<filename>/etc/auto.master</filename>, on créé un fichier spécifique à
	notre contexte dans le dossier <filename
	class='directory'>/etc/auto.master.d/</filename> avec le suffixe
	<filename>.autofs</filename>.</para>

<screen>echo "/ahome  /etc/auto.home" | \
sudo tee -a /etc/auto.master.d/ahome.autofs</screen>
	</listitem>
	<listitem>
	<para>On créé le fichier <filename>/etc/auto.home</filename> qui utilise
	une syntaxe particulière pour que le montage du système de fichiers du
	serveur soit générique et indépendant du nombre des comptes
	utilisateurs.</para>

<screen>echo "*    -fstype=nfs4    [2001:678:3fc:1f5:baad:caff:fefe:3]:/home/&amp;" | \
sudo tee -a /etc/auto.home</screen>
	<itemizedlist>
	<listitem>
	<para>Le premier paramètre est le symbole <keycap>*</keycap> qui se
	substitue au nom d'utilisateur&nbsp;: <systemitem>etu-nfs</systemitem> dans
	notre exemple.</para>
	</listitem>
	<listitem>
	<para>Le deuxième paramètre <option>-fstype=nfs4</option> correspond à une
	option de montage qui privilégie la version 4 du protocole
	<acronym>NFS</acronym>. Le jeu des options de montage est le même que pour
	un montage statique.</para>
	</listitem>
	<listitem>
	<para>Le troisième paramètre est l'adresse <acronym>IPv4</acronym> ou
	<acronym>IPv6</acronym> du serveur. Comme on ne dispose pas d'un service
	<acronym>DNS</acronym> à ce stade de la progression des travaux pratiques,
	on utilise directement les adresses <acronym>IP</acronym>.</para>
	</listitem>
	<listitem>
	<para>Le répertoire <filename class='directory'>/home/</filename>
	correspond à la configuration de l'exportation <acronym>NFS</acronym> <link
	linkend='sysadm-net.nfs.server.exports'>sur le serveur.</link> Le
	répertoire <filename class='directory'>/home/</filename> est situé sous la
	racine d'exportation qui est uniquement connue du serveur.</para>
	</listitem>
	<listitem>
	<para>Le symbole <keycap>&amp;</keycap> indique la répétition du premier
	paramètre&nbsp;: le nom d'utilisateur.</para>
	</listitem>
	</itemizedlist>
	</listitem>
	<listitem>
	<para>Une fois les fichiers de configuration en place, il ne faut pas
	oublier de redémarrer le service et de contrôler son bon
	fonctionnement.</para>

<screen>sudo systemctl restart autofs</screen>

<screen>systemctl status autofs
● autofs.service - Automounts filesystems on demand
     Loaded: loaded (/lib/systemd/system/autofs.service; enabled; vendor preset: enabled)
     Active: <emphasis>active</emphasis> (running) since Sun 2021-08-29 09:42:16 CEST; 51s ago
       Docs: man:autofs(8)
    Process: 8027 ExecStart=/usr/sbin/automount $OPTIONS --pid-file /var/run/autofs.pid (code=exited, status=0/SUCCESS)
   Main PID: 8028 (automount)
      Tasks: 4 (limit: 1131)
     Memory: 1.0M
        CPU: 29ms
     CGroup: /system.slice/autofs.service
             └─8028 /usr/sbin/automount --pid-file /var/run/autofs.pid

août 29 09:42:16 client-nfs systemd[1]: Starting Automounts filesystems on demand...
août 29 09:42:16 client-nfs systemd[1]: Started Automounts filesystems on demand.</screen>
	</listitem>
	</orderedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les conditions à respecter sur le client et le
	serveur <acronym>NFS</acronym> pour que l'utilisateur
	<systemitem>etu-nfs</systemitem> ait la capacité à écrire dans son
	répertoire personnel&nbsp;?</phrase></para>

	<para>Rechercher les attributs d'un compte utilisateur qui correspondent
	aux propriétés des objets d'un système de fichiers au sens général.</para>
	</question>
	<answer>
	<para>Les identifiants numériques <systemitem>uid/gid</systemitem> doivent
	nécessairement être identiques sur le client et le serveur
	<acronym>NFS</acronym>. Toute la gestion des droits sur le système de
	fichiers est conditionnée par ces valeurs.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment prendre l'identité de l'utilisateur
	<systemitem>etu-nfs</systemitem> pour tester la validité du
	montage&nbsp;?</phrase></para>

	<para>Cette validation suppose que l'utilisateur puisse atteindre son
	répertoire et que l'on visualise l'automontage avec les commandes
	<command>mount</command> et <command>df</command>.</para>
	</question>
	<answer>
	<para>C'est la commande <command>su</command> qui permet de «changer
	d'identité» sur le système. On l'utilise donc pour prendre l'identité de
	l'utilisateur dont le répertoire est situé sur le serveur
	<acronym>NFS</acronym>. Pour que l'opération de montage automatique ait
	lieu, il suffit de se placer dans ce répertoire.</para>

<screen><prompt>etu@client-nfs:~$</prompt> <emphasis>su - etu-nfs</emphasis>
<prompt>etu-nfs@client-nfs:~$</prompt> pwd
/ahome/etu-nfs
<prompt>etu-nfs@:client-nfs~$</prompt> df -HT
Sys. de fichiers                                  Type     Taille Utilisé Dispo Uti% Monté sur
udev                                              devtmpfs   495M       0  495M   0% /dev
tmpfs                                             tmpfs      103M    680k  102M   1% /run
/dev/vda1                                         ext4        72G    2,4G   66G   4% /
tmpfs                                             tmpfs      512M       0  512M   0% /dev/shm
tmpfs                                             tmpfs      5,3M       0  5,3M   0% /run/lock
tmpfs                                             tmpfs      103M       0  103M   0% /run/user/1000
<emphasis>[2001:678:3fc:1f5:baad:caff:fefe:3]:/home/etu-nfs nfs4        72G    2,4G   66G   4% /ahome/etu-nfs</emphasis></screen>

<screen><prompt>etu-nfs@client-nfs:~$</prompt> mount | grep nfs
<emphasis>[2001:678:3fc:1f5:baad:caff:fefe:3]:/home/etu-nfs on /ahome/etu-nfs type nfs4</emphasis>
	(rw,relatime,vers=4.2,rsize=131072,wsize=131072,namlen=255,hard,proto=tcp6,
	timeo=600,retrans=2,sec=sys,clientaddr=2001:678:3fc:1f5:baad:caff:fefe:2,
	local_lock=none,addr=2001:678:3fc:1f5:baad:caff:fefe:3)</screen>

	<para>Bien sûr, ces manipulations ne sont possibles que si la <link
	linkend='sysadm-net.nfs.server'>configuration du serveur</link> est
	effective.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Réaliser une capture réseau lors de l'exécution des commandes
	et relever les numéros de ports caractéristiques de ces transactions.
	Est-il possible de retrouver les informations échangées dans les données de
	capture&nbsp;?</phrase></para>

	<para>La marche à suivre est identique à celle de la <link
	linkend='sysadm-net.nfs.server.capture'>même question côté serveur</link>
	<acronym>NFS</acronym>.</para>
	</question>
	</qandaentry>
</qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.nfs.perm'>
	<title>Gestion des droits sur le système de fichiers NFS</title>

	<para>Le contrôle les droits sur les objets de l'arborescence exportée par
	le serveur <acronym>NFS</acronym> est limité au masque de permissions de
	ces objets. Il est donc important de faire correspondre les identifiants
	<option>uid</option> et <option>gid</option> entre le client et le
	serveur.</para>

	<para>Les manipulations suivantes sont à réaliser en «concertation» entre
	les administrateurs des postes client et serveur. Le compte utilisateur
	<systemitem>etu-nfs</systemitem> doit avoir été créé sur le <link
	linkend='sysadm-net.nfs.server.user'>serveur</link> et sur le <link
	linkend='sysadm-net.nfs.client.auto.user'>client</link>.</para>

<note>
	<para>Ces manipulations se font sans système de gestion centralisé de
	l'authentification. L'utilisation d'un annuaire <acronym>LDAP</acronym>
	pour fournir une base de comptes utilisateurs fait l'objet d'un support de
	travaux pratiques qui vient après celui-ci. Ce support se concentre sur le
	volet système de fichiers réseau.</para>
</note>

<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
	<para><phrase>Quelles sont les valeurs numériques des identifiants
	<option>uid</option> et <option>gid</option> du compte utilisateur
	<systemitem>etu-nfs</systemitem> sur le client et sur le serveur
	<acronym>NFS</acronym>&nbsp;?</phrase></para>

	<para>Si les valeurs différent entre le client et le serveur, il faut
	détruire ces comptes utilisateurs et reprendre les options de la commande
	<command>adduser</command> pour fournir ces valeurs de façon
	explicite.</para>
	</question>
	<answer>
	<para>L'extrait du résultat de l'instruction <userinput><prompt>$</prompt>
	sudo adduser --help</userinput> ci-dessous montre les options
	utiles.</para>

<screen>adduser [--home DIR] [--shell SHELL] [--no-create-home] <emphasis>[--uid ID]</emphasis>
[--firstuid ID] [--lastuid ID] [--gecos GECOS] [--ingroup GROUP | <emphasis>--gid ID</emphasis>]
[--disabled-password] [--disabled-login] USER
   Ajoute un utilisateur normal</screen>

	<para>Reprendre la <link linkend='sysadm-net.nfs.client.auto.user'>question
	sur la création d'un compte utilisateur local</link> dont le répertoire est
	situé sur le serveur <acronym>NFS</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Sur quel poste peut on créer des fichiers et des répertoires
	avec des masques de permissions ayant d'autres valeurs <option>uid</option>
	et <option>gid</option> que celles de l'utilisateur
	<systemitem>etu-nfs</systemitem>&nbsp;? Quelles sont les options des
	commandes <command>chmod</command> et <command>chown</command> à utiliser
	pour réaliser ces opérations&nbsp;?</phrase></para>

	<para>Utiliser les pages de manuels des commandes.</para>
	</question>
	<answer>
	<para>C'est sur le serveur que le super utilisateur a la possibilité de
	créer n'importe quel objet avec n'importe quel propriétaire dans la mesure
	où le système de fichiers est local et non réseau.</para>

<screen><prompt>etu@server-nfs:~$</prompt> sudo touch /ahome/etu-nfs/ThisOneIsMine
<prompt>etu@server-nfs:~$</prompt> sudo chown etu-nfs.etu-nfs /ahome/etu-nfs/ThisOneIsMine
<prompt>etu@server-nfs:~$</prompt> sudo touch /ahome/etu-nfs/ThisOneIs-NOT-Mine
<prompt>etu@server-nfs:~$</prompt> sudo chown 2000.2000 /ahome/etu-nfs/ThisOneIs-NOT-Mine
<prompt>etu@server-nfs:~$</prompt> sudo ls -lh /ahome/etu-nfs/
total 4,0K
-rw-r--r-- 1 etu-nfs etu-nfs 18 29 août  16:15 textfile
-rw-r--r-- 1 etu-nfs etu-nfs  0 29 août  18:32 ThisOneIsMine
-rw-r--r-- 1    2000    2000  0 29 août  18:33 ThisOneIs-NOT-Mine</screen>

	<para>Côté client, les objets créés sont biens visibles et la vue réseau du
	système de fichiers <acronym>NFS</acronym> passe par une correspondance des
	propriétaires.</para>

<screen><prompt>etu-nfs@client-nfs:~$</prompt> id
uid=1001(etu-nfs) gid=1001(etu-nfs) groupes=1001(etu-nfs)
<prompt>etu-nfs@client-nfs:~$</prompt> ls -lh
total 4,0K
-rw-r--r-- 1 etu-nfs etu-nfs 18 29 août  16:15 textfile
-rw-r--r-- 1 etu-nfs etu-nfs  0 29 août  18:32 ThisOneIsMine
-rw-r--r-- 1    2000    2000  0 29 août  18:33 ThisOneIs-NOT-Mine</screen>

	<para>Côté client <acronym>NFS</acronym>, les valeurs des identifiants
	<option>uid</option> et <option>gid</option> sont correctement restitués et
	l'utilisateur n'a que le droit de lecture sur le fichier
	<filename>ThisOneIs-NOT-Mine</filename>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est le service qui assure la conformité des identifiants
	entre serveur et client <acronym>NFS</acronym>&nbsp;?</phrase></para>

	<para>Reprendre la liste des service <acronym>RPC</acronym> actifs sur les
	deux systèmes.</para>
	</question>
	<answer>
	<para>Le démon <systemitem class='daemon'>rpc.idmapd</systemitem> est
	fourni avec le paquet <systemitem>nfs-common</systemitem>.</para>
	</answer>
	</qandaentry>
</qandaset>
</sect1>

<sect1 xml:id='sysadm-net.nfs.refdocs'>
	<title>Documents de référence</title>

<variablelist>
	<varlistentry xml:id='sysadm-net.nfs.fs'>
	<term><citetitle>Systèmes de fichiers réseau&nbsp;: NFS &amp;
	CIFS</citetitle></term>
	<listitem>
	<para>&url.net-fs;&nbsp;: présentation des modes de fonctionnement des
	systèmes de fichiers réseau <acronym>NFS</acronym> &amp;
	<acronym>CIFS</acronym>.</para>
	</listitem>
	</varlistentry>

	<varlistentry xml:id='sysadm-net.nfs.howto'>
	<term><citetitle>Linux NFS-HOWTO</citetitle></term>
	<listitem>
	<para>&url.nfs.howto;&nbsp;: documentation historique complète sur la
	configuration  d'un serveur et d'un client <acronym>NFS</acronym> jusqu'à
	la version 3 inclue.</para>
	</listitem>
	</varlistentry>

	<varlistentry xml:id='sysadm-net.nfsv4.config'>
	<term><citetitle>Nfsv4 configuration</citetitle></term>
	<listitem>
	<para>&url.nfsv4.config;&nbsp;: traduction française extraite des pages du
	projet <acronym>CITI</acronym> de l'université du Michigan.</para>
	</listitem>
	</varlistentry>
</variablelist>
</sect1>
</article>
