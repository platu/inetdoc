<?xml version='1.0'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
	"/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd"[

<!ENTITY author		SYSTEM "author.xml">
<!ENTITY legal		SYSTEM "legal.xml">

<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.xml'>
%inetdoc_urls;

<!ENTITY url.frr
	'<link xmlns="http://docbook.org/ns/docbook"
	xlink:href="https://frrouting.org">
	<citetitle>FRRouting Project</citetitle></link>'>

<!ENTITY url.frr-documentation
	'<link xmlns="http://docbook.org/ns/docbook"
	xlink:href="https://docs.frrouting.org">
	<citetitle>FRRouting User Guide</citetitle></link>'>

<!ENTITY url.startup-scripts
  '<link xmlns="http://docbook.org/ns/docbook"
  xlink:href="https://gitlab.inetdoc.net/labs/startup-scripts">
  <citetitle>startup-scripts</citetitle></link>'>

<!ENTITY url.netplan-doc
  '<link xmlns="http://docbook.org/ns/docbook"
  xlink:href="https://netplan.readthedocs.io/en/stable/">
  <citetitle>Netplan documentation</citetitle></link>'>

<!-- A copy of http://www.w3.org/2003/entities/2007/w3centities-f.ent is at:
/usr/local/share -->
<!ENTITY % w3centities-f PUBLIC "-//W3C//ENTITIES Combined Set//EN//XML"
	"/usr/local/share/w3centities-f.ent">
%w3centities-f;
]>

<article xml:id='ospf' xml:lang='fr'>

<info>
	<title>Introduction au routage dynamique OSPF avec FRRouting</title>

	&author;
	<abstract>
	<para>
	<informaltable frame='none' pgwide='1'>
	<tgroup cols='2' align='left' colsep='0' rowsep='0'>
	<colspec colwidth='5*'/>
	<colspec colwidth='220px'/>
	<tbody>
	<row>
	<entry valign='top'>
    <para>Le protocole <acronym>OSPF</acronym> (<wordasword>Open Shortest Path
    First</wordasword>) permet un routage dynamique efficace et évolutif dans les
    grands réseaux <acronym>IP</acronym>, en calculant automatiquement les
    meilleures routes en fonction de l'état des liens.</para>

    <para>Ce support de travaux pratiques est une introduction au protocole de
    routage dynamique <acronym>OSPF</acronym>. Il détaille la mise en place
    d'une topologie en triangle utilisant des VLANs, ainsi que la configuration
    des routeurs avec la suite logicielle <application>FRRouting</application>
    pour activer et paramétrer <acronym>OSPF</acronym> dans une aire
    unique.</para>

    <para>Les manipulations présentées expliquent comment préparer les
    systèmes, valider les communications entre routeurs et configurer les
    démons <acronym>OSPFv2</acronym> et <acronym>OSPFv3</acronym> étape par
    étape.</para>
	</entry>
	<entry>
	<inlinemediaobject>
	<imageobject role='html'>
		<imagedata fileref='images/OSPF-topology.png' format='PNG' width='480px' scalefit='1'/>
	</imageobject>
	<imageobject role='fo'>
		<imagedata fileref='images/OSPF-topology.png' format='PNG' width='6cm' scalefit='1'/>
	</imageobject>
	</inlinemediaobject>
	</entry>
	</row>
	</tbody>
	</tgroup>
	</informaltable>
	</para>
	</abstract>

	<keywordset>
	<keyword>ospf</keyword>
	<keyword>ospfv2</keyword>
	<keyword>ospfv3</keyword>
	<keyword>frr</keyword>
	<keyword>routage</keyword>
	<keyword>trunk</keyword>
	<keyword>vlan</keyword>
	</keywordset>
</info>

<sect1 xml:id='ospf.legal.meta'>
	&legal;
	<bridgehead xml:id='ospf.meta'
	renderas='sect2'>Méta-information</bridgehead>

	<para>Ce document est écrit avec <link
	xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link>
	XML sur un système <link
	xlink:href="https://www.debian.org"><citetitle>Debian
	GNU/Linux</citetitle></link>. Il est disponible en version imprimable au
	format PDF&nbsp;: <link
	xlink:href="https://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>
</sect1>

<sect1 xml:id='ospf.archi'>
	<title>Topologie réseau étudiée</title>

	<para>La topologie réseau étudiée peut être présentée sous deux formes
	distinctes&nbsp;: logique et physique.</para>

	<variablelist>
	<varlistentry xml:id='ospf.topologie.logique'>
		<term>Topologie logique</term>
	<listitem>
        <para>On retrouve un grand classique dans l'introduction aux protocoles
        de routage dynamiques&nbsp;: le triangle dont les trois côtés (liens)
        sont de type <acronym>LAN</acronym>.</para>

        <para>Si on se place sur un sommet du triangle, le côté opposé
        correspond à un réseau “inconnu” que l'on peut joindre via les routeurs
        voisins.</para>

	<mediaobject>
	<imageobject role='fo'>
		<imagedata fileref='images/OSPF-topology.png' format='PNG'
		width='12cm' scalefit='1' align='center'/>
	</imageobject>
	<imageobject role='html'>
		<imagedata fileref='images/OSPF-topology.png' format='PNG'
		width='640px' scalefit='1' align='center'/>
	</imageobject>
	<textobject>
		<phrase>Topologie logique en triangle</phrase>
	</textobject>
	<caption>
		<para><link
		xlink:href='images/ospf-cloud-logical-topology.png'>Topologie logique
		en triangle</link></para>
	</caption>
	</mediaobject>
	</listitem>
	</varlistentry>
	<varlistentry xml:id='ospf.topologie.physique'>
		<term>Topologie physique</term>
	<listitem>
		<para>On s'appuie sur le support &url.inter-vlan-routing; pour
		constituer une topologie physique à base de réseaux locaux virtuels ou
		<acronym>VLAN</acronym>s. On fait correspondre à chaque lien de la
		topologie logique en triangle un numéro de <acronym>VLAN</acronym>
		défini.</para>

	<mediaobject>
	<imageobject role='fo'>
		<imagedata fileref='images/physical-topology.png' format='PNG'
		width='12cm' scalefit='1' align='center'/>
	</imageobject>
	<imageobject role='html'>
		<imagedata fileref='images/physical-topology.png' format='PNG'
		width='640px' scalefit='1' align='center'/>
	</imageobject>
	<textobject>
		<phrase>Topologie phusique en étoile</phrase>
	</textobject>
	<caption>
		<para><link
		xlink:href='images/ospf-cloud-host-topology.png'>Topologie physique
		en étoile</link></para>
	</caption>
	</mediaobject>
	</listitem>
	</varlistentry>
	</variablelist>

	<para>Après avoir mis en œuvre la topologie physique en s'appuyant sur le
	support de la séance de travaux pratiques précédente&nbsp;:
	&url.inter-vlan-routing;, on implante les démons de routage
    <acronym>OSPF</acronym> sur les trois routeurs <systemitem>R1</systemitem>,
    <systemitem>R2</systemitem> et <systemitem>R3</systemitem>.</para>

    <para>Ce support se limite à l'étude du routage dynamique à l'intérieur
    d'une aire unique. La seule “frontière” de communication inter-aires
    visible est constituée par le lien vers l'Internet. Cette route par défaut
    sera redistribuée via <acronym>OSPF</acronym> par le routeur
    <systemitem>R1</systemitem> aux autres routeurs. On verra alors un exemple
    de route externe dans les bases de données <acronym>OSPF</acronym>.</para>

	<para>Voici le plan d'adressage de la maquette qui a été utilisée pour
	rédiger ce document.</para>

<table xml:id='ospf.mockup.addressing' frame='all' pgwide='1'>
	<title>Maquette</title>
	<tgroup cols='5' align='left' colsep='1' rowsep='1'>
		<colspec colnum='1' colwidth='1*'/>
		<colspec colnum='2' colwidth='2*'/>
		<colspec colnum='3' colwidth='1*'/>
		<colspec colnum='4' colwidth='2*'/>
		<colspec colnum='5' colwidth='2.5*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333" ?>
		<?dbfo color="#fff" ?>
		<entry>Rôle</entry>
		<entry>OSPF router-id</entry>
		<entry>VLAN</entry>
		<entry>Type</entry>
		<entry>Adresses</entry>
	</row>
	</thead>
	<tbody>
	<row>
		<entry morerows='3' valign='middle'>R1</entry>
		<entry morerows='3' valign='middle'>
			OSPFv2&nbsp;: 1.0.0.4<?custom-linebreak?>
			OSPFv3&nbsp;: 1.0.0.6</entry>
		<entry>360</entry>
		<entry>Passerelle</entry>
		<entry>
			<systemitem class='ipaddress'>192.168.104.129/29</systemitem><?custom-linebreak?>
			<systemitem class='ipaddress'>fe80:168::1</systemitem>
		</entry>
	</row>
	<row>
		<entry>440</entry>
		<entry>R1 -> R2</entry>
		<entry>
			<systemitem class='ipaddress'>10.44.0.1/29</systemitem><?custom-linebreak?>
            <systemitem class='ipaddress'>fe80::1b8:1/64</systemitem>
		</entry>
	</row>
	<row>
		<entry>441</entry>
		<entry>R1 -> R3</entry>
		<entry>
			<systemitem class='ipaddress'>10.44.1.1/29</systemitem><?custom-linebreak?>
            <systemitem class='ipaddress'>fe80::1b9:1/64</systemitem>
		</entry>
	</row>
	<row>
		<entry>10</entry>
		<entry>Hébergement</entry>
		<entry>
			<systemitem class='ipaddress'>10.10.0.1/24</systemitem><?custom-linebreak?>
			<systemitem class='ipaddress'>fd14:ca46:3864:a::1/64</systemitem>
		</entry>
	</row>
	<row>
		<entry morerows='2' valign='middle'>R2</entry>
		<entry morerows='2' valign='middle'>
			OSPFv2&nbsp;: 2.0.0.4<?custom-linebreak?>
			OSPFv3&nbsp;: 2.0.0.6</entry>
		<entry>440</entry>
		<entry>R2 -> R1</entry>
		<entry>
			<systemitem class='ipaddress'>10.44.0.2/29</systemitem><?custom-linebreak?>
            <systemitem class='ipaddress'>fe80::1b8:2/64</systemitem>
		</entry>
	</row>
	<row>
		<entry>442</entry>
		<entry>R2 -> R3</entry>
		<entry>
			<systemitem class='ipaddress'>10.44.2.2/29</systemitem><?custom-linebreak?>
            <systemitem class='ipaddress'>fe80::1ba:2/64</systemitem>
		</entry>
	</row>
	<row>
		<entry>20</entry>
		<entry>Hébergement</entry>
		<entry>
			<systemitem class='ipaddress'>10.20.0.1/24</systemitem><?custom-linebreak?>
			<systemitem class='ipaddress'>fd14:ca46:3864:14::1/64</systemitem>
		</entry>
	</row>
	<row>
		<entry morerows='2' valign='middle'>R3</entry>
		<entry morerows='2' valign='middle'>
			OSPFv2&nbsp;: 3.0.0.4<?custom-linebreak?>
			OSPFv3&nbsp;: 3.0.0.6</entry>
		<entry>441</entry>
		<entry>R3 -> R1</entry>
		<entry>
			<systemitem class='ipaddress'>10.44.1.3/29</systemitem><?custom-linebreak?>
            <systemitem class='ipaddress'>fe80::1b9:3/64</systemitem>
		</entry>
	</row>
	<row>
		<entry>442</entry>
		<entry>R3 -> R2</entry>
		<entry>
			<systemitem class='ipaddress'>10.44.2.3/29</systemitem><?custom-linebreak?>
            <systemitem class='ipaddress'>fe80::1ba:3/64</systemitem>
		</entry>
	</row>
	<row>
		<entry>30</entry>
		<entry>Hébergement</entry>
		<entry>
			<systemitem class='ipaddress'>10.30.0.1/24</systemitem><?custom-linebreak?>
			<systemitem class='ipaddress'>fd14:ca46:3864:1e::1/64</systemitem>
		</entry>
	</row>
	</tbody>
	</tgroup>
</table>
</sect1>

<sect1 xml:id='ospf.prepare-config'>
	<title>Préparer les systèmes pour le routage IPv4 et IPv6</title>

<sect2 xml:id='ospf.prepare-config.dsw'>
    <title>Raccorder et lancer les routeurs virtuels</title>

    <para>Les trois machines virtuelles de routage doivent être raccordées au
    commutateur de distribution de l'hyperviseur.</para>

    <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
    <para><phrase>Comment configurer les ports du commutateur avant le
    lancement des machines virtuelles&nbsp;?</phrase></para>
    </question>
    <answer>
    <para>On utilise le script de procédure <filename>switch-conf.py</filename>
    qui applique les déclarations contenues dans un fichier
    <acronym>YAML</acronym>. Le code du script est accessible à partir du dépôt
    Git &url.startup-scripts;.</para>

    <para>Voici une copie du fichier de configuration
    <filename>switch.yaml</filename> des trois ports de commutateur.</para>

<screen>ovs:
  switches:
    - name: dsw-host
      ports:
        - name: tap5 # R1 switch port
          type: OVSPort
          vlan_mode: trunk
          trunks: [360, 440, 441]
        - name: tap6 # R2 switch port
          type: OVSPort
          vlan_mode: trunk
          trunks: [52, 440, 442] # VLAN 52 provides Internet temporary access
#         trunks: [440, 442]
        - name: tap7 # R3 switch port
          type: OVSPort
          vlan_mode: trunk
          trunks: [52, 441, 442] # VLAN 52 provides Internet temporary access
#         trunks: [441, 442]</screen>

    <para>On applique les paramètres définis ci-dessus.</para>

<screen>$HOME/masters/scripts/switch-conf.py switch.yaml</screen>

    <para>Les numéros de ports de commutateur et de VLAN donnés dans les
    exemples ci-dessus doivent être adaptés selon le plan d’adressage
    spécifique à vos travaux pratiques.</para>
    </answer>
    </qandaentry>

    <qandaentry xml:id='ospf.switch-fabric'>
    <question>
    <para><phrase>Comment afficher les entrées de la table
    <acronym>CAM</acronym> du commutateur de distribution sur
    l'hyperviseur&nbsp;?</phrase></para>

    <para>Rechercher les options de la commande <command>ovs-appctl</command> à
    partir de la console de l'hyperviseur.</para>
    </question>
    <answer>
    <para>L'affichage de la table <acronym>CAM</acronym> du commutateur
    <systemitem>dsw-host</systemitem> de l'hyperviseur se fait à l'aide de la
    commande&nbsp;:</para>

<screen>sudo ovs-appctl fdb/show dsw-host</screen>

    <para>Pour sélectionner un <acronym>VLAN</acronym> particulier, on ajoute
    un appel à <command>grep</command>. Voici des exemples d'affichage pour les
    <acronym>VLAN</acronym>s de la maquette <emphasis>une fois que les routeurs
    virtuels sont lancés et échangent entre eux</emphasis>.</para>

    <itemizedlist>
    <listitem>
    <para>Lien entre <systemitem>R1</systemitem> et
    <systemitem>R2</systemitem>.</para>

<screen>sudo ovs-appctl fdb/show dsw-host | grep 440
   10   440  b8:ad:ca:fe:00:05  274
   18   440  b8:ad:ca:fe:00:06  120</screen>
   </listitem>
   <listitem>
   <para>Lien entre <systemitem>R1</systemitem> et
   <systemitem>R3</systemitem>.</para>

<screen>sudo ovs-appctl fdb/show dsw-host | grep 441
   12   441  b8:ad:ca:fe:00:07    1
   10   441  b8:ad:ca:fe:00:05    1</screen>
   </listitem>
   <listitem>
   <para>Lien entre <systemitem>R2</systemitem> et
   <systemitem>R3</systemitem>.</para>

<screen>sudo ovs-appctl fdb/show dsw-host | grep 442
   18   442  b8:ad:ca:fe:00:06   51
   12   442  b8:ad:ca:fe:00:07   51</screen>
   </listitem>
   </itemizedlist>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment lancer les trois routeurs virtuels&nbsp;?</phrase></para>
    </question>
    <answer>
    <para>On utilise le script de procédure <filename>lab-startup.py</filename>
    qui applique les déclarations contenues dans un fichier
    <acronym>YAML</acronym>. Le code du script est accessible à partir du dépôt
    Git &url.startup-scripts;.</para>

    <para>Voici une copie du fichier <filename>frr-lab.yaml</filename> de
    déclaration des trois routeurs virtuels.</para>

<screen>kvm:
  vms:
    - vm_name: R1
      master_image: debian-testing-amd64.qcow2 # master image to be used
      force_copy: false # do not force copy the master image to the VM image
      memory: 1024
      tapnum: 5
    - vm_name: R2
      master_image: debian-testing-amd64.qcow2 # master image to be used
      force_copy: false # do not force copy the master image to the VM image
      memory: 1024
      tapnum: 6
    - vm_name: R3
      master_image: debian-testing-amd64.qcow2 # master image to be used
      force_copy: false # do not force copy the master image to the VM image
      memory: 1024
      tapnum: 7</screen>

    <para>Les numéros d'interfaces <systemitem>tap</systemitem> sont à changer
    suivant les attributions du plan d'adressage de travaux pratiques.</para>

    <para>On lance les trois routeurs virtuels avec le script
    <command>lab-startup.py</command>.</para>

<screen>$HOME/masters/scripts/lab-startup.py frr-lab.yaml</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment changer le nom d'hôte de chacun des trois routeurs
    virtuels&nbsp;?</phrase></para>

    <para>Utiliser la connexion console avec la commande
    <command>telnet</command> et définir le nouveau nom d'hôte avec la commande
    <command>hostnamectl</command>.</para>
    </question>
    <answer>
    <para>On obtient la liste des numéros de ports d'accès console au lancement
    des routeurs virtuels ou à l'aide de la commande <command>lsof -i</command>
    par exemple. Ensuite, on ouvre la connexion sur le port ouvert et on change
    le nom d'hôte et on redémarre le système.</para>

<screen>telnet localhost 2306</screen>

<screen>Trying ::1...
Connected to localhost.
Escape character is '^]'.

localhost login: etu
Mot de passe :
Linux localhost 6.11.4-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.11.4-1 (2024-10-20) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.</screen>

<screen><prompt>etu@localhost:~$</prompt> <emphasis>sudo hostnamectl hostname R2</emphasis>
<prompt>etu@localhost:~$</prompt> <emphasis>sudo reboot</emphasis></screen>
    </answer>
    </qandaentry>
    </qandaset>
</sect2>

<sect2 xml:id='ospf.prepare-config.routing'>
    <title>Activer le routage sur les routeurs virtuels</title>

    <para>Sans modification de la configuration par défaut, un système
    GNU/Linux n'assure pas la fonction de routage du trafic d'une interface
    réseau à une autre.</para>

    <para>L'activation du routage correspond à un réglage de paramètres du
    sous-système réseau du noyau Linux. L'outil qui permet de consulter et
    modifier les réglages de paramètre sur le noyau est appelé
    <application>sysctl</application>.</para>

    <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
    <para><phrase>Comment activer le routage dans le sous-système réseau du
    noyau Linux&nbsp;?</phrase></para>

    <para>Utiliser la commande <command>sysctl</command> pour effectuer des
    recherches et identifier les paramètres utiles.</para>

    <para>Il est dorénavant recommandé de créer un fichier de configuration
    spécifique par fonction. C'est la raison pour laquelle on crée un nouveau
    fichier <filename>/etc/sysctl.d/10-routing.conf</filename>.</para>
    </question>
    <answer>
    <para>Voici un exemple de création de fichier qui active les clés relatives
    au routage <acronym>IPv4</acronym> et <acronym>IPv6</acronym>.</para>

<screen>cat &lt;&lt; EOF | sudo tee /etc/sysctl.d/10-routing.conf
net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1
net.ipv4.conf.all.log_martians=1
EOF</screen>

    <warning>
    <para>Il ne faut pas oublier d'appliquer les nouvelles valeurs des
    paramètres de configuration.</para>
    </warning>

<screen>sudo sysctl --system</screen>

    <para>On utilise la même commande pour vérifier que la fonction routage est
    bien activée pour les deux protocoles réseau.</para>

<screen>sudo sysctl net.ipv4.ip_forward net.ipv6.conf.all.forwarding</screen>

<screen>net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1</screen>
    </answer>
    </qandaentry>
    </qandaset>
</sect2>

<sect2 xml:id='ospf.prepare-config.1stconf'>
    <title>Appliquer une première configuration réseau</title>

    <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
    <para><phrase>Comment appliquer les configurations réseau
    <acronym>IPv4</acronym> et <acronym>IPv6</acronym> à partir de l'unique
    interface du routeur&nbsp;?</phrase></para>

    <para>Consulter la documentation de <citetitle>Netplan</citetitle> pour
    obtenir les informations sur la configuration des interfaces réseau à
    l'adresse &url.netplan-doc;.</para>
    </question>
    <answer>
    <para>Il existe plusieurs possibilités pour configurer une interface
    réseau. Dans le contexte de ces manipulations, on utilise
    <citetitle>Netplan</citetitle> dans le but de séparer la partie déclarative
    du moteur de configuration.</para>

    <para>C'est <systemitem>systemd-networkd</systemitem> qui joue le rôle de
    moteur de configuration sur les machines virtuelles utilisées avec ces
    manipulations.</para>

    <para>La configuration par défaut de l'interface
    <systemitem>enp0s1</systemitem> doit être éditée et remplacée. Il faut
    configurer autant de sous-interfaces que de <acronym>VLAN</acronym>s
    utilisés.</para>

    <itemizedlist>
    <listitem>
    <para>L'interface principale correspond à l'interface “physique” de la
    machine. Elle est nommée <systemitem>enp0s1</systemitem> en fonction de
    l'ordre des adresses des composants raccordés au bus
    <acronym>PCI</acronym>.</para>
    </listitem>
    <listitem>
    <para>Une sous-interface doit être créée pour chaque
    <acronym>VLAN</acronym> désigné dans le plan d'adressage.</para>

    <para>Le routeur <systemitem>R1</systemitem> se distingue des deux autres
    par son raccordement au <acronym>VLAN</acronym> d'infrastructure qui lui
    donne directement accès à l'Internet.</para>

    <para>Les routeurs <systemitem>R2</systemitem> et
    <systemitem>R3</systemitem> doivent utiliser un accès temporaire à un
    <acronym>VLAN</acronym> sur lequel l'adressage automatique est actif. Le
    but de cet accès temporaire est de permettre l'installation des paquets
    nécessaires à la suite des manipulations.</para>
    </listitem>
    </itemizedlist>

    <para>Voici une copie du fichier
    <filename>/etc/netplan/enp0s1.yaml</filename> du routeur
    <systemitem>R1</systemitem>.</para>

<screen>network:
    version: 2
    ethernets:
      enp0s1:
        dhcp4: false
        dhcp6: false
        accept-ra: false
        nameservers:
          addresses:
            - 172.16.0.2
            - 2001:678:3fc:3::2

    vlans:
      # Infrastructure VLAN
      enp0s1.360:
        id: 360
        link: enp0s1
        addresses:
          - 192.168.104.130/29
          - 2001:678:3fc:168::82/64
        routes:
          - to: default
            via: 192.168.104.129
          - to: "::/0"
            via: "fe80::168:1"
            on-link: true
      # R1 -> R2
      enp0s1.440:
        id: 440
        link: enp0s1
        addresses:
          - 10.44.0.1/29
          - fe80::1b8:1/64
      # R1 -> R3
      enp0s1.441:
        id: 441
        link: enp0s1
        addresses:
          - 10.44.1.1/29
          - fe80::1b9:1/64</screen>

    <para>Voici une copie du fichier
    <filename>/etc/netplan/enp0s1.yaml</filename> du routeur
    <systemitem>R2</systemitem> avec une sous-interface temporaire dans le
    <acronym>VLAN</acronym> <option>52</option>.</para>

<screen>network:
    version: 2
    ethernets:
      enp0s1:
        dhcp4: false
        dhcp6: false
        accept-ra: false
        nameservers:
          addresses:
            - 172.16.0.2
            - 2001:678:3fc:3::2

    vlans:
      # Temporary Internet access
      enp0s1.52:
        id: 52
        link: enp0s1
        dhcp4: true
        dhcp6: false
        accept-ra: true
      # R2 -> R1
      enp0s1.440:
        id: 440
        link: enp0s1
        addresses:
          - 10.44.0.2/29
          - fe80::1b8:2/64
      # R2 -> R3
      enp0s1.442:
        id: 442
        link: enp0s1
        addresses:
          - 10.44.2.2/29
          - fe80::1ba:2/64</screen>

    <para>Ce deuxième fichier de déclaration de la configuration réseau est
    pratiquement identique à celui du routeur <systemitem>R3</systemitem>.
    C'est pourquoi, on ne fournit pas de copie de ce dernier.</para>

    <para>Une fois le fichier de configuration en place, il suffit de faire
    appel à la commande <command>netplan</command> pour appliquer les
    changements.</para>

<screen>sudo netplan apply</screen>

    <para>Pour vérifier l'état courant de la configuration appliquée, on peut
    utiliser à nouveau la commande <command>netplan</command>.</para>

<screen>sudo netplan status</screen>
    </answer>
    </qandaentry>
    </qandaset>
</sect2>
</sect1>

<sect1 xml:id='ospf.install-frr'>
    <title>Installer le paquet frr et lancer les démons de routage OSPF</title>

	<para>La suite de démons de routage <application>FRRouting</application>
	couvre la totalité des protocoles de routage dynamiques. Le paquet
	<application>frr</application> fournit autant de processus que de
	protocoles. Ici, on se concentre sur le protocole <acronym>OSPF</acronym>.
	Voici une représentation de l'organisation des démons actifs dans notre
	contexte.</para>

	<mediaobject>
	<imageobject role='fo'>
		<imagedata format='PNG' fileref='images/frr-daemons.png' width='10cm' scalefit='1' />
	</imageobject>
	<imageobject role='html'>
		<imagedata format='PNG' fileref='images/frr-daemons.png' width='560px' scalefit='1' />
	</imageobject>
	<textobject>
		<phrase>Synoptique des démons FRRouting</phrase>
	</textobject>
	</mediaobject>

	<para>Les manipulations de ce support s'appuient sur la documentation du
	projet&nbsp;: &url.frr-documentation;</para>

    <note>
    <para>Au moment de la rédaction de ce document,
    <application>FRRouting</application> ne permet pas d’utiliser simultanément
    les familles d’adresses <acronym>IPv4</acronym> et <acronym>IPv6</acronym>
    avec un seul démon. C’est pourquoi nous devons activer et configurer deux
    démons distincts&nbsp;: <systemitem>ospfd</systemitem> pour
    <acronym>IPv4</acronym> et <systemitem>ospf6d</systemitem> pour
    <acronym>IPv6</acronym>.</para>
    </note>

    <important>
    <para>Les questions de cette section doivent être traitées sur les trois
    routeurs de la topologie étudiée.</para>
    </important>

    <qandaset defaultlabel='number'>
    <qandadiv xml:id='ospf.install-frr.qandaset.div1'>
    <qandaentry>
    <question>
    <para><phrase>Comment installer le paquet <systemitem>frr</systemitem> à
    partir du dépôt du site &url.frr;&nbsp;?</phrase></para>
    </question>
    <answer>
	<para>Pour installer le paquet <application>frr</application>, on doit
	ajouter un nouveau dépôt au système.</para>

	<para>On commence par ajouter la clé de signature des paquets à la
	configuration du gestionnaire.</para>

<screen>sudo apt -y install curl gpg</screen>

<screen>curl -s https://deb.frrouting.org/frr/keys.asc | \
sudo gpg -o /usr/share/keyrings/frr-keyring.gpg --dearmor</screen>

	<para>On créé ensuite un nouveau fichier de liste de sources de
	paquets qui fait référence à cette clé de signature.</para>

<screen>echo "deb [signed-by=/usr/share/keyrings/frr-keyring.gpg] \
https://deb.frrouting.org/frr bookworm frr-stable" | \
sudo tee /etc/apt/sources.list.d/frr.list</screen>

    <para>Avant de lancer l'installation des paquets de la suite
    <application>FRRouting</application>, on doit mettre à jour le catalogue
    local.</para>

<screen>sudo apt update
sudo apt -y install frr frr-pythontools</screen>

    <para>On peut afficher les informations sur le paquet
    <systemitem>frr</systemitem>.</para>

<screen>apt show ^frr$</screen>

	<para>Sans configuration particulière, les services
	<application>zebra</application> et <application>staticd</application> sont
	lancés. Aucun protocole de routage dynamique n'est activé.</para>

<screen>systemctl status frr</screen>

<screen>● frr.service - FRRouting
     Loaded: loaded (/usr/lib/systemd/system/frr.service; enabled; preset: enabled)
     Active: active (running) since Sat 2024-11-02 16:17:42 CET; 5min ago
 Invocation: a1d3f0e79647471bb1a17069f3f4c69a
       Docs: https://frrouting.readthedocs.io/en/latest/setup.html
    Process: 2098 ExecStart=/usr/lib/frr/frrinit.sh start (code=exited, status=0/SUCCESS)
   Main PID: 2107 (watchfrr)
     Status: "FRR Operational"
      Tasks: 8 (limit: 1032)
     Memory: 14.9M (peak: 28.2M)
        CPU: 416ms
     CGroup: /system.slice/frr.service
             ├─2107 /usr/lib/frr/watchfrr -d -F traditional zebra mgmtd staticd
             ├─2117 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000
             ├─2122 /usr/lib/frr/mgmtd -d -F traditional -A 127.0.0.1
             └─2124 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1

nov. 02 16:17:42 R2 staticd[2124]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00
nov. 02 16:17:42 R2 frrinit.sh[2144]: [2144|staticd] done
nov. 02 16:17:42 R2 zebra[2117]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00
nov. 02 16:17:42 R2 frrinit.sh[2128]: [2128|zebra] done
nov. 02 16:17:42 R2 watchfrr[2107]: [QDG3Y-BY5TN] zebra state -> up : connect succeeded
nov. 02 16:17:42 R2 watchfrr[2107]: [QDG3Y-BY5TN] mgmtd state -> up : connect succeeded
nov. 02 16:17:42 R2 watchfrr[2107]: [QDG3Y-BY5TN] staticd state -> up : connect succeeded
nov. 02 16:17:42 R2 watchfrr[2107]: [KWE5Q-QNGFC] all daemons up, doing startup-complete notify
nov. 02 16:17:42 R2 frrinit.sh[2098]: Started watchfrr.
nov. 02 16:17:42 R2 systemd[1]: Started frr.service - FRRouting.</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment vérifier que la console unifiée du service
    <systemitem>frr</systemitem> est active&nbsp;?</phrase></para>

    <para>Afficher le contenu du fichier
    <filename>/etc/frr/vtysh.conf</filename> et vérifier qu'il contient
    l'entrée <literal>service
    integrated-vtysh-config</literal>.</para>

    <para>L'accès à cette console unifiée est important puisqu'il permet
    d'utiliser une console unique pour les trois démons qui sont utilisés dans
    la suite des manipulations&nbsp;: <application>zebra</application>,
    <application>ospfd</application> et
    <application>ospf6d</application>.</para>
    </question>
    <answer>
    <para>Voici un exemple pour un routeur de la maquette.</para>

<screen>sudo grep "service integrated-vtysh-config" /etc/frr/vtysh.conf</screen>

<screen>service integrated-vtysh-config</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment ajouter l'utilisateur <systemitem>etu</systemitem> aux groupes
	<systemitem>frr</systemitem> et <systemitem>frrvty</systemitem>&nbsp;?</phrase></para>

    <para>Utiliser la commande <command>adduser</command>.</para>

    <para>Une fois que l'utilisateur appartient à ces groupes, il a un accès
    direct à la console de configuration des protocoles actifs.</para>
    </question>
    <answer>
    <para>Comme dans les autres travaux pratiques de la série, on utilise une boucle.</para>

<programlisting>for grp in frr frrvty
do
    sudo adduser etu $grp
done</programlisting>

    <para>Il ne faut pas oublier de déconnecter/reconnecter l'utilisateur pour
    bénéficier de la nouvelle attribution de groupe.</para>

    <para>On vérifie l'appartenance aux groupes avec la commande
    <command>groups</command>.</para>

<screen>groups</screen>
<screen>etu adm sudo users frrvty frr</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment activer les deux démons des protocoles
    <acronym>OSPFv2</acronym> et
    <acronym>OSPFv3</acronym>&nbsp;?</phrase></para>

	<para>Consulter le fichier de configuration&nbsp;:
	<filename>/etc/frr/daemons</filename>.</para>
    </question>
    <answer>
    <para>Il faut remplacer les clés <literal>no</literal> en
    <literal>yes</literal> pour les démons des deux versions du protocole
    <acronym>OSPF</acronym>.</para>

<screen>sudo sed -i 's/ospfd=no/ospfd=yes/' /etc/frr/daemons
sudo sed -i 's/ospf6d=no/ospf6d=yes/' /etc/frr/daemons
sudo systemctl restart frr</screen>

    <para>On peut alors afficher l'état du service <systemitem>frr</systemitem>
    et vérifier que les nouveaux démons de routage dynamique
    <acronym>OSPF</acronym> sont bien activés.</para>

<screen>systemctl status frr</screen>

<screen>● frr.service - FRRouting
     Loaded: loaded (/usr/lib/systemd/system/frr.service; enabled; preset: enabled)
     Active: active (running) since Sat 2024-11-02 17:40:32 CET; 6s ago
 Invocation: 84e33888211f45f297c9135cace76751
       Docs: https://frrouting.readthedocs.io/en/latest/setup.html
    Process: 2467 ExecStart=/usr/lib/frr/frrinit.sh start (code=exited, status=0/SUCCESS)
   Main PID: 2476 (watchfrr)
     Status: "FRR Operational"
      Tasks: 12 (limit: 1032)
     Memory: 23M (peak: 34.8M)
        CPU: 380ms
     CGroup: /system.slice/frr.service
             ├─2476 /usr/lib/frr/watchfrr -d -F traditional zebra mgmtd ospfd ospf6d staticd
             ├─2488 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000
             ├─2493 /usr/lib/frr/mgmtd -d -F traditional -A 127.0.0.1
             ├─2495 <emphasis>/usr/lib/frr/ospfd -d -F traditional -A 127.0.0.1</emphasis>
             ├─2498 <emphasis>/usr/lib/frr/ospf6d -d -F traditional -A ::1</emphasis>
             └─2501 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1

nov. 02 17:40:32 R2 mgmtd[2493]: [VTVCM-Y2NW3] Configuration Read in Took: 00:00:00
nov. 02 17:40:32 R2 frrinit.sh[2504]: [2504|mgmtd] done
nov. 02 17:40:32 R2 watchfrr[2476]: [QDG3Y-BY5TN] zebra state -> up : connect succeeded
nov. 02 17:40:32 R2 watchfrr[2476]: [QDG3Y-BY5TN] mgmtd state -> up : connect succeeded
nov. 02 17:40:32 R2 watchfrr[2476]: [QDG3Y-BY5TN] <emphasis>ospfd state -> up : connect succeeded</emphasis>
nov. 02 17:40:32 R2 watchfrr[2476]: [QDG3Y-BY5TN] <emphasis>ospf6d state -> up : connect succeeded</emphasis>
nov. 02 17:40:32 R2 watchfrr[2476]: [QDG3Y-BY5TN] staticd state -> up : connect succeeded
nov. 02 17:40:32 R2 watchfrr[2476]: [KWE5Q-QNGFC] all daemons up, doing startup-complete notify
nov. 02 17:40:32 R2 frrinit.sh[2467]: Started watchfrr.
nov. 02 17:40:32 R2 systemd[1]: Started frr.service - FRRouting.</screen>

	<para>On peut aussi lister les démons actifs à partir de la console du
	service.</para>

<screen>vtysh</screen>

<screen>
Hello, this is FRRouting (version 10.1.1).
Copyright 1996-2005 Kunihiro Ishiguro, et al.

<prompt>R2#</prompt> sh daemons
 mgmtd zebra <emphasis>ospfd ospf6d</emphasis> watchfrr staticd</screen>
    </answer>
    </qandaentry>
    </qandadiv>

    <qandadiv>
    <!-- Question spécifique à ne pas reproduire dans la synthèse -->
    <qandaentry>
    <question>
    <para><phrase>Comment désactiver les sous-interfaces d'accès temporaire à
    Internet pour les routeurs <systemitem>R2</systemitem> et
    <systemitem>R3</systemitem>&nbsp;?</phrase></para>

    <para>Il existe au moins deux possibilités.</para>
    <itemizedlist>
    <listitem>
    <para>Utiliser directement la commande <command>ip</command> pour
    désactiver une sous-interface au niveau liaison.</para>
    </listitem>
    <listitem>
    <para>Éditer le fichier de déclaration et commenter tous les paramètre de
    la sous-interface temporaire.</para>
    </listitem>
    </itemizedlist>
    </question>
    <answer>
    <para>Si on utilise la commande <command>ip</command>, l'interface sera
    bien désactivée mais elle apparaîtra à nouveau lors du redémarrage du
    routeur virtuel.</para>

<screen>sudo ip link set enp0s1.52 down</screen>

    <para>Si on édite le fichier de déclaration en commentant les paramètres de
    la sous-interface, on s'assure qu'elle n'apparaîtra plus, même lors d'un
    redémarrage du routeur. Voici un exemple pour le routeur
    <systemitem>R3</systemitem>.</para>

<screen>network:
    version: 2
    ethernets:
      enp0s1:
        dhcp4: false
        dhcp6: false
        accept-ra: false
        nameservers:
          addresses:
            - 172.16.0.2
            - 2001:678:3fc:3::2

    vlans:
#      # Temporary Internet access
#      enp0s1.52:
#        id: 52
#        link: enp0s1
#        dhcp4: true
#        dhcp6: false
#        accept-ra: true
      # R3 -> R1
      enp0s1.440:
        id: 440
        link: enp0s1
        addresses:
          - 10.44.0.3/29
          - fe80::1b8:3/64
      # R3 -> R2
      enp0s1.442:
        id: 442
        link: enp0s1
        addresses:
          - 10.44.2.3/29
          - fe80::1ba:3/64</screen>
    </answer>
    </qandaentry>
    </qandadiv>
    </qandaset>

	<para>Une fois l'ensemble des opérations de cette section réalisées, chaque
	routeur dispose des outils pour mettre en œuvre la topologie physique et
	ensuite les protocoles de routage dynamique <acronym>OSPF</acronym>.</para>
</sect1>

<sect1 xml:id='ospf.pointopoint'>
	<title>Valider les communications entre routeurs</title>

    <para>Avant d’aborder le déploiement du protocole de routage dynamique, il
    est nécessaire de valider plusieurs éléments&nbsp;:</para>

    <itemizedlist>
    <listitem>
	<para>Le raccordement des routeurs aux ports de commutateurs désignés</para>
    </listitem>
    <listitem>
    <para>Les communications entre chaque routeur</para>
    </listitem>
    <listitem>
    <para>La visualisation des tables de routage pour les interfaces réseau configurées</para>
    </listitem>
    </itemizedlist>

	<qandaset>
	<qandaentry>
	<question>
	<para><phrase>Quelles sont les tests à effectuer pour vérifier l'état des
	différents “côtés” de la topologie triangle&nbsp;?</phrase></para>

	<para>Il faut afficher la table de routage de chaque routeur
	puis la table des voisins. Ainsi, on peut contrôler les correspondances
	entre les adresses de couche réseau et de couche liaison.</para>
	</question>
	<answer>
	<para>Dans le contexte de la maquette on obtient les résultats suivants
	pour le routeur <systemitem>R1</systemitem>. On se limite à l'affichage des
	entrées de la table de routage apprises par le noyau avec l'option
	<option>proto&nbsp;kernel</option>.</para>

<screen>ip route ls proto kernel</screen>

<screen>10.44.0.0/29 dev enp0s1.440 scope link src 10.44.0.1
10.44.1.0/29 dev enp0s1.441 scope link src 10.44.1.1
192.168.104.128/29 dev enp0s1.360 scope link src 192.168.104.130</screen>

<screen>ip -6 route ls proto kernel</screen>

<screen>2001:678:3fc:168::/64 dev enp0s1.360 metric 256 pref medium
fe80::/64 dev enp0s1 metric 256 pref medium
fe80::/64 dev enp0s1.441 metric 256 pref medium
fe80::/64 dev enp0s1.360 metric 256 pref medium
fe80::/64 dev enp0s1.440 metric 256 pref medium</screen>

	<para>Pour les entrées relatives au voisinage réseau, on se limite aussi à
	l'affichage des voisins directs des interfaces du routeur.</para>

	<para>On repère dans la copie d'écran ci-dessous les adresses des deux
	autres routeurs&nbsp;: <systemitem>R2</systemitem> et
	<systemitem>R3</systemitem>.</para>

<screen>ip nei ls</screen>

<screen>10.44.0.2 dev enp0s1.440 lladdr b8:ad:ca:fe:00:06 REACHABLE<co xml:id="co-r2"/>
10.44.1.3 dev enp0s1.441 lladdr b8:ad:ca:fe:00:07 REACHABLE<co xml:id="co-r3"/>
fe80::1b9:3 dev enp0s1.441 lladdr b8:ad:ca:fe:00:07 STALE<co xml:id="co-r3-ll"/>
fe80::baad:caff:fefe:6 dev enp0s1.440 lladdr b8:ad:ca:fe:00:06 router STALE<co xml:id="co-r2-ll-auto"/>
fe80:168::1 dev enp0s1.360 lladdr 80:6a:00:dc:67:53 router STALE
fe80::baad:caff:fefe:7 dev enp0s1.441 lladdr b8:ad:ca:fe:00:07 STALE<co xml:id="co-r3-ll-auto"/>
fe80::1b8:2 dev enp0s1.440 lladdr b8:ad:ca:fe:00:06 STALE<co xml:id="co-r2-ll"/></screen>

    <calloutlist>
    <callout arearefs="co-r2 co-r2-ll co-r2-ll-auto">
    <para>Entrées du routeur <systemitem>R2</systemitem></para>
    </callout>
    <callout arearefs="co-r3 co-r3-ll co-r3-ll-auto">
    <para>Entrées du routeur <systemitem>R3</systemitem></para>
    </callout>
    </calloutlist>

    <important>
    <para>Les tables de voisinage réseau sont peuplées à partir des échanges
    entre routeurs. Il est donc nécessaire de lancer les tests de communication
    <acronym>ICMP</acronym> en amont de l'affichage de ces tables.</para>
    </important>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les opérations à effectuer pour valider les
	communications <acronym>IPv4</acronym> et <acronym>IPv6</acronym> entre
	chacun des routeurs&nbsp;?</phrase></para>

	<para>Lancer les tests <acronym>ICMP</acronym> usuels entre chaque routeur
	sur chaque lien actif.</para>
	</question>
	<answer>
	<para>Exemple entre <systemitem>R1</systemitem> et
	<systemitem>R2</systemitem>&nbsp;; toujours dans le contexte de la
	maquette.</para>

	<itemizedlist>
	<listitem>
	<para>Requête <acronym>IPv4</acronym> de <systemitem>R1</systemitem> vers
	<systemitem>R2</systemitem> sur le <acronym>VLAN</acronym>
	<systemitem>440</systemitem>.</para>

<screen>ping -qc2 10.44.0.2</screen>

<screen>PING 10.44.0.2 (10.44.0.2) 56(84) bytes of data.

--- 10.44.0.2 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1002ms
rtt min/avg/max/mdev = 0.533/7.471/14.409/6.938 ms</screen>

	<para>Aucun paquet n'a été perdu. Le routeur <systemitem>R2</systemitem>
	est bien joignable depuis <systemitem>R1</systemitem>.</para>
	</listitem>
	<listitem>
	<para>Requête <acronym>IPv6</acronym> <wordasword>multicast</wordasword>
	depuis <systemitem>R1</systemitem> sur le <acronym>VLAN</acronym>
	<systemitem>480</systemitem>.</para>

<screen>ping -qc2 ff02::1%enp0s1.440</screen>

<screen>PING ff02::1%enp0s1.440 (ff02::1%enp0s1.440) 56 data bytes

--- ff02::1%enp0s1.440 ping statistics ---
2 packets transmitted, 2 received, +1 duplicates, <emphasis>0% packet loss</emphasis>, time 1031ms
rtt min/avg/max/mdev = 0.065/0.283/0.719/0.307 ms</screen>
	</listitem>
	</itemizedlist>

	<para>L'opération est à répéter sur chaque lien entre deux routeurs reliés
	sur le même <acronym>VLAN</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les opérations à effectuer pour visualiser les
	tables de routage <acronym>IPv4</acronym> et <acronym>IPv6</acronym>
	existantes d'un routeur au niveau de la console unifiée
	<application>vtysh</application>&nbsp;?</phrase></para>

	<para>Afficher les tables de routage à partir de la console
	<application>vtysh</application> avec les commandes du système
	<trademark>Cisco</trademark> <acronym>IOS</acronym> <command>show ip
	route</command> et <command>show ipv6 route</command>.</para>
	</question>
	<answer>
	<para>Dans le contexte de la maquette, on obtient les résultats suivants
	pour le routeur <systemitem>R2</systemitem>.</para>

<screen><prompt>R2#</prompt> sh ip route connected
Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

C>* 10.44.0.0/29 is directly connected, enp0s1.440, 00:40:37
C>* 10.44.2.0/29 is directly connected, enp0s1.442, 00:40:37</screen>

<screen><prompt>R2#</prompt> sh ipv6 route connected
Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

C * fe80::/64 is directly connected, enp0s1, 00:41:41
C * fe80::/64 is directly connected, enp0s1.442, 00:41:41
C>* fe80::/64 is directly connected, enp0s1.440, 00:41:41</screen>

    <para>Comme dans le cas de la question précédente, l'affichage des tables
    de routage doit être fait sur les trois routeurs virtuels pour vérifier la
    cohérence de la topologie avant de passer au routage dynamique.</para>
	</answer>
	</qandaentry>
	</qandaset>
</sect1>

<sect1 xml:id='ospf.protocol-config'>
	<title>Configurer les démons OSPFv2 et OSPFv3</title>

	<para>Dans cette section, on introduit les premières commandes de
	configuration du protocole de routage dynamique <acronym>OSPF</acronym> qui
	permettent d'activer le protocole puis d'ajouter des entrées de réseau dans
	la base de données de ce protocole.</para>

	<qandaset>
	<qandaentry>
	<question>
	<para><phrase>Comment peut on contrôler que le protocole
	<acronym>OSPF</acronym> est actif ou non sur un
	routeur&nbsp;?</phrase></para>

	<para>Une fois la console <application>vtysh</application> ouverte, lancer
	les commandes de visualisation de l'état du protocole listées ci-dessous.
	Ces commandes peuvent être lancées sur chacun des trois routeurs.</para>

	<simplelist type='horiz'>
		<member><command>show&nbsp;daemons</command></member>
		<member><command>show&nbsp;ip&nbsp;ospf</command></member>
		<member><command>show&nbsp;ipv6&nbsp;ospf6</command></member>
	</simplelist>
	</question>
	<answer>
	<para>Dans les informations données dans la copie d'écran ci-dessous, il
	apparaît qu'aucune configuration du protocole de routage dynamique n'a été
	activée.</para>

<screen><prompt>R1#</prompt> sh daemons
 zebra <emphasis>ospfd ospf6d</emphasis> watchfrr staticd</screen>

<screen><prompt>R1#</prompt> sh ip ospf</screen>

<screen><prompt>R1#</prompt> sh ipv6 ospf
% OSPFv3 instance not found</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les opérations à effectuer pour activer les
	protocoles de routage <acronym>OSPFv2</acronym> et
	<acronym>OSPFv3</acronym>&nbsp;? Comment affecter manuellement
	l'identifiant du routeur&nbsp;?</phrase></para>

	<warning>
	<para>Les identifiants à utiliser lors de la séance de travaux pratiques
	sont donnés dans les tableaux des plans d'adressage. Voir <xref
	linkend='ospf.archi'/>.</para>
	</warning>

	<para>La liste des commandes utiles en mode configuration dans la console
	<application>vtysh</application> est la suivante.</para>

	<simplelist type='horiz'>
		<member><command>router&nbsp;ospf</command></member>
		<member><command>router&nbsp;ospf6</command></member>
		<member><command>ospf&nbsp;router-id&nbsp;X.X.X.X</command></member>
		<member><command>ospf6&nbsp;router-id&nbsp;X.X.X.X</command></member>
		<member><command>log&nbsp;detail</command></member>
	</simplelist>
    </question>
    <answer>
	<para>Toujours à partir de la console <application>vtysh</application>, on
	accède au mode configuration à l'aide de la commande
	<command>conf&nbsp;t</command>. Voici un exemple de séquence sur le
	troisième routeur.</para>

<screen><prompt>R1#</prompt> conf t
R1(config)# router ospf
R1(config-router)# <emphasis>ospf router-id 1.0.0.4</emphasis>
R1(config-router)# log detail
R1(config-router)# ^Z</screen>

<screen><prompt>R1#</prompt> conf t
R1(config)# router ospf6
R1(config-ospf6)# <emphasis>ospf6 router-id 1.0.0.6</emphasis>
R1(config-ospf6)# log detail
R1(config-ospf6)# ^Z</screen>

    <para>Une fois que chaque démon de routage <acronym>OSPF</acronym> possède
    un identifiant unique, on peut afficher les propriétés du protocole de
    routage dynamique même si aucun échange de route n'a encore eu lieu.</para>

<screen>sh run ospfd</screen>

<screen>Building configuration...

Current configuration:
!
frr version 10.1.1
frr defaults traditional
hostname R1
log syslog informational
service integrated-vtysh-config
!
<emphasis>router ospf</emphasis>
 ospf router-id 1.0.0.4
 log-adjacency-changes detail
exit
!
end</screen>

<screen>sh run ospf6d</screen>

<screen>Building configuration...

Current configuration:
!
frr version 10.1.1
frr defaults traditional
hostname R1
log syslog informational
service integrated-vtysh-config
!
<emphasis>router ospf6</emphasis>
 ospf6 router-id 1.0.0.6
 log-adjacency-changes detail
exit
!
end</screen>

	<para>Le choix de codage des identifiants <acronym>OSPF</acronym> a pour
	but d'éviter une confusion avec les adresses des réseaux actifs sur chaque
	routeur.</para>

	<para>Si on reprend les instructions de la question précédente, on obtient
	l'état de chacun des démons de protocole de routage dynamique.</para>

<screen>sh ip ospf</screen>
<screen> <emphasis>OSPF Routing Process, Router ID: 1.0.0.4</emphasis>
 Supports only single TOS (TOS0) routes
 This implementation conforms to RFC2328
 RFC1583Compatibility flag is disabled
 OpaqueCapability flag is disabled
 Initial SPF scheduling delay 0 millisec(s)
 Minimum hold time between consecutive SPFs 50 millisec(s)
 Maximum hold time between consecutive SPFs 5000 millisec(s)
 Hold time multiplier is currently 1
 SPF algorithm has not been run
 SPF timer is inactive
 LSA minimum interval 5000 msecs
 LSA minimum arrival 1000 msecs
 Write Multiplier set to 20
 Refresh timer 10 secs
 Maximum multiple paths(ECMP) supported 256
 Administrative distance 110
 Number of external LSA 0. Checksum Sum 0x00000000
 Number of opaque AS LSA 0. Checksum Sum 0x00000000
 Number of areas attached to this router: 0
 All adjacency changes are logged</screen>

<screen>sh ipv6 ospf</screen>

<screen> <emphasis>OSPFv3 Routing Process (0) with Router-ID 1.0.0.6</emphasis>
 Running 00:09:20
 LSA minimum arrival 1000 msecs
 Maximum-paths 256
 Administrative distance 110
 Initial SPF scheduling delay 0 millisec(s)
 Minimum hold time between consecutive SPFs 50 millsecond(s)
 Maximum hold time between consecutive SPFs 5000 millsecond(s)
 Hold time multiplier is currently 1
 SPF algorithm has not been run
 SPF timer is inactive
 Number of AS scoped LSAs is 0
 Number of areas in this router is 0
 Authentication Sequence number info
  Higher sequence no 0, Lower sequence no 0
 All adjacency changes are logged</screen>

    <para>L'affectation des identifiants des démons de routage
    <acronym>OSPF</acronym> doit être réalisée sur les trois routeurs de la
    topologie. Ces identifiants seront très utiles et importants dès qu'il
    faudra afficher les listes de routeurs voisins au sens du protocole
    <acronym>OSPF</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='ospf-interface'>
	<question>
    <para><phrase>Comment activer les protocoles de routage
    <acronym>OSPFv2</acronym> et <acronym>OSPFv3</acronym> pour les réseaux
    d'interconnexion de chaque routeur&nbsp;?</phrase></para>

	<para>Il faut activer le protocole de routage dynamique sur chaque
	interface de la topologie qui participe à la construction du
	triangle.</para>

	<para>La liste des commandes utiles en mode console et en mode
	configuration dans <application>vtysh</application> est la suivante.</para>

	<simplelist type='horiz'>
		<member><command>show&nbsp;ip&nbsp;route&nbsp;connected</command></member>
		<member><command>show&nbsp;ip&nbsp;route&nbsp;ospf</command></member>
		<member><command>show&nbsp;ipv6&nbsp;route&nbsp;connected</command></member>
		<member><command>show&nbsp;ipv6&nbsp;route&nbsp;ospf</command></member>
		<member><command>ip&nbsp;ospf&nbsp;area&nbsp;0</command></member>
		<member><command>ipv6&nbsp;ospf6&nbsp;area&nbsp;0</command></member>
	</simplelist>
	</question>
	<answer>
	<para>Voici un exemple de séquence d'instructions pour le routeur
	<systemitem>R1</systemitem>.</para>

    <para>On commence par lister les entrées marquées <emphasis>C</emphasis> ou
    <wordasword>connected</wordasword> des tables de routage
    <acronym>IPv4</acronym> et <acronym>IPv6</acronym> de façon à reconnaître
    les deux côtés de la topologie triangle connus du “sommet”
    <systemitem>R1</systemitem>.</para>

<screen>sh ip route connected</screen>

<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

C>* 10.44.0.0/29 is directly connected, <emphasis>enp0s1.440</emphasis>, 01:26:12
C>* 10.44.1.0/29 is directly connected, <emphasis>enp0s1.441</emphasis>, 01:26:12
C>* 192.168.104.128/29 is directly connected, enp0s1.360, 01:26:12</screen>

<screen>sh ipv6 route connected</screen>

<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

C>* 2001:678:3fc:168::/64 is directly connected, enp0s1.360, 01:30:26
C * fe80::/64 is directly connected, enp0s1.360, 01:30:25
C * fe80::/64 is directly connected, <emphasis>enp0s1.440</emphasis>, 01:30:26
C * fe80::/64 is directly connected, enp0s1, 01:30:26
C>* fe80::/64 is directly connected, <emphasis>enp0s1.441</emphasis>, 01:30:26</screen>

    <para>À partir de ces affichages, on sait que l'on doit activer les
    protocoles <acronym>OSPF</acronym> pour les deux sous-interfaces&nbsp;:
    <systemitem>enp0s1.440</systemitem> et
    <systemitem>enp0s1.441</systemitem>.</para>

<screen><prompt>R1#</prompt> conf t
R1(config)# int enp0s1.440
R1(config-if)# <emphasis>ip ospf area 0</emphasis>
R1(config-if)# <emphasis>ipv6 ospf6 area 0</emphasis>
R1(config-if)# int enp0s1.441
R1(config-if)# <emphasis>ip ospf area 0</emphasis>
R1(config-if)# <emphasis>ipv6 ospf6 area 0</emphasis>
R1(config-if)# ^Z</screen>

    <para>Ces opérations doivent être répétées sur les trois routeurs de la
    topologie.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment visualiser l'état	des interfaces actives pour chaque
	processus de protocole de routage dynamique <acronym>OSPFv2</acronym> ou
	<acronym>OSPFv3</acronym>&nbsp;?</phrase></para>

	<para>Les interfaces sont dites actives pour les protocoles
	<acronym>OSPFv2</acronym> ou <acronym>OSPFv3</acronym> dès qu'elles ont été
	ajoutées aux processus de routage dynamique en précisant l'aire à laquelle
	elles appartiennent.</para>

	<para>La liste des commandes utiles dans la console
	<application>vtysh</application> est la suivante.</para>

	<simplelist type='horiz'>
		<member><command>show&nbsp;ip&nbsp;ospf&nbsp;interface</command></member>
		<member><command>show&nbsp;ipv6&nbsp;ospf6&nbsp;interface</command></member>
	</simplelist>
	</question>
	<answer>
	<para>En prenant l'exemple du routeur <systemitem>R2</systemitem>,
	on obtient les résultats suivants.</para>

<screen><prompt>R2#</prompt> sh ip ospf interface enp0s1.440</screen>

<screen><emphasis>enp0s1.440 is up</emphasis><co xml:id='co-int-up'/>
  ifindex 4, MTU 1500 bytes, <emphasis>BW 0 Mbit</emphasis><co xml:id='co-bw-0'/> &lt;UP,LOWER_UP,BROADCAST,RUNNING,MULTICAST>
  Internet Address 10.44.0.2/29, Broadcast 10.44.0.7, Area 0.0.0.0
  MTU mismatch detection: enabled
  <emphasis>Router ID 2.0.0.4</emphasis><co xml:id='co-router-id'/>, Network Type BROADCAST, Cost: 10
  Transmit Delay is 1 sec, State Backup, Priority 1
  <emphasis>Designated Router (ID) 1.0.0.4 Interface Address 10.44.0.1/29</emphasis><co xml:id='co-dr'/>
  <emphasis>Backup Designated Router (ID) 2.0.0.4, Interface Address 10.44.0.2</emphasis><co xml:id='co-bdr'/>
  Multicast group memberships: OSPFAllRouters OSPFDesignatedRouters
  Timer intervals configured, Hello 10s, Dead 40s, Wait 40s, Retransmit 5
    Hello due in 5.086s
  <emphasis>Neighbor Count is 1, Adjacent neighbor count is 1</emphasis><co xml:id='co-adjacent'/>
  Graceful Restart hello delay: 10s</screen>

	<para>La copie d'écran ci-dessus permet d'identifier les éléments
	suivants&nbsp;:</para>

	<calloutlist>
	<callout arearefs='co-int-up'>
	<para>L'indicateur <emphasis>is up</emphasis> confirme que l'interface est
    bien active pour le protocole de routage. Cela signifie que les messages du
    protocole <acronym>OSPF</acronym> sont transmis sur cette interface et que
    des échanges avec des routeurs <acronym>OSPF</acronym> voisins sur ce
    réseau peuvent avoir lieu.</para>
	</callout>
	<callout arearefs='co-bw-0'>
    <para>Le fait que la bande passante soit “vue” comme étant nulle montre que
    le calcul de coût de lien ne prend pas en compte ce facteur. Ce point sera
    repris dans le calcul des coûts à partir d'une référence définie dans la
    configuration des démons <acronym>OSPF</acronym>.</para>
	</callout>
	<callout arearefs='co-router-id'>
    <para>On retrouve ici l'identifiant du routeur transmis vers les autres
    routeurs voisins.</para>
	</callout>
    <callout arearefs='co-dr'>
    <para>Cette ligne identifie le routeur <acronym>OSPF</acronym>
    <systemitem>R1</systemitem> comme étant le routeur de référence sur ce
    réseau <acronym>IPv4</acronym>. Dans notre cas, la topologie triangle ne
    comprend qu'un seul routeur voisin <acronym>OSPF</acronym> par réseau, ce
    qui limite l'utilité d'un routeur de référence pour les calculs des
    meilleurs routes. Si on avait plusieurs routeurs présents sur un même
    réseau, le rôle de référent serait essentiel pour limiter les échanges de
    bases de données de routage lors des calculs de tables de topologie.</para>
	</callout>
    <callout arearefs='co-bdr'>
    <para>Cette ligen identifie le routeur <acronym>OSPF</acronym>
    <systemitem>R2</systemitem> comme étant le routeur de référence de secours
    sur ce réseau. Comme dans le cas précédent, l'utilisation d'une topologie
    triangle limite l'importance de ce rôle comme il n'y a que deux routeurs
    pour chaque côté de cette topologie.</para>
	</callout>
    <callout arearefs='co-adjacent'>
    <para>Le routeur <acronym>OSPF</acronym> a un routeur voisin sur ce réseau.
    Il s'agit du routeur <systemitem>R1</systemitem>.</para>
    </callout>
	</calloutlist>

	<para>On reprend la même démarche pour le protocole
	<acronym>OSPFv3</acronym>.</para>

<screen><prompt>R2#</prompt> sh ipv6 ospf6 interface enp0s1.440</screen>

<screen><emphasis>enp0s1.440 is up</emphasis><co xml:id='co-6-int-up'/>, type BROADCAST
  Interface ID: 4
  Internet Address:
    inet : 10.44.0.2/29
    inet6: fe80::baad:caff:fefe:6/64
    inet6: fe80::1b8:2/64
  Instance ID 0, Interface MTU 1500 (autodetect: 1500)
  MTU mismatch detection: enabled
  Area ID 0.0.0.0, Cost 10
  State BDR, Transmit Delay 1 sec, Priority 1
  Timer intervals configured:
   Hello 10(8.803), Dead 40, Retransmit 5
  <emphasis>DR: 1.0.0.6 BDR: 2.0.0.4</emphasis><co xml:id='co-6-dr'/>
  Number of I/F scoped LSAs is 2
    0 Pending LSAs for LSUpdate in Time 00:00:00 [thread off]
    0 Pending LSAs for LSAck in Time 00:00:00 [thread off]
  Graceful Restart hello delay: 10s
  Authentication Trailer is disabled</screen>

    <para>Relativement, à l'affichage des informations sur l'association entre
    une interface réseau et le démon de protocole <acronym>OSPFv2</acronym>
    pour <acronym>IPv4</acronym>, l'affichage pour <acronym>OSPFv3</acronym> et
    <acronym>IPv6</acronym> est plus succinct.</para>

    <calloutlist>
    <callout arearefs='co-6-int-up'>
    <para>Cette information est identique à celle du démon
    <acronym>OSPFv2</acronym>. L'interface est associée et active. Les messages
    du protocole <acronym>OSPFv3</acronym> peuvent être échangés sur le réseau
    auquel cette interface appartient.</para>
    </callout>
    <callout arearefs='co-6-dr'>
    <para>Les identifiants des routeurs référence et de secours sont affichés
    sur une seule ligne.</para>
    </callout>
    </calloutlist>
	</answer>
	</qandaentry>

	<qandaentry xml:id='ospf-database'>
	<question>
	<para><phrase>Comment vérifier que l'identifiant de routeur a correctement
	été attribué&nbsp;?</phrase></para>

    <para>À partir des commandes proposées et de résultats des questions
    précédentes, rechercher l'information demandée.</para>
	</question>
	<answer>
    <para>Quelque soit la version du protocole <acronym>OSPF</acronym>,
    l'identifiant de routeur est toujours codé sous la forme d'une adresse
    <acronym>IPv4</acronym>.</para>

    <para>Pour valider la conformité entre les identifiants définis dans le
    plan d'adressage des travaux pratiques et les valeurs effectivement
    utilisées par les deux démons de routage dynamique, on affiche le contenu
    des base de topologie du protocole.</para>

    <para>Avec le démon <acronym>OSPFv2</acronym>, l'identification du routeur
    est immédiate.</para>

<screen><prompt>R1#</prompt> sh ip ospf database</screen>

<screen>
       <emphasis>OSPF Router with ID (1.0.0.4)</emphasis>

                Router Link States (Area 0.0.0.0)

Link ID         ADV Router      Age  Seq#       CkSum  Link count
1.0.0.4        1.0.0.4          884 0x8000001f 0x3bee 2
2.0.0.4        2.0.0.4         1016 0x8000001d 0xab78 2
3.0.0.4        3.0.0.4          843 0x8000001d 0xd34a 2

                Net Link States (Area 0.0.0.0)

Link ID         ADV Router      Age  Seq#       CkSum
10.44.0.1      1.0.0.4          994 0x80000018 0xe61c
10.44.1.1      1.0.0.4          984 0x80000018 0xe61a
10.44.2.3      3.0.0.4          843 0x80000018 0xbc3e</screen>

    <para>En revanche, le démon <acronym>OSPFv3</acronym> ne donne pas
    d'information sur l'identifiant du processus en cours. L'affichage est
    cependant beaucoup plus exhaustif avec les informations par
    interface.</para>

<screen><prompt>R1#</prompt> sh ipv6 ospf6 database</screen>

<screen>
        Area Scoped Link State Database (Area 0)

Type LSId           AdvRouter       Age   SeqNum                        Payload
Rtr  0.0.0.0        1.0.0.6        1012 8000001b                1.0.0.6/0.0.0.5
Rtr  0.0.0.0        1.0.0.6        1012 8000001b                1.0.0.6/0.0.0.3
Rtr  0.0.0.0        2.0.0.4        1010 80000019                1.0.0.6/0.0.0.5
Rtr  0.0.0.0        2.0.0.4        1010 80000019                3.0.0.6/0.0.0.4
Rtr  0.0.0.0        3.0.0.6        1010 80000019                1.0.0.6/0.0.0.3
Rtr  0.0.0.0        3.0.0.6        1010 80000019                3.0.0.6/0.0.0.4
Net  0.0.0.3        1.0.0.6        1088 80000017                        1.0.0.6
Net  0.0.0.3        1.0.0.6        1088 80000017                        3.0.0.6
Net  0.0.0.5        1.0.0.6        1012 80000017                        1.0.0.6
Net  0.0.0.5        1.0.0.6        1012 80000017                        2.0.0.4
Net  0.0.0.4        3.0.0.6        1010 80000017                        3.0.0.6
Net  0.0.0.4        3.0.0.6        1010 80000017                        2.0.0.4

        I/F Scoped Link State Database (I/F enp0s1.440 in Area 0)<co xml:id='co-ospfv3-440'/>

Type LSId           AdvRouter       Age   SeqNum                        Payload
Lnk  0.0.0.5        1.0.0.6         303 8000001a                    fe80::1b8:1
Lnk  0.0.0.4        2.0.0.4        1019 80000017                    fe80::1b8:2

        I/F Scoped Link State Database (I/F enp0s1.441 in Area 0)<co xml:id='co-ospfv3-441'/>

Type LSId           AdvRouter       Age   SeqNum                        Payload
Lnk  0.0.0.3        1.0.0.6         288 8000001a                    fe80::1b9:1
Lnk  0.0.0.3        3.0.0.6        1090 80000017                    fe80::1b9:3

        AS Scoped Link State Database

Type LSId           AdvRouter       Age   SeqNum                        Payload</screen>

    <calloutlist>
    <callout arearefs='co-ospfv3-440'>
    <para>Sur le côté <systemitem>R1</systemitem>-<systemitem>R2</systemitem>
    du triangle, on utilise le <acronym>VLAN</acronym> 440 et les identifiants
    de routeurs correspondent.</para>
    </callout>
    <callout arearefs='co-ospfv3-441'>
    <para>Sur le côté <systemitem>R1</systemitem>-<systemitem>R3</systemitem>
    du triangle, on utilise le <acronym>VLAN</acronym> 441 et les identifiants
    de routeurs correspondent.</para>
    </callout>
    </calloutlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment identifier le type de réseau d'une
	interface&nbsp;?</phrase></para>

	<para>À partir des résultats des questions précédentes, rechercher
	l'information demandée.</para>
	</question>
	<answer>
	<para>Comme on utilise des liens Ethernet dans ce contexte de travaux
	pratiques, le type le plus important est le réseau de diffusion ou
	<wordasword>BROADCAST</wordasword>.</para>

<screen><prompt>R3#</prompt> sh ip ospf interface enp0s1.442</screen>
<screen>enp0s1.442 is up
  ifindex 4, MTU 1500 bytes, BW 0 Mbit &lt;UP,LOWER_UP,BROADCAST,RUNNING,MULTICAST>
  Internet Address 10.44.2.3/29, Broadcast 10.44.2.7, Area 0.0.0.0
  MTU mismatch detection: enabled
  Router ID 3.0.0.4, <emphasis>Network Type BROADCAST</emphasis>, Cost: 10
  Transmit Delay is 1 sec, State DR, Priority 1
  Designated Router (ID) 3.0.0.4 Interface Address 10.44.2.3/29
  Backup Designated Router (ID) 2.0.0.4, Interface Address 10.44.2.2
  Saved Network-LSA sequence number 0x80000019
  Multicast group memberships: OSPFAllRouters OSPFDesignatedRouters
  Timer intervals configured, Hello 10s, Dead 40s, Wait 40s, Retransmit 5
    Hello due in 1.361s
  Neighbor Count is 1, Adjacent neighbor count is 1
  Graceful Restart hello delay: 10s</screen>

<screen><prompt>R3#</prompt> sh ipv6 ospf6 interface enp0s1.442</screen>
<screen>enp0s1.442 is up, <emphasis>type BROADCAST</emphasis>
  Interface ID: 4
  Internet Address:
    inet : 10.44.2.3/29
    inet6: fe80::baad:caff:fefe:7/64
    inet6: fe80::1ba:3/64
  Instance ID 0, Interface MTU 1500 (autodetect: 1500)
  MTU mismatch detection: enabled
  Area ID 0.0.0.0, Cost 10
  State DR, Transmit Delay 1 sec, Priority 1
  Timer intervals configured:
   Hello 10(9.055), Dead 40, Retransmit 5
  DR: 3.0.0.6 BDR: 2.0.0.4
  Number of I/F scoped LSAs is 2
    0 Pending LSAs for LSUpdate in Time 00:00:00 [thread off]
    0 Pending LSAs for LSAck in Time 00:00:00 [thread off]
  Graceful Restart hello delay: 10s
  Authentication Trailer is disabled</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment obtenir la liste du ou des routeurs voisins pour
	chaque processus de protocole de routage dynamique
	<acronym>OSPFv2</acronym> ou
	<acronym>OSPFv3</acronym>&nbsp;?</phrase></para>

    <para>Dès qu'une interface est active, il y a émission de paquets
    <option>HELLO</option> et si un autre routeur avec une interface active
    envoie aussi des paquets <option>HELLO</option> dans le même
    <acronym>VLAN</acronym>, les deux routeurs cherchent à former une
    adjacence.</para>

	<para>La liste des commandes utiles dans la console
	<application>vtysh</application> est la suivante.</para>

	<simplelist type='horiz'>
		<member><command>show&nbsp;ip&nbsp;ospf&nbsp;neighbor</command></member>
		<member><command>show&nbsp;ipv6&nbsp;ospf6&nbsp;neighbor</command></member>
	</simplelist>
	</question>
	<answer>
	<para>À partir du routeur <systemitem>R1</systemitem>, voici un
	exemple de liste de routeurs <acronym>OSPF</acronym> voisins dans laquelle
	on reconnaît les identifiants des routeurs <systemitem>R2</systemitem> et
	<systemitem>R3</systemitem>.</para>

<screen><prompt>R1#</prompt> sh ip ospf neighbor</screen>

<screen>Neighbor ID     Pri State           Up Time         Dead Time Address         Interface               RXmtL RqstL DBsmL
<emphasis>2.0.0.4</emphasis>           1 Full/Backup     11h34m21s         37.712s 10.44.0.2       enp0s1.440:10.44.0.1    0     0     0
<emphasis>3.0.0.4</emphasis>           1 Full/Backup     11h35m30s         33.792s 10.44.1.3       enp0s1.441:10.44.1.1    0     0     0</screen>

<screen><prompt>R1#</prompt> sh ipv6 ospf6 neighbor</screen>

<screen>Neighbor ID     Pri    DeadTime    State/IfState         Duration I/F[State]
<emphasis>2.0.0.4</emphasis>           1    00:00:37     Full/BDR             11:36:00 enp0s1.440[DR]
<emphasis>3.0.0.6</emphasis>           1    00:00:37     Full/BDR             11:37:15 enp0s1.441[DR]</screen>

    <para>Les deux listes de voisins donnent une information essentielle sur
    l'état de protocole de routage avec le mot clé
    <systemitem>Full</systemitem>. Cet état indique que deux routeurs adjacents
    ont entièrement synchronisé leurs bases de données d’état de liens,
    permettant ainsi un échange complet des informations de routage.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment identifier le rôle des différentes interfaces des
	routeurs pour chacun des liens du triangle de la topologie
	logique&nbsp;?</phrase></para>

<warning>
	<para>La réponse à cette question suppose que les démons
	<acronym>OSPF</acronym> des trois routeurs de la topologie logique en
	triangle aient convergé. On doit repérer l'état <option>Full</option> pour
	les listes de routeurs voisins.</para>

	<para>De plus, la réponse varie en fonction de l'ordre d'activation des
	démons <acronym>OSPF</acronym> des différents routeurs. En effet, un
	routeur peut être élu routeur désigné (<acronym>DR</acronym>) en l'absence
	de routeurs voisins. Cette élection n'est pas remise en cause tant qu'il
	n'y pas de changement d'état de lien.</para>
</warning>

	<para>À partir des résultats des questions précédentes sur les interfaces
	actives, il est possible de compléter le schéma de la topologie étudiée
	avec l'état des interfaces pour chacun des trois liens.</para>
	</question>
	<answer>

	<mediaobject>
	<imageobject role='fo'>
		<imagedata format='PNG'
		fileref='images/OSPF-lab-link-states.png'
		width='10cm' scalefit='1' />
	</imageobject>
	<imageobject role='html'>
		<imagedata format='PNG'
		fileref='images/OSPF-lab-link-states.png'
		width='480px' scalefit='1' />
	</imageobject>
	<textobject>
		<phrase>Topologie logique OSPF et rôle des interfaces de
		routeurs</phrase>
	</textobject>
	</mediaobject>

	<para>Sur un même réseau de diffusion, il est possible de trouver plusieurs
	routeurs <acronym>OSPF</acronym>. Établir une relation de voisinage et
	procéder aux échanges de bases de données topologiques entre chaque routeur
	revient à constituer un réseau de relations complètement maillé. À chaque
	nouveau calcul de topologie, ce réseau complètement maillé est inefficace.
	C'est la raison pour laquelle la notion de routeur référent ou
	<wordasword>Designated Router</wordasword> a été introduite. Lors d'un
	recalcul de topologie, tous les routeurs s'adressent au routeur référent
	qui correspond au cœur d'un réseau en topologie étoile.</para>

	<para>Dans le contexte de la topologie triangle étudiée, il y a bien
	élection d'un routeur référent et d'un routeur référent de secours.
	Cependant, comme il n'y a que deux routeurs par domaine de diffusion ou
	<acronym>VLAN</acronym>, on ne peut pas caractériser l'utilité de cette
	élection.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Quels sont les réseaux <acronym>IPv4</acronym> et
    <acronym>IPv6</acronym> présents dans la table de topologie du protocole
    <acronym>OSPF</acronym>&nbsp;?</phrase></para>

	<para>On cherche a visualiser la liste des préfixes des réseaux connus des
	deux démons <acronym>OSPF</acronym>.</para>

	<para>La liste des commandes utiles dans la console
	<application>vtysh</application> est la suivante.</para>

	<simplelist type='horiz'>
		<member><command>show&nbsp;ip&nbsp;ospf&nbsp;route</command></member>
		<member><command>show&nbsp;ipv6&nbsp;ospf6 route</command></member>
	</simplelist>
	</question>
	<answer>
	<para>Une fois que les trois routeurs de la topologie ont convergé, chaque
	démon connaît les trois préfixes qui correspondent aux trois côtés du
	triangle. Un routeur correspond à un sommet du triangle et il doit
	apprendre le préfixe réseau du côté opposé via ses deux routeurs
	voisins.</para>

	<para>Voici la vue depuis le routeur
	<systemitem>R1</systemitem>.</para>

<screen><prompt>R1#</prompt> sh ip ospf route</screen>
<screen>============ OSPF network routing table ============
N    10.44.0.0/29          <emphasis>[10]</emphasis> area: 0.0.0.0
                           directly attached to enp0s1.440
N    10.44.1.0/29          <emphasis>[10]</emphasis> area: 0.0.0.0
                           directly attached to enp0s1.441
N    10.44.2.0/29          <emphasis>[20]</emphasis> area: 0.0.0.0
                           via 10.44.0.2, enp0s1.440
                           via 10.44.1.3, enp0s1.441

============ OSPF router routing table =============

============ OSPF external routing table ===========</screen>

	<para>Les valeurs notées entre crochets correspondent à la métrique du lien
	pour joindre le réseau noté à gauche.</para>

<screen><prompt>R1#</prompt> sh ipv6 ospf6 route</screen>

    <para>Cette dernière commande ne produit aucun résultat et c'est
    normal&nbsp;! En effet, avec le protocole <acronym>IPv6</acronym> les
    relations de voisinage entre routeurs (adjacences) se font avec les
    adresses <acronym>IPv6</acronym> de lien local.</para>

    <para>Formulé autrement, les trois côtés de la topologie triangle sont des
    réseaux de transit qui servent à acheminer le trafic entre routeurs
    voisins. Il est inutile de gaspiller un préfixe réseau
    <acronym>IPv6</acronym> pour cette tâche.</para>
    </answer>
    </qandaentry>
	<qandaentry>
	<question>
    <para><phrase>Comment sont calculées les coûts de liens pour joindre les
    réseaux&nbsp;?</phrase></para>

    <para>Rechercher les informations sur les calculs de coûts dans les
    supports de cours sur le protocole <acronym>OSPF</acronym>.</para>
    </question>
    <answer>
    <para>Depuis la première spécification du protocole
    <acronym>OSPF</acronym>, le calcul de métrique peut se faire suivant deux
    méthodes.</para>

    <itemizedlist>
    <listitem>
    <para>À partir de l'expression&nbsp;: 10<superscript>8</superscript> /
	Bande_Passante_du_lien</para>
    </listitem>
    <listitem>
    <para>À partir d'une valeur <option>Cost</option> définie manuellement</para>
    </listitem>
    </itemizedlist>

    <note>
	<para>La valeur du numérateur (10<superscript>8</superscript>) correspond à
	un débit de 100Mbps. À l'époque de la rédaction du standard
	<acronym>OSPFv2</acronym>, ce débit a servi de référence. Aujourd'hui,
	cette valeur est complètement dépassée. C'est la raison pour laquelle on
	adapte le calcul de métrique en changeant le coefficient du numérateur.
	Voir la <xref linkend='ospf.auto-cost' />.</para>
    </note>

    <para>Dans notre cas, chaque interface de routeur a un coût de
    <option>10</option> et une valeur de “bande passante” de <option>0</option>
    par défaut. Utilisez la commande d'affichage des information
    <acronym>OSPF</acronym> pour revoir ces valeurs.</para>

	<simplelist type='horiz'>
		<member><command>show&nbsp;ip&nbsp;ospf&nbsp;interface</command></member>
		<member><command>show&nbsp;ipv6&nbsp;ospf6&nbsp;interface</command></member>
	</simplelist>

    <para>Pour <acronym>OSPFv2</acronym>, les deux premiers réseaux de la table
    sont joignable via un unique lien avec un coût de <option>10</option>. Le
    troisième réseau est joignable via deux liens&nbsp;; d'où la métrique de
    <option>20</option>.</para>

	<para>Pour les préfixes <acronym>IPv6</acronym>, aucun préfixe n'est
	présent sachant que les relations de voisinage entre routeurs utilisent
	obligatoirement les adresses de lien local appartenant au préfixe
	<systemitem class='ipaddress'>fe80::/10</systemitem>.</para>

    <para>Les préfixes des réseaux d'hébergement de conteneurs apparaitront dès
    que le protocole de routage aura été activé pour les interfaces
    <acronym>SVI</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment visualiser les tables de routage depuis la console
	<command>vtysh</command>&nbsp;?</phrase></para>

	<para>L'affichage demandé illustre les mécanismes de choix entre
	différentes solutions pour une même destination. Cet affichage est à
	comparer avec celui demandé à la question suivante.</para>

	<para>La liste des commandes utiles dans la console
	<application>vtysh</application> est la suivante.</para>

	<simplelist type='horiz'>
		<member><command>show&nbsp;ip&nbsp;route</command></member>
		<member><command>show&nbsp;ipv6&nbsp;route</command></member>
	</simplelist>
	</question>
	<answer>
	<para>On reprend à nouveau l'exemple du routeur
	<systemitem>R1</systemitem>.</para>

<screen><prompt>R1#</prompt> sh ip route</screen>

<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* 0.0.0.0/0 [0/0] via 192.168.104.129, enp0s1.360, 15:22:36
O   10.44.0.0/29 [110/10] is directly connected, enp0s1.440, weight 1, 13:49:19
C>* 10.44.0.0/29 is directly connected, enp0s1.440, 15:22:36
L>* 10.44.0.1/32 is directly connected, enp0s1.440, 15:22:36
O   10.44.1.0/29 [110/10] is directly connected, enp0s1.441, weight 1, 13:48:58
C>* 10.44.1.0/29 is directly connected, enp0s1.441, 15:22:36
L>* 10.44.1.1/32 is directly connected, enp0s1.441, 15:22:36
O>* 10.44.2.0/29 [110/20] via 10.44.0.2, enp0s1.440, weight 1, 12:30:55
  *                       via 10.44.1.3, enp0s1.441, weight 1, 12:30:55
C>* 192.168.104.128/29 is directly connected, enp0s1.360, 15:22:36
L>* 192.168.104.130/32 is directly connected, enp0s1.360, 15:22:36</screen>

<screen><prompt>R1#</prompt> sh ipv6 route</screen>

<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* ::/0 [0/1024] via fe80:168::1, enp0s1.360 onlink, 15:23:47
K d 2001:678:3fc:168::/64 [0/512] is directly connected, enp0s1.360, 15:23:44
C>* 2001:678:3fc:168::/64 is directly connected, enp0s1.360, 15:23:46
L>* 2001:678:3fc:168::82/128 is directly connected, enp0s1.360, 15:23:46
C * fe80::/64 is directly connected, enp0s1.360, 15:23:45
C * fe80::/64 is directly connected, enp0s1.440, 15:23:46
C * fe80::/64 is directly connected, enp0s1, 15:23:46
C>* fe80::/64 is directly connected, enp0s1.441, 15:23:46</screen>

	<itemizedlist>
	<listitem>
	<para>Les entrées marquées avec le caractère <option>*</option>
	correspondent aux routes retenues et mémorisées par le sous-système réseau
	du noyau. Les autres entrées sont placées en réserve au cas où la solution
	initialement retenue serait en défaut.</para>
	</listitem>
	<listitem>
	<para>L'entrée notée <option>K</option> correspond à une route apprise
	depuis le sous-système réseau du noyau.</para>
	</listitem>
	<listitem>
	<para>Les entrées notées <option>C</option> correspondent à des routes pour
	lesquelles il existe une interface sur le routeur. Les métriques de ses
	routes ont la valeur <option>0</option>. Ce sont les routes les plus
	prioritaires.</para>
	</listitem>
	<listitem>
    <para>Les entrées notées <option>L</option> correspondent aux adresses
    locales du routeur dans un réseau connecté.</para>
	</listitem>
	<listitem>
	<para>Les entrées notées <option>O</option> correspondent aux routes
	apprises via le protocole <acronym>OSPF</acronym>. La métrique de ces
	routes se décompose en deux parties. La valeur figée à <option>110</option>
	définit le niveau de priorité du protocole <acronym>OSPF</acronym>
	(<wordasword>Administrative Distance</wordasword>) relativement aux autres
	protocoles de routage. Les valeurs notées après le <option>/</option> sont
	les métriques de liens calculées comme indiqué ci-dessus.</para>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment visualiser les tables de routage au niveau
	système&nbsp;?</phrase></para>

	<para>Utiliser une commande usuelle de visualisation de la table de
	routage.</para>

	<simplelist type='horiz'>
		<member><command>ip&nbsp;route&nbsp;ls</command></member>
		<member><command>ip&nbsp;-6&nbsp;route&nbsp;ls</command></member>
	</simplelist>
	</question>
	<answer>
	<para>Avec la commande <command>ip</command>, on voit apparaître les
	sources d'alimentation de la table de routage finale du système.</para>

	<itemizedlist>
	<listitem>
	<para><option>kernel</option> pour les entrées connues du sous-système
	réseau du noyau. Ce sont les entrées avec le caractère <option>C</option>
	dans la console <command>vtysh</command>.</para>
	</listitem>
	<listitem>
	<para><option>ospf</option> pour les entrées apprises via le protocole de
	routage dynamique. Le réseau correspond au côté opposé au sommet du
	triangle est appris via <acronym>OSPF</acronym> puisque le sous-système
	réseau du noyau ne le connaît pas.</para>
	</listitem>
	</itemizedlist>

<screen>ip route ls</screen>
<screen>default via 192.168.104.129 dev enp0s1.360 proto static
10.44.0.0/29 dev enp0s1.440 proto kernel scope link src 10.44.0.1
10.44.1.0/29 dev enp0s1.441 proto kernel scope link src 10.44.1.1
10.44.2.0/29 nhid 30 <emphasis>proto ospf metric 20</emphasis>
        nexthop via 10.44.1.3 dev enp0s1.441 weight 1
        nexthop via 10.44.0.2 dev enp0s1.440 weight 1
192.168.104.128/29 dev enp0s1.360 proto kernel scope link src 192.168.104.130</screen>

	<para>La table de routage <acronym>IPv6</acronym> ne fait apparaître aucune
	nouvelle entrée puisque les réseaux de conteneurs desservis par
	<systemitem>R2</systemitem> et <systemitem>R3</systemitem> n'ont pas encore
	été annoncés à ce stade de la configuration.</para>

<screen>ip -6 route ls</screen>
<screen>2001:678:3fc:168::/64 dev enp0s1.360 proto kernel metric 256 pref medium
2001:678:3fc:168::/64 dev enp0s1.360 proto ra metric 512 expires 2591830sec pref high
fe80::/64 dev enp0s1 proto kernel metric 256 pref medium
fe80::/64 dev enp0s1.441 proto kernel metric 256 pref medium
fe80::/64 dev enp0s1.360 proto kernel metric 256 pref medium
fe80::/64 dev enp0s1.440 proto kernel metric 256 pref medium
default via fe80:168::1 dev enp0s1.360 proto static metric 1024 onlink pref medium</screen>
    </answer>
	</qandaentry>
	</qandaset>
</sect1>

<sect1 xml:id='ospf.default-information'>
	<title>Publier les routes par défaut via OSPF</title>

	<para>Dans la topologie logique étudiée, le routeur <systemitem
	class='systemname'>R1</systemitem> dispose d'un lien montant vers
	l'Internet. On peut donc considérer que ce lien est la route par défaut
	vers tous les réseaux non connus de l'aire <acronym>OSPF</acronym>
	contenant les trois routeurs.</para>

	<para>Il est possible de publier une route par défaut via le protocole
	<acronym>OSPF</acronym> depuis le routeur <systemitem
	class='systemname'>R1</systemitem> vers les routeurs <systemitem
	class='systemname'>R2</systemitem> et <systemitem
	class='systemname'>R3</systemitem>.</para>

    <para>Pour rappel, revoir la question <xref linkend='ospf-database'/> et
    consulter les bases de données <acronym>OSPFv2</acronym> et
    <acronym>OSPFv3</acronym> avant la mise en place de la publication de route
    par défaut. On reconnaît les <acronym>LSA</acronym>s (<wordasword>Link
    State Advertisement)</wordasword>) de type 1 et 2 qui correspondent
    respectivement aux annonces de routeurs et de réseaux.</para>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
	<para><phrase>Quelle est la condition préalable à respecter pour que le
	routeur <systemitem class='systemname'>R1</systemitem> soit en mesure de
	publier une route par défaut via le protocole de routage
	<acronym>OSPF</acronym>&nbsp;?</phrase></para>

	<para>À partir des tables de routage relevées dans la <xref
	linkend='ospf.protocol-config' />, repérer le routeur qui
	dispose d'un accès vers un réseau qui n'appartient pas à la topologie
	triangle.</para>

	<simplelist type='horiz'>
		<member><command>ip&nbsp;route&nbsp;ls&nbsp;default</command></member>
		<member><command>ip&nbsp;-6&nbsp;route&nbsp;ls&nbsp;default</command></member>
		<member><command>sh&nbsp;ip&nbsp;route&nbsp;kernel</command></member>
		<member><command>sh&nbsp;ipv6&nbsp;route&nbsp;kernel</command></member>
	</simplelist>
	</question>
	<answer>
	<para>Une route par défaut doit exister avant d'être injectée dans une aire
	<acronym>OSPF</acronym>. Dans notre cas, une route statique par défaut
	suffit à respecter la condition préalable.</para>

	<para>Sur la maquette, on valide la présence des routes par défaut à l'aide
	la commande <command>ip</command> au niveau système.</para>

<screen>ip route ls default</screen>
<screen><emphasis>default via 192.168.104.129</emphasis> dev enp0s1.360 proto static</screen>

<screen>ip -6 route ls default</screen>
<screen><emphasis>default via fe80:168::1</emphasis> dev enp0s1.360 proto static metric 1024 onlink pref medium</screen>

	<para>Au niveau de la console <command>vtysh</command>, ces même routes
	correspondent aux entrées marquées <option>K</option> pour
	<wordasword>kernel</wordasword>.</para>

<screen><prompt>R1#</prompt> sh ip route kernel</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* <emphasis>0.0.0.0/0 [0/0] via 192.168.104.129</emphasis>, enp0s1.360, 15:40:19</screen>

<screen><prompt>R1#</prompt> sh ipv6 route kernel</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

K>* <emphasis>::/0 [0/1024] via fe80:168::1</emphasis>, enp0s1.360 onlink, 15:41:24
K d 2001:678:3fc:168::/64 [0/512] is directly connected, enp0s1.360, 15:41:2</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est l'instruction à utiliser pour publier une route
	par défaut via le protocole de routage
	<acronym>OSPFv2</acronym>&nbsp;?</phrase></para>

	<para>Parmi toutes les méthodes de redistribution de routes disponibles
	avec le protocole <acronym>OSPFv2</acronym>, il en existe une dédiée à
	l'injection de route par défaut dans une aire normale. Consulter le guide
	&url.frr-documentation;.</para>

	<para>Rechercher le mot clé <option>redistribution</option> dans la section
	<citetitle>OSPF route-map</citetitle>.</para>
	</question>
	<answer>
	<para>L'instruction qui correspond à la redistribution de route par défaut
	à destination des autres routeurs de l'aire <acronym>OSPF</acronym> est la
	suivante.</para>

	<simplelist type='horiz'>
		<member><command>default-information&nbsp;originate</command></member>
	</simplelist>

	<para>On doit l'appliquer dans la section
	<wordasword>router&nbsp;ospf</wordasword> de la configuration du routeur
	<systemitem class='systemname'>R1</systemitem>.</para>

<screen><prompt>R1#</prompt> conf t
R1(config)# router ospf
R1(config-router)# default-information originate
R1(config-router)# ^Z</screen>

	<para>Une fois cette instruction exécutée, le rôle du routeur <systemitem
	class='systemname'>R1</systemitem> change. Il devient
	<wordasword>Autonomous System Boundary Router</wordasword> ou
	<acronym>ASBR</acronym>. Les bases de données sont complétées avec des
	<acronym>LSAs</acronym> de type 5.</para>

<screen><prompt>R1#</prompt> sh ip ospf database external</screen>
<screen>
       OSPF Router with ID (1.0.0.4)

                AS External Link States

  LS age: 32
  Options: 0x2  : *|-|-|-|-|-|E|-
  LS Flags: 0xb
  LS Type: AS-external-LSA
  Link State ID: 0.0.0.0 (External Network Number)
  Advertising Router: 1.0.0.4
  LS Seq Number: 80000001
  Checksum: 0x269d
  Length: 36

  Network Mask: /0
        Metric Type: 2 (Larger than any link state path)
        TOS: 0
        Metric: 10
        Forward Address: 0.0.0.0
        External Route Tag: 0</screen>

	<para>On voit apparaître une nouvelle rubrique baptisée <wordasword>AS
	External Link States</wordasword>. Ce nouveau rôle pour le routeur
	<systemitem class='systemname'>R1</systemitem> apparaît aussi lorsque l'on
	affiche l'état de l'instance de routage <acronym>OSPFv2</acronym>.</para>

<screen><prompt>R1#</prompt> sh ip ospf</screen>
<screen> OSPF Routing Process, Router ID: 1.0.0.4
 Supports only single TOS (TOS0) routes
 This implementation conforms to RFC2328
 RFC1583Compatibility flag is disabled
 OpaqueCapability flag is disabled
 Initial SPF scheduling delay 0 millisec(s)
 Minimum hold time between consecutive SPFs 50 millisec(s)
 Maximum hold time between consecutive SPFs 5000 millisec(s)
 Hold time multiplier is currently 1
 SPF algorithm last executed 2m04s ago
 Last SPF duration 68 usecs
 SPF timer is inactive
 LSA minimum interval 5000 msecs
 LSA minimum arrival 1000 msecs
 Write Multiplier set to 20
 Refresh timer 10 secs
 Maximum multiple paths(ECMP) supported 256
 Administrative distance 110
 <emphasis>This router is an ASBR (injecting external routing information)</emphasis>
 Number of external LSA 1. Checksum Sum 0x0000269d
 Number of opaque AS LSA 0. Checksum Sum 0x00000000
 Number of areas attached to this router: 1
 All adjacency changes are logged
 Area ID: 0.0.0.0 (Backbone)
   Number of interfaces in this area: Total: 2, Active: 2
   Number of fully adjacent neighbors in this area: 2
   Area has no authentication
   SPF algorithm executed 9 times
   Number of LSA 6
   Number of router LSA 3. Checksum Sum 0x0001a8b4
   Number of network LSA 3. Checksum Sum 0x0002727f
   Number of summary LSA 0. Checksum Sum 0x00000000
   Number of ASBR summary LSA 0. Checksum Sum 0x00000000
   Number of NSSA LSA 0. Checksum Sum 0x00000000
   Number of opaque link LSA 0. Checksum Sum 0x00000000
   Number of opaque area LSA 0. Checksum Sum 0x00000000</screen>

	<para>Le routeur <systemitem class='systemname'>R1</systemitem>, est
	maintenant à la frontière entre deux systèmes autonomes. Il est responsable
	de l'émission des <acronym>LSA</acronym>s de type 5 à destination des
	autres routeurs de l'aire.</para>

	<para>Ici, <systemitem class='systemname'>R1</systemitem> possède une route
	statique définie au niveau système vers l'Internet. Cette route statique
	est redistribuée <systemitem class='systemname'>R2</systemitem> et
	<systemitem class='systemname'>R3</systemitem>. Cette route apparaît comme
	une entrée de type <option>E2</option> dans les tables de routage de ces
	routeurs.</para>

	<para>L'indicateur <option>E2</option> correspond au type par défaut des
	routes apprises par le biais de la redistribution. La métrique est un point
	important à considérer avec les routes de type <option>E2</option>. Ces
	routes ne présentent que le coût du chemin allant du routeur
	<acronym>ASBR</acronym> vers le réseau de destination&nbsp;; ce qui ne
	correspond pas au coût réel du chemin à l'intérieur de l'aire
	<acronym>OSPF</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est l'instruction à utiliser pour publier une route
	par défaut via le protocole de routage
	<acronym>OSPFv3</acronym>&nbsp;?</phrase></para>

	<para>Reprendre la même démarche de la question précédente avec le
	protocole <acronym>OSPFv3</acronym>. Consulter le guide
	&url.frr-documentation;.</para>

	<para>Rechercher le mot clé <option>redistribution</option> dans la section
	<citetitle>OSPF6 route-map</citetitle>.</para>
	</question>
	<answer>
	<para>L'instruction est identique pour les deux versions du protocole
	<acronym>OSPF</acronym>.</para>

	<simplelist type='horiz'>
		<member><command>default-information&nbsp;originate</command></member>
	</simplelist>

	<para>On doit l'appliquer dans la section
	<wordasword>router&nbsp;ospf6</wordasword> de la configuration du routeur
	<systemitem class='systemname'>R1</systemitem>.</para>

<screen><prompt>R1#</prompt> conf t
R1(config)# router ospf6
R1(config-ospf6)# default-information originate
R1(config-ospf6)# ^Z</screen>

	<para>Une fois cette instruction exécutée, le rôle du routeur <systemitem
	class='systemname'>R1</systemitem> change. Il devient
	<wordasword>Autonomous System Boundary Router</wordasword> ou
	<acronym>ASBR</acronym>. Les bases de données sont complétées avec des
	<acronym>LSAs</acronym> de type 5.</para>

<screen><prompt>R1#</prompt> sh ipv6 ospf6 database as-external</screen>
<screen>
        AS Scoped Link State Database

Type LSId           AdvRouter       Age   SeqNum                        Payload
ASE  0.0.0.1        1.0.0.6          42 80000001                             <emphasis>::</emphasis></screen>

	<para>On voit apparaître une nouvelle rubrique baptisée <wordasword>AS
	Scoped Link State Database</wordasword>. Ce nouveau rôle pour le routeur
	<systemitem class='systemname'>R1</systemitem> apparaît aussi lorsque l'on
	affiche l'état de l'instance de routage <acronym>OSPFv3</acronym>.</para>

<screen><prompt>R1#</prompt> sh ipv6 ospf6</screen>
<screen> OSPFv3 Routing Process (0) with Router-ID 1.0.0.6
 Running 14:44:14
 LSA minimum arrival 1000 msecs
 Maximum-paths 256
 Administrative distance 110
 Initial SPF scheduling delay 0 millisec(s)
 Minimum hold time between consecutive SPFs 50 millsecond(s)
 Maximum hold time between consecutive SPFs 5000 millsecond(s)
 Hold time multiplier is currently 1
 SPF algorithm last executed 00:01:59 ago, reason R+, R-, A
 Last SPF duration 0 sec 145 usec
 SPF timer is inactive
 <emphasis>Number of AS scoped LSAs is 1</emphasis>
 Number of areas in this router is 1
 Authentication Sequence number info
  Higher sequence no 0, Lower sequence no 0
 All adjacency changes are logged

 Area 0
     Number of Area scoped LSAs is 6
     Interface attached to this area: enp0s1.440 enp0s1.441
     SPF last executed 119.712612s ago</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment la publication de route par défaut apparaît elle sur
	les autres routeurs de la topologie triangle&nbsp;?</phrase></para>

	<para>Relevez, dans la console <command>vtysh</command>, la métrique de la
	route par défaut sur les routeurs qui n'ont pas une connexion directe vers
	l'Internet.</para>

	<para>Les instructions à utiliser pour traiter cette question entrent dans
	la liste suivante.</para>

	<simplelist type='horiz'>
		<member><command>show ip route A.B.C.D/MM</command></member>
		<member><command>show ipv6 route A:B:C::D/MM</command></member>
		<member><command>show ip ospf route</command></member>
		<member><command>show ipv6 ospf6 route</command></member>
	</simplelist>
	</question>
	<answer>
	<para>En prenant l'exemple du routeur <systemitem
	class='systemname'>R2</systemitem>, on retrouve les informations
	suivantes.</para>

	<itemizedlist>
	<listitem>
	<para>Vue de la table de routage&nbsp;:</para>

<screen><prompt>R2#</prompt> sh ip route 0.0.0.0</screen>
<screen>Routing entry for 0.0.0.0/0
  <emphasis>Known via "ospf"</emphasis>, distance 110, metric 10, best
  Last update 00:07:09 ago
  * 10.44.0.1, via enp0s1.440, weight 1</screen>

<screen><prompt>R2#</prompt> sh ipv6 route ::</screen>
<screen>Routing entry for ::/0
  <emphasis>Known via "ospf6"</emphasis>, distance 110, metric 10, best
  Last update 00:05:09 ago
  * fe80::1b8:1, via enp0s1.440, weight 1</screen>
	</listitem>
	<listitem>
	<para>Vue de la base de topologie <acronym>OSPF</acronym>&nbsp;:</para>

<screen><prompt>R2#</prompt> sh ip ospf route</screen>
<screen>============ OSPF network routing table ============
N    10.44.0.0/29          [10] area: 0.0.0.0
                           directly attached to enp0s1.440
N    10.44.1.0/29          [20] area: 0.0.0.0
                           via 10.44.0.1, enp0s1.440
                           via 10.44.2.3, enp0s1.442
N    10.44.2.0/29          [10] area: 0.0.0.0
                           directly attached to enp0s1.442

============ OSPF router routing table =============
R    1.0.0.4               [10] area: 0.0.0.0, ASBR
                           via 10.44.0.1, enp0s1.440

============ OSPF external routing table ===========
N <emphasis>E2 0.0.0.0/0</emphasis>             [10/10] tag: 0
                           via 10.44.0.1, enp0s1.440</screen>

<screen><prompt>R2#</prompt> sh ipv6 ospf6 route</screen>
<screen>*N <emphasis>E2 ::/0</emphasis>                           fe80::1b8:1               enp0s1.440 00:07:18</screen>
	</listitem>
	</itemizedlist>

	<para>Avec les copies d'écran ci-dessus, on vérifie bien que les routes par
	défaut ont été apprises via le protocole <acronym>OSPF</acronym>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment assurer la traduction d'adresses source sur
	l'interface de sortie du routeur <systemitem
	class='systemname'>R1</systemitem> vers l'Internet&nbsp;?</phrase></para>

    <para>Reprendre la section <citetitle>Activation de la traduction
    d'adresses</citetitle> du support &url.interco.pppoe;.</para>
	</question>
	<answer>
	<para>Dans le cas de la maquette, c'est l'interface
	<systemitem>enp0s1.360</systemitem> qui assure l'interconnexion avec
	l'Internet. Voici une copie de l'instruction d'ajout de la règle de
	traduction des adresses sources et de sa sauvegarde pour
	<acronym>IPv4</acronym> et <acronym>IPv6</acronym>.</para>

    <itemizedlist>
    <listitem>
    <para>Installer le paquet <systemitem>nftables</systemitem>.</para>

<screen>sudo apt -y install nftables</screen>
    </listitem>
    <listitem>
    <para>Créer le fichier de règles <filename>/etc/nftables.conf</filename>.</para>

<screen>cat &lt;&lt; EOF | sudo tee /etc/nftables.conf
#!/usr/sbin/nft -f

flush ruleset

table inet nat {
    chain postrouting {
        type nat hook postrouting priority 100;
        oifname "enp0s1.360" masquerade
    }
}
EOF</screen>
    </listitem>
    <listitem>
    <para>Appliquer la règle de traduction d'adresses sources en activant le
    service.</para>

<screen>sudo systemctl enable --now nftables.service</screen>
    </listitem>
    <listitem>
    <para>Afficher la liste des règles de filtrage actives.</para>

<screen>sudo nft list ruleset</screen>
    </listitem>
    </itemizedlist>

    <para>Pour terminer, on peut lancer des tests de communication
    <acronym>ICMP</acronym> <acronym>IPv4</acronym> depuis les routeurs
    <systemitem>R2</systemitem> ou <systemitem>R3</systemitem>.</para>

<screen><prompt>etu@R2:~$</prompt> ping -qc2 9.9.9.9
PING 9.9.9.9 (9.9.9.9) 56(84) bytes of data.

--- 9.9.9.9 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1002ms
rtt min/avg/max/mdev = 28.604/28.676/28.748/0.072 ms</screen>

    <important>
    <para>À ce stade de la configuration, les tests <acronym>IPv6</acronym>
    sont impossible à réaliser dans la mesure où toutes les adresses présentes
    sont des adresses de lien local.</para>
    </important>
	</answer>
	</qandaentry>
	</qandaset>
</sect1>

<sect1 xml:id='ospf.containersi-network'>
	<title>Ajouter un réseau d'hébergement à chaque routeur</title>

	<para>Dans cette section, on créé un réseau de conteneur attaché à chaque
	routeur de la topologie triangle. L'objectif est de peupler les tables de
	routage en ajoutant un lien <acronym>OSPF</acronym> au delà des
	routeurs.</para>

	<para>Une fois ces réseaux en place, il est possible de réaliser des tests
	de connectivité entre conteneurs et d'optimiser les métriques.</para>

    <para>Cette partie reprend le contenu de la section <citetitle>Réseau
    d'hébergement de conteneurs</citetitle> du support de travaux pratiques
    &url.interco.pppoe;.</para>

<qandaset>
	<qandaentry>
	<question>
    <para><phrase>Quels sont les paquets à installer pour mettre en place un
    commutateur d'accès et le gestionnaire de conteneurs
    <citetitle>Incus</citetitle>&nbsp;?</phrase></para>

    <para>Consulter la section <citetitle>Réseau d'hébergement de
    conteneurs</citetitle> du support &url.interco.pppoe;.</para>

    <note>
    <para>Pour les routeurs <systemitem>R2</systemitem> et
    <systemitem>R3</systemitem>, il faut rétablir l'accès temporaire à Internet
    pour installer les paquets demandés.</para>
    </note>
	</question>
	<answer>
    <variablelist>
    <varlistentry>
    <term>openvswitch-switch</term>
    <listitem>
    <para>Création d'un commutateur de raccordement des conteneurs et d'une
    interface virtuelle commutée</para>
    </listitem>
    </varlistentry>
    <varlistentry>
    <term>dnsmasq</term>
    <listitem>
    <para>Adressage automatique des conteneurs</para>
    </listitem>
    </varlistentry>
    <varlistentry>
    <term>incus</term>
    <listitem>
    <para>Gestion des conteneurs</para>
    </listitem>
    </varlistentry>
    </variablelist>

<screen>sudo apt -y install openvswitch-switch dnsmasq incus</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Quelles sont les modifications à apporter au fichier de
    déclaration <acronym>YAML</acronym>
    <filename>/etc/netplan/enp0s1.yaml</filename> pour créer le commutateur
    <systemitem>asw-host</systemitem>&nbsp;?</phrase></para>
	</question>
	<answer>
    <para>Voici un extrait du fichier
    <filename>/etc/netplan/enp0s1.yaml</filename> avec les instructions de
    création du commutateur <systemitem>asw-host</systemitem>.</para>

<screen>
    <emphasis>openvswitch: {}</emphasis>

  bridges:
    <emphasis>asw-host:</emphasis>
      <emphasis>openvswitch: {}</emphasis></screen>
	</answer>
	</qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment ajouter une nouvelle interface virtuelle commutée
    (<wordasword>Switched Virtual Interface</wordasword>) qui servira de
    passerelle par défaut pour tous les conteneurs
    hébergés&nbsp;?</phrase></para>

    <para>Rechercher dans la documentation <application>Netplan</application>
    des exemples de déclarations d'interfaces de type <acronym>SVI</acronym>
    appartenant à des <acronym>VLAN</acronym>s.</para>
    </question>
    <answer>
    <para>Voici une copie complète du fichier
    <filename>/etc/netplan/enp0s1.yaml</filename> du routeur
    <systemitem>R2</systemitem> auquel on ajouté la déclaration d'une interface
    <systemitem>vlan20</systemitem> avec les adresses <acronym>IPv4</acronym>
    et <acronym>IPv6</acronym> conformes au contexte de la maquette utilisée
    pour la rédaction de ce document.</para>

<screen>network:
    version: 2
    ethernets:
      enp0s1:
        dhcp4: false
        dhcp6: false
        accept-ra: false
        nameservers:
          addresses:
            - 172.16.0.2
            - 2001:678:3fc:3::2

    openvswitch: {}

    bridges:
      asw-host:
        openvswitch: {}

    vlans:
#      # Temporary Internet access
#      enp0s1.52:
#        id: 52
#        link: enp0s1
#        dhcp4: true
#        dhcp6: false
#        accept-ra: true
      # R2 -> R1
      enp0s1.440:
        id: 440
        link: enp0s1
        addresses:
          - 10.44.0.2/29
          - fe80::1b8:2/64
      # R2 -> R3
      enp0s1.442:
        id: 442
        link: enp0s1
        addresses:
          - 10.44.2.2/29
          - fe80::1ba:2/64
      vlan20:
        id: 20
        link: asw-host
        addresses:
          - 10.20.0.1/24
          - fd14:ca46:3864:14::1/64</screen>

    <para>Avec ce fichier de déclaration l'interface d'accès temporaire est
    commentée et ne servira plus dans la suite des manipulations. À partir de
    la question suivante, tout le trafic des routeurs
    <systemitem>R2</systemitem> et <systemitem>R3</systemitem> transite par le
    routeur <systemitem>R1</systemitem>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment publier le nouveau réseau d'hébergement via
    <acronym>OSPF</acronym>&nbsp;?</phrase></para>

    <para>Revoir la question <xref linkend='ospf-interface'/> sur l'activation
    <acronym>OSPF</acronym> au niveau de chaque interface.</para>
    </question>
    <answer>
    <para>On active le protocole <acronym>OSPF</acronym> pour l'interface
    commutée virtuelle de chacun des trois routeurs. Voici un exemple pour le
    routeur <systemitem>R2</systemitem>.</para>

<screen><prompt>R2#</prompt> conf t
R2(config)# int vlan20
R2(config-if)# ip ospf area 0
R2(config-if)# ipv6 ospf6 area 0
R2(config-if)# ip ospf passive
R2(config-if)# ipv6 ospf6 passive
R2(config-if)# ^Z</screen>

    <para>Une fois cette opération réalisée, le routage dynamique est complet
    et le trafic des routeurs <systemitem>R2</systemitem> et
    <systemitem>R3</systemitem> est acheminé via <systemitem>R1</systemitem>.
    On peut lancer des tests <acronym>ICMP</acronym>.</para>

<screen>ping -qc2 9.9.9.9</screen>
<screen>PING 9.9.9.9 (9.9.9.9) 56(84) bytes of data.

--- 9.9.9.9 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 28.502/29.014/29.526/0.512 ms</screen>

<screen>ping -qc2 2620:fe::fe</screen>
<screen>PING 2620:fe::fe (2620:fe::fe) 56 data bytes

--- 2620:fe::fe ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 40.675/47.384/54.094/6.709 ms</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment administrer et initialiser le gestionnaire de
    conteneurs <citetitle>Incus</citetitle>&nbsp;?</phrase></para>

    <para>Consulter la section <citetitle>Réseau d'hébergement de
    conteneurs</citetitle>.</para>
	</question>
	<answer>
    <para>Pour commencer, l'utilisateur normal doit appartenir aux deux groupes
    système <systemitem>incus</systemitem> et
    <systemitem>incus-admin</systemitem>. On reprend la démarche
    précédente.</para>

<screen>for grp in incus incus-admin
do
    sudo adduser etu $grp
done</screen>

    <para>Comme l'affectation de groupe se joue à la connexion, il faut se
    déconnecter/reconnecter pour rendre l'attribution effective.</para>

<screen>groups</screen>
<screen>etu adm sudo users frrvty frr incus-admin incus</screen>

    <para>Pour l'initialisation du gestionnaire de conteneur, on utilise un
    fichier de déclaration préparé en amont. Voici une copie du fichier
    <filename>incus.yaml</filename> pour le routeur
    <systemitem>R2</systemitem>.</para>

<screen>config: {}
networks: []
storage_pools:
- config: {}
  description: ""
  name: default
  driver: dir
profiles:
- config: {}
  description: ""
  devices:
    eth0:
      name: eth0
      nictype: bridged
      parent: asw-host
      type: nic
      vlan: 20
    root:
      path: /
      pool: default
      type: disk
  name: default
projects: []
cluster: null</screen>

    <para>L'initialisation se fait à partir de ce fichier.</para>

<screen>cat incus.yaml | incus admin init --preseed</screen>

    <para>On peut afficher le résultat de cette initialisation du gestionnaire
    de conteneurs avec l'instruction suivante.</para>

<screen>incus profile show default</screen>

    <para>En cas d'erreur, il est aussi possible d'éditer le profil par défaut.</para>

<screen>incus profile edit default</screen>

    <important>
    <para>Les opérations de cette question doivent être réalisées sur les trois
    routeurs en adaptant les numéros de <acronym>VLAN</acronym> de réseau
    d'hébergement.</para>
    </important>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment mettre en place l'adressage automatique
    <acronym>IPv4</acronym> et <acronym>IPv6</acronym> dans le réseau
    d'hébergement&nbsp;?</phrase></para>

    <para>Consulter la section <citetitle>Adressage automatique dans le réseau
    d'hébergement</citetitle> du document &url.interco.pppoe;</para>
    </question>
    <answer>
    <para>On créé un fichier de configuration pour le service
    <application>dnsmasq</application> en l'adaptant au contexte du plan
    d'adressage de chaque routeur. Voici un exemple pour le routeur
    <systemitem>R1</systemitem> de la maquette.</para>

<screen>cat &lt;&lt; EOF | sudo tee /etc/dnsmasq.conf
# Specify Container VLAN interface
interface=<emphasis>vlan10</emphasis>

# Enable DHCPv4 on Container VLAN
dhcp-range=<emphasis>10.10.0.20,10.10.0.200</emphasis>,3h

# Enable IPv6 router advertisements
enable-ra

# Enable SLAAC
dhcp-range=::,constructor:<emphasis>vlan10</emphasis>,ra-names,slaac

# Optional: Specify DNS servers
dhcp-option=option:dns-server,172.16.0.2,9.9.9.9
dhcp-option=option6:dns-server,[2001:678:3fc:3::2],[2620:fe::fe]

# Avoid DNS listen port conflict between dnsmasq and systemd-resolved
port=0
EOF</screen>

    <para>Une fois le fichier de configuration en place, on peut relancer le
    service et afficher son état.</para>

<screen>sudo systemctl restart dnsmasq
systemctl status dnsmasq</screen>

    <important>
    <para>Une fois encore, les opérations de cette question doivent être
    réalisées sur les trois routeurs en adaptant le nom de l'interface et les
    adresses <acronym>IPv4</acronym> du réseau d'hébergement.</para>
    </important>
    </answer>
    </qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment créer 3 conteneurs avec un
    adressage&nbsp;?</phrase></para>

    <para>Consulter la section <citetitle>Configuration et lancement des
    conteneurs</citetitle> du document &url.interco.pppoe;.</para>
	</question>
	<answer>
	<para>On lance la création des 3 conteneurs demandés avec une boucle.</para>

<screen>for i in {0..2}; do incus launch images:debian/trixie c$i; done</screen>

<screen>incus ls</screen>

<screen>+------+---------+--------------------+---------------------------------------------+-----------+-----------+
| NAME |  STATE  |        IPV4        |                    IPV6                     |   TYPE    | SNAPSHOTS |
+------+---------+--------------------+---------------------------------------------+-----------+-----------+
| c0   | RUNNING | 10.20.0.33 (eth0)  | fd14:ca46:3864:14:216:3eff:fe2c:c5b9 (eth0) | CONTAINER | 0         |
+------+---------+--------------------+---------------------------------------------+-----------+-----------+
| c1   | RUNNING | 10.20.0.87 (eth0)  | fd14:ca46:3864:14:216:3eff:fe76:f0d0 (eth0) | CONTAINER | 0         |
+------+---------+--------------------+---------------------------------------------+-----------+-----------+
| c2   | RUNNING | 10.20.0.153 (eth0) | fd14:ca46:3864:14:216:3eff:fe2c:d169 (eth0) | CONTAINER | 0         |
+------+---------+--------------------+---------------------------------------------+-----------+-----------+</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
    <para><phrase>Comment vérifier la publication des réseaux de conteneurs
    dans l'aire <acronym>OSPF</acronym>&nbsp;?</phrase></para>

    <para>On vérifie que l'interface commutée virtuelle (<wordasword>Switched
    Virtual Interface</wordasword> )est bien active pour chacune des deux
    versions du protocole de routage dynamique.</para>
	</question>
	<answer>
	<para>Voici un exemple de configuration pour le routeur <systemitem
	class='systemname'>R2</systemitem>.</para>

<screen><prompt>R2#</prompt> sh ip ospf interface vlan20</screen>

<screen><emphasis>vlan20 is up</emphasis>
  ifindex 6, MTU 1500 bytes, BW 0 Mbit &lt;UP,LOWER_UP,BROADCAST,RUNNING,MULTICAST>
  Internet Address 10.20.0.1/24, Broadcast 10.20.0.255, Area 0.0.0.0
  MTU mismatch detection: enabled
  Router ID 2.0.0.4, <emphasis>Network Type BROADCAST, Cost: 10</emphasis>
  Transmit Delay is 1 sec, State DR, Priority 1
  Designated Router (ID) 2.0.0.4 Interface Address 10.20.0.1/24
  No backup designated router on this network
  Multicast group memberships: &lt;None>
  Timer intervals configured, Hello 10s, Dead 40s, Wait 40s, Retransmit 5
    <emphasis>No Hellos (Passive interface)</emphasis>
  Neighbor Count is 0, Adjacent neighbor count is 0
  Graceful Restart hello delay: 10s</screen>

<screen><prompt>R2#</prompt> sh ipv6 ospf6 interface vlan20</screen>

<screen><emphasis>vlan20 is up, type BROADCAST</emphasis>
  Interface ID: 6
  Internet Address:
    inet : 10.20.0.1/24
    inet6: fd14:ca46:3864:14::1/64
    inet6: fe80::2865:4aff:fe35:fdd0/64
  Instance ID 0, Interface MTU 1500 (autodetect: 1500)
  MTU mismatch detection: enabled
  Area ID 0.0.0.0, <emphasis>Cost 10</emphasis>
  State DR, Transmit Delay 1 sec, Priority 1
  Timer intervals configured:
   <emphasis>No Hellos (Passive interface)</emphasis>
  DR: 2.0.0.4 BDR: 0.0.0.0
  Number of I/F scoped LSAs is 1
    0 Pending LSAs for LSUpdate in Time 00:00:00 [thread off]
    0 Pending LSAs for LSAck in Time 00:00:00 [thread off]
  Graceful Restart hello delay: 10s
  Authentication Trailer is disabled</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment valider l'accès à l'Internet depuis les
	conteneurs&nbsp;?</phrase></para>

	<para>On reprend la liste des tests <acronym>ICMP</acronym> pour valider
	l'acheminement du trafic au niveau de la couche réseau et on lance une mise
	à jour du catalogue des paquets pour valider la résolution des noms.</para>
	</question>
	<answer>
	<para>À partir du routeur <systemitem class='systemname'>R2</systemitem>,
	on utilise les séquences suivantes&nbsp;:</para>

	<itemizedlist>
	<listitem>
	<para>Tests <acronym>ICMP</acronym> au niveau réseau&nbsp;:</para>

<screen>for i in {0..2}
do
    echo ">>>>>>>>>>>>>>>>> c$i"
    incus exec c$i -- ping -qc2 9.9.9.9
done</screen>

<screen>for i in {0..2}
do
    echo ">>>>>>>>>>>>>>>>> c$i"
    incus exec c$i -- ping -qc2 2620:fe::fe
done</screen>
	</listitem>
	<listitem>
	<para>Tests au niveau application avec résolution des noms&nbsp;:</para>

<screen>for i in {0..2}
do
    echo ">>>>>>>>>>>>>>>>> c$i"
    incus exec c$i -- apt update
    incus exec c$i -- apt -y full-upgrade
done</screen>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment vérifier que tous les réseaux de conteneurs sont bien
	visibles depuis les routeurs de la topologie triangle&nbsp;?</phrase></para>

	<para>Afficher les tables de routage <acronym>IPv4</acronym> et
	<acronym>IPv6</acronym> de l'un des trois routeurs et vérifier la présence
	des trois réseaux de conteneurs.</para>
	</question>
	<answer>
	<para>Voici le résultat obtenu depuis la console du routeur <systemitem
    class='systemname'>R3</systemitem>. On identifie les réseaux d'hébergement
    des routeurs <systemitem>R1</systemitem> et <systemitem>R2</systemitem>
    pour lesquels on trouve des entrées marquées <literal>O>*</literal>.</para>

<screen><prompt>R3#</prompt> sh ip route</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

O>* 0.0.0.0/0 [110/10] via 10.44.1.1, enp0s1.441, weight 1, 02:12:47
<emphasis>O>* 10.10.0.0/24 [110/20] via 10.44.1.1</emphasis>, enp0s1.441, weight 1, 02:12:48
<emphasis>O>* 10.20.0.0/24 [110/20] via 10.44.2.2</emphasis>, enp0s1.442, weight 1, 00:11:37
O   10.30.0.0/24 [110/10] is directly connected, vlan30, weight 1, 02:12:36
C>* 10.30.0.0/24 is directly connected, vlan30, 02:12:54
L>* 10.30.0.1/32 is directly connected, vlan30, 02:12:54
O>* 10.44.0.0/29 [110/20] via 10.44.1.1, enp0s1.441, weight 1, 00:11:37
  *                       via 10.44.2.2, enp0s1.442, weight 1, 00:11:37
O   10.44.1.0/29 [110/10] is directly connected, enp0s1.441, weight 1, 02:12:55
C>* 10.44.1.0/29 is directly connected, enp0s1.441, 02:12:55
L>* 10.44.1.3/32 is directly connected, enp0s1.441, 02:12:55
O   10.44.2.0/29 [110/10] is directly connected, enp0s1.442, weight 1, 01:18:48
C>* 10.44.2.0/29 is directly connected, enp0s1.442, 02:12:55
L>* 10.44.2.3/32 is directly connected, enp0s1.442, 02:12:55</screen>

<screen><prompt>R3#</prompt> sh ipv6 route</screen>
<screen>Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIPng, O - OSPFv3, I - IS-IS, B - BGP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

O>* ::/0 [110/10] via fe80::1b9:1, enp0s1.441, weight 1, 00:14:55
<emphasis>O>* fd14:ca46:3864:a::/64 [110/20] via fe80::1b9:1</emphasis>, enp0s1.441, weight 1, 02:21:04
<emphasis>O>* fd14:ca46:3864:14::/64 [110/20] via fe80::baad:caff:fefe:6</emphasis>, enp0s1.442, weight 1, 00:14:56
O   fd14:ca46:3864:1e::/64 [110/10] is directly connected, vlan30, weight 1, 02:14:55
C>* fd14:ca46:3864:1e::/64 is directly connected, vlan30, 02:15:27
L>* fd14:ca46:3864:1e::1/128 is directly connected, vlan30, 02:15:27
C * fe80::/64 is directly connected, vlan30, 02:15:28
C * fe80::/64 is directly connected, asw-host, 02:15:29
C * fe80::/64 is directly connected, enp0s1.52, 02:19:13
C * fe80::/64 is directly connected, enp0s1.441, 22:24:07
C * fe80::/64 is directly connected, enp0s1.442, 22:24:08
C>* fe80::/64 is directly connected, enp0s1, 22:24:08</screen>

    <para>Si on reprend, la même démarche sur chaque routeur, on doit trouver
    deux entrées <acronym>OSPF</acronym> relatives aux réseaux d'hébergement
    raccordés aux deux “sommets du triangle” dans les tables de routage.</para>
    </answer>
	</qandaentry>
</qandaset>
</sect1>

<sect1 xml:id='ospf.auto-cost'>
	<title>Adapter de la métrique de lien au débit</title>

    <para>Par défaut, le calcul de métrique du le protocole
    <acronym>OSPF</acronym> se fait à partir d'un coût fixe de 10. Dans cette
    section, on revient au calcul du quotient entre le débit binaire de
    référence et le débit binaire de l'interface.</para>

    <para>À l'origine, le calcul de ce quotient utilise la
    formule&nbsp;10<superscript>8</superscript>&nbsp;/&nbsp;bande&nbsp;passante&nbsp;du&nbsp;lien.</para>

	<para>Cette règle a été établie à une époque où l'utilisation d'un lien à
	100Mbps était considéré comme une situation futuriste. Aujourd'hui, les
	liens à 100Mbps sont dépassés.</para>

    <important>
    <para>Pour que les calculs de métriques soient cohérents sur l'ensemble de
    la topologie triangle, il est essentiel d'appliquer les modifications de
    configuration sur les trois routeurs.</para>
    </important>

	<qandaset>
	<qandaentry>
	<question>
	<para><phrase>Quelle est l'instruction à utiliser pour que le calcul de
	métrique <acronym>OSPF</acronym> se fasse sur la base d'un débit de lien à
	40Gbps&nbsp;?</phrase></para>

	<para>Rechercher le mot clé <wordasword>reference</wordasword> dans
	l'index des instructions de configuration. Consulter la documentation
	&url.frr-documentation;.</para>
	</question>
	<answer>
	<para>C'est l'instruction
	<command>auto-cost&nbsp;reference-bandwidth</command> qui permet de fixer
	une nouvelle référence de coût de lien en Mbps.</para>

<screen><prompt>R1#</prompt> conf t
R1(config)# router ospf
R1(config-router)# auto-cost reference-bandwidth ?
  (1-4294967)  The reference bandwidth in terms of Mbits per second
R1(config-router)# auto-cost reference-bandwidth 400000
R1(config-router)# ^Z</screen>

<screen><prompt>R1#</prompt> conf t
R1(config)# router ospf6
R1(config-ospf6)# auto-cost reference-bandwidth ?
  (1-4294967)  The reference bandwidth in terms of Mbits per second
R1(config-ospf6)# auto-cost reference-bandwidth 400000
R1(config-ospf6)# ^Z</screen>

    <para>En appliquant les mêmes instructions sur les trois routeurs de la
    topologie, on fixe le numérateur du quotient de calcul des métriques de
    routes.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment modifier le débit binaire d'un lien à
	10Gbps&nbsp;?</phrase></para>

    <note>
    <para>Sur une machine physique avec des composants réseau matériels, le
    débit d'un lien est directement extrait des paramètres du composant de
    l'interface connectée au lien.</para>
    <para>Dans le cas d'interfaces qui n'ont aucune réalité physique, ce débit
    peut être attribué arbitrairement par configuration. On doit rechercher
    dans les options de la console <application>vtysh</application> le moyen
    d'attribuer une indication de débit aux sous-interfaces de
    <acronym>VLAN</acronym>s.</para>
    </note>
	</question>
	<answer>
    <para>En affichant les paramètres des interfaces des routeurs virtuels, on
    constate que le paramètre <option>speed</option> est à zéro.</para>

<screen><prompt>R1#</prompt> sh interface vlan10</screen>
<screen>Interface vlan10 is up, line protocol is up
  Link ups:       1    last: 2024/11/03 14:26:00.66
  Link downs:     2    last: 2024/11/03 14:26:00.65
  vrf: default
  index 8 metric 0 mtu 1500 <emphasis>speed 0</emphasis> txqlen 1000
  flags: &lt;UP,LOWER_UP,BROADCAST,RUNNING,MULTICAST>
  Type: Ethernet
  HWaddr: da:35:df:7e:5d:42
  inet 10.10.0.1/24
  inet6 fd14:ca46:3864:a::1/64
  inet6 fe80::d835:dfff:fe7e:5d42/64
  Interface Type Other
  Interface Slave Type None
  protodown: off</screen>

    <para>Pour assurer un calcul correct de métrique, on doit fixer
    manuellement le débit binaire des interfaces dans la configuration
    <systemitem>frr</systemitem>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment peut-on identifier le débit d'un lien dans la
	configuration <acronym>OSPF</acronym>&nbsp;?</phrase></para>

	<para>Visualiser les paramètres des interfaces réseau depuis la console
	<application>vtysh</application>. Les commandes suivantes peuvent être
	lancées sur chacun des trois routeurs.</para>

	<simplelist type='horiz'>
		<member><command>show&nbsp;ip&nbsp;ospf interface</command></member>
		<member><command>show&nbsp;ipv6&nbsp;ospf6 interface</command></member>
	</simplelist>
	</question>
	<answer>
	<para>Voici le résultat obtenu sur le routeur <systemitem
	class='systemname'>R1</systemitem>.</para>

<screen><prompt>R1#</prompt> conf t
R3(config)# int vlan10
R3(config-if)# bandwidth 10000
R3(config-if)# ^Z</screen>

<screen><prompt>R1#</prompt> sh ip ospf interface vlan10</screen>
<screen>vlan10 is up
  ifindex 8, MTU 1500 bytes, <emphasis>BW 10000 Mbit</emphasis> &lt;UP,LOWER_UP,BROADCAST,RUNNING,MULTICAST>
  Internet Address 10.10.0.1/24, Broadcast 10.10.0.255, Area 0.0.0.0
  MTU mismatch detection: enabled
  Router ID 1.0.0.4, Network Type BROADCAST, Cost: 4
  Transmit Delay is 1 sec, State DR, Priority 1
  Designated Router (ID) 1.0.0.4 Interface Address 10.10.0.1/24
  No backup designated router on this network
  Multicast group memberships: &lt;None>
  Timer intervals configured, Hello 10s, Dead 40s, Wait 40s, Retransmit 5
    No Hellos (Passive interface)
  Neighbor Count is 0, Adjacent neighbor count is 0
  Graceful Restart hello delay: 10s</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est le coût d'accès au réseau de conteneurs attaché au
	routeur <systemitem class='systemname'>R3</systemitem> depuis le
	routeur <systemitem class='systemname'>R2</systemitem>&nbsp;?
	Justifier la valeur de métrique obtenue.</phrase></para>

	<para>À partir des informations de routage sur <systemitem
	class='systemname'>R2</systemitem>, faire la somme des métriques de
	chaque lien entre les deux extrémités en communication.</para>
	</question>
	<answer>
	<para>Il est possible d'obtenir les informations de calcul de métrique à
	partir de l'affichage d'une route particulière à la console
	<application>vtysh</application>.</para>

<screen><prompt>R1#</prompt> sh ip route 10.20.0.0/24</screen>
<screen>Routing entry for 10.20.0.0/24
  Known via "ospf", distance 110, <emphasis>metric 8</emphasis>, best
  Last update 00:21:32 ago
  * 10.44.0.2, via enp0s1.440, weight 1</screen>

    <para>Dans l'exemple ci-dessus, la métrique d'accès au réseau <systemitem
    class='ipaddress'>10.30.0.0/24</systemitem> correspond à la somme des
    métriques de deux liens à 10Gbps. La somme donne une métrique de
    40/10&nbsp;+&nbsp;40/10&nbsp;=&nbsp;8.</para>

	<para>On obtient un résultat identique avec la table de routage
	<acronym>IPv6</acronym>.</para>

<screen><prompt>R1#</prompt> sh ipv6 route fd14:ca46:3864:1e::/64</screen>
<screen>Routing entry for fd14:ca46:3864:1e::/64
  Known via "ospf6", distance 110, <emphasis>metric 8</emphasis>, best
  Last update 00:25:44 ago
  * fe80::1b9:3, via enp0s1.441, weight 1</screen>
	</answer>
	</qandaentry>
	</qandaset>
</sect1>

<sect1 xml:id='ospf.conf'>
	<title>Sauvegarder les fichiers de configuration</title>

    <para>Les commandes utiles pour l'affichage et  la sauvegarde sont les
    suivantes.</para>
	<simplelist type='horiz'>
		<member><command>show&nbsp;run</command></member>
		<member><command>copy&nbsp;run&nbsp;start</command></member>
	</simplelist>

    <para>Une fois sorti de la console <systemitem>frr</systemitem>, la
    configuration unifiée des démons est stockée dans le fichier
    <filename>/etc/frr/frr.conf</filename>.</para>

	<para>Voici une copie des fichiers de configuration des trois routeurs une
	fois toutes les manipulations réalisées.</para>

	<itemizedlist>
	<listitem>
	<para>Routeur <systemitem class='systemname'>R1</systemitem>.</para>

<screen><?dbfo keep-together="auto" ?><xi:include href='files/R1-frr.conf'
parse='text' xmlns:xi='http://www.w3.org/2001/XInclude'/></screen>
	</listitem>
	<listitem>
	<para>Routeur <systemitem class='systemname'>R2</systemitem>.</para>

<screen><?dbfo keep-together="auto" ?><xi:include href='files/R2-frr.conf'
parse='text' xmlns:xi='http://www.w3.org/2001/XInclude'/></screen>
	</listitem>
	<listitem>
	<para>Routeur <systemitem class='systemname'>R3</systemitem>.</para>

<screen><?dbfo keep-together="auto" ?><xi:include href='files/R3-frr.conf'
parse='text' xmlns:xi='http://www.w3.org/2001/XInclude'/></screen>
	</listitem>
	</itemizedlist>
</sect1>

<sect1 xml:id='ospf.conclusion'>
    <title>Pour conclure...</title>

    <para>Ce document fournit une introduction détaillée à la configuration du
    protocole de routage dynamique <acronym>OSPF</acronym> avec
    <application>FRRouting</application> sur des routeurs virtuels Linux. Il
    couvre la préparation des systèmes, l'installation et l'activation des
    démons <acronym>OSPF</acronym>, ainsi que la validation des communications
    entre routeurs.</para>

    <para>Les manipulations proposées permettent de mettre en place une
    topologie réseau en triangle et de configurer pas à pas le routage
    <acronym>OSPF</acronym> pour <acronym>IPv4</acronym> et
    <acronym>IPv6</acronym>. Ce guide pratique offre une base solide pour
    comprendre et implémenter le routage dynamique <acronym>OSPF</acronym> dans
    un environnement virtuel.</para>
</sect1>
</article>
