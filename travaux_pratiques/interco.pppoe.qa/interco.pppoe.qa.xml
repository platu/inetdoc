<?xml version='1.0'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
"/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [

<!ENTITY author		SYSTEM "author.xml">
<!ENTITY legal		SYSTEM "legal.xml">

<!-- urls -->
<!ENTITY % rfc_urls SYSTEM 'rfc.urls.xml'>
%rfc_urls;

<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.xml'>
%inetdoc_urls;

<!ENTITY url.ppp-wikipedia
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://en.wikipedia.org/wiki/Point-to-Point_Protocol">
<citetitle>Point-to-Point Protocol</citetitle></link>'>

<!ENTITY url.pppoe-wikipedia
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://en.wikipedia.org/wiki/Point-to-point_protocol_over_Ethernet">
<citetitle>Point-to-point protocol over Ethernet</citetitle></link>'>

<!ENTITY url.cheatsheet
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://www.inetdoc.net/pdf/iproute-cheatsheet.pdf">
<citetitle>Antisèche réseau</citetitle></link>'>

<!ENTITY % w3centities-f PUBLIC "-//W3C//ENTITIES Combined Set//EN//XML"
	"http://www.w3.org/2003/entities/2007/w3centities-f.ent">
%w3centities-f;
]>

<article xml:id='interco.pppoe' xml:lang='fr'>

<info>
	<title>Topologie Hub &amp; Spoke avec le protocole PPPoE</title>

	&author;
	<abstract>
	<para>
	<informaltable frame='none' pgwide='1'>
	<tgroup cols='2' align='left' colsep='0' rowsep='0'>
	<colspec colwidth='1*'/>
	<colspec colwidth='1*'/>
	<tbody>
    <row>
	<entry>
	<inlinemediaobject>
	<imageobject role='html'>
		<imagedata fileref='images/pppoe-hub-and-spoke-logical-topology.png' format='PNG' width='480px' scalefit='1'/>
	</imageobject>
	<imageobject role='fo'>
		<imagedata fileref='images/pppoe-hub-and-spoke-logical-topology.png' format='PNG' width='7cm' scalefit='1'/>
	</imageobject>
	</inlinemediaobject>
	</entry>
    <entry valign='top'>
	<para>Ce support de travaux pratiques est une illustration d'une topologie
	réseau classique baptisée <wordasword>Hub &amp; Spoke</wordasword>. Le
	<wordasword>Hub</wordasword> est un routeur qui concentre tous les flux des
	routeurs d'extrémités appelés <wordasword>Spoke</wordasword>. Les liaisons
	entre le <wordasword>Hub</wordasword> et les routeurs
	<wordasword>Spoke</wordasword> sont point à point et utilisent le protocole
	<acronym>PPP</acronym>. Avec la généralisation de la fibre optique dans les
	réseaux étendus (<acronym>WAN</acronym>), on doit encapsuler les trames
	<acronym>PPP</acronym> dans un <acronym>VLAN</acronym> Ethernet à l'aide de
	la technologie <acronym>PPPoE</acronym>.</para>

	<para>Les manipulations proposées reprennent en grande partie celles du
	support &url.interco.pppoe-cloud; en les adaptant à la topologie en
	triangle.</para> 
	</entry>
	</row>
	</tbody>
	</tgroup>
	</informaltable>
	</para>
	</abstract>

	<keywordset>
		<keyword>ppp</keyword>
		<keyword>pppoe</keyword>
		<keyword>chap</keyword>
		<keyword>route</keyword>
		<keyword>forward</keyword>
		<keyword>trunk</keyword>
		<keyword>vlan</keyword>
	</keywordset>
</info>

<sect1 xml:id='interco.pppoe.legal.meta'>
&legal;

<sect2 xml:id='interco.pppoe.meta'>
	<title>Méta-information</title>

	<para>Cet article est écrit avec <link
		xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link>
		XML sur un système <link
		xlink:href="https://www.debian.org"><citetitle>Debian
		GNU/Linux</citetitle></link>. Il est disponible en version
		imprimable au format PDF&nbsp;: <link
		xlink:href="https://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>

	<para>Toutes les commandes utilisées dans ce document ne sont pas
		spécifiques à une version particulière des systèmes UNIX ou GNU/Linux.
		C'est la distribution <citetitle>Debian GNU/Linux</citetitle> qui est
		utilisée pour les tests présentés. Voici une liste des paquets
		contenant les commandes&nbsp;:</para>

<itemizedlist>
	<listitem>
	<para><application>iproute2</application> - Outils de contrôle du trafic et
		du réseau</para>
	</listitem>
	<listitem>
	<para><application>ifupdown</application> - High level tools to configure
		network interfaces</para>
    </listitem>
	<listitem>
	<para><application>iputils-ping</application> - Tools to test the
		reachability of network hosts</para>
	</listitem>
	<listitem>
	<para><application>iputils-tracepath</application> - Tools to trace the
		network path to a remote host</para>
	</listitem>
	<listitem>
	<para><application>ppp</application> - Point-to-Point Protocol (PPP) -
		daemon</para>
	</listitem>
	<listitem>
	<para><application>pppoe</application> - PPP over Ethernet driver</para>
	</listitem>
</itemizedlist>
</sect2>

<sect2 xml:id='interco.pppoe.convtypo'>
	<title>Conventions typographiques</title>

	<para>Tous les exemples d'exécution des commandes sont précédés d'une
		invite utilisateur ou <wordasword>prompt</wordasword> spécifique au
		niveau des droits utilisateurs nécessaires sur le système.</para>

	<itemizedlist>
	<listitem>
	<para>Toute commande précédée de l'invite <prompt>$</prompt> ne nécessite
		aucun privilège particulier et peut être utilisée au niveau utilisateur
		simple.</para>
	</listitem>
	<listitem>
	<para>Toute commande précédée de l'invite <prompt>#</prompt> nécessite les
		privilèges du super-utilisateur.</para>
	</listitem>
	</itemizedlist>
</sect2>

<sect2 xml:id='interco.pppoe.troubleshoot'>
	<title>Aide à la mise au point</title>

	<para>Afin de résoudre les problèmes de connexion et de configuration, la
		journalisation système constitue le principal canal
		d'information.</para>

	<para>L'affichage des messages système est géré par le démon <systemitem
		class='daemon'>rsyslogd</systemitem>. Pour consulter ces messages,
		il faut lire le contenu des fichiers du répertoire <filename
		class='directory'>/var/log/</filename>. Dans le cas des travaux
		pratiques, les informations nécessaires à la mise au point des
		connexions réseau se trouvent dans le fichier
		<filename>/var/log/syslog</filename>.</para>

	<para>Pour visualiser les dernières lignes d'un journal système à la
		console on peut utiliser la commande <command>tail</command>.</para>

<screen><prompt>$</prompt> tail -n 50 -f /var/log/syslog</screen>

	<para>Du point de vue droits sur le système de fichiers, la commande
		<command>tail</command> peut être utilisée au niveau utilisateur normal
		dès lors que celui-ci appartient au groupe
		<systemitem>adm</systemitem>. Les commandes <command>id</command> et
		<command>groups</command> permettent de connaître les groupes auxquels
		l'utilisateur courant appartient.</para>
</sect2>
</sect1>

<?custom-pagebreak?>
<sect1 xml:id='interco.pppoe.hub-and-spoke'>
	<title>Topologie Hub &amp; Spoke - Protocole PPPoE</title>

	<para>Le Protocole Point à Point (<acronym>PPP</acronym>) est utilisé pour
	établir une communication directe entre deux hôtes. Il relie deux routeurs
	de façon logique au dessus d'une topologie de réseau physique qui peut
	comprendre divers composants et différentes technologies. Il permet aux
	deux extrémités en communication de négocier des paramètres de transmission
	tels que l'authentification, la compression et l'attribution d'adresses de
	couche réseau. Dans ce document, on utilise le protocole
	<acronym>PPP</acronym> au dessus d'un réseau Ethernet qui représente la
	technologie mise en œuvre par un opérateur Internet.</para>

	<para>Comme un Ethernet est par définition un réseau de diffusion, il est
	nécessaire d'introduire un protocole intermédiaire appelé
	<acronym>PPPoE</acronym> qui sert à identifier les deux hôtes de la liaison
	logique point à point.</para>

	<para>Ce support met en œuvre une “figure“ classique appelée topologie
	<citetitle>Hub &amp; Spoke</citetitle>. Voici une description des rôles des
	différents routeurs de cette topologie.</para>
	
	<variablelist>
	<varlistentry xml:id='interco.pppoe.hub-role'>
		<term><citetitle>Hub</citetitle></term>
	<listitem>
	<para>Traduit mot à mot, le rôle <wordasword>Hub</wordasword> correspond à
	un concentrateur.</para>

	<para>Il concentre tous les flux réseau des routeurs qui ont le rôle
	<wordasword>Spoke</wordasword>. En effet, les échanges entre deux routeurs
	<wordasword>Spoke</wordasword> doivent passer par le routeur
	<wordasword>Hub</wordasword>.</para>

	<para>On lui attribue aussi la fonction de <wordasword>Broadband Remote
	Access Server</wordasword> ou <acronym>BRAS</acronym>. Dans notre contexte,
	cette fonction se caractérise par le fait que ce routeur détient le plan
	d'adressage. C'est lui qui a la responsabilité de délivrer les adresses
	<acronym>IP</acronym> lors de l'initiation de la session
	<acronym>PPP</acronym>.</para>
	</listitem>
	</varlistentry>

	<varlistentry xml:id='interco.pppoe.spoke-role'>
		<term><citetitle>Spoke</citetitle></term>
	<listitem>
	<para>Le rôle <wordasword>Spoke</wordasword> correspond à un réseau
	d'extrémité au delà duquel on ne trouve aucune interconnexion. Le routeur
	<wordasword>Spoke</wordasword> doit s'adresser au routeur
	<acronym>Hub</acronym> dès qu'il veut acheminer un flux réseau. Il s'agit
	bien d'un routeur d'extrémité qui ne dispose d'aucun chemin alternatif pour
	joindre l'Internet.</para> 

	<para>Dans les réseaux domestiques, la «box» correspond bien au rôle
	<wordasword>Spoke</wordasword> dans la mesure où elle se voit attribuer des
	adresses <acronym>IPv4</acronym> et <acronym>IPv6</acronym> publiques par
	le fournisseur d'accès Internet. Les seules informations qu'elle détient
	sont les authentifiants du client de l'opérateur.</para>
	</listitem>
	</varlistentry>
	</variablelist>

	<mediaobject>
	<imageobject role='fo'>
		<imagedata fileref='images/pppoe-hub-and-spoke-logical-topology.png' format='PNG'
		width='12cm' scalefit='1' align='center'/>
	</imageobject>
	<imageobject role='html'>
		<imagedata fileref='images/pppoe-hub-and-spoke-logical-topology.png' format='PNG'
		width='640px' scalefit='1' align='center'/>
	</imageobject>
	<textobject>
		<phrase>Topologie entre deux routeurs <wordasword>Hub</wordasword> et
		<wordasword>Spoke</wordasword> avec <acronym>PPPoE</acronym></phrase>
	</textobject>
	<caption>
		<para><link xlink:href='images/pppoe-topology.png'>Topologie entre deux
		routeurs <wordasword>Hub</wordasword> et <wordasword>Spoke</wordasword>
		avec <acronym>PPPoE</acronym></link></para>
	</caption>
	</mediaobject>

	<para>Comme le montre le graphique ci-dessus, l'opérateur distingue 4
	réseaux ou <acronym>VLANs</acronym> différents.</para>

	<variablelist>
	<varlistentry>
	<term>Raccordement Internet</term>
	<term>Rouge</term>
	<listitem>
		<para>Ce réseau caractérise l'accès à l'Internet. Il s'agit de la
		dorsale de l'opérateur. Dans notre cas, le plan d'adressage est défini
		dans le document &url.infra.tp;.</para> 
	</listitem>
	</varlistentry>
	<varlistentry>
	<term>Management/Supervision</term>
	<term>Violet</term>
	<listitem>
		<para>Ce réseau correspond à la gestion des équipements et à la
		supervision des liens en fibre optique. Il n'utilise que des adresses
		de lien local <acronym>IPv6</acronym>.</para>  
	</listitem>
	</varlistentry>
	<varlistentry>
	<term>Données de l'entreprise cliente</term>
	<term>Orange</term>
	<listitem>
		<para>C'est sur ce réseau que la session <acronym>PPP</acronym> est
		établie. L'entreprise cliente s'authentifie auprès du
		<acronym>BRAS</acronym> de l'opérateur et obtient en échange une
		adresse <acronym>IPv4</acronym> et une adresse <acronym>IPv6</acronym>
		qui permettent d'accéder à Internet.</para>
	</listitem>
	</varlistentry>
	<varlistentry>
	<term>Réseau de l'entreprise cliente</term>
	<term>Vert</term>
	<listitem>
		<para>C'est le réseau des services hébergés sur son propre site par
		l'entreprise clients de l'opérateur. Ici, on choisit de déployer
		plusieurs conteneurs pour illustrer plusieurs hôtes ou serveurs dont le
		trafic doit transiter par la session <acronym>PPP</acronym>.</para>
	</listitem>
	</varlistentry>
	</variablelist>

	<para>Voici le plan d'adressage de la maquette utilisée pour rédiger ce
	support de travaux pratiques.</para>

	<table xml:id='interco.pppoe.hub-and-spoke.mockup.addressing' frame='all' pgwide='1'>
		<title>Maquette</title>
	<tgroup cols='6' align='left' colsep='1' rowsep='1'>
	<colspec colnum='1' colwidth='1*'/>
	<colspec colnum='2' colwidth='1*'/>
	<colspec colnum='3' colwidth='1*'/>
	<colspec colnum='4' colwidth='1.5*'/>
	<colspec colnum='5' colwidth='1*'/>
	<colspec colnum='6' colwidth='2*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333" ?>
		<?dbfo color="#fff" ?>
		<entry>Rôle</entry>
		<entry>VLAN</entry>
		<entry>Numéro</entry>
		<entry>Type</entry>
		<entry>Destination</entry>
		<entry>Adresse/Authentification</entry>
	</row>
	</thead>
	<tbody>
		<!-- Maquette -->
		<row>
			<entry morerows='4' valign='middle'>Hub<?custom-linebreak?>bleu</entry>
			<entry>Rouge</entry>
			<entry>300</entry>
			<entry>Passerelle</entry>
			<entry>-</entry>
			<entry>
				<systemitem class='ipaddress'>10.141.0.161/27</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>2001:678:3fc:12c::1/64</systemitem>
			</entry>
		</row>
		<row>
			<entry>Violet</entry>
			<entry>470</entry>
			<entry>Lien local</entry>
			<entry>Spoke1</entry>
			<entry><systemitem class='ipaddress'>fe80:1d6::1/64</systemitem></entry>
		</row>
		<row>
			<entry>Orange</entry>
			<entry>471</entry>
			<entry>Point à point</entry>
			<entry>Spoke1</entry>
			<entry><systemitem class='ipaddress'>10.47.1.1:10.47.1.2</systemitem></entry>
		</row>
		<row>
			<entry>Violet</entry>
			<entry>472</entry>
			<entry>Lien local</entry>
			<entry>Spoke2</entry>
			<entry><systemitem class='ipaddress'>fe80:1d8::1/64</systemitem></entry>
		</row>
		<row>
			<entry>Orange</entry>
			<entry>473</entry>
			<entry>Point à point</entry>
			<entry>Spoke2</entry>
			<entry><systemitem class='ipaddress'>10.47.3.1:10.47.3.2</systemitem></entry>
		</row>
		<row>
			<entry morerows='2' valign='middle'>Spoke1<?custom-linebreak?>Vert</entry>
			<entry>Violet</entry>
			<entry>470</entry>
			<entry>Lien local</entry>
			<entry>Hub</entry>
			<entry><systemitem class='ipaddress'>fe80:1d6::2/64</systemitem></entry>
		</row>
		<row>
			<entry>Orange</entry>
			<entry>471</entry>
			<entry>Authentifiants</entry>
			<entry>Hub</entry>
			<entry align='center'><systemitem>5p0k3_1 / 0r4ng3_1</systemitem></entry>
		</row>
		<row>
			<entry>Vert</entry>
			<entry>1</entry>
			<entry>Passerelle</entry>
			<entry>-</entry>
			<entry>
				<systemitem class='ipaddress'>10.0.1.1/24</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>fda0:7a62:1::1/64</systemitem>
			</entry>
		</row>
		<row>
			<entry morerows='2' valign='middle'>Spoke2<?custom-linebreak?>Vert</entry>
			<entry>Violet</entry>
			<entry>472</entry>
			<entry>Lien local</entry>
			<entry>Hub</entry>
			<entry><systemitem class='ipaddress'>fe80:1d8::2/64</systemitem></entry>
		</row>
		<row>
			<entry>Orange</entry>
			<entry>473</entry>
			<entry>Authentifiants</entry>
			<entry>Hub</entry>
			<entry align='center'><systemitem>5p0k3_2 / 0r4ng3_2</systemitem></entry>
		</row>
		<row>
			<entry>Vert</entry>
			<entry>2</entry>
			<entry>Passerelle</entry>
			<entry>-</entry>
			<entry>
				<systemitem class='ipaddress'>10.0.2.1/24</systemitem><?custom-linebreak?>
				<systemitem class='ipaddress'>fda0:7a62:2::1/64</systemitem>
			</entry>
		</row>
	</tbody>
	</tgroup>
</table>
</sect1>

<sect1 xml:id='interco.pppoe.hub'>
	<title>Routeur Hub (bleu)</title>

	<para>Le rôle du routeur <wordasword>Hub</wordasword> est d'interconnecter
	un réseau de collecte opérateur (<acronym>LAN</acronym>) qui donne accès à
	l'Internet et plusieurs réseaux étendus (<acronym>WAN</acronym>) de
	raccordement de sites distants. Le routeur <wordasword>Hub</wordasword>
	assure aussi la fonction <wordasword>Broadband Remote Access
	Server</wordasword> (<acronym>BRAS</acronym>). C'est la raison pour
	laquelle il détient les adresses <acronym>IPv4</acronym> et
	<acronym>IPv6</acronym> à attribuer aux routeurs d'extrémité appelés
	<wordasword>Spoke</wordasword>.</para>

	<para>Le routeur <wordasword>Hub</wordasword> doit aussi gérer
	l'encapsulation des trames <acronym>PPP</acronym> sur un réseau de
	diffusion Ethernet.</para>

	<para>Cette section reprend essentiellement la partie
	&url.interco.pppoe-cloud.hub.pppoe; du support &url.interco.pppoe-cloud;.
	On doit cependant adapter la configuration des interfaces réseau du routeur
	<wordasword>Hub</wordasword> en ajoutant un second jeu d'interfaces pour le
	deuxième site distant.</para>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
		<para><phrase>Dans quel fichier sont stockés les paramètres passés au
		démon <command>pppd</command> lors du lancement du serveur
		<acronym>PPPoE</acronym>&nbsp;?</phrase></para>

		<para>Consulter les pages de manuels de l'outil
		<command>pppoe-server</command>.</para>
	</question>
	<answer>
		<para>C'est le fichier
		<filename>/etc/ppp/pppoe-server-options</filename> qui contient la
		liste des paramètres utilisés lors du dialogue
		<acronym>PPP</acronym>.</para>

		<para>Ce fichier contient tous les paramètres communs aux deux démons
		<systemitem>pppd</systemitem> qui sont lancés via
		<command>pppoe-server</command>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Comment créer les comptes utilisateurs locaux sur le
		routeur <wordasword>Hub</wordasword> sachant qu'ils ne sont autorisés
		ni à se connecter ni à avoir un répertoire
		personnel&nbsp;?</phrase></para> 

		<para>Consulter les options de la commande <command>adduser</command>.</para>
	</question>
	<answer>
		<para>Voici un exemple dans le contexte de la maquette.</para>

<screen><prompt>etu@HubBleu:~$</prompt> sudo adduser --disabled-login --no-create-home --force-badname 5p0k3_1
Autorise l'usage de noms d'utilisateur critiquables.
Ajout de l'utilisateur « 5p0k3_1 » ...
Ajout du nouveau groupe « 5p0k3_1 » (1002) ...
Ajout du nouvel utilisateur « 5p0k3_1 » (1002) avec le groupe « 5p0k3_1 » ...
Le répertoire personnel « /home/5p0k3_1 » n'a pas été créé.
Changing the user information for 5p0k3_1
Enter the new value, or press ENTER for the default
	Full Name []: Spoke 1
	Room Number []:
	Work Phone []:
	Home Phone []:
	Other []:
Cette information est-elle correcte ? [O/n]

<prompt>etu@HubBleu:~$</prompt> sudo adduser --disabled-login --no-create-home --force-badname 5p0k3_2
Autorise l'usage de noms d'utilisateur critiquables.
Ajout de l'utilisateur « 5p0k3_2 » ...
Ajout du nouveau groupe « 5p0k3_2 » (1003) ...
Ajout du nouvel utilisateur « 5p0k3_2 » (1003) avec le groupe « 5p0k3_2 » ...
Le répertoire personnel « /home/5p0k3_2 » n'a pas été créé.
Changing the user information for 5p0k3_2
Enter the new value, or press ENTER for the default
	Full Name []: Spoke 2
	Room Number []:
	Work Phone []:
	Home Phone []:
	Other []:
Cette information est-elle correcte ? [O/n]</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Dans quel fichier sont stockés les paramètres d'identité
		et d'authentification utilisés par le protocole
		<acronym>CHAP</acronym>&nbsp;?</phrase></para>

		<para>Consulter les pages de manuels du démon <command>pppd</command> à
		la section <citetitle>AUTHENTICATION</citetitle>.</para>
	</question>
	<answer>
		<para>C'est le fichier <filename>/etc/ppp/chap-secrets</filename> qui
		contient les couples <wordasword>login/password</wordasword> utilisés
		lors de l'authentification.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Comment ajouter les authentifiants des deux routeurs
		<wordasword>Spoke</wordasword> dans le fichier d'authentification
		<acronym>CHAP</acronym>&nbsp;?</phrase></para>
	</question>
	<answer>
		<para>Voici une copie du fichier dans le contexte de la maquette. Seuls
		les noms d'utilisateur et les mots de passe comptent.</para>

<screen># Secrets for authentication using CHAP
# client	server	secret			IP addresses
"5p0k3_1"	*		"0r4ng3_1"		*
"5p0k3_2"	*		"0r4ng3_2"		*</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Relativement au support &url.interco.pppoe-cloud;, quel
		paramètre supplémentaire doit être ajouté à la configuration de la
		commande <command>pppoe-server</command> pour distinguer les échanges
		entre les deux routeurs
		<wordasword>Spoke</wordasword>&nbsp;?</phrase></para>

		<para>Consulter les options de la commande
		<command>pppoe-server</command>.</para>
	</question>
	<answer>
		<para>L'option <option>-u</option> permet de désigner une “unité“ qui
		sert à nommer l'interface. Par exemple, <option>-u&nbsp;0</option>
		correspond à l'interface <systemitem>ppp0</systemitem>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Comment éditer le fichier
		<filename>/etc/network/interfaces</filename> pour ouvrir le
		raccordement des deux sites distants&nbsp;?</phrase></para>

		<para>Reprendre la configuration du support &url.interco.pppoe-cloud;
		en la complétant.</para>

		<itemizedlist>
		<listitem>
		<para>Ajouter l'option <option>-u</option> suivie du numéro de
		l'interface <systemitem>ppp</systemitem> utilisée pour la session vers
		un site distant donné. Ce numéro conditionne l'ajout des routes
		statiques vers les réseaux de conteneurs.</para>
		</listitem>
		<listitem>
		<para>Ajouter une condition spécifique à l'arrêt du processus
		<systemitem class='daemon'>pppoe-server</systemitem> relatif à un site
		distant unique. Il ne faut pas que l'arrêt d'une liaison vers un site
		provoque l'arrêt de toutes les liaisons.</para>
		</listitem>
		</itemizedlist>
	</question>
	<answer>
		<para>Voici une copie du fichier de configuration réseau système dans
		le contexte de la maquette.</para>

<screen># This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto enp0s2
iface enp0s2 inet manual
	up ip link set dev $IFACE up
	down ip link set dev $IFACE down

# ---------- VLAN ROUGE ----------
auto enp0s2.300
iface enp0s2.300 inet static
	address 10.141.0.162/27
	gateway 10.141.0.161
	dns-nameserver 9.9.9.9

iface enp0s2.300 inet6 static
	address 2001:678:3fc:12c::2/64
	gateway 2001:678:3fc:12c::1

# ---------- VLAN VIOLET SPOKE 1 -
auto enp0s2.470
iface enp0s2.470 inet6 static
	address fe80:1d6::1/64

# ---------- VLAN ORANGE SPOKE 1 -
auto enp0s2.471
iface enp0s2.471 inet manual
	up ip link set dev $IFACE up
	up pppoe-server -I $IFACE -C BRAS -L 10.47.1.1 -R 10.47.1.2 -N 1 -u 0
	down kill $(ps aux | egrep "[pppoe]-server.*$IFACE" | tr -s [:blank:] | cut -d ' ' -f 2)
	down ip link set dev $IFACE down

# ---------- VLAN VIOLET SPOKE 2 -
auto enp0s2.472
iface enp0s2.472 inet6 static
	address fe80:1d8::1/64

# ---------- VLAN ORANGE SPOKE 2 -
auto enp0s2.473
iface enp0s2.473 inet manual
	up ip link set dev $IFACE up
	up pppoe-server -I $IFACE -C BRAS -L 10.47.3.1 -R 10.47.3.2 -N 1 -u 1
	down kill $(ps aux | egrep "[pppoe]-server.*$IFACE" | tr -s [:blank:] | cut -d ' ' -f 2)
	down ip link set dev $IFACE down</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Comment ajouter les routes statiques vers les réseaux
		locaux <acronym>IPv4</acronym> et <acronym>IPv6</acronym> de chaque
		site distant lors de l'ouverture de la session <acronym>PPP</acronym>
		propre à un site&nbsp;?</phrase></para>

		<itemizedlist>
		<listitem>
		<para>Pour <acronym>IPv4</acronym>, il est possible d'utiliser
		l'adresse <acronym>IP</acronym> de l'extrémité de la liaison
		<acronym>PPP</acronym> pour désigner le routeur qui donne accès au
		réseau local distant. Cette possibilité est intéressante si on ne veut
		pas dépendre du numéro de l'interface <acronym>PPP</acronym>.</para>

		<para>Dans notre cas, l'option <option>-u</option> du démon <systemitem
		class='daemon'>pppoe-server</systemitem> fixe le numéro d'interface
		<acronym>PPP</acronym> et on peut l'utiliser pour traiter la
		question.</para>
		</listitem>
		<listitem>
		<para>Pour <acronym>IPv6</acronym>, la liaison <acronym>PPP</acronym>
		n'utilise que des adresses de lien local générées dynamiquement
		puisqu'il s'agit d'un réseau de transit entre deux routeurs. Il est
		donc nécessaire d'utiliser le numéro d'interface pour appliquer la
		route statique vers le réseau local d'un site donné.</para> 
		</listitem>
		</itemizedlist>
	</question>
	<answer>
		<para>Voici une copie du script exécutable
		<filename>/etc/ppp/ip-up.d/staticroute</filename> pour
		<acronym>IPv4</acronym> qui utilise les adresses d'extrémités de la
		maquette. Ce choix manque de rigueur dans la mesure où on applique les
		routes statiques pour tous les sites sans distinguer les sessions
		<acronym>PPP</acronym>.</para>

<screen>#!/bin/sh

if [ -z "${CONNECT_TIME}" ]; then
	ip route add 10.0.1.0/24 via 10.47.1.2
	ip route add 10.0.2.0/24 via 10.47.3.2
fi</screen>

	<para>Voici une copie du script exécutable
	<filename>/etc/ppp/ipv6-up.d/staticroute</filename> pour
	<acronym>IPv6</acronym>. Cette fois-ci, on distingue bien la route statique
	à appliquer en fonction de la session <acronym>PPP</acronym>.</para>

<screen>#!/bin/sh

if [ -z "${CONNECT_TIME}" ]; then
	case "${PPP_IFACE}" in
		"ppp0")
			ip -6 route add fda0:7a62:1::/64 dev ${PPP_IFACE}
			;;
		"ppp1")
			ip -6 route add fda0:7a62:2::/64 dev ${PPP_IFACE}
			;;
	esac
fi</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Comment tester la validité des tables de routage
		<acronym>IPv4</acronym> et <acronym>IPv6</acronym> pour chaque site
		distant après de l'ouverture de la session
		<acronym>PPP</acronym>&nbsp;?</phrase></para>

		<para>Après affichage des tables de routage on peut contacter une
		adresse <acronym>IPv4</acronym> et une adresse <acronym>IPv6</acronym>
		d'un conteneur de chaque site distant.</para>

		<para>Attention ! Pour qu'un conteneur soit joignable, il faut qu'il
		ait été créé et configuré. Si ce n'est pas encore le cas au moment des
		tests, on doit se contenter des adresses du commutateur virtuel. Ce
		dernier test présente un gros défaut&nbsp;: il ne qualifie pas la
		fonction routage du routeur <wordasword>Spoke</wordasword>.</para>
	</question>
	<answer>
	<para>Voici une série de copie d'écran valables dans le contexte de la
	maquette.</para>

	<para>On commence par les tables de routages.</para>

<screen><prompt>$</prompt> ip route ls
default via 10.141.0.161 dev enp0s2.300 onlink
<emphasis>10.0.1.0/24 via 10.47.1.2 dev ppp0</emphasis>
<emphasis>10.0.2.0/24 via 10.47.3.2 dev ppp1</emphasis>
10.47.1.2 dev ppp0 proto kernel scope link src 10.47.1.1
10.47.3.2 dev ppp1 proto kernel scope link src 10.47.3.1
10.141.0.160/27 dev enp0s2.300 proto kernel scope link src 10.141.0.162</screen>

<screen><prompt>$</prompt> ip -6 route ls proto 3
<emphasis>fda0:7a62:1::/64 dev ppp0 metric 1024 pref medium</emphasis>
<emphasis>fda0:7a62:2::/64 dev ppp1 metric 1024 pref medium</emphasis>
fe80::/10 dev ppp0 metric 1 pref medium
fe80::/10 dev ppp1 metric 1 pref medium
default via 2001:678:3fc:12c::1 dev enp0s2.300 metric 1024 onlink pref medium</screen>

	<para>On débute les tests <acronym>ICMP</acronym> par les adresses de
	passerelles des réseaux locaux des sites distants.</para>

<screen><prompt>etu@HubBleu:~$</prompt> ping -q -c2 10.0.1.1
PING 10.0.1.1 (10.0.1.1) 56(84) bytes of data.

--- 10.0.1.1 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1002ms
rtt min/avg/max/mdev = 0.744/1.025/1.307/0.281 ms
<prompt>etu@HubBleu:~$</prompt> ping -q -c2 10.0.2.1
PING 10.0.2.1 (10.0.2.1) 56(84) bytes of data.

--- 10.0.2.1 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 0.672/0.953/1.235/0.281 ms</screen>

<screen><prompt>etu@HubBleu:~$</prompt> ping -q -c2 fda0:7a62:1::1
PING fda0:7a62:1::1(fda0:7a62:1::1) 56 data bytes

--- fda0:7a62:1::1 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 0.767/0.923/1.080/0.156 ms
<prompt>etu@HubBleu:~$</prompt> ping -q -c2 fda0:7a62:2::1
PING fda0:7a62:2::1(fda0:7a62:2::1) 56 data bytes

--- fda0:7a62:2::1 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 0.775/0.973/1.172/0.198 ms</screen>

	<para>Enfin, on teste la connectivité réseau avec les adresses d'un
	conteneur de chaque site distant.</para>

<screen><prompt>etu@HubBleu:~$</prompt> ping -q -c2 10.0.1.10
PING 10.0.1.10 (10.0.1.10) 56(84) bytes of data.

--- 10.0.1.10 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1002ms
rtt min/avg/max/mdev = 0.776/1.211/1.647/0.435 ms

<prompt>etu@HubBleu:~$</prompt> ping -q -c2 fda0:7a62:1:0:216:3eff:feda:e1a
PING fda0:7a62:1:0:216:3eff:feda:e1a(fda0:7a62:1:0:216:3eff:feda:e1a) 56 data bytes

--- fda0:7a62:1:0:216:3eff:feda:e1a ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 0.824/1.527/2.230/0.703 ms</screen>

<screen><prompt>etu@HubBleu:~$</prompt> ping -q -c2 10.0.2.10
PING 10.0.2.10 (10.0.2.10) 56(84) bytes of data.

--- 10.0.2.10 ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 0.865/1.465/2.066/0.600 ms

<prompt>etu@HubBleu:~$</prompt> ping -q -c2 fda0:7a62:2:0:216:3eff:feda:e1a
PING fda0:7a62:2:0:216:3eff:feda:e1a(fda0:7a62:2:0:216:3eff:feda:e1a) 56 data bytes

--- fda0:7a62:2:0:216:3eff:feda:e1a ping statistics ---
2 packets transmitted, 2 received, <emphasis>0% packet loss</emphasis>, time 1001ms
rtt min/avg/max/mdev = 0.698/1.350/2.002/0.652 ms</screen>
	</answer>
	</qandaentry>
	</qandaset>
</sect1>

<?custom-pagebreak?>
<sect1 xml:id='interco.pppoe.spoke'>
	<title>Routeurs Spoke (vert)</title>

	<para>Dans le scénario défini dans la <xref
	linkend='interco.pppoe.hub-and-spoke'/>, un routeur de site d'extrémité
	ou <wordasword>Spoke</wordasword> ne peut accéder aux autres réseaux que
	via le routeur <wordasword>Hub</wordasword>. Son interface
	<acronym>WAN</acronym> joue donc le rôle de route par défaut pour le réseau
	local des hôtes hébergé sur un site distant.</para>

	<para>Dans le contexte de ces manipulations, le réseau local de site est
	représenté par des conteneurs <application>LXD</application> raccordés à un
	commutateur virtuel.</para>

	<para>Cette section, comme la précédente, reprend la partie
	&url.interco.pppoe-cloud.spoke.pppoe; du support
	&url.interco.pppoe-cloud;.</para>

	<para>Les routeurs <wordasword>Spoke</wordasword> utilisent un démon
	<systemitem class='daemon'>pppd</systemitem> dans le
	<acronym>VLAN</acronym> <option>Data</option> (Orange) pour établir une
	session <acronym>PPP</acronym> avec le routeur
	<wordasword>Hub</wordasword>.</para>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
		<para><phrase>Quelles sont les messages des journaux système qui
		montrent que la session <acronym>PPP</acronym> a bien été
		établie&nbsp;?</phrase></para>

		<para>Après avoir consulté la page &url.ppp-wikipedia; repérer les
		messages relatifs aux deux sous-couches <acronym>LCP</acronym> et
		<acronym>NCP</acronym> du protocole <acronym>PPP</acronym>.</para>
	</question>
	<answer>
		<para>sur le routeur <citetitle>Spoke1vert</citetitle> de la maquette,
		on relève les messages suivants à l'aide de la commande <command>grep
		ppp /var/log/syslog</command>&nbsp;:</para>

		<itemizedlist>
		<listitem>
		<para>Lancement du démon <systemitem class='daemon'>pppd</systemitem>.</para>

<screen>Spoke1Vert pppd[2452]: Plugin rp-pppoe.so loaded.
Spoke1Vert pppd[2453]: pppd 2.4.7 started by etu, uid 0</screen>
		</listitem>

		<listitem>
		<para>Reconnaissance des extrémités de la liaison point à point avec le protocole <acronym>PPPoE</acronym></para>
	
<screen>Spoke1Vert pppd[2453]: Send PPPOE Discovery V1T1 PADI session 0x0 length 4
Spoke1Vert pppd[2453]:  dst ff:ff:ff:ff:ff:ff  src b0:ad:ca:fe:00:65
Spoke1Vert pppd[2453]:  [service-name]
Spoke1Vert pppd[2453]: Recv PPPOE Discovery V1T1 PADO session 0x0 length 36
Spoke1Vert pppd[2453]:  dst b0:ad:ca:fe:00:65  src b0:ad:ca:fe:00:64
Spoke1Vert pppd[2453]:  [AC-name BRAS] [service-name] [AC-cookie  6a f6 a2 45 86 95 b6 fa 0b 2c 52 13 fc d5 00 cf a5 09 00 00]
Spoke1Vert pppd[2453]: Send PPPOE Discovery V1T1 PADR session 0x0 length 28
Spoke1Vert pppd[2453]:  dst b0:ad:ca:fe:00:64  src b0:ad:ca:fe:00:65
Spoke1Vert pppd[2453]:  [service-name] [AC-cookie  6a f6 a2 45 86 95 b6 fa 0b 2c 52 13 fc d5 00 cf a5 09 00 00]
Spoke1Vert pppd[2453]: Recv PPPOE Discovery V1T1 PADS session 0x1 length 4
Spoke1Vert pppd[2453]:  dst b0:ad:ca:fe:00:65  src b0:ad:ca:fe:00:64
Spoke1Vert pppd[2453]:  [service-name]
Spoke1Vert pppd[2453]: PADS: Service-Name: ''
Spoke1Vert pppd[2453]: PPP session is 1
Spoke1Vert pppd[2453]: <emphasis>Connected to b0:ad:ca:fe:00:64 via interface enp0s2.471</emphasis></screen>
		</listitem>

		<listitem>
		<para>Négociation des paramètres et authentification dans la
		sous-couche <acronym>LCP</acronym>.</para>

<screen>Spoke1Vert pppd[2453]: using channel 6
Spoke1Vert pppd[2453]: Using interface ppp0
Spoke1Vert pppd[2453]: Connect: ppp0 &lt;--> enp0s2.471
Spoke1Vert pppd[2453]: sent [LCP ConfReq id=0x1 &lt;mru 1492> &lt;magic 0x4b398629>]
Spoke1Vert pppd[2453]: rcvd [LCP ConfReq id=0x1 &lt;mru 1492> &lt;auth chap MD5> &lt;magic 0x7473b69b>]
Spoke1Vert pppd[2453]: sent [LCP ConfAck id=0x1 &lt;mru 1492> &lt;auth chap MD5> &lt;magic 0x7473b69b>]
Spoke1Vert pppd[2453]: sent [LCP ConfReq id=0x1 &lt;mru 1492> &lt;magic 0x4b398629>]
Spoke1Vert pppd[2453]: rcvd [LCP ConfAck id=0x1 &lt;mru 1492> &lt;magic 0x4b398629>]
Spoke1Vert pppd[2453]: sent [LCP EchoReq id=0x0 magic=0x4b398629]
Spoke1Vert pppd[2453]: rcvd [LCP EchoReq id=0x0 magic=0x7473b69b]
Spoke1Vert pppd[2453]: sent [LCP EchoRep id=0x0 magic=0x4b398629]
Spoke1Vert pppd[2453]: rcvd [CHAP Challenge id=0x92 &lt;fa8f749ff6b35e08fb00710e1f8e55a961>, name = "HubBleu"]
Spoke1Vert pppd[2453]: sent [CHAP Response id=0x92 &lt;7b0d6d2f67a7394183249dab9f414278>, name = "5p0k3_1"]
Spoke1Vert pppd[2453]: rcvd [LCP EchoRep id=0x0 magic=0x7473b69b]
Spoke1Vert pppd[2453]: rcvd [CHAP Success id=0x92 "Access granted"]
Spoke1Vert pppd[2453]: CHAP authentication succeeded: Access granted
Spoke1Vert pppd[2453]: CHAP authentication succeeded
Spoke1Vert pppd[2453]: <emphasis>peer from calling number B0:AD:CA:FE:00:64 authorized</emphasis></screen>
		</listitem>

		<listitem>
		<para>Attribution des adresses dans la sous-couche
		<acronym>NCP</acronym>. Ici, la lettre <option>N</option> est remplacée
		par <acronym>IP</acronym> pour le protocole <acronym>IPv4</acronym> et
		<acronym>IPV6</acronym> pour le protocole
		<acronym>IPv6</acronym>.</para>

		<para>En fin de copie d'écran, on relève le statut des scripts
		d'application des routes par défaut vers la liaison
		<acronym>PPP</acronym>.</para>

<screen>Spoke1Vert pppd[2453]: sent [IPCP ConfReq id=0x1 &lt;addr 0.0.0.0> &lt;ms-dns1 0.0.0.0> &lt;ms-dns2 0.0.0.0>]
Spoke1Vert pppd[2453]: sent [IPV6CP ConfReq id=0x1 &lt;addr fe80::9c61:b636:c47b:6da7>]
Spoke1Vert pppd[2453]: rcvd [CCP ConfReq id=0x1 &lt;deflate 15> &lt;deflate(old#) 15> &lt;bsd v1 15>]
Spoke1Vert pppd[2453]: sent [CCP ConfReq id=0x1]
Spoke1Vert pppd[2453]: sent [CCP ConfRej id=0x1 &lt;deflate 15> &lt;deflate(old#) 15> &lt;bsd v1 15>]
Spoke1Vert pppd[2453]: rcvd [IPCP ConfReq id=0x1 &lt;compress VJ 0f 01> &lt;addr 10.47.1.1>]
Spoke1Vert pppd[2453]: sent [IPCP ConfRej id=0x1 &lt;compress VJ 0f 01>]
Spoke1Vert pppd[2453]: rcvd [IPV6CP ConfReq id=0x1 &lt;addr fe80::44e3:1233:8a57:4b9c>]
Spoke1Vert pppd[2453]: sent [IPV6CP ConfAck id=0x1 &lt;addr fe80::44e3:1233:8a57:4b9c>]
Spoke1Vert pppd[2453]: rcvd [IPCP ConfNak id=0x1 &lt;addr 10.47.1.2> &lt;ms-dns1 172.16.0.2> &lt;ms-dns2 172.16.0.2>]
Spoke1Vert pppd[2453]: sent [IPCP ConfReq id=0x2 &lt;addr 10.47.1.2> &lt;ms-dns1 172.16.0.2> &lt;ms-dns2 172.16.0.2>]
Spoke1Vert pppd[2453]: rcvd [IPV6CP ConfAck id=0x1 &lt;addr fe80::9c61:b636:c47b:6da7>]
Spoke1Vert pppd[2453]: <emphasis>local  LL address fe80::9c61:b636:c47b:6da7</emphasis>
Spoke1Vert pppd[2453]: remote LL address fe80::44e3:1233:8a57:4b9c
Spoke1Vert pppd[2453]: Script /etc/ppp/ipv6-up started (pid 2490)
Spoke1Vert pppd[2453]: rcvd [CCP ConfAck id=0x1]
Spoke1Vert pppd[2453]: rcvd [CCP ConfReq id=0x2]
Spoke1Vert pppd[2453]: sent [CCP ConfAck id=0x2]
Spoke1Vert pppd[2453]: rcvd [IPCP ConfReq id=0x2 &lt;addr 10.47.1.1>]
Spoke1Vert pppd[2453]: sent [IPCP ConfAck id=0x2 &lt;addr 10.47.1.1>]
Spoke1Vert pppd[2453]: <emphasis>rcvd [IPCP ConfAck id=0x2 &lt;addr 10.47.1.2> &lt;ms-dns1 172.16.0.2> &lt;ms-dns2 172.16.0.2>]</emphasis>
Spoke1Vert pppd[2453]: local  IP address 10.47.1.2
Spoke1Vert pppd[2453]: remote IP address 10.47.1.1
Spoke1Vert pppd[2453]: primary   DNS address 172.16.0.2
Spoke1Vert pppd[2453]: secondary DNS address 172.16.0.2
Spoke1Vert pppd[2453]: Script /etc/ppp/ip-up started (pid 2494)
Spoke1Vert pppd[2453]: <emphasis>Script /etc/ppp/ipv6-up finished (pid 2490), status = 0x0</emphasis>
Spoke1Vert pppd[2453]: <emphasis>Script /etc/ppp/ip-up finished (pid 2494), status = 0x0</emphasis></screen>
		</listitem>
		</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Comment relever les adresses utilisées par les conteneurs
		<application>LXD</application> après installation et
		configuration&nbsp;?</phrase></para>

		<para>Rechercher dans la liste des options de la commande
		<command>lxc</command>, celle qui permet de lister les conteneurs
		présents sur le système.</para>
	</question>
	<answer>
		<para>Voici la liste des conteneurs actifs sur le premier site distant
		de la maquette. Les adresses <acronym>IPv4</acronym> et
		<acronym>IPv6</acronym> utilisées apparaissent directement.</para>

<screen><prompt>etu@Spoke1Vert:~$</prompt> lxc ls
+------------+---------+------------------+-----------------------------------------+-----------+-----------+
|    NAME    |  STATE  |       IPV4       |                  IPV6                   |   TYPE    | SNAPSHOTS |
+------------+---------+------------------+-----------------------------------------+-----------+-----------+
| container0 | RUNNING | 10.0.1.10 (eth0) | fda0:7a62:1:0:216:3eff:feda:e1a (eth0)  | CONTAINER | 0         |
+------------+---------+------------------+-----------------------------------------+-----------+-----------+
| container1 | RUNNING | 10.0.1.11 (eth0) | fda0:7a62:1:0:216:3eff:fec4:d325 (eth0) | CONTAINER | 0         |
+------------+---------+------------------+-----------------------------------------+-----------+-----------+
| container2 | RUNNING | 10.0.1.12 (eth0) | fda0:7a62:1:0:216:3eff:fe66:86fb (eth0) | CONTAINER | 0         |
+------------+---------+------------------+-----------------------------------------+-----------+-----------+</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Quelles sont les opérations à effectuer pour installer un
		service Web dans chaque conteneur&nbsp;? Une fois l'installation du
		service effectuée, comment obtenir la liste des adresses sur lesquelles
		le service est en écoute&nbsp;?</phrase></para>

		<para>Installer le paquet <systemitem>lighttpd</systemitem> dans chaque
		conteneur et donner la liste des ports en écoute dans chaque
		conteneur.</para>
	</question>
	<answer>
		<para>Partant de la liste des conteneurs obtenue à la question
		précédente, on installe les paquets <systemitem>lighttpd</systemitem>
		et <systemitem>lsof</systemitem> dans les conteneurs.</para> 

<screen><prompt>$</prompt> for i in {0..2}; do lxc exec container$i -- apt install -y lighttpd lsof; done</screen>

		<para>Les services Web sont démarrés directement lors de l'installation
		des paquets et on peut lister les services ouverts.</para>

<screen><prompt> etu@Spoke1Vert:~$</prompt> for i in {0..2}; do lxc exec container$i -- lsof -i; done
COMMAND   PID     USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
lighttpd 1311 www-data    4u  IPv4 1893171      0t0  TCP *:http (LISTEN)
lighttpd 1311 www-data    5u  IPv6 1893172      0t0  TCP *:http (LISTEN)
COMMAND   PID     USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
lighttpd 1310 www-data    4u  IPv4 1893336      0t0  TCP *:http (LISTEN)
lighttpd 1310 www-data    5u  IPv6 1896204      0t0  TCP *:http (LISTEN)
COMMAND   PID     USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
lighttpd 1310 www-data    4u  IPv4 1902888      0t0  TCP *:http (LISTEN)
lighttpd 1310 www-data    5u  IPv6 1902889      0t0  TCP *:http (LISTEN)</screen>

		<para>Dans chaque conteneur, le port <systemitem>TCP/80</systemitem> est
		ouvert pour les protocoles réseau <acronym>IPv4</acronym> et
		<acronym>IPv6</acronym>.</para>

		<para>La même liste peut être obtenue à l'aide de la commande
		<command>ss</command>.</para>

<screen><prompt>etu@Spoke1Vert:~$</prompt> for i in {0..2}; do lxc exec container$i -- ss -ta; done
State     Recv-Q  Send-Q  Local Address:Port   Peer Address:Port  Process
LISTEN    0       1024          0.0.0.0:http        0.0.0.0:*
LISTEN    0       1024             [::]:http           [::]:*
State     Recv-Q  Send-Q  Local Address:Port   Peer Address:Port  Process
LISTEN    0       1024          0.0.0.0:http        0.0.0.0:*
LISTEN    0       1024             [::]:http           [::]:*
State     Recv-Q  Send-Q  Local Address:Port   Peer Address:Port  Process
LISTEN    0       1024          0.0.0.0:http        0.0.0.0:*
LISTEN    0       1024             [::]:http           [::]:*</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Comment valider l'accès à ce service Web au niveau du
		routeur <wordasword>Spoke</wordasword>&nbsp;?</phrase></para>

		<para>Il s'agit de faire un test au niveau de la couche application. À
		la console, les deux outils adaptés sont <command>wget</command> et
		<command>curl</command>.</para>
	</question>
	<answer>
		<para>Voici un exemple de test pour chaque protocole de la couche
		réseau avec <command>wget</command> dans le contexte de la
		maquette.</para>

<screen><prompt>etu@Spoke1Vert:~$</prompt> for addr in 10.0.1.10 10.0.1.11 10.0.1.12; \
do sh -c "wget -O /dev/null http://$addr 2>&amp;1 | grep \"HTTP\" "; done
requête HTTP transmise, en attente de la réponse… 200 OK
requête HTTP transmise, en attente de la réponse… 200 OK
requête HTTP transmise, en attente de la réponse… 200 OK</screen>

<screen><prompt>etu@Spoke1Vert:~$</prompt> for addr in fda0:7a62:1:0:216:3eff:feda:e1a \
fda0:7a62:1:0:216:3eff:fec4:d325 \
fda0:7a62:1:0:216:3eff:fe66:86fb; \
do sh -c "wget -O /dev/null http://[$addr] 2>&amp;1 | grep \"HTTP\" "; done
requête HTTP transmise, en attente de la réponse… 200 OK
requête HTTP transmise, en attente de la réponse… 200 OK
requête HTTP transmise, en attente de la réponse… 200 OK</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Comment valider les accès Web depuis le routeur
		<wordasword>Hub</wordasword> et depuis l'autre routeur
		<wordasword>Spoke</wordasword>&nbsp;?</phrase></para>

		<para>Il suffit de reprendre la même série de tests depuis les autres
		routeurs de la topologie.</para>
	</question>
	<answer>
		<para>Voici deux exemples de tests réalisés dans le contexte de la maquette.</para>

<screen><prompt>etu@HubBleu:~$</prompt> for addr in fda0:7a62:1:0:216:3eff:feda:e1a \
fda0:7a62:1:0:216:3eff:fec4:d325 \
fda0:7a62:1:0:216:3eff:fe66:86fb; \
do sh -c "wget -O /dev/null http://[$addr] 2>&amp;1 | grep \"HTTP\" "; done
requête HTTP transmise, en attente de la réponse… 200 OK
requête HTTP transmise, en attente de la réponse… 200 OK
requête HTTP transmise, en attente de la réponse… 200 OK</screen>

<screen><prompt>etu@Spoke2Vert:~$</prompt> for addr in fda0:7a62:1:0:216:3eff:feda:e1a \
fda0:7a62:1:0:216:3eff:fec4:d325 \
fda0:7a62:1:0:216:3eff:fe66:86fb; \
do sh -c "wget -O /dev/null http://[$addr] 2>&amp;1 | grep \"HTTP\" "; done
requête HTTP transmise, en attente de la réponse… 200 OK
requête HTTP transmise, en attente de la réponse… 200 OK
requête HTTP transmise, en attente de la réponse… 200 OK</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
		<para><phrase>Est-il possible d'obtenir les mêmes résultats depuis un
		routeur extérieur au routeur
		<wordasword>Hub</wordasword>&nbsp;?</phrase></para>

		<para>Analyser la portée de la table de routage du routeur
		<wordasword>Hub</wordasword>.</para>
	</question>
	<answer>
		<para>La table de routage du routeur <wordasword>Hub</wordasword> sert
		uniquement à joindre les routeurs <wordasword>Spoke</wordasword> et à
		offrir une connectivité entre ces sites distants.</para>

		<para>Comme les règles de traduction des adresses source
		<acronym>IPv4</acronym> et <acronym>IPv6</acronym> ont été implantées
		sur le routeur <wordasword>Hub</wordasword>, les réseaux de conteneurs
		ont accès à Internet mais ils ne sont pas accessibles depuis
		Internet.</para> 

		<para>Rendre ces services accessibles depuis l'Internet est un des
		objectifs du support de travaux pratiques suivant&nbsp;:
		&url.interco.netfilter;.</para>
	</answer>
	</qandaentry>
	</qandaset>
</sect1>

<sect1 xml:id='interco.pppoe.refdocs'>
	<title>Documents de référence</title>

	<variablelist>
	<varlistentry xml:id='interco.pppoe.rfc1661'>
		<term><citetitle>The Point-to-Point Protocol (PPP)</citetitle></term>
		<listitem>
		<para>&url.rfc1661;&nbsp;: Le protocole point à point <acronym>PPP</acronym>
		fournit une méthode standard de transport de datagrammes
		multi-protocoles sur des liaisons point à point. <acronym>PPP</acronym>
		comprend 3 composants principaux&nbsp;:</para>

		<orderedlist>
		<listitem>
		<para>Une méthode d'encapsulation des datagrammes
		multi-protocoles.</para>
		</listitem>
		<listitem>
		<para>Un protocole de contrôle de niveau liaison ou <wordasword>Link
		Control Protocol</wordasword> (<acronym>LCP</acronym>) pour établir,
		configurer et tester une connexion de données à ce niveau.</para>
		</listitem>
		<listitem>
		<para>Une famille de protocoles de contrôle de niveau réseau pour
		établir et configurer différents protocoles de niveau réseau.</para>
		</listitem>
		</orderedlist>
		</listitem>
	</varlistentry>

	<varlistentry xml:id='interco.pppoe.config.interface.lan'>
		<term><citetitle>Configuration d'une interface de réseau
		local</citetitle></term>
		<listitem>
		<para>&url.config.interface.lan;&nbsp;: identification du type d'interface,
		de ses caractéristiques et manipulations des paramètres. Ce support
		fournit une méthodologie de dépannage simple d'une connexion
		réseau.</para>
		</listitem>
	</varlistentry>
	</variablelist>
</sect1>
</article>
