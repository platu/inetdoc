<?xml version='1.0'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML
V5.0//EN" "/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [

<!ENTITY author SYSTEM "author.xml">
<!ENTITY legal SYSTEM "legal.xml">
<!ENTITY nbsp "&#160;">

<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.xml'>
%inetdoc_urls;

<!ENTITY % rfc_urls SYSTEM 'rfc.urls.xml'>
%rfc_urls;

<!ENTITY url.bonding
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.linuxfoundation.org/collaborate/workgroups/networking/bonding">
<citetitle>bonding</citetitle></link>'>

<!ENTITY url.etherchannel
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.cisco.com/en/US/tech/tk389/tk213/technologies_white_paper09186a0080092944.shtml">
<citetitle>etherchannel</citetitle></link>'>

<!ENTITY url.multipath
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://sources.redhat.com/lvm2/wiki/MultipathUsageGuide">
<citetitle>multipath</citetitle></link>'>

<!ENTITY url.open-iscsi
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.open-iscsi.org/">
<citetitle>Open-iSCSI</citetitle></link>'>

<!ENTITY url.usingparted
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.gnu.org/software/parted/manual/html_node/Using-Parted.html#Using-Parted">
<citetitle>Using Parted</citetitle></link>'>

<!ENTITY url.ext4howto
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://ext4.wiki.kernel.org/index.php/Ext4_Howto">
<citetitle>Ext4 Howto</citetitle></link>'>

<!ENTITY url.iscsi.debian.wiki
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://wiki.debian.org/SAN/iSCSI">
<citetitle>iSCSI and Debian</citetitle></link>'>

<!ENTITY url.sparse_file
'<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://en.wikipedia.org/wiki/Sparse_file">
<citetitle>Sparse file</citetitle></link>'>

<!-- A copy of http://www.w3.org/2003/entities/2007/w3centities-f.ent is at:
/usr/local/share -->
<!ENTITY % w3centities-f PUBLIC "-//W3C//ENTITIES Combined Set//EN//XML"
	"/usr/local/share/w3centities-f.ent">
%w3centities-f;
]>

<article xml:id='sysadm-net.iscsi' xml:lang='fr'>

<info>
	<title>Introduction aux réseaux de stockage iSCSI</title>

	&author;
<abstract>
	<para>
	<informaltable frame='none' pgwide='1'>
	<tgroup cols='2' align='left' colsep='0' rowsep='0'>
	<colspec colwidth='5*'/>
	<colspec colwidth='220px'/>
	<tbody>
	<row>
	<entry valign='top'>
    <para>Ce support de travaux pratiques est consacré à l'étude des
    technologies de stockage <acronym>DAS</acronym> (<wordasword>Direct
    Attached Storage</wordasword>), <acronym>SAN</acronym> (<wordasword>Storage
    Area Network</wordasword>) et de la redondance
    <acronym>RAID&nbsp;1</acronym>. Le protocole <acronym>iSCSI</acronym> est
    utilisé comme exemple d'accès «mode bloc» aux unités de stockage réseau
    pour la partie <acronym>SAN</acronym>. La redondance
    <acronym>RAID&nbsp;1</acronym> utilise les fonctions intégrées au noyau
    Linux. L'infrastructure proposée montre comment les différentes
    technologies élémentaires peuvent être combinées pour atteindre les
    objectifs de haute disponibilité et de sauvegarde.</para>
	</entry>
	<entry>
	<inlinemediaobject>
	<imageobject role='fo'>
	<imagedata fileref='images/targetcli.png' format='PNG' width='5cm' scalefit='1'/>
	</imageobject>
	<imageobject role='html'>
	<imagedata fileref='images/targetcli.png' format='PNG' width='18em' scalefit='1'/>
	</imageobject>
	</inlinemediaobject>
	</entry>
	</row>
	</tbody>
	</tgroup>
	</informaltable>
	</para>
</abstract>

<keywordset>
	<keyword>DAS</keyword>
	<keyword>debian</keyword>
	<keyword>iscsi</keyword>
	<keyword>Initiator</keyword>
	<keyword>linux</keyword>
	<keyword>mdadm</keyword>
	<keyword>RAID</keyword>
	<keyword>SAN</keyword>
	<keyword>Target</keyword>
	<keyword>Targetcli</keyword>
</keywordset>
</info>

<sect1 xml:id='sysadm-net.iscsi.legal.meta'>
	&legal;
	<bridgehead xml:id='sysadm-net.iscsi.meta'
	renderas='sect2'>Méta-information</bridgehead>

	<para>Ce document est écrit avec <link
	xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link>
	XML sur un système <link
	xlink:href="http://www.debian.org"><citetitle>Debian
	GNU/Linux</citetitle></link>. Il est disponible en version imprimable au
	format PDF&nbsp;: <link
	xlink:href="https://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.objectives'>
	<title>Objectifs</title>

	<para>Après avoir réalisé les manipulations proposées par ce support, vous
	serez en mesure de&nbsp;:</para>

    <variablelist>
	<varlistentry>
		<term>Découvrir et comprendre les technologies de stockage
		réseau (DAS, SAN, iSCSI, RAID&nbsp;1)</term>
        <listitem>
        <para>Identifier les différences entre les architectures de stockage
        direct (<acronym>DAS</acronym>), les réseaux de stockage
        (<acronym>SAN</acronym>) et la redondance
        <acronym>RAID&nbsp;1</acronym>, en mettant l'accent sur le protocole
        <acronym>iSCSI</acronym> comme exemple d’accès mode bloc aux unités
        de stockage réseau.</para>
        </listitem>
	</varlistentry>

	<varlistentry>
		<term>Configurer un initiateur iSCSI sur un système
		Linux.</term>
        <listitem>
        <para>Configurer une infrastructure minimale <acronym>iSCSI</acronym>,
        incluant la préparation des unités de stockage, la configuration des
        rôles <wordasword>Initiator</wordasword> et
        <wordasword>Target</wordasword>, et la validation de la connectivité
        réseau et du partage de volumes de stockage.</para>
        </listitem>
	</varlistentry>

	<varlistentry>
		<term>Expérimenter la redondance et la haute disponibilité avec
		RAID&nbsp;1</term>
        <listitem>
        <para>Illustrer la création et la gestion d’un volume
        <acronym>RAID&nbsp;1</acronym> combinant un disque local et un volume
        <acronym>iSCSI</acronym>, afin de démontrer la réplication synchrone
        des données et la tolérance aux pannes dans un environnement
        réel.</para>
        </listitem>
	</varlistentry>

	<varlistentry>
		<term>Automatiser la gestion et la sauvegarde des volumes
		logiques</term>
        <listitem>
        <para>Initier les étudiants à la gestion avancée des volumes logiques
        (<acronym>LVM</acronym>), à la création de
        <wordasword>snapshots</wordasword> pour la sauvegarde, et à la
        restauration de données, tout en évaluant les performances des
        différentes solutions de stockage mises en œuvre.</para>
        </listitem>
	</varlistentry>
    </variablelist>
</sect1>

<?custom-pagebreak?>
<sect1 xml:id='sysadm-net.iscsi.plan'>
	<title>Topologie, scénario et plan d'adressage</title>

	<bridgehead xml:id='sysadm-net.iscsi.logical-topology'
	renderas='sect2'>Topologie logique</bridgehead>

	<para>Les manipulations présentées dans ce support utilisent un domaine de
	diffusion unique (<acronym>VLAN</acronym>) dans lequel on trouve deux
	systèmes virtuels ou physiques avec deux unités de stockage distinctes
	chacune.</para>

	<itemizedlist>
	<listitem>
	<para>La première unité de disque <systemitem>/dev/vda</systemitem>
	représente le stockage du système d'exploitation de la machine
	virtuelle.</para>
	</listitem>
	<listitem>
	<para>La seconde unité de stockage <systemitem>/dev/vdb</systemitem> est
	dédiée aux manipulations présentées dans ce document.</para>
	</listitem>
	</itemizedlist>

<mediaobject>
	<imageobject role='fo'>
	<imagedata fileref='images/iscsi-logical-topology.png' format='PNG' contentwidth='15cm' width='15.5cm'/>
	</imageobject>
	<imageobject role='html'>
	<imagedata fileref='images/iscsi-logical-topology.png' format='PNG' contentwidth='700px' scalefit='1'/>
	</imageobject>
	<textobject>
	<phrase>Topologie logique</phrase>
	</textobject>
	<caption>
	<para><link xmlns="http://docbook.org/ns/docbook"
	xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.iscsi/images/iscsi-logical-topology.png'>Topologie
	logique - vue complète</link></para>
	</caption>
</mediaobject>

	<bridgehead xml:id='sysadm-net.iscsi.scenario'
	renderas='sect2'>Scénario</bridgehead>

	<para>Le séquencement des opérations dépend des rôles définis par la
	technologie <acronym>iSCSI</acronym>.</para>

<table frame='all' pgwide='1' xml:id='iscsi-roles-table'>
	<title>Attribution des rôles ISCSI</title>
	<tgroup cols='2' align='left' colsep='1' rowsep='1'>
	<colspec colnum='1' colname='c1' colwidth='1*'/>
	<colspec colnum='2' colname='c2' colwidth='1*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333"&nbsp;?>
		<?dbfo color="#fff"&nbsp;?>
	<entry>Rôle <wordasword>Initiator</wordasword></entry>
	<entry>Rôle <wordasword>Target</wordasword></entry>
	</row>
	</thead>
	<tbody>
	<row>
	<entry>Préparation d'une unité de stockage locale en vue de la redondance
	avec l'unité de stockage réseau proposée par le rôle
	<wordasword>Target</wordasword></entry>
	<entry>Préparation d'une unité de stockage locale qui sera mise à
	disposition sur le réseau à l'aide de la technologie
	<acronym>iSCSI</acronym></entry>
	</row>
	<row>
	<entry>Recherche et installation du ou des paquet(s) pour le rôle
	<wordasword>Initiator</wordasword></entry>
	<entry>Recherche et installation du ou des paquet(s) pour le rôle
	<wordasword>Target</wordasword></entry>
	</row>
	<row>
	<entry>Étude des outils de configuration du service
	<application>open-iscsi</application></entry>
	<entry>Étude des outils de configuration du service
	<application>targetcli</application></entry>
	</row>
	<row>
	<entry namest='c1' nameend='c2' align='center'>Validation manuelle de la
	configuration <acronym>SAN</acronym> <acronym>iSCSI</acronym></entry>
	</row>
	<row>
	<entry namest='c1' nameend='c2' align='center'>Validation de la
	configuration système</entry>
	</row>
	<row>
	<entry namest='c1' nameend='c2' align='center'>Validation de
	l'authentification mutuelle entre les rôles
	<wordasword>Initiator</wordasword> et
	<wordasword>Target</wordasword></entry>
	</row>
	<row>
    <entry>
    <para>Mise en place de la <emphasis>réplication synchrone</emphasis> avec
    un tableau <acronym>RAID&nbsp;1</acronym> entre l'unité de disque locale et
    l'unité de disque réseau <acronym>iSCSI</acronym> fournie par le rôle
    <wordasword>Target</wordasword>.</para>
    <para>Mise en place de la <emphasis>réplication asynchrone</emphasis> avec
    le gestionnaire de volumes logiques <acronym>LVM</acronym> et la création
    d'instantanés (<wordasword>snapshots</wordasword>) de sauvegarde.</para>
    </entry>
    <entry>&nbsp;</entry>
	</row>
	<row>
	<entry namest='c1' nameend='c2' align='center'>Étude comparative des
	performances d'accès</entry>
	</row>
	</tbody>
	</tgroup>
</table>

    <?custom-pagebreak?>
	<bridgehead xml:id='sysadm-net.iscsi.addressing'
	renderas='sect2'>Plan d'adressage</bridgehead>

	<para>Partant de la topologie présentée ci-dessus, on utilise un plan
	d'adressage pour chacun des rôles <acronym>iSCSI</acronym>.</para>

	<para>Le tableau ci-dessous correspond au plan d'adressage de la maquette
	qui a servi à traiter les questions des sections suivantes. Lors des
	séances de travaux pratiques, un plan d'adressage spécifique est fourni à
	chaque binôme d'étudiants. Il faut se référer au document
	&url.infra.moodle;.</para>

	<table xml:id='sysadm-net.iscsi.mockup-addressing' frame='all' pgwide='1'>
        <title>Plan d'adressage de la maquette « Introduction aux réseaux de
        stockage iSCSI »</title>
	<tgroup cols='3'>
	<colspec colnum='1' colwidth='1*'/>
	<colspec colnum='2' colwidth='1*'/>
	<colspec colnum='3' colwidth='3*'/>
	<thead>
	<row>
		<?dbfo bgcolor="#333"&nbsp;?>
		<?dbfo color="#fff"&nbsp;?>
		<entry>Rôle</entry>
		<entry>VLAN</entry>
		<entry>Adresses IP</entry>
	</row>
	</thead>
	<tbody>
	<row>
		<entry>
		<citetitle>Initiator</citetitle>
		</entry>
		<entry>369</entry>
		<entry>
		<systemitem class='ipaddress'>10.0.113.6/28</systemitem><?custom-linebreak?>
		<systemitem class='ipaddress'>2001:678:3fc:171:baad:caff:fefe:6/64</systemitem>
		</entry>
	</row>
	<row>
		<entry>
		<citetitle>Target</citetitle>
		</entry>
		<entry>369</entry>
		<entry>
		<systemitem class='ipaddress'>10.0.113.5/28</systemitem><?custom-linebreak?>
		<systemitem class='ipaddress'>2001:678:3fc:171:baad:caff:fefe:5/64</systemitem>
		</entry>
	</row>
	</tbody>
	</tgroup>
	</table>

	<para>Pour traiter le scénario de ce support qui associe la technologie
	<acronym>iSCSI</acronym>, la redondance de disque <acronym>RAID&nbsp;1</acronym>
	et la gestion de volume logique <acronym>LVM</acronym>, on utilise deux
	instances de machines virtuelles avec une unité de disque
	supplémentaire.</para>

    <para>Avant de traiter les questions des sections suivantes, recherchez
    dans le cours &url.infra.moodle; les éléments nécessaires au raccordement
    des machines virtuelles ou physiques. Les étapes usuelles sont les
    suivantes&nbsp;:</para>

	<orderedlist>
	<listitem>
	<para>Attribuer les adresses <acronym>IPv4</acronym> et
	<acronym>IPv6</acronym> à chaque poste en fonction de l'espace
	d'adressage du réseau défini.</para>
	</listitem>
	<listitem>
	<para>Rechercher le numéro de VLAN correspondant aux réseaux
	<acronym>IP</acronym> attribués.</para>
	</listitem>
	<listitem>
	<para>Repérer le commutateur sur lequel des ports ont été affectés au
	<acronym>VLAN</acronym> recherché. Connecter les deux postes de travaux
	pratiques sur les ports identifiés.</para>
	</listitem>
	<listitem>
	<para>Configurer les interfaces réseau de chaque poste&nbsp;: adresse,
	masque et passerelle par défaut. Valider la connectivité
	<acronym>IP</acronym> entre les deux postes puis avec les autres réseaux de
	l'infrastructure de travaux pratiques.</para>
	</listitem>
	</orderedlist>
</sect1>

<?custom-pagebreak?>
<sect1 xml:id='sysadm-net.iscsi.technology'>
	<title>Technologie iSCSI</title>

    <para>Cette section présente sommairement le protocole et les rôles
    <acronym>iSCSI</acronym>. Ce support fait suite à la présentation sur le
    &url.storage; utilisée en cours.</para>

<mediaobject>
	<imageobject role='fo'>
	<imagedata fileref='images/topologie-iscsi.png' format='PNG' contentwidth='12cm' width='12.5cm'/>
	</imageobject>
	<imageobject role='html'>
	<imagedata fileref='images/topologie-iscsi.png' format='PNG' contentwidth='640px' scalefit='1'/>
	</imageobject>
	<textobject>
	<phrase>Topologie iSCSI basique</phrase>
	</textobject>
	<caption>
    <para><link xmlns="http://docbook.org/ns/docbook"
    xlink:href='https://www.inetdoc.net/travaux_pratiques/sysadm-net.iscsi/images/topologie-iscsi.png'>Topologie
    iSCSI basique - vue complète</link></para>
	</caption>
</mediaobject>

    <variablelist>
    <varlistentry>
        <term>Qu'est-ce que l'iSCSI ?</term>
        <listitem>
        <para>Il s'agit d'un protocole réseau standardisé qui permet de
        transporter les commandes SCSI sur un réseau TCP/IP. Grâce à cette
        technologie, il est possible d’accéder à un espace de stockage à
        distance comme s’il s’agissait d’un disque dur local, en utilisant une
        infrastructure réseau Ethernet.</para>
        </listitem>
    </varlistentry>

    <varlistentry>
        <term>Fonctionnement et architecture</term>
        <listitem>
        <para>Le protocole <acronym>iSCSI</acronym> encapsule les commandes
        <acronym>SCSI</acronym> dans des paquets IP. Pour garantir l'intégrité
        des transmissions, le protocole gère l'ordre d’envoi, la retransmission
        et la séquence des commandes, car le réseau IP n’assure pas de
        livraison fiable. Les données sont traitées comme dans les
        architectures SAN classiques, ce qui permet d'utiliser la technologie
        de manière comparable à la technologie <wordasword>Fibre
        Channel</wordasword>, mais sur un réseau IP.</para>
        </listitem>
    </varlistentry>

    <varlistentry>
        <term>Rôles des équipements</term>
        <listitem>
        <para>Le rôle «&nbsp;Target&nbsp;» est un système (matériel ou
        logiciel) qui héberge le volume de stockage à publier sur le réseau. Il
        peut s'agir d'un serveur physique ou virtuel, d'une baie de disques ou
        d'un simple disque/fichier exporté.</para>

        <para>Le rôle «&nbsp;Initiator&nbsp;» correspond au client qui accède
        au volume de stockage iSCSI publié sur le réseau.</para>
        </listitem>
    </varlistentry>

    <varlistentry>
        <term>Avantages de l’iSCSI</term>
        <listitem>
        <para>Coût réduit&nbsp;: l'iSCSI fonctionne sur des réseaux classiques,
        sans matériel propriétaire, contrairement à Fibre Channel, ce qui
        permet de réduire les coûts matériels et d’administration.</para>

        <para>Simplicité et flexibilité&nbsp;: la gestion s'effectue à l'aide
        d'outils standards sur des réseaux homogènes, ce qui facilite la
        formation et l'exploitation.</para>

        <para>Interopérabilité&nbsp;: pris en charge nativement par la plupart
        des systèmes d’exploitation (Linux, Windows, etc.) et par de nombreux
        équipements réseau modernes.</para>
        </listitem>
    </varlistentry>

    <varlistentry>
        <term>Bonnes pratiques et optimisation des performances</term>
        <listitem>
        <para>L'agrégation de liens (bonding, LACP, Etherchannel) permet
        d'augmenter la bande passante ou d'assurer la tolérance de
        panne.</para>

        <para>Multipath&nbsp;: pour assurer la redondance et la répartition de
        charge, plusieurs chemins réseau peuvent être utilisés
        simultanément.</para>

        <para>Architectures homogènes&nbsp;: privilégier un réseau Ethernet
        unifié simplifie l'exploitation et réduit les risques d’erreur.</para>
        </listitem>
    </varlistentry>

    <varlistentry>
        <term>Mise en œuvre sous Linux</term>
        <listitem>
        <para>Plusieurs implémentations coexistent dans les systèmes Linux.
        Pour ces manipulations, nous avons choisi d'utiliser des outils qui
        exploitent les fonctions du noyau Linux.</para>

        <para>Côté initiateur, la référence est
        <application>open-iscsi</application>. Ce logiciel, dont le cœur est
        intégré au noyau Linux, gère la connexion aux cibles iSCSI.</para>

        <para>Côté cible, les outils comme
        <application>targetcli-fb</application> permettent de configurer le
        partage de volumes via la pile LIO du noyau Linux.</para>
        </listitem>
    </varlistentry>
    </variablelist>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.storage'>
	<title>Préparer une unité de stockage</title>

	<para>Cette section traite des manipulations à effectuer pour
	préparer une unité de stockage à son utilisation dans une configuration
	<acronym>DAS</acronym> (et|ou) <acronym>SAN</acronym>.</para>

    <para>Comme indiqué dans le <xref linkend='iscsi-roles-table' />, les
    manipulations de cette section sont utiles pour le rôle
    <citetitle>Initiator</citetitle> une fois que la session
    <acronym>iSCSI</acronym> est établie et que la nouvelle unité de disque
    appelée <literal>/dev/sda</literal> est accessible.</para>

<warning>
	<para>Les copies d'écran utilisées dans les réponses correspondent à
    l'utilisation d'une machine virtuelle à laquelle on ajoute une unité de
    disque NVME nommée <literal>/dev/nvme1n1</literal>.</para>

    <para>Suivant le mode de raccordement choisi (nvme, scsci, virtio ou iscsi),
    les noms des unités de disques changent.</para>
</warning>

<sect2 xml:id='sysadm-net.iscsi.storage.list'>
	<title>Afficher la liste des unités de stockage</title>

	<para>Pour commencer, il est utile de connaître la liste des unités de
	stockage mode bloc sur un système.</para>

<qandaset defaultlabel='number'>
	<qandadiv>
	<qandaentry xml:id='sysadm-net.iscsi.storage.lsblk'>
	<question>
	<para xml:id='lsblkshort'><phrase>Quelle est la commande apparentée à <command>ls</command> qui
	permet d'obtenir la liste des périphériques de stockage mode
	bloc&nbsp;?</phrase></para>

	<para>Consulter la liste des outils fournis avec le paquet
	<application>util-linux</application>.</para>
	</question>
	<answer>
<screen>dpkg -L util-linux | grep bin/ls</screen>

<screen><emphasis>/usr/bin/lsblk</emphasis>
/usr/bin/lscpu
/usr/bin/lsipc
/usr/bin/lslocks
/usr/bin/lslogins
/usr/bin/lsmem
/usr/bin/lsns</screen>

    <para>Une fois que la commande <command>lsblk</command> est identifiée,
    vous devez l'utiliser pour obtenir la liste voulue.</para>

<screen>lsblk</screen>

<screen>NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sr0          11:0    1  1024M  0 rom
vda         254:0    0   366K  0 disk
nvme0n1     259:1    0   120G  0 disk
├─nvme0n1p1 259:4    0     3M  0 part
├─nvme0n1p2 259:5    0   124M  0 part /boot/efi
└─nvme0n1p3 259:6    0 119,9G  0 part /
<emphasis>nvme1n1     259:3    0    32G  0 disk</emphasis></screen>

    <para>Dans le système de fichiers, c'est l'unité
    <systemitem>/dev/nvme1n1</systemitem> qui doit être utilisée pour les
    manipulations de cette section.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.iscsi.storage.setup'>
	<title>Créer une table des partitions et formater une unité de disque</title>

    <para>Dans quel contexte doit-on partitionner et formater une unité de
    disque&nbsp;?</para>

	<itemizedlist>
	<listitem>
    <para>On peut s'entraîner avec les seconds disques des rôles
    <wordasword>Initiator</wordasword> et <wordasword>Target</wordasword>. Une
    fois les tests effectués, il est préférable d'effacer la table de partition
    avec en suivant les instructions de la <xref
    linkend='sysadm-net.iscsi.storage.blank' />.</para>
	</listitem>
	<listitem>
    <para>Il est également possible de s'entraîner avec l'unité de stockage
    <acronym>iSCSI</acronym> sur le système <wordasword>Initiator</wordasword>
    une fois la session <acronym>iSCSI</acronym> établie. Comme l'unité de
    disque réseau est la propriété exclusive du rôle
    <wordasword>Initiator</wordasword> mode bloc, les manipulations sont les
    mêmes que pour un disque local au système. Comme dans le cas précédent, il
    est préférable d'effacer la table de partition avec en suivant les
    instructions de la <xref linkend='sysadm-net.iscsi.storage.blank'
    />.</para>
	</listitem>
    <listitem>
    <para>Enfin, partitionnez et formatez le volume logique
    <acronym>LVM</acronym> pour pouvoir suivre les manipulations à partir de la
    <xref linkend='sysadm-net.iscsi.lvm-snapshot' />.</para>
    </listitem>
	</itemizedlist>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Comment créer une partition unique utilisant le maximum
    d'espace de stockage de l'unité de disque&nbsp;?</phrase></para>

	<para>Consulter la documentation de <application>parted</application> à
	l'adresse &url.usingparted;.</para>

    <para>Installez le paquet <command>parted</command> si nécessaire.</para>

<screen>sudo apt install parted</screen>
	</question>
	<answer>
<screen>sudo parted /dev/nvme1n1</screen>
<screen>GNU Parted 3.6
Using /dev/nvme1n1
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted)</screen>

<screen>(parted) <emphasis>mklabel gpt</emphasis>
(parted) <emphasis>print</emphasis></screen>

<screen>Model: QEMU NVMe Ctrl (nvme)
Disk /dev/nvme1n1: 34,4GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags:

Number  Start  End  Size  File system  Name  Flags</screen>

<screen>(parted) <emphasis>mkpart myOwnPartition ext4 1MiB 100%</emphasis>
(parted) <emphasis>print</emphasis></screen>

<screen>Model: QEMU NVMe Ctrl (nvme)
Disk /dev/nvme1n1: 34,4GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags:

Number  Start   End     Size    File system  Name            Flags
 1      1049kB  34,4GB  34,4GB  ext4         myOwnPartition</screen>

<screen>(parted) <emphasis>quit</emphasis></screen>
<screen>Information: You may need to update /etc/fstab.</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la commande à utiliser pour les opérations de
	formatage&nbsp;? Quel est le rôle de l'option <option>-T</option> de cette
	commande&nbsp;?</phrase></para>

	<para>Les informations utiles sont disponibles à la page &url.ext4howto;.
	Les pages de manuels détaillent les fonctions des options.</para>
	</question>
	<answer>
	<para>La commande utilisée pour le formatage d'un système de fichiers <option>ext4</option>.</para>

<screen>dpkg -S $(sudo which mkfs.ext4)</screen>
<screen>e2fsprogs: /usr/sbin/mkfs.ext4</screen>

    <para>L'option <option>-T</option> permet de définir le type d'utilisation du système
    de fichiers à formater en fonction sa taille. Les paramètres par défaut sont
    définis dans le fichier <filename>/etc/mke2fs.conf</filename>. Voici un
    résumé des paramètres intéressants pour ces manipulations&nbsp;:</para>

	<itemizedlist>
	<listitem>
    <para><option>ext4</option>&nbsp;:i active des fonctionnalités avancées
    telles que la journalisation, l'allocation basée sur l'étendue, la prise en
    charge de fichiers très volumineux, les groupes de blocs flexibles, les
    sommes de contrôle des métadonnées, le 64 bits, la prise en charge des
    répertoires volumineux et des champs inode supplémentaires.</para>
	</listitem>
	<listitem>
    <para><option>small/floppy/news</option>&nbsp;: utilise des tailles de
    bloc plus petites (1024 octets) et des densités d'inodes plus élevées
    (plus d'inodes par espace) pour les petits systèmes de fichiers ou des
    cas d'utilisation spécifiques (par exemple, les spools de
    nouvelles).</para>
	</listitem>
	<listitem>
    <para><option>big/huge</option>&nbsp;: conçu pour les grands systèmes de
    fichiers avec un ratio d'inodes beaucoup plus élevé (moins d'inodes par
    espace). Il est utile pour le stockage de vidéos et d'images par
    exemple.</para>
	</listitem>
	<listitem>
    <para><option>largefile/largefile4</option>&nbsp;: ratios d'inodes très
    élevés et tailles de blocs indéfinies pour les scénarios à usage unique et
    les fichiers volumineux. Il est utile pour le stockage d'images de machines
    virtuelles, de sauvegardes ou de flux vidéo en direct.</para>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe de la commande de formatage de la
	partition créée lors de l'étape précédente&nbsp;?</phrase></para>

	<para>Des exemples de syntaxe sont disponibles à la page
	&url.ext4howto;.</para>
	</question>
	<answer>
<screen>sudo mkfs.ext4 /dev/nvme1n1p1</screen>
<screen>mke2fs 1.47.2 (1-Jan-2025)
Discarding device blocks: done
Creating filesystem with 8388096 4k blocks and 2097152 inodes
Filesystem UUID: 97049e50-931a-4741-8c87-faf2582c494f
Superblock backups stored on blocks:
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
	4096000, 7962624

Allocating group tables: done
Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe de la commande de visualisation des
	attributs du système de fichiers créé lors du
	formatage&nbsp;?</phrase></para>

	<para>Les informations utiles sur les attributs sont fournies à la page
	&url.ext4howto;.</para>
	</question>
    <answer>

<screen>sudo tune2fs -l /dev/nvme1n1p1</screen>
<screen>tune2fs 1.47.2 (1-Jan-2025)
Filesystem volume name:   &lt;none>
Last mounted on:          &lt;not available>
Filesystem UUID:          97049e50-931a-4741-8c87-faf2582c494f
Filesystem magic number:  0xEF53
Filesystem revision #:    1 (dynamic)
Filesystem features:      has_journal ext_attr resize_inode dir_index orphan_file filetype extent 64bit flex_bg metadata_csum_seed sparse_super large_file huge_file dir_nlink extra_isize metadata_csum
Filesystem flags:         signed_directory_hash
Default mount options:    user_xattr acl
Filesystem state:         clean
Errors behavior:          Continue
Filesystem OS type:       Linux
Inode count:              2097152
Block count:              8388096
Reserved block count:     419404
Overhead clusters:        176700
Free blocks:              8210878
Free inodes:              2097140
First block:              0
Block size:               4096
Fragment size:            4096
Group descriptor size:    64
Reserved GDT blocks:      1024
Blocks per group:         32768
Fragments per group:      32768
Inodes per group:         8192
Inode blocks per group:   512
Flex block group size:    16
Filesystem created:       Sat Aug 23 16:20:39 2025
Last mount time:          n/a
Last write time:          Sat Aug 23 16:20:39 2025
Mount count:              0
Maximum mount count:      -1
Last checked:             Sat Aug 23 16:20:39 2025
Check interval:           0 (&lt;none>)
Lifetime writes:          6274 kB
Reserved blocks uid:      0 (user root)
Reserved blocks gid:      0 (group root)
First inode:              11
Inode size:               256
Required extra isize:     32
Desired extra isize:      32
Journal inode:            8
Default directory hash:   half_md4
Directory Hash Seed:      b7f68521-faa9-4357-bc98-f5baa8cf5f4e
Journal backup:           inode blocks
Checksum type:            crc32c
Checksum:                 0x8a2806a9
Checksum seed:            0x8c83f6ed
Orphan file inode:        12</screen>

    <para>La sortie de la commande <command>tune2fs -l</command> indique que le
    système de fichiers <literal>ext4</literal> sur la partition
    <literal>/dev/nvme1n1p1</literal> est propre, utilise des blocs de 4 Ko et
    des inodes de 256 octets, et prend en charge des fonctionnalités telles que
    la journalisation et les extensions.</para>

    <itemizedlist>
    <listitem>
    <para>Les sommes de contrôle des métadonnées sont représentées sur 64
    bits.</para>
    </listitem>
    <listitem>
    <para>Les fichiers volumineux sont supportés.</para>
    </listitem>
    <listitem>
    <para>Le système de fichiers vient d'être créé avec presque tous les blocs
    et inodes libres.</para>
    </listitem>
    <listitem>
    <para>Il dispose d'options de montage par défaut (user_xattr, acl).</para>
    </listitem>
    </itemizedlist>

    <para>Aucun nom de volume n'est défini. Aucune vérification fsck périodique
    n'est prévue, et le système de fichiers est de type Linux, avec un
    comportement d'erreur défini sur «&nbsp;continuer&nbsp;».</para>
	</answer>
	</qandaentry>
	</qandaset>
	</sect2>

<sect2 xml:id='sysadm-net.iscsi.storage.mount'>
	<title>Monter manuellement un volume de stockage</title>

    <para>Une fois qu'un volume de stockage a été partitionné et formaté, vous
    pouvez le <emphasis>«&nbsp;monter&nbsp;»</emphasis> dans l'arborescence du
    système de fichiers du système pour pouvoir lire et écrire des
    données.</para>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Comment obtenir l'identifiant du volume de stockage à ajouter
	au système de fichiers&nbsp;?</phrase></para>

	<para>Consulter la liste des utilitaires fournis avec le paquet
	<application>util-linux</application>. Il faut se rappeler que la
	représentation fichier d'un périphérique de stockage se distingue par son
	mode d'accès&nbsp;: le mode bloc.</para>
	</question>
	<answer>
	<para>La commande à utiliser est <command>blkid</command>. Dans l'exemple
	de la partition <systemitem>/dev/vdb1</systemitem>, on obtient le résultat
	suivant.</para>

<screen>sudo blkid /dev/nvme1n1p1</screen>
<screen>/dev/nvme1n1p1: <emphasis>UUID="97049e50-931a-4741-8c87-faf2582c494f"</emphasis>
BLOCK_SIZE="4096" TYPE="ext4" PARTLABEL="myOwnPartition"
PARTUUID="57ae228a-bd8d-49de-9933-97b2c71af70e"</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Dans quel fichier de configuration trouve-t-on la liste des
	périphériques montés lors de l'initialisation du
	système&nbsp;?</phrase></para>

	<para>Consulter la liste des fichiers du paquet
	<application>util-linux</application>.</para>
	</question>
	<answer>
	<para>Le fichier recherché est <filename>/etc/fstab</filename>. Il contient
	la liste des points de montage. Dans l'exemple ci-dessous, la racine
	et la partition d'échange utilisée en cas de saturation des ressources
	<acronym>RAM</acronym> du système.</para>

<screen>grep -v '^#' /etc/fstab</screen>
<screen>PARTUUID=95ed2e41-f56c-4cc0-a79e-c93a07e93c79 / ext4 rw,discard,errors=remount-ro,x-systemd.growfs 0 1
PARTUUID=71f5d30c-8e21-4372-81f6-11eb66815669 /boot/efi vfat defaults,umask=077 0 2</screen>
    </answer>
    </qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la commande qui donne la liste des montages en
	cours d'utilisation sur le système&nbsp;? Quelle est l'option qui permet de
	scruter les entrées du fichier recherché dans la question précédente et de
	monter tous les points non encore utilisés&nbsp;?</phrase></para>

	<para>La commande est fournie par le paquet du même nom.</para>
	</question>
	<answer>
	<para>Le paquet <application>mount</application> fournit la commande du
	même nom. Cette commande liste tous les montages actifs du système. La
	liste comprend les systèmes de fichiers virtuels qui représentent l'état
	courant des paramètres du noyau ainsi que les systèmes de fichiers
	physiques qui correspondent aux unités de stockage utilisées.</para>

<screen>mount | grep nvme</screen>
<screen>/dev/nvme0n1p3 on / type ext4 (rw,relatime,discard,errors=remount-ro)
/dev/nvme0n1p2 on /boot/efi type vfat (rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro)</screen>

	<para>L'option de montage des entrées inutilisées du fichier
	<filename>/etc/fstab</filename> est <option>-a</option>. Elle doit être
	utilisée dans la question suivante.</para>
    </answer>
    </qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment monter manuellement le système de fichiers de la
	partition <systemitem>/dev/nvmen1p1</systemitem>&nbsp;?</phrase></para>

	<para>Le répertoire de test pour les montages temporaires est
	historiquement <systemitem>/mnt/</systemitem>.</para>

	<para>Consulter les pages de manuels de la commande
	<command>mount</command>.</para>
	</question>
	<answer>
	<para>On dispose d'au moins deux solutions pour désigner la partition à monter.</para>
	<itemizedlist>
	<listitem>
	<para>Utilser l'identifiant de partition unique.</para>

<screen>sudo mount -U "97049e50-931a-4741-8c87-faf2582c494f" /mnt</screen>
<screen>mount | grep mnt</screen>
<screen>/dev/nvme1n1p1 on /mnt type ext4 (rw,relatime)</screen>
<screen>sudo umount /mnt</screen>
	</listitem>
	<listitem>
	<para>Utiliser le nom défini par <application>udev</application> dans le
	système de fichiers.</para>

<screen>sudo mount /dev/nvme1n1p1 /mnt</screen>
<screen>mount | grep mnt</screen>
<screen>/dev/nvme1n1p1 on /mnt type ext4 (rw,relatime)</screen>
<screen>sudo umount /mnt</screen>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment démonter manuellement le système de fichiers de la
	partition <systemitem>/dev/nvmen1p1</systemitem>&nbsp;?</phrase></para>

	<para>Consulter les pages de manuels de la commande
	<command>mount</command>.</para>
	</question>
	<answer>
	<para>L'opération de démontage utilise l'arborescence du système de
	fichiers pour désigner le volume de stockage.</para>

<screen>sudo umount /mnt</screen>

    <para>Cette commande a déjà été appelée dans la question précédente pour
    éviter les conflits entre les deux syntaxes de montage différentes.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.iscsi.storage.blank'>
	<title>Détruire la table des partitions</title>

    <para>Dans cette section, on veut effacer toutes les traces des
    manipulations précédentes pour traiter les questions des autres parties du
    support de travaux pratiques.</para>

<warning>
    <para>Attention au nom d'unité de disque utilisé pour les manipulations qui
    suivent. La suppression de la table de patition de l'unité de disque
    système est fatale&nbsp;!</para>
</warning>

<qandaset defaultlabel='number'>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe d'appel de l'outil
	<application>parted</application> qui permet de visualiser la table de
	partition d'une unité de disque&nbsp;?</phrase></para>

	<para>Consultez la documentation de <application>parted</application> à
	l'adresse &url.usingparted;.</para>
	</question>
	<answer>
<screen>sudo parted /dev/nvme1n1 print</screen>

<screen>sudo parted /dev/nvme1n1 print</screen>
<screen>Model: QEMU NVMe Ctrl (nvme)
Disk /dev/nvme1n1: 34,4GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags:

Number  Start   End     Size    File system  Name            Flags
 1      1049kB  34,4GB  34,4GB  ext4         myOwnPartition</screen>

    <para>Le résultat montre que l'unité de disque a été partitionnée dans une
    section précédente. Vous devez donc effacer les traces de ces
    opérations.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelle est la syntaxe de la commande <command>dd</command>
	qui permet d'effacer complètement la table des partitions d'une unité de
	disque&nbsp;?</phrase></para>

	<para>Utiliser l'aide en ligne de la commande&nbsp;: <userinput>dd
	--help</userinput>.</para>
	</question>
	<answer>
	<para>La commande suivante écrit des 0 dans les 4 premiers blocs de 512
	octets de l'unité de disque.</para>

<screen>sudo dd if=/dev/zero of=/dev/nvme1n1 bs=4k count=64</screen>
<screen>64+0 enregistrements lus
64+0 enregistrements écrits
262144 octets (262 kB, 256 KiB) copiés, 0,00376759 s, 69,6 MB/s</screen>

<screen>sudo parted /dev/nvme1n1 print</screen>
<screen><emphasis>Error: /dev/nvme1n1: unrecognised disk label</emphasis>
Model: QEMU NVMe Ctrl (nvme)
Disk /dev/nvme1n1: 34,4GB
Sector size (logical/physical): 512B/512B
Partition Table: unknown
Disk Flags:</screen>

    <para>Le résultat de la dernière commande d'affichage de la table de
    partition montre que toute trace de table de partition
    <acronym>GPT</acronym> a disparu.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.target'>
	<title>Configuration du rôle Target</title>

    <para>Dans cette partie, les manipulations préparent le système auquel on a
    attribué le rôle <wordasword>Target</wordasword> à l'aide de l'outil
    <application>targetcli-fb</application>.</para>

<sect2 xml:id='sysadm-net.iscsi.target.install'>
	<title>Installation de l'outil de paramétrage du rôle target</title>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
	<para><phrase>Quel est le paquet qui contient l'outil de configuration du
	service dans l'espace utilisateur&nbsp;?</phrase></para>

    <para>Recherchez le mot clé <application>targetcli</application> dans
    la liste des paquets.</para>

    <para>Installez le paquet après avoir identifié son nom exact.</para>
	</question>
	<answer>
<screen>sudo apt search --names-only ^target
targetcli-fb/testing,now 1:2.1.53-1.3 all [installé]
  Command shell for managing the Linux LIO kernel target</screen>

<screen>sudo apt install targetcli-fb</screen>
	</answer>
	</qandaentry>
    </qandaset>
</sect2>

<sect2 xml:id='sysadm-net.iscsi.target.config'>
	<title>Configuration du rôle target</title>

	<para>La technologie <acronym>iSCSI</acronym> dispose d'un schéma de
	nommage propre défini dans le document standard &url.rfc3721;. Le format
	retenu ici est baptisé <acronym>iqn</acronym> (<wordasword>iSCSI Qualified
	Name</wordasword>). Il s'agit d’une chaîne qui débute par
	<literal>iqn.</literal> suivie d'une date au format
	<literal>AAAA-MM</literal>, du nom de l'autorité qui a attribué le nom (le
	nom de domaine à l'envers), puis une autre chaîne unique qui identifie le
	nœud de stockage.</para>

	<para>Dans un premier temps, on n'utilise aucun mécanisme
	d'authentification sachant que la configuration initiale se fait dans un
	contexte de travaux pratiques sur un réseau isolé.</para>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
	<para><phrase>Quelles sont les étapes à suivre pour publier un volume de
	stockage sur le réseau à partir de l'interface de l'outil
	<application>targetcli</application>&nbsp;?</phrase></para>
	</question>
	<answer>
    <para>Identifiez les deux entrées intéressantes à partir du menu principal
    de l'outil de configuration <command>targetcli</command> à l'aide de la
    commande <command>ls</command>.</para>

<screen>sudo targetcli</screen>
<screen>targetcli shell version 2.1.53
Copyright 2011-2013 by Datera, Inc and others.
For help on commands, type 'help'.

/> ls
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 0]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 0]
  o- loopback ......................................................................................................... [Targets: 0]
  o- vhost ............................................................................................................ [Targets: 0]
  o- xen-pvscsi ....................................................................................................... [Targets: 0]
/></screen>

    <para>Les deux entrées du menu principal de l'outil qui nous intéressent
    sont&nbsp;:</para>
	<itemizedlist>
	<listitem>
    <para>La section <emphasis>backstores</emphasis> désigne les volumes de
    stockage à publier sur le réseau. Ici, les deux items intéressants sont
    <emphasis>fileio</emphasis> et <emphasis>block</emphasis>. Le premier
    permet de faire correspondre un fichier du système local au volume à
    publier. Le second fait correspondre une unité de disque physique au volume
    à publier.</para>
	</listitem>
	<listitem>
    <para>La section <emphasis>iscsi</emphasis> sert à définir une «cible»
    (<wordasword>Target</wordasword>) comprenant au moins une unité logique
    (<acronym>LUN</acronym> en vocabulaire <acronym>SCSI</acronym>). C'est ici
    que l'on configure le point de contact réseau pour le système
    <wordasword>Initiator</wordasword>.</para>
	</listitem>
	</itemizedlist>
	</answer>
	</qandaentry>
	</qandaset>

<bridgehead xml:id='sysadm-net.iscsi.target.config.backstores'
	renderas='sect3'>Partie stockage local&nbsp;:
	<wordasword>backstores</wordasword></bridgehead>

	<qandaset defaultlabel='number'>
	<qandaentry>
	<question>
    <para><phrase>Quelles sont les opérations à effectuer pour définir un
    disque physique comme volume de stockage&nbsp;?</phrase></para>

	<para>Consultez le site de référence et repérez les options du menu
	<option>block</option>.</para>
	</question>
	<answer>
	<para>Créez un volume appelé <emphasis>blockvol0</emphasis> associé à
	l'unité de stockage locale au système
	<systemitem>/dev/nvme1n1</systemitem>.</para>

<screen>/> cd /backstores/block
/backstores/block> create blockvol0 /dev/nvme1n1
<emphasis>Created block storage object blockvol0 using /dev/nvme1n1.</emphasis></screen>
<screen>/backstores/block> ls
o- block ........................................... [Storage Objects: 1]
  o- blockvol0 .......... [/dev/nvme1n1 (32.0GiB) write-thru deactivated]
    o- alua ............................................ [ALUA Groups: 1]
      o- default_tg_pt_gp ................ [ALUA state: Active/optimized]</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les opérations à effectuer pour définir un
	fichier comme volume de stockage&nbsp;?</phrase></para>

	<para>Consultez le site de référence et repérez les options du menu
	<option>fileio</option>.</para>
	</question>
	<answer>
	<para>Créez un volume appelé <emphasis>filevol0</emphasis> associé au
	fichier <filename>/var/cache/filevol0</filename>.</para>

<screen>/> cd /backstores/fileio
/backstores/fileio> create filevol0 /var/cache/filevol0 32G
<emphasis>Created fileio filevol0 with size 34359738368</emphasis></screen>
<screen>/backstores/fileio> ls</screen>
<screen>o- fileio ......................................... [Storage Objects: 1]
  o- filevol0 ... [/var/cache/filevol0 (32.0GiB) write-back deactivated]
    o- alua ........................................... [ALUA Groups: 1]
      o- default_tg_pt_gp ............... [ALUA state: Active/optimized]</screen>
	</answer>
	</qandaentry>
	</qandaset>

<bridgehead xml:id='sysadm-net.iscsi.target.config.iscsi'
	renderas='sect3'>Partie portail iSCSI</bridgehead>

	<qandaset>
	<qandaentry>
	<question>
	<para><phrase>Quelles sont les opérations à effectuer pour définir un
	nouveau portail réseau <acronym>iSCSI</acronym>&nbsp;?</phrase></para>

	<para>Consultez le site de référence et repérez les options du menu
	<option>iscsi</option>. Attention&nbsp;! Une cible <acronym>iSCSI</acronym>
	comprend plusieurs attributs.</para>
	</question>
	<answer>
	<orderedlist>
	<listitem>
	<formalpara>
	<title>Nommage du portal au format <acronym>iqn</acronym></title>

	<para>Si le nom du portail n'est pas fourni avec la commande
	<command>create</command>, il est généré automatiquement.</para>
	</formalpara>

<screen>cd /iscsi</screen>
<screen>create</screen>
<screen>Created target <emphasis>iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8.</emphasis>
Created TPG 1.
Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.</screen>
<screen>/iscsi> ls</screen>
<screen>o- iscsi ....................................................... [Targets: 1]
  o- iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8 ..... [TPGs: 1]
    o- tpg1 .......................................... [no-gen-acls, no-auth]
      o- acls ..................................................... [ACLs: 0]
      o- luns ..................................................... [LUNs: 0]
      o- portals ............................................... [Portals: 1]
        o- 0.0.0.0:3260 ................................................ [OK]</screen>
	</listitem>
	<listitem>
	<formalpara>
	<title>Association entre unité logique et portail
	<acronym>iSCSI</acronym></title>

	<para>Les numéros d'unités logiques <acronym>SCSI</acronym> ou
	<acronym>LUNs</acronym> sont affectés automatiquement. Ici, l'unité
	<option>lun0</option> correspond à la première association faite depuis le
	dépôt des volumes de stockage.</para> </formalpara>

<screen>cd /iscsi/iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8/tpg1/luns</screen>
<screen>>create /backstores/block/blockvol0
<emphasis>Created LUN 0.</emphasis></screen>
<screen>ls /iscsi/</screen>
<screen>o- iscsi ........................................................ [Targets: 1]
  o- iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8 ...... [TPGs: 1]
    o- tpg1 ........................................... [no-gen-acls, no-auth]
      o- acls ...................................................... [ACLs: 0]
      o- luns ...................................................... [LUNs: 1]
      | o- lun0 .......... [block/blockvol0 (/dev/nvme1n1) (default_tg_pt_gp)]
      o- portals ................................................ [Portals: 1]
        o- 0.0.0.0:3260 ................................................. [OK]</screen>
	</listitem>
	<listitem>
	<formalpara>
	<title>Configuration réseau du portail <acronym>iSCSI</acronym></title>

	<para>Un même portail peut être en écoute sur <acronym>IPv4</acronym> et
	<acronym>IPv6</acronym>. Dans l'exemple ci-dessous on ouvre une
	configuration double pile en désignant la totalité des réseaux
	<acronym>IPv6</acronym> après voir effacé l'entrée créée automatiquement
	lors de la création du portail.</para>
	</formalpara>

<screen>cd /iscsi/iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8/tpg1/portals/</screen>
<screen>delete 0.0.0.0 3260
<emphasis>Deleted network portal 0.0.0.0:3260</emphasis></screen>
<screen>create ::0</screen>
<screen><emphasis>Using default IP port 3260</emphasis>
<emphasis>Created network portal ::0:3260</emphasis></screen>
<screen>ls
o- portals ..................................................... [Portals: 1]
  o- [::0]:3260 ........................................................ [OK]</screen>

	<para>On peut sortir de l'outil <application>targetcli</application> pour
	vérifier que le service réseau est bien accessible. La configuration est
	sauvegardée automatiquement.</para>

<screen>exit</screen>
<screen>Global pref auto_save_on_exit=true
Last 10 configs saved in /etc/rtslib-fb-target/backup/.
<emphasis>Configuration saved to /etc/rtslib-fb-target/saveconfig.json</emphasis></screen>
	</listitem>
	</orderedlist>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment vérifier la disponibilité du portail réseau
	<acronym>iSCSI</acronym>&nbsp;?</phrase></para>

	<para>À l'aide des commandes <command>ss</command> ou
	<command>lsof</command>, relever le numéro de port de la couche transport
	relatif au protocole <acronym>iSCSI</acronym>.</para>

	<para>Sur le système <wordasword>Initiator</wordasword>, lancer l'opération
	de découverte des volumes du portail <acronym>iSCSI</acronym>.</para>
	</question>
	<answer>
	<para>Voici un exemple d'exécution de la commande <command>ss</command>
	depuis le système <wordasword>Target</wordasword>.</para>

<screen>ss -tan '( sport = :3260 )'</screen>
<screen>State       Recv-Q  Send-Q            Local Address:Port        Peer Address:Port         Process
LISTEN      0       256                           *:3260                   *:*</screen>

    <para>Maintenant que le service est disponible, utilisez la fonction de
    découverte <emphasis>depuis le système
    <wordasword>Initiator</wordasword></emphasis>.</para>

    <para>Vous devez utiliser l'adresse <acronym>IP</acronym> de votre système
    <wordasword>Target</wordasword>.</para>

<screen>sudo iscsiadm -m discovery \
  --type sendtargets \
  --portal=[2001:678:3fc:171:baad:caff:fefe:5]
<emphasis>[2001:678:3fc:171:baad:caff:fefe:5]:3260,1 iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8</emphasis></screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Est-il possible d'ouvrir une session <acronym>iSCSI</acronym>
	à ce stade de la configuration&nbsp;?</phrase></para>

	<para>Depuis votre système <wordasword>Initiator</wordasword>, lancez l'opération
	d'ouverture de session.</para>
	</question>
	<answer>
	<para>Même si le service réseau et la fonction découverte sont ouverts, le
	volume de stockage réseau n'est pas encore accessible. L'ouverture de
	session depuis l'hôte <wordasword>Initiator</wordasword> échoue et on
	obtient le message suivant.</para>

	<para>La réponse à la question est donc <emphasis>non</emphasis>.</para>

    <para>Vous devez utiliser l'identifiant <acronym>IQN</acronym> de votre
    système <wordasword>Target</wordasword>. Il est affiché dans les résultats
    de la commande découverte à la question précédente.</para>

<screen>sudo iscsiadm -m node \
	-T iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8 \
	-p [2001:678:3fc:171:baad:caff:fefe:5] \
	-l</screen>
<screen>iscsiadm: Could not login to
  [iface: default, target: iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8, portal: 2001:678:3fc:171:baad:caff:fefe:5,3260].
iscsiadm: <emphasis>initiator reported error (24 - iSCSI login failed due to authorization failure)</emphasis>
iscsiadm: Could not log into all portals</screen>

	<para>Côté hôte <wordasword>Target</wordasword>, les journaux système font
	apparaître un message du type suivant.</para>

<screen>journalctl -n 100 --grep scsi</screen>
<screen>target kernel: <emphasis>iSCSI Login negotiation failed.</emphasis>
target kernel: iSCSI Initiator Node: <emphasis>iqn.1993-08.org.debian:01:733ea42cb56</emphasis> is not authorized to access iSCSI target portal group: 1.</screen>

    <para>Profitez de ces messages pour relever l'identifiant
    <acronym>IQN</acronym> de votre système <wordasword>Initiator</wordasword>.
    Dans l'exemple ci-dessus, on relève la valeur
    <literal>iqn.1993-08.org.debian:01:733ea42cb56</literal>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment autoriser l'accès au volume de stockage depuis
	l'hôte <wordasword>Initiator</wordasword> sans
	authentication&nbsp;?</phrase></para>

	<para>Recherchez les paramètres relatifs à la rubrique
	<option>acls</option> de l'outil <command>targetcli</command>.</para>
	</question>
	<answer>

    <para>Pour autoriser l'ouverture d'une session <acronym>iSCSI</acronym>,
    créez une liste de contrôle d'accès (<acronym>ACL</acronym>) avec
    l'identité du système <wordasword>Initiator</wordasword>.</para>

    <para>Depuis le système <wordasword>Initiator</wordasword>, affichez
    l'identité <acronym>iSCSI</acronym> définie lors de l'installation du
    paquet <application>open-iscsi</application>.</para>

<screen>sudo grep -v ^# /etc/iscsi/initiatorname.iscsi
InitiatorName=<emphasis>iqn.1993-08.org.debian:01:733ea42cb56</emphasis></screen>

    <para>Vérifiez que l'identifiant <acronym>IQN</acronym> du rôle
    <wordasword>Initiator</wordasword> correspond bien à la valeur relevée dans
    la question précédente.</para>

    <para>Depuis le système <wordasword>Target</wordasword>, créez une nouvelle
    entrée dans la rubrique <option>acls</option> du portail
    <acronym>iSCSI</acronym> via l'outil <command>targetcli</command>.</para>

<screen>sudo targetcli</screen>
<screen>cd /iscsi/iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8/tpg1/acls</screen>
<screen>create iqn.1993-08.org.debian:01:733ea42cb56
Created Node <emphasis>ACL for iqn.1993-08.org.debian:01:733ea42cb56</emphasis>
Created mapped LUN 0.</screen>
<screen>exit</screen>

    <para>Enfin, reprenez la commande d'ouverture de session sur le système
    <wordasword>Initiator</wordasword>. Cette nouvelle tentative d'ouverture de
    session doit être un succès.</para>

<screen>sudo iscsiadm -m node
    -T iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8 \
    -p [2001:678:3fc:171:baad:caff:fefe:5] \
    -l</screen>
<screen>Login to
  [iface: default, target: iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8,
  portal: 2001:678:3fc:171:baad:caff:fefe:5,3260] <emphasis>successful</emphasis>.</screen>
	</answer>
	</qandaentry>
</qandaset>

	<para>À partir de cette étape, le système
	<wordasword>Initiator</wordasword> dispose d'une nouvelle unité de
	stockage mode bloc.</para>
</sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.initiator'>
	<title>Configurer le système Initiator</title>

    <para>Les manipulations de cette partie préparent le système auquel on a
    attribué le rôle <wordasword>Initiator</wordasword>. Ce système est celui
    qui utilise le volume de stockage mis à disposition sur le réseau par le
    rôle <wordasword>Target</wordasword>.</para>

<sect2 xml:id='sysadm-net.iscsi.package'>
	<title>Sélectionner le paquet et lancer le service</title>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Comment identifier et installer le paquet correspondant au
	rôle <wordasword>Initiator</wordasword>&nbsp;?</phrase></para>

	<para>En effectuant une recherche simple dans le catalogue des paquets
	disponibles, on obtient la liste des paquets dont le nom contient la chaîne
	de caractères <option>iscsi</option>.</para>
    </question>
    <answer>
    <para>La syntaxe la plus simple consiste à lancer une recherche sur les
    noms de paquets.</para>

<screen>apt search --names-only iscsi</screen>

    <para>Pour optimiser l'affichage du résultat de recherche, on utilise une
    syntaxe plus complète.</para>

<screen>apt -o "Apt::Cmd::Disable-Script-Warning=1" \
  search --names-only iscsi | grep -B2 -i initiator</screen>

<screen><emphasis>open-iscsi</emphasis>/testing,now 2.1.11-2 amd64 [installé]
  iSCSI initiator tools</screen>

	<para>On relève que le paquet <systemitem>open-iscsi</systemitem> est le
	seul associé au rôle <wordasword>Initiator</wordasword>. Installez le.</para>

<screen>sudo apt install open-iscsi</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment connaître l'état du service
	<wordasword>Initiator</wordasword> et valider son
	fonctionnement&nbsp;?</phrase></para>

	<para>À partir de la liste des services actifs, repérez les messages
	relatifs au rôle <wordasword>Initiator</wordasword>.</para>
	</question>
	<answer>
<screen>systemctl status open-iscsi.service</screen>
<screen>systemctl status open-iscsi.service
○ open-iscsi.service - Login to default iSCSI targets
     Loaded: loaded (/usr/lib/systemd/system/open-iscsi.service; enabled; preset: enabled)
     Active: inactive (dead)
  Condition: start condition unmet at Fri 2025-08-22 19:14:58 CEST; 22h ago
       Docs: man:iscsiadm(8)
             man:iscsid(8)

août 22 19:14:58 initiator systemd[1]: open-iscsi.service - Login to default iSCSI targets was skipped
  because no trigger condition checks were met.</screen>

<warning>
	<para>L'état actuel de la configuration montre que le service est lancé
	sans aucune session <acronym>iSCSI</acronym> active. Pour l'instant aucun
	système avec le rôle <wordasword>Target</wordasword> n'a été
	contacté.</para>
</warning>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.iscsi.tests'>
	<title>Accéder aux volumes de stockage réseau iSCSI</title>

<qandaset>
	<qandadiv>
	<qandaentry>
	<question>
	<para><phrase>Quelle est la commande principale du rôle
	<wordasword>Initiator</wordasword> qui permet de tester la connectivité
	<acronym>iSCSI</acronym>&nbsp;?</phrase></para>

	<para>Consultez la liste des fichiers du paquet
	<systemitem>open-iscsi</systemitem>.</para>
	</question>
	<answer>
	<para>En consultant la liste donnée ci-dessus, relevez qu'un seul
	outil est exécutable&nbsp;: la commande <command>iscsiadm</command>.</para>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.iscsi.tests.discovery'>
	<question>
	<para><phrase>Quelles sont les options de découverte proposées avec cette
	commande&nbsp;? Donnez un exemple fournissant l'identifiant de l'unité de
	stockage réseau visible.</phrase></para>

	<para>Consultez les pages de manuels de la commande identifiée dans la
	question précédente.</para>
	</question>
	<answer>
    <para>À partir du système <wordasword>Initiator</wordasword>, listez le ou
    les volume(s) de stockage visible(s) sur le réseau local&nbsp;:</para>

    <para>Si le portail du système avec le rôle <wordasword>Target</wordasword>
    est configuré pour être accessible via <acronym>IPv6</acronym>, vous devez
    utiliser la commande suivante en adaptant l'adresse au
    contexte&nbsp;:</para>

<screen>sudo iscsiadm -m discovery \
  --type sendtargets \
  --portal=[2001:678:3fc:171:baad:caff:fefe:5]
<emphasis>[2001:678:3fc:171:baad:caff:fefe:5]:3260,1 iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8</emphasis></screen>

<screen>sudo iscsiadm -m discovery \
    --type sendtargets \
    --portal=10.0.113.5
<emphasis>10.0.113.5:3260,1 iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8</emphasis></screen>

    <para>Dans les deux copies d'écran ci-dessus, l'identifiant
    <acronym>IQN</acronym> du volume de stockage réseau visible est
    <literal>iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8</literal>.</para>

	<para>Malheureusement, les adresses de lien local <acronym>IPv6</acronym>
	ne sont pas utilisables au moment de la rédaction de ces lignes.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment obtenir la liste des portails
	<acronym>iSCSI</acronym> déjà connus du système
	<wordasword>Initiator</wordasword>&nbsp;?</phrase></para>

	<para>Recherchez dans les pages de manuels de la commande
	<command>iscsiadm</command>.</para>
	</question>
	<answer>
	<para>C'est le mode <option>node</option> qui permet d'obtenir
	l'information demandée.</para>

<screen>sudo iscsiadm -m node</screen>
<screen>10.0.113.5:3260,1 iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8
[2001:678:3fc:171:baad:caff:fefe:5]:3260,1 iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment effacer la liste des portails
	<acronym>iSCSI</acronym> déjà connus du système
	<wordasword>Initiator</wordasword>&nbsp;?</phrase></para>

	<para>Recherchez dans les pages de manuels de la commande
	<command>iscsiadm</command>.</para>
	</question>
	<answer>
    <para>C'est à nouveau le mode <option>node</option> qui permet d'obtenir
    l'information demandée.</para>

<screen>sudo iscsiadm -m node --op=delete</screen>

<warning>
	<para>Attention ! Si la commande ci-dessus est exécutée, il faut
	reprendre les opérations de découverte décrites à la question <xref
	linkend='sysadm-net.iscsi.tests.discovery' /> pour compléter la liste
	des portails <acronym>iSCSI</acronym> connus.</para>
</warning>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quel est l'identifiant à communiquer ou à paramétrer pour que
	le système <wordasword>Initiator</wordasword> soit reconnu côté système
	<wordasword>Target</wordasword>&nbsp;?</phrase></para>

	<para>Recherchez les informations relatives au nommage
	<acronym>iSCSI</acronym> dans les outils et les fichiers fournis avec le
	paquet de gestion du rôle <wordasword>Initiator</wordasword>.</para>
	</question>
	<answer>
	<para>Le répertoire <systemitem>/etc/iscsi/</systemitem> contient les
	paramètres de configuration du service.</para>

<screen>ls -p /etc/iscsi/
initiatorname.iscsi  iscsid.conf</screen>

	<para>Consultez ou éditez ce fichier pour communiquer l'identité
	du système <wordasword>Initiator</wordasword> au système
	<wordasword>Target</wordasword> pour configurer le contrôle d'accès.</para>

	<para>Par exemple, l'identifiant unique donnée dans la copie d'écran
	ci-dessous est à transmettre au système
	<wordasword>Target</wordasword>.</para>

<screen>sudo grep -v ^# /etc/iscsi/initiatorname.iscsi
InitiatorName=<emphasis>iqn.1993-08.org.debian:01:733ea42cb5</emphasis></screen>

    <para>Depuis le système  <wordasword>Target</wordasword>, vous obtenez le
    résultat suivant après avoir créé la liste de contrôle d'accès au volume
    réseau via l'interface <command>targetcli</command>.</para>

<screen>sudo targetcli</screen>
<screen>cd /
ls</screen>
<screen>o- / ....................................................................... [...]
  o- backstores ............................................................ [...]
  | o- block ................................................ [Storage Objects: 1]
  | | o- blockvol0 ................. [/dev/nvme1n1 (32.0GiB) write-thru activated]
  | |   o- alua ................................................. [ALUA Groups: 1]
  | |     o- default_tg_pt_gp ..................... [ALUA state: Active/optimized]
  | o- fileio ............................................... [Storage Objects: 1]
  | | o- filevol0 ......... [/var/cache/filevol0 (32.0GiB) write-back deactivated]
  | |   o- alua ................................................. [ALUA Groups: 1]
  | |     o- default_tg_pt_gp ..................... [ALUA state: Active/optimized]
  | o- pscsi ................................................ [Storage Objects: 0]
  | o- ramdisk .............................................. [Storage Objects: 0]
  o- iscsi .......................................................... [Targets: 1]
  | o- <emphasis>iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8</emphasis> ........ [TPGs: 1]
  |   o- tpg1 ............................................. [no-gen-acls, no-auth]
  |     o- acls ........................................................ [ACLs: 1]
  |     | o- <emphasis>iqn.1993-08.org.debian:01:733ea42cb56</emphasis> .............. [Mapped LUNs: 1]
  |     |   o- mapped_lun0 ........................... [lun0 block/blockvol0 (rw)]
  |     o- luns ........................................................ [LUNs: 1]
  |     | o- lun0 ............ [block/blockvol0 (/dev/nvme1n1) (default_tg_pt_gp)]
  |     o- portals .................................................. [Portals: 1]
  |       o- [::0]:3260 ..................................................... [OK]
  o- loopback ....................................................... [Targets: 0]
  o- vhost .......................................................... [Targets: 0]
  o- xen-pvscsi ..................................................... [Targets: 0]</screen>

	<para>La copie d'écran ci-dessus montre l'association des identités
	<acronym>iSCSI</acronym> des systèmes <wordasword>Initiator</wordasword>
	et <wordasword>Target</wordasword>.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Quelles sont les options de connexion proposées avec la
	commande <command>iscsiadm</command>&nbsp;?</phrase></para>

	<para>Donnez un exemple illustrant l'établissement d'une connexion.</para>

	<para>Consultez les pages de manuels de la commande identifiée
	précédemment.</para>
	</question>
	<answer>

<screen>sudo iscsiadm -m node
    -T iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8 \
    -p [2001:678:3fc:171:baad:caff:fefe:5] \
    -l</screen>
<screen>Login to
  [iface: default, target: iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8,
  portal: 2001:678:3fc:171:baad:caff:fefe:5,3260] <emphasis>successful</emphasis>.</screen>

	<para>Dans l'exemple ci-dessus, la connexion sans authentification est un
	succès dans la mesure où les paramètres d'authentification et de protection
	en écriture ont été forcés à zéro sur la configuration du système
	<wordasword>Target</wordasword>. Voir <xref
	linkend='sysadm-net.iscsi.target.config.iscsi'/></para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment obtenir les caractéristiques de l'unité de stockage
	<acronym>iSCSI</acronym> associée&nbsp;?</phrase></para>

	<para>Revoir la question <xref linkend='sysadm-net.iscsi.storage.lsblk'
	endterm='lsblkshort'/> et/ou consulter les journaux système.</para>
	</question>
	<answer>
	<para>Le résultat de la commande <command>lsblk</command> montre l'arrivée
	d'un nouveau volume de stockage.</para>

<screen>lsblk</screen>
<screen>NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
<emphasis>sda           8:0    0    32G  0 disk</emphasis>
sr0          11:0    1  1024M  0 rom
vda         254:0    0   366K  0 disk
nvme1n1     259:1    0    32G  0 disk
nvme0n1     259:3    0   120G  0 disk
├─nvme0n1p1 259:4    0     3M  0 part
├─nvme0n1p2 259:5    0   124M  0 part /boot/efi
└─nvme0n1p3 259:6    0 119,9G  0 part /</screen>

	<para>Voici un extrait des messages de journalisation du système.</para>

<screen>journalctl -n 200 --grep '(sda|iscsi)'</screen>
<screen>initiator iscsid[6922]: Connection2:0 to [target:
  iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8, 
  portal:2001:678:3fc:171:baad:caff:fefe:5,3260] through [iface: default]
  is operational now
initiator kernel: sd 6:0:0:0: [sda] Attached SCSI disk
initiator kernel: sd 6:0:0:0: [sda] Optimal transfer size 131072 bytes
initiator kernel: sd 6:0:0:0: [sda] Preferred minimum I/O size 512 bytes
initiator kernel: sd 6:0:0:0: [sda] Write cache: enabled, read cache: enabled, supports DPO and FUA
initiator kernel: sd 6:0:0:0: [sda] Mode Sense: 43 00 10 08
initiator kernel: sd 6:0:0:0: [sda] Write Protect is off
initiator kernel: sd 6:0:0:0: [sda] 67108864 512-byte logical blocks: (34.4 GB/32.0 GiB)
initiator kernel: scsi host6: iSCSI Initiator over TCP/IP</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Donnez la liste des entrées de périphériques de stockage
	créées par le démon <systemitem>udev</systemitem>&nbsp;?</phrase></para>

	<para>Listez les entrées de périphériques mode bloc de l'arborescence
	système.</para>
	</question>
	<answer>
	<para>Les fichiers de description des périphériques mode bloc sont tous
	situés dans le répertoire <filename class='directory'>/dev/</filename>. En
	reprenant l'exemple ci-dessus, on obtient&nbsp;:</para>

<screen>ls -lA /dev/[v,s]d*</screen>
<screen>brw-rw---- 1 root disk   8, 0 24 août  11:27 /dev/sda
brw-rw---- 1 root disk 254, 0 22 août  19:14 /dev/vda</screen>

	<para>L'entrée <filename>/dev/sda</filename> correspond à l'unité de disque
	<acronym>iSCSI</acronym>. L'unité de disque est donc bien vue de façon
	transparente comme un périphérique local du système accessible en mode
	bloc. Il entre bien dans la catégorie <acronym>SAN</acronym> ou
	<wordasword>Storage Area Network</wordasword>.</para>
	</answer>
	</qandaentry>
	</qandadiv>
</qandaset>
</sect2>

<sect2 xml:id='sysadm-net.iscsi.reset'>
	<title>Réinitialiser la session <acronym>iSCSI</acronym></title>

    <para>Dans le cas d'une nouvelle configuration avec un autre hôte
    <wordasword>Target</wordasword> ou dans le cas d'un dépannage, il est utile
    de pouvoir reprendre les paramètres du rôle
    <wordasword>Initiator</wordasword>.</para>

<qandaset>
	<qandaentry>
	<question>
	<para><phrase>Comment obtenir la liste des sessions actives avec le
	système <wordasword>Target</wordasword>&nbsp;?</phrase></para>

	<para>Consultez les pages de manuels de la commande de configuration du
	rôle <wordasword>Initiator</wordasword>&nbsp;:
	<command>iscsiadm</command>.</para>
	</question>
	<answer>
	<para>C'est le mode <option>session</option>, documenté dans les pages
	de manuels de la commande <command>iscsiadm</command>, qui permet de
	répondre à la question.</para>

<screen>sudo iscsiadm -m session</screen>
<screen>tcp: [2] [2001:678:3fc:171:baad:caff:fefe:5]:3260,1
    iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8 (non-flash)</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment libérer toutes les sessions actives depuis le
	système <wordasword>Initiator</wordasword>&nbsp;?</phrase></para>

	<para>Consultez les pages de manuels de la commande de configuration du
	rôle <wordasword>Initiator</wordasword>&nbsp;:
	<command>iscsiadm</command>.</para>
	</question>
	<answer>
	<para>Pour cette question, c'est le mode <option>node</option> qui nous
	intéresse.</para>

<screen>sudo iscsiadm -m node -U all</screen>
<screen>Logging out of session [sid: 2,
    target: iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8, portal: 2001:678:3fc:171:baad:caff:fefe:5,3260]
Logout of [sid: 2,
    target: iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8, portal: 2001:678:3fc:171:baad:caff:fefe:5,3260]
    <emphasis>successful</emphasis>.</screen>
	</answer>
	</qandaentry>
</qandaset>

	<para>Il faut relancer une nouvelle session
	<acronym>iSCSI</acronym> pour traiter les manipulations
	suivantes.</para>
</sect2>

<sect2 xml:id='sysadm-net.iscsi.automatic'>
	<title>Rendre la session iSCSI permanente</title>

    <para>Une fois la connexion à la ressource <acronym>iSCSI</acronym> testée,
    passez à la configuration système pour retrouver le volume de stockage
    après un redémarrage du système <wordasword>Initiator</wordasword>.</para>

<qandaset>
	<qandaentry>
	<question>
    <para><phrase>Comment rendre l'ouverture session <acronym>iSCSI</acronym>
    automatique lors de l'initialisation du système
    <wordasword>Initiator</wordasword>&nbsp;?</phrase></para>

	<para>Recherchez dans la liste des fichiers du paquet
	<application>open-iscsi</application> les éléments relatifs à la
	configuration système. Éditez le fichier de configuration principal de
	façon à rendre automatique le lancement du service.</para>
	</question>
	<answer>
	<para>Au niveau système, les fichiers de configuration sont
	nécessairement dans le répertoire <filename
	class='directory'>/etc/</filename>.</para>

<screen>dpkg -L open-iscsi | grep '/etc/iscsi'</screen>
<screen>/etc/iscsi
<emphasis>/etc/iscsi/iscsid.conf</emphasis></screen>

	<para>Le fichier <filename>/etc/iscsi/iscsid.conf</filename> contient
	une directive dans la section <wordasword>Startup settings</wordasword>
	qui rend automatique l'accès à une ressource déjà enregistrée. Voici le
	contenu de cette section extraite du fichier de configuration.</para>

<screen>#*****************
# Startup settings
#*****************

# To request that the iscsi initd scripts startup a session set to "automatic".
<emphasis>node.startup = automatic</emphasis></screen>

<warning>
	<para>Attention ! Après édition du fichier
	<filename>/etc/iscsi/iscsid.conf</filename>, la valeur
	<option>automatic</option> n'est appliquée que pour les nouvelles
	opérations de découverte et d'ouverture de session.</para>
</warning>

<screen>sudo sed -i 's/^node.startup = manual/node.startup = automatic/' /etc/iscsi/iscsid.conf</screen>
<screen>sudo systemctl restart open-iscsi.service
systemctl status open-iscsi.service</screen>

<screen>● open-iscsi.service - Login to default iSCSI targets
     Loaded: loaded (/usr/lib/systemd/system/open-iscsi.service; enabled; preset: enabled)
     Active: active (exited) since Sun 2025-08-24 14:31:42 CEST; 7s ago
 Invocation: cc7d753b5ecc4235990e6fb658c2ef07
       Docs: man:iscsiadm(8)
             man:iscsid(8)
    Process: 7471 ExecStart=/usr/sbin/iscsiadm -m node <emphasis>--loginall=automatic</emphasis> (code=exited, status=21)
    Process: 7472 ExecStart=/usr/lib/open-iscsi/activate-storage.sh (code=exited, status=0/SUCCESS)
   Main PID: 7472 (code=exited, status=0/SUCCESS)
   Mem peak: 2M
        CPU: 51ms

août 24 14:31:42 initiator systemd[1]: Starting open-iscsi.service - Login to default iSCSI targets...
août 24 14:31:42 initiator iscsiadm[7471]: <emphasis>iscsiadm: No records found</emphasis>
août 24 14:31:42 initiator systemd[1]: Finished open-iscsi.service - Login to default iSCSI targets.</screen>

    <para>La copie d'écran ci-dessus montre que l'ouverture de session est
    automatique au lancement du service
    <systemitem>open-iscsi.service</systemitem> et qu'en l'état actuel aucun
    enregistrement de session n'est présent dans la configuration.</para>

    <para>Voici un nouvel exemple d'instructions de découverte puis d'ouverture
    de session.</para>

<screen>sudo iscsiadm -m discovery \
    --type sendtargets \
    --portal=[2001:678:3fc:171:baad:caff:fefe:5]</screen>
<screen>[2001:678:3fc:171:baad:caff:fefe:5]:3260,1
    iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8</screen>

<screen>sudo iscsiadm -m node \
    -T iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8 \
    -p [2001:678:3fc:171:baad:caff:fefe:5] \
    -l</screen>
<screen>Login to [iface: default,
    target: iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8,
    portal: 2001:678:3fc:171:baad:caff:fefe:5,3260] <emphasis>successful</emphasis>.</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	<para><phrase>Comment connaître l'état et la liste d'une session
	<acronym>iSCSI</acronym> active&nbsp;?</phrase></para>

	<para>Consultez les pages de manuels de la commande de configuration du
	rôle <wordasword>Initiator</wordasword>&nbsp;:
	<command>iscsiadm</command>.</para>
	</question>
	<answer>
    <para>Le mode <option>session</option> est dédié aux manipulations sur les
    sessions. La commande de test la plus simple est la suivante.</para>

<screen>sudo iscsiadm -m session</screen>
<screen>tcp: [1] [2001:678:3fc:171:baad:caff:fefe:5]:3260,1
    iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8 (non-flash)</screen>

	<para>Si la liste est vide, il n'y a pas de session
	<acronym>iSCSI</acronym> active en cours.</para>

	<para>Il est possible d'obtenir davantage d'informations sur les
	paramètres de session en cours à l'aide de l'option <option>-P</option>
	suivie d'un numéro désignant le niveau de détail attendu.</para>

	<para>La commande <literal>iscsiadm -m session -P 3</literal> affiche
	les paramètres sur les interfaces réseau utilisées, etc.</para>

<screen>sudo iscsiadm -m session -P 3</screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.iscsi.uuid'>
	<question>
    <para><phrase>Comment retrouver un point de montage unique de l'unité de
    stockage <acronym>iSCSI</acronym> après réinitialisation du système
    <wordasword>Initiator</wordasword>&nbsp;?</phrase></para>

	<para>Créez un répertoire de montage et recherchez les options utiles
	dans les pages de manuels des commandes <command>mount</command>,
	<command>systemd.mount</command> et <command>blkid</command>. Éditer le
	fichier <filename>/etc/fstab</filename> en utilisant les options
	sélectionnées. Noter que le fichier <filename>fstab</filename> possède
	ses propres pages de manuels.</para>
	</question>
	<answer>
	<para>La création du répertoire destiné au montage du volume de stockage
	<acronym>iSCSI</acronym> se fait simplement.</para>

<screen>sudo mkdir /var/cache/iscsi-vol0</screen>

	<para>C'est à cette étape que les questions de la <xref
	linkend='sysadm-net.iscsi.storage' /> sont utiles.</para>

	<para>Après partitionnement de l'unité de stockage
	<acronym>iSCSI</acronym> <filename>/dev/sda</filename> et formatage de
	la partition <filename>/dev/sda1</filename>, relevez
	l'identifiant unique de ce volume avec la commande
	<command>blkid</command>. Voici un exemple.</para>

<screen>lsblk /dev/sda
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS
sda    8:0    0  32G  0 disk</screen>

<screen>sudo parted /dev/sda mklabel gpt
Information: You may need to update /etc/fstab.</screen>

<screen>sudo parted /dev/sda mkpart myOwnPartition ext4 1MiB 100%
Information: You may need to update /etc/fstab.</screen>

<screen>sudo blkid /dev/sda1
/dev/sda1: <emphasis>UUID="97049e50-931a-4741-8c87-faf2582c494f"</emphasis>
    BLOCK_SIZE="4096" TYPE="ext4" PARTLABEL="myOwnPartition"
    PARTUUID="acc9f840-4b0b-4ffe-86e3-b8c499a90021"</screen>

<screen>sudo mount -U "97049e50-931a-4741-8c87-faf2582c494f" /var/cache/iscsi-vol0/</screen>

<screen>mount mount | grep iscsi
/dev/sda1 on /var/cache/iscsi-vol0 type ext4 (rw,relatime)</screen>

<screen>sudo touch /var/cache/iscsi-vol0/empyFile.txt</screen>

<screen>sudo ls -l /var/cache/iscsi-vol0/
total 16
-rw-r--r-- 1 root root     0 24 août  17:12 <emphasis>empyFile.txt</emphasis>
drwx------ 2 root root 16384 24 août  17:10 lost+found</screen>

<screen>sudo umount /var/cache/iscsi-vol0</screen>
	</answer>
	</qandaentry>

	<qandaentry xml:id='sysadm-net.iscsi.fstab'>
	<question>
	<para><phrase>Quelles sont les informations à insérer dans le fichier
	<filename>/etc/fstab</filename> pour assurer le montage du volume de
	stockage à chaque initialisation du système&nbsp;?</phrase></para>

	<para>Consultez les pages de manuels de la commande
	<command>mount</command> ainsi que la documentation du paquet
	<application>open-iscsi</application>.</para>
	</question>
	<answer>
	<para>Le choix des options à utiliser lors de l'édition du fichier
	<filename>/etc/fstab</filename> constitue un point très délicat.</para>

<screen>echo "PARTUUID=\"acc9f840-4b0b-4ffe-86e3-b8c499a90021\"\
/var/cache/iscsi-vol0  ext4  _netdev  0   2" |\
sudo tee -a /etc/fstab</screen>
	<itemizedlist>
	<listitem>
	<para>Le choix de la valeur <option>UUID</option> se fait à partir du
	résultat de la commande <command>blkid</command> donné ci-dessus.</para>
	</listitem>
	<listitem>
	<para>Le point de montage <filename
	class='directory'>/var/cache/iscsi-vol0</filename> a lui aussi été
	défini ci-dessus.</para>
	</listitem>
	<listitem>
	<para>Le système de fichiers utilisé est, là encore, connu&nbsp;:
	<option>ext4</option>.</para>
	</listitem>
	<listitem>
	<para>L'option <option>_netdev</option> spécifie que le système de
	fichiers réside sur un périphérique nécessitant des accès réseau. Il est
	donc inutile d'y accéder tant qu'aucune interface réseau n'est
	active.</para>
	</listitem>
	</itemizedlist>

<screen>sudo mount -a
mount: (hint) your fstab has been modified, but systemd still uses
       the old version; use 'systemctl daemon-reload' to reload.</screen>

<screen>mount | grep iscsi
/dev/sda1 on /var/cache/iscsi-vol0 type ext4 (rw,relatime,stripe=32,_netdev)</screen>

<screen>sudo ls -l /var/cache/iscsi-vol0/
total 16
-rw-r--r-- 1 root root     0 24 août  17:12 <emphasis>empyFile.txt</emphasis>
drwx------ 2 root root 16384 24 août  17:10 lost+found</screen>

    <para>Une fois les tests de validation du montage effectués, on procède au
    démontage de la partition dans le but de traiter les questions des sections
    suivantes.</para>

<screen>sudo umount /var/cache/iscsi-vol0/</screen>

<screen>sudo sed -i '/^PARTUUID="acc9f840-4b0b-4ffe-86e3-b8c499a90021".*/d' /etc/fstab</screen>

<screen>cat /etc/fstab</screen>
<screen>PARTUUID=95ed2e41-f56c-4cc0-a79e-c93a07e93c79 / ext4 rw,discard,errors=remount-ro,x-systemd.growfs 0 1
PARTUUID=71f5d30c-8e21-4372-81f6-11eb66815669 /boot/efi vfat defaults,umask=077 0 2</screen>

    <para>La table des montages système est revenue à l'état initial.</para>
	</answer>
	</qandaentry>
</qandaset>
</sect2>
</sect1>


<sect1 xml:id='sysadm-net.iscsi.auth'>
  <title>Configuration de l'authentification CHAP</title>

  <para>Dans cette partie, on suppose que tous les tests précédents ont été
  effectués avec succès et que les échanges entre les systèmes
  <wordasword>Target</wordasword> et <wordasword>Initiator</wordasword> sont
  validés.</para>

  <para>On s'intéresse maintenant à l'authentification entre ces mêmes
  systèmes. Pour traiter les questions suivantes, une nouvelle entrée a été
  utilisée pour le rôle <wordasword>Target</wordasword>.</para>

  <para>Le mécanisme d'authentification le plus communément utilisé dans le
  déploiement des connexions <acronym>iSCSI</acronym> s'appuie sur
  <acronym>CHAP</acronym> (<wordasword>Challenge-Handshake Authentication
  Protocol</wordasword>). Il s'agit d'une méthode d'authentification entre deux
  hôtes pairs sans échange de mot de passe en clair sur le réseau. Cette
  méthode suppose que les deux hôtes utilisent le même mot de passe.</para>

  <qandaset>
    <qandaentry>
    <question>
    <para><phrase>Quel est l'attribut qui permet d'activer globalement
    l'authentification avec
    <application>targetcli</application>&nbsp;?</phrase></para>

    <para>Recherchez dans la liste des attributs du menu
    <literal>tpg1</literal> celui qui est relatif à l'authentification.</para>
    </question>
    <answer>
    <para>Placez-vous au niveau <literal>tpg1</literal> du menu de
    l'application <application>targetcli</application>.</para>

<screen>sudo targetcli</screen>
<screen>cd /iscsi/iqn.2003-01.org.linux-iscsi.target.x8664:sn.cd547a636fe7/tpg1/</screen>

    <para>Relevez la valeur de l'attribut <literal>authentication</literal>.</para>

<screen>get attribute authentication
<emphasis>authentication=0</emphasis></screen>

    <para>Changez la valeur de cet attribut pour activer l'authentification au
    niveau du portail <acronym>iSCSI</acronym>.</para>

<screen>set attribute authentication=1</screen>
<screen>get attribute authentication
<emphasis>authentication=1</emphasis></screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
    <para><phrase>Comment régler les paramètres d'authentification
    <acronym>CHAP</acronym> à deux voies pour le portail
    <acronym>iSCSI</acronym>&nbsp;?</phrase></para>

    <para>Recherchez les paramètres disponibles au niveau de la liste de
    contrôle d'accès dédiée au rôle <wordasword>Initiator</wordasword>.</para>
    </question>
    <answer>
    <para>Partant de la configuration mise en place dans la <xref
    linkend='sysadm-net.iscsi.target' />, on ajoute les paramètres
    d'authentification à la liste de contrôle d'accès existante.</para>

<screen>sudo targetcli</screen>

<screen>cd /iscsi/iqn.2003-01.org.linux-iscsi.target.x8664:sn.cd547a636fe7/tpg1/
cd acls/iqn.1993-08.org.debian:01:733ea42cb56</screen>

    <para>Définissez les paramètres d'authentification pour cette liste de
    contrôle d'accès. Comme la méthode <acronym>CHAP</acronym> est symétrique,
    vous devez déposer de part et d'autre le secret. On fixe ici les paramètres
    <option>userid</option> et <option>password</option>.</para>

<screen>set auth userid=SAN-lab-user
Parameter userid is now <emphasis>'SAN-lab-user'</emphasis>.</screen>

<screen>set auth password=SAN-lab-pwd
Parameter password is now <emphasis>'SAN-lab-pwd'</emphasis>.</screen>

<screen>set auth mutual_userid=target-user
Parameter mutual_userid is now <emphasis>'target-user'</emphasis>.</screen>

<screen>set auth mutual_password=target-pwd
Parameter mutual_password is now <emphasis>'target-pwd'</emphasis>.</screen>

    <para>Les valeurs définies ci-dessus doivent être reportées dans la
    configuration du service <application>open-iscsi</application> sur le
    système <wordasword>Initiator</wordasword>.</para>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment régler les paramètres d'authentification
    <acronym>CHAP</acronym> sur le système <wordasword>Initiator</wordasword>
    &nbsp;?</phrase></para>

    <para>Recherchez dans le fichier de configuration principal du rôle
    <wordasword>Initiator</wordasword> les paramètres relatifs à
    l'authentification.</para>

    <para>Libérez la session existante avant d'ajouter les authentifiants à la
    configuration du service <application>open-iscsi</application>.</para>

    <para>Effacez l'enregistrement obtenu avec l'instruction de découverte
    utilisée précédemment.</para>
    </question>
    <answer>
    <para>Commencez par libérer la session.</para>
<screen>sudo iscsiadm -m node -U all</screen>
<screen>Logging out of session [sid: 1,
    target: iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8,
    portal: 2001:678:3fc:171:baad:caff:fefe:5,3260]
Logout of [sid: 1,
    target: iqn.2003-01.org.linux-iscsi.target.x8664:sn.5fc599ddeef8,
    portal: 2001:678:3fc:171:baad:caff:fefe:5,3260] <emphasis>successful</emphasis>.</screen>

    <para>Effacez ensuite l'enregistrement de découverte du portail depuis le
    rôle <wordasword>Initiator</wordasword>.</para>
<screen>sudo iscsiadm -m discoverydb \
    -t sendtargets \
    -p [2001:678:3fc:171:baad:caff:fefe:5]:3260 \
    -o <emphasis>delete</emphasis></screen>

    <para>Le nom d'utilisateur et le mot de passe sont définis dans le fichier
    <filename>/etc/iscsi/iscsid.conf</filename> du système
    <wordasword>Initiator</wordasword>.</para>

<screen>sudo grep -m1 -A30 CHAP /etc/iscsi/iscsid.conf</screen>
<screen># CHAP Settings
# *************

# To enable CHAP authentication set node.session.auth.authmethod
# to CHAP. The default is None.
#
# NOTE: currently this attribute is checked for validity but then
# ignored, so even if it is set to None, CHAP will be used if the
# credentials (username/password and possibly username_in/password_in)
# are set. This behavior is deprecated, and in the future CHAP will
# not be used if authmethod is set to None.
#
<emphasis>#node.session.auth.authmethod = CHAP</emphasis>

# To configure which CHAP algorithms to enable, set
# node.session.auth.chap_algs to a comma separated list.
# The algorithms should be listed in order of decreasing
# preference - in particular, with the most preferred algorithm first.
# Valid values are MD5, SHA1, SHA256, and SHA3-256.
# The default is MD5.
#node.session.auth.chap_algs = SHA3-256,SHA256,SHA1,MD5

# To set a CHAP username and password for initiator
# authentication by the target(s), uncomment the following lines:
<emphasis>#node.session.auth.username = username</emphasis>
<emphasis>#node.session.auth.password = password</emphasis>

# To set a CHAP username and password for target(s)
# authentication by the initiator, uncomment the following lines:
<emphasis>#node.session.auth.username_in = username_in</emphasis>
<emphasis>#node.session.auth.password_in = password_in</emphasis></screen>

    <para>Éditez les lignes du fichier
    <filename>/etc/iscsi/iscsid.conf</filename> avec les valeurs définies dans
    la configuration du rôle <wordasword>Target</wordasword>.</para>

<screen>sudo sed \
-i 's/^#node.session.auth.authmethod = CHAP/node.session.auth.authmethod = CHAP/' \
/etc/iscsi/iscsid.conf</screen>

<screen>sudo sed \
-i 's/^#node.session.auth.username = username/node.session.auth.username = SAN-lab-user/' \
/etc/iscsi/iscsid.conf</screen>

<screen>sudo sed \
-i 's/^#node.session.auth.password = password/node.session.auth.password = SAN-lab-pwd/' \
/etc/iscsi/iscsid.conf</screen>

<screen>sudo sed \
-i 's/^#node.session.auth.username_in =.*/node.session.auth.username_in = target-user/' \
/etc/iscsi/iscsid.conf</screen>

<screen>sudo sed \
-i 's/^#node.session.auth.password_in = .*/node.session.auth.password_in = target-pwd/' \
/etc/iscsi/iscsid.conf</screen>

    <para>relancez le service <application>open-iscsi</application> pour
    prendre en compte les modifications effectuées sur la configuration du rôle
    <wordasword>Initiator</wordasword>.</para>

<screen>sudo systemctl restart open-iscsi.service</screen>

    <para>Lancez une nouvelle découverte du portail
    <acronym>iSCSI</acronym>.</para>

<screen>sudo iscsiadm -m discovery \
    --type sendtargets \
    --portal=[2001:678:3fc:171:baad:caff:fefe:5]</screen>

    <para>Lancez une nouvelle ouverture de session.</para>

<screen>sudo iscsiadm -m node \
    -T iqn.2003-01.org.linux-iscsi.target.x8664:sn.cd547a636fe7 \
    -p [2001:678:3fc:171:baad:caff:fefe:5]:3260 \
    --login</screen>

    <para>Relevez les informations de session.</para>

<screen>sudo iscsiadm -m session
tcp: [1] [2001:678:3fc:171:baad:caff:fefe:5]:3260,1 \
    iqn.2003-01.org.linux-iscsi.target.x8664:sn.cd547a636fe7 (non-flash)</screen>
    </answer>
    </qandaentry>
  </qandaset>

    <para>Une fois la session établie, une authentification sécurisée est en
    place entre les rôles <wordasword>Target</wordasword> et
    <wordasword>Initiator</wordasword>.</para>

    <para>Cependant, si le mécanisme d'authentification est valide,
    l'algorithme de chiffrement pose problème. En effet, le protocole
    <acronym>MD5</acronym> ne garantit pas un niveau de sécurité
    suffisant.</para>

    <para>Nous devons attendre une nouvelle version de la pile LIO du noyau
    Linux pour bénéficier de l'algorithme <acronym>SHA3-256</acronym>.</para>
<screen>sudo iscsiadm -m node -o show | grep -i chap</screen>
<screen>iface.chap_auth = &lt;empty>
iface.bidi_chap = &lt;empty>
node.session.auth.authmethod = CHAP
<emphasis>node.session.auth.chap_algs = MD5</emphasis></screen>

</sect1>

<sect1 xml:id='sysadm-net.iscsi.raid1'>
  <title>Configuration d'une unité logique RAID&nbsp;1</title>

  <para>Dans cette partie, vous allez créer une unité logique
  <acronym>RAID&nbsp;1</acronym> composée d'un de disque local et d'un disque
  <acronym>iSCSI</acronym> afin d'illustrer une solution de réplication
  synchrone. En effet, dans un volume <acronym>RAID&nbsp;1</acronym>, chaque
  disque contient à tout moment exactement les mêmes données. Ici, le contenu
  de l'unité de disque locale est identique à celui de l'unité de disque
  réseau. Cette réplication est dite synchrone, car toute écriture locale est
  dupliquée sur le réseau de stockage <acronym>iSCSI</acronym>.</para>

  <sect2 xml:id='sysadm-net.iscsi.raid1.config'>
    <title>Sélection du paquet et création de l'unité RAID&nbsp;1</title>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para><phrase>Quel est le paquet qui contient les outils de configuration
      et de gestion des différents types d'unités <acronym>RAID</acronym>
      logicielles&nbsp;? Installer ce paquet et identifier l'outil d'administration
      de tableau <acronym>RAID</acronym> logiciel.</phrase></para>

      <para>Effectuer une recherche dans les descriptions de paquets avec
      l'acronyme clé <acronym>RAID</acronym>.</para>
    </question>
    <answer>

<screen>apt -o "Apt::Cmd::Disable-Script-Warning=1" search raid |\
  grep -B2 administration

p   mdadm   - outil d'administration d'ensembles RAID</screen>

<screen>sudo apt install mdadm</screen>

      <para>Une fois le paquet installé, listez son
      contenu et identifez les commandes utilisateur.</para>

<screen>dpkg -L mdadm | grep bin</screen>
<screen>/usr/sbin
/usr/sbin/mdadm
/usr/sbin/mdmon</screen>
      </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Recherchez la syntaxe d'appel à l'outil identifié dans la
      question précédente pour créer l'unité de stockage
      <acronym>RAID&nbsp;1</acronym>&nbsp;?</phrase></para>

      <para>Exécutez cette commande et relevez les messages obtenus.</para>
    </question>
    <answer>
    <para>Après s'être assuré qu'aucune table de partition n'existe sur les
    deux unités constituant le tableau, on obtient le résultat suivant.</para>

<screen><prompt>$</prompt> sudo mdadm --create /dev/md0 --level=raid1 --raid-devices=2 /dev/sda /dev/vdb
mdadm: Note: this array has metadata at the start and
    may not be suitable as a boot device.  If you plan to
    store '/boot' on this device please ensure that
    your boot-loader understands md/v1.x metadata, or use
    --metadata=0.90
Continue creating array? y
mdadm: Defaulting to version 1.2 metadata
mdadm: array /dev/md0 started.</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.raid1.manage'>
    <title>Manipulations sur l'unité de disque RAID&nbsp;1</title>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para><phrase>Comment connaître l'état de l'unité logique
      <acronym>RAID&nbsp;1</acronym>&nbsp;?</phrase></para>

      <para>Effectuer une recherche dans le système de fichiers virtuel
      <filename class='directory'>/proc/</filename>.</para>
    </question>
    <answer>
      <para>Exemple du tableau créé lors l'exécution de la commande de la
      question précédente.</para>

<screen><prompt>$</prompt> cat /proc/mdstat
Personalities : [raid1]
md0 : active raid1 vdb[1] sda[0]
      33537920 blocks super 1.2 [2/2] [UU]

unused devices: &lt;none></screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
      <para><phrase>Comment afficher la liste des propriétés de l'unité logique
      <acronym>RAID&nbsp;1</acronym>&nbsp;?</phrase></para>

      <para>Effectuer une recherche dans les options de la commande
      d'administration.</para>
    </question>
    <answer>
<screen><prompt>$</prompt> sudo mdadm --detail /dev/md0
/dev/md0:
           Version : 1.2
     Creation Time : Sat Sep  3 18:07:32 2022
        Raid Level : raid1
        Array Size : 33520640 (31.97 GiB 34.33 GB)
     Used Dev Size : 33520640 (31.97 GiB 34.33 GB)
      Raid Devices : 2
     Total Devices : 2
       Persistence : Superblock is persistent

       Update Time : Sat Sep  3 18:09:18 2022
             State : clean, resyncing
    Active Devices : 2
   Working Devices : 2
    Failed Devices : 0
     Spare Devices : 0

Consistency Policy : resync

     Resync Status : 65% complete

              Name : initiator:0  (local to host initiator)
              UUID : e3da1d56:9df89f79:866d5607:eeb2beff
            Events : 11

    Number   Major   Minor   RaidDevice State
       0       8        0        0      active sync   /dev/sda
       1     254       16        1      active sync   /dev/vdb/</screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
      <para><phrase>Comment rendre la configuration du tableau
      <acronym>RAID&nbsp;1</acronym> permanente au niveau système&nbsp;?</phrase></para>

      <para>Effectuer une recherche dans les options de la commande
      d'administration.</para>
    </question>
    <answer>
      <para>C'est le fichier <filename>/etc/mdadm/mdadm.conf</filename> qui
      contient les directives de configuration. On ajoute en fin de ce fichier
      la définition du tableau créé plus haut.</para>

<screen><prompt>$</prompt> sudo mdadm --detail --scan | sudo tee -a /etc/mdadm/mdadm.conf</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.lvm-snapshot'>
  <title>Configuration d'un volume logique et de sa sauvegarde</title>

  <para>L'objectif de cette partie est de créer un mécanisme de sauvegarde
  réseau automatisé en s'appuyant sur la notion de «prise de vue» ou
  <wordasword>snapshot</wordasword> proposée par le gestionnaire de volume
  logique <acronym>LVM</acronym>. Dans un instantané, on ne stocke que les
  différences relativement au volume logique original.</para>

  <qandaset>
    <qandaentry>
    <question>
	  <para><phrase>Quel est le paquet associé à la gestion de volume logique
	  <acronym>LVM</acronym>&nbsp;?</phrase></para>

	  <para>Rechercher et installer le paquet qui permet de créer et gérer des
	  volumes physiques, logiques ainsi que des groupes.</para>
    </question>
    <answer>
	  <para>En anglais, on parle de <wordasword>Logical Volume
	  Manager</wordasword> ou <acronym>LVM</acronym>. On cherche donc un paquet
	  avec la chaîne 'lvm'.</para>

<screen><prompt>$</prompt> aptitude search ^lvm
p   lvm2           - gestionnaire de volumes logiques de Linux
p   lvm2-dbusd     - démon D-Bus pour LVM2
p   lvm2-lockd     - démon de verrouillage pour LVM</screen>

<screen><prompt>$</prompt> sudo apt install lvm2</screen>
    </answer>
    </qandaentry>

	<qandaentry>
	<question>
	  <para><phrase>Comment créer un volume physique associé au tableau RAID&nbsp;1
	  précédemment créé&nbsp;?</phrase></para>

      <para>Rechercher dans la liste des outils ceux qui correspondent à la
      gestion de volume physique (PV).</para>
	</question>
	<answer>
	  <para>L'instruction de recherche habituelle est de la forme&nbsp;:</para>

<screen><prompt>$</prompt> dpkg -L lvm2 | grep bin</screen>

	  <para>Ce sont les outils dont le nom commence par 'pv' qui servent à
	  manipuler les volumes physiques.</para>

<screen><prompt>$</prompt> sudo pvcreate --help</screen>

	  <para>Création du volume physique.</para>

<screen><prompt>$</prompt> sudo pvcreate /dev/md0
  Physical volume "/dev/md0" successfully created.</screen>

	  <para>Affichage résumé de l'état du volume physique.</para>

<screen><prompt>$</prompt> sudo pvs
  PV         VG Fmt  Attr PSize   PFree
  /dev/md0      lvm2 ---  &lt;31,97g &lt;31,97g</screen>

	  <para>Affichage détaillé de l'état du volume physique.</para>

<screen><prompt>$</prompt> sudo pvdisplay
  "/dev/md0" is a new physical volume of "&lt;31,97 GiB"
  --- NEW Physical volume ---
  PV Name               /dev/md0
  VG Name
  PV Size               &lt;31,97 GiB
  Allocatable           NO
  PE Size               0
  Total PE              0
  Free PE               0
  Allocated PE          0
  PV UUID               vUlk3p-dzZJ-MyLZ-hMcU-P9dH-oQuB-2lptum</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
      <para><phrase>Comment créer un groupe de volumes contenant le tableau
      RAID&nbsp;1&nbsp;?</phrase></para>

      <para>Rechercher dans la liste des outils ceux qui correspondent à la
      gestion de groupes de volumes (VG).</para>
	</question>
	<answer>
      <para>À partir du résultat de la commande de recherche de la question
      précédente, relevez le fait que ce sont les outils dont le nom commence
      par 'vg' qui servent à manipuler les groupes de volumes.</para>

<screen><prompt>$</prompt> sudo vgcreate --help</screen>

      <para>Création du groupe de volumes avec un unique volume
      physique.</para>

<screen><prompt>$</prompt> sudo vgcreate lab-vg /dev/md0
  Volume group "lab-vg" successfully created</screen>

	  <para>Affichage résumé de l'état du volume physique.</para>

<screen><prompt>$</prompt> sudo vgs
  VG         #PV #LV #SN Attr   VSize  VFree
  lab-vg   1   0   0 wz--n- 31,96g 31,96g</screen>

	  <para>Affichage détaillé de l'état du volume physique.</para>

<screen><prompt>$</prompt> sudo vgdisplay
  --- Volume group ---
  VG Name               lab-vg
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  1
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                0
  Open LV               0
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               31,96 GiB
  PE Size               4,00 MiB
  Total PE              8183
  Alloc PE / Size       0 / 0
  Free  PE / Size       8183 / 31,96 GiB
  VG UUID               KIq2zb-emxQ-JiT0-6wAk-tPlO-MmrN-wxzkLl</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	  <para><phrase>Comment créer un volume logique à l'intérieur du groupe
	  contenant le tableau <acronym>RAID&nbsp;1</acronym>&nbsp;?</phrase></para>

      <para>Rechercher dans la liste des outils ceux qui correspondant à la
      gestion des volumes logiques (LV).</para>

	  <para>Dans cet exemple, nous allons créer un volume logique de 16Go pour
	  une capacité de 32Go. En situation réelle, il faudrait remplacer les
	  gigaoctets par des téraoctets.</para>
	</question>
	<answer>
	  <para>Toujours à partir du résultat de la commande de recherche des deux
	  questions précédentes, relevez que ce sont les outils dont le nom
	  commence par 'lv' qui servent à manipuler les volumes logiques.</para>

<screen><prompt>$</prompt> sudo lvcreate --help</screen>

	  <para>Création du volume logique de 16Go.</para>

<screen><prompt>$</prompt> sudo lvcreate --size 16Go lab-vg
  Logical volume "lvol0" created.</screen>

	  <para>Affichage résumé de l'état du volume logique.</para>

<screen><prompt>$</prompt> sudo lvs
  LV    VG         Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lvol0 lab-vg -wi-a----- 16,00g</screen>

	  <para>Affichage détaillé de l'état du volume logique.</para>

<screen><prompt>$</prompt> sudo lvdisplay
  --- Logical volume ---
  LV Path                /dev/lab-vg/lvol0
  LV Name                lvol0
  VG Name                lab-vg
  LV UUID                8UFwye-RMgA-hzY4-8nnv-h7nK-09GA-Ff2AT2
  LV Write Access        read/write
  LV Creation host, time initiator, 2022-09-05 14:27:28 +0200
  LV Status              available
  # open                 0
  LV Size                16,00 GiB
  Current LE             4096
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           252:0</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	  <para><phrase>Comment créer un système de fichiers sur le nouveau volume
	  logique&nbsp;?</phrase></para>

	  <para>Reprendre les traitements de la <xref
	  linkend='sysadm-net.iscsi.storage' /> avec le nom du volume logique
	  obtenu à la question précédente.</para>
	</question>
	<answer>
	  <para>Formatage du système de fichiers.</para>

<screen><prompt>$</prompt> sudo mkfs.ext4 /dev/lab-vg/lvol0
mke2fs 1.46.5 (30-Dec-2021)
Discarding device blocks: done
Creating filesystem with 4194304 4k blocks and 1048576 inodes
Filesystem UUID: d94a59f2-7c67-4be7-9643-d646d1dbe2a4
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
        4096000

Allocating group tables: done
Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	  <para><phrase>Comment monter et accéder au nouveau système de
	  fichiers&nbsp;?</phrase></para>

	  <para>Créer un sous dossier au niveau <filename
	  class='directory'>/mnt</filename> et monter le nouveau système de
	  fichiers manuellement.</para>
	</question>
	<answer>
	  <para>Exemple de résultats attendus.</para>

<screen><prompt>$</prompt> sudo mkdir /mnt/lvol0

<prompt>$</prompt> sudo mount /dev/lab-vg/lvol0 /mnt/lvol0/

<prompt>$</prompt> mount | grep lvol0
/dev/mapper/lab--vg-lvol0 on /mnt/lvol0 type ext4 (rw,relatime)</screen>

	  <para>Une fois le système de fichiers monté, il est possible de créer des
	  dossiers et des fichiers avec les permissions adaptées. Voici un exemple
	  avec une attribution de dossier à l'utilisateur normal
	  <systemitem>etu</systemitem>.</para>

<screen><prompt>$</prompt> sudo mkdir /mnt/lvol0/etu-files
<prompt>$</prompt> sudo chown etu.etu /mnt/lvol0/etu-files
<prompt>$</prompt> touch /mnt/lvol0/etu-files/my-first-file</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	  <para><phrase>Comment visualiser l'état global des systèmes de fichiers
	  et des montages en cours&nbsp;?</phrase></para>

	  <para>Utiliser les commandes usuelles telles que <command>df</command> et
	  <command>lsblk</command>.</para>
	</question>
	<answer>
	  <para>Exemple de résultat attendu.</para>

<screen><prompt>$</prompt> df -hT
Sys. de fichiers          Type     Taille Utilisé Dispo Uti% Monté sur
udev                      devtmpfs   463M       0  463M   0% /dev
tmpfs                     tmpfs       97M    700K   97M   1% /run
/dev/vda2                 ext4       117G    2,0G  109G   2% /
tmpfs                     tmpfs      484M       0  484M   0% /dev/shm
tmpfs                     tmpfs      5,0M       0  5,0M   0% /run/lock
/dev/vda1                 vfat       511M    3,5M  508M   1% /boot/efi
tmpfs                     tmpfs       97M       0   97M   0% /run/user/1000
/dev/mapper/lab--vg-lvol0 ext4        16G     28K   15G   1% /mnt/lvol0</screen>

<screen><prompt>$</prompt> lsblk
NAME              MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
sda                 8:0    0    32G  0 disk
sdb                 8:16   0    32G  0 disk
└─md0               9:0    0    32G  0 raid1
  └─lab--vg-lvol0 252:0    0    16G  0 lvm   /mnt/lvol0
sr0                11:0    1  1024M  0 rom
vda               254:0    0   120G  0 disk
├─vda1            254:1    0   512M  0 part  /boot/efi
├─vda2            254:2    0 118,5G  0 part  /
└─vda3            254:3    0   977M  0 part  [SWAP]
vdb               254:16   0    32G  0 disk
└─md0               9:0    0    32G  0 raid1
  └─lab--vg-lvol0 252:0    0    16G  0 lvm   /mnt/lvol0</screen>

	  <para>Cette dernière commande illustre bien l'état de la réplication
	  <acronym>RAID&nbsp;1</acronym> en plus de l'utilisation du volume
	  logique.</para>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	  <para><phrase>Comment créer deux instantanés du volume
	  logique avec des jeux de fichiers différents&nbsp;?</phrase></para>

	  <para>Après avoir créé une série de fichiers, recherchez les options de
	  la commande <command>lvcreate</command> qui permettent de créer la
	  première prise de vue (<wordasword>snapshot</wordasword>).</para>
	</question>
	<answer>
	  <para>Création de 10 fichiers vides.</para>

<screen><prompt>$</prompt> for i in {1..10}
do
	touch /mnt/lvol0/etu-files/first-$(printf "%02d" $i)-file
done

<prompt>$</prompt> ls -1 /mnt/lvol0/etu-files/
first-01-file
first-02-file
first-03-file
first-04-file
first-05-file
first-06-file
first-07-file
first-08-file
first-09-file
first-10-file
my-first-file</screen>

	  <para>Première capture instantanée du système de fichiers.</para>

<screen><prompt>$</prompt> sudo lvcreate --snapshot --name first-snap -L 500M /dev/lab-vg/lvol0
  Logical volume "first-snap" created.</screen>

	  <para>Création de 10 nouveaux fichiers vides.</para>

<screen><prompt>$</prompt> for i in {1..10}
do
    touch /mnt/lvol0/etu-files/second-$(printf "%02d" $i)-file
done

<prompt>$</prompt> ls -1 /mnt/lvol0/etu-files/
first-01-file
first-02-file
first-03-file
first-04-file
first-05-file
first-06-file
first-07-file
first-08-file
first-09-file
first-10-file
my-first-file
second-01-file
second-02-file
second-03-file
second-04-file
second-05-file
second-06-file
second-07-file
second-08-file
second-09-file
second-10-file</screen>

	  <para>Seconde capture instantanée du système de fichiers.</para>

<screen><prompt>$</prompt> sudo lvcreate --snapshot --name second-snap -L 500M /dev/lab-vg/lvol0
  Logical volume "second-snap" created.</screen>

	  <para>État du volume logique.</para>

<screen><prompt>$</prompt> sudo lvs
LV          VG     Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  first-snap  lab-vg swi-a-s--- 500,00m      lvol0  0,01
  lvol0       lab-vg owi-aos---  16,00g
  second-snap lab-vg swi-a-s--- 500,00m      lvol0  0,01</screen>
	</answer>
	</qandaentry>

	<qandaentry>
	<question>
	  <para><phrase>Comment tester la restauration du système de fichiers à
	  partir des instantanés&nbsp;?</phrase></para>

	  <para>Après avoir supprimé tous les fichiers du dossier <filename
	  class='directory'>/mnt/lvol0/etu-files/</filename>, restaurez le
	  contenu des deux prises de vues dans l'ordre.</para>
	</question>
	<answer>
	  <para>Supprimez des fichiers du répertoire de travail.</para>

<screen><prompt>$</prompt> rm /mnt/lvol0/etu-files/*</screen>

	  <para>Restaurez à partir du premier instantané.</para>

<screen><prompt>$</prompt> sudo lvconvert --merge /dev/lab-vg/first-snap
  Delaying merge since origin is open.
  Merging of snapshot lab-vg/first-snap will occur on next activation of lab-vg/lvol0.</screen>

	  <para>Pour que la restauration soit effective, il est nécessaire de
	  désactiver/réactiver le volume logique à l'aide de la commande
	  <command>lvchange</command>.</para>

<screen><prompt>$</prompt> sudo lvchange --activate n lab-vg/lvol0
  Logical volume lab-vg/lvol0 is used by another device.</screen>

	  <para>Aïe&nbsp;! Le volume logique est en cours d'utilisation. On doit
	  donc démonter le système de fichiers et tester à nouveau.</para>

<screen><prompt>$</prompt> sudo umount /mnt/lvol0
<prompt>$</prompt> sudo lvchange --activate n lab-vg/lvol0</screen>

	  <para>Cette fois ci, le volume est enfin désactivé. On peut le
	  réactiver.</para>

<screen><prompt>$</prompt> sudo lvchange --activate y lab-vg/lvol0</screen>

<screen><prompt>$</prompt> sudo lvscan
  ACTIVE   Original '/dev/lab-vg/lvol0' [16,00 GiB] inherit
  ACTIVE   Snapshot '/dev/lab-vg/second-snap' [500,00 MiB] inherit</screen>

	<para>La partition est bien disponible et on a retrouvé la liste des
	fichiers du premier instantané.</para>

<screen><prompt>$</prompt> sudo mount /dev/lab-vg/lvol0 /mnt/lvol0/

<prompt>$</prompt> ls -1 /mnt/lvol0/etu-files/
first-01-file
first-02-file
first-03-file
first-04-file
first-05-file
first-06-file
first-07-file
first-08-file
first-09-file
first-10-file
my-first-file</screen>

	  <para>Pour restaurer le contenu du second instantané, reprenez
	  les mêmes opérations à partir de la commande
	  <command>lvconvert</command>.</para>
	</answer>
	</qandaentry>
  </qandaset>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.raid-rebuild'>
  <title>Perte d'une unité de disque du tableau RAID&nbsp;1</title>

  <para>L'objectif de cette partie est de simuler la perte d'une unité de
  disque du tableau <acronym>RAID&nbsp;1</acronym> et de provoquer la reconstruction
  de ce tableau depuis l'unité de disque réseau <acronym>iSCSI</acronym>. On
  illustre ainsi le mécanisme de tolérance aux pannes en plus de l'utilisation
  des <wordasword>snapshots</wordasword> du gestionnaire de volumes logiques
  <acronym>LVM</acronym>.</para>

  <qandaset>
    <qandaentry>
    <question>
	  <para><phrase>Comment provoquer une panne de disque côté
	  <wordasword>Initiator</wordasword>&nbsp;?</phrase></para>
	</question>
	<answer>
	  <orderedlist>
	  <listitem>
		<para>Extinction de la machine virtuelle avec le rôle
		<wordasword>Initiator</wordasword>.</para>
	  </listitem>
	  <listitem>
		<para>Suppression du fichier image du disque supplémentaire de la
		machine virtuelle.</para>
	  </listitem>
	  <listitem>
	    <para>Redémarrage de la même machine virtuelle.</para>
	  </listitem>
	  </orderedlist>
	</answer>
	</qandaentry>
  </qandaset>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.bench'>
  <title>Évaluation des performances</title>

  <para>Pour obtenir des résultats fiables avec <command>sysbench</command>, un
  temps d'exécution de plusieurs heures est nécessaire. Les résultats donnés
  ici ne sont que des échantillons.</para>

<screen><prompt>$</prompt> sudo apt install sysbench</screen>

  <variablelist>
    <varlistentry xml:id='sysadm-net.iscsi.bench.local'>
      <term>Unité de disque locale</term>
      <listitem>
      <para>Système de fichiers <option>ext4</option>.</para>

<screen><prompt>$</prompt> mkdir /var/tmp/benchmark

<prompt>$</prompt> cd /var/tmp/benchmark/</screen>

<screen><prompt>$</prompt> sysbench fileio prepare</screen>

<screen><prompt>$</prompt> sysbench fileio --file-test-mode=rndrw run
sysbench 1.0.20 (using system LuaJIT 2.1.0-beta3)

Running the test with following options:
Number of threads: 1
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      6062.94
    writes/s:                     4041.90
    fsyncs/s:                     12939.18

Throughput:
    <emphasis>read, MiB/s:                  94.73</emphasis>
    <emphasis>written, MiB/s:               63.15</emphasis>

General statistics:
    total time:                          10.0062s
    total number of events:              230569

Latency (ms):
         min:                                    0.00
         avg:                                    0.04
         max:                                  133.67
         95th percentile:                        0.15
         sum:                                 9943.24

Threads fairness:
    events (avg/stddev):           230569.0000/0.00
    execution time (avg/stddev):   9.9432/0.00</screen>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>Volume logique <acronym>LVM</acronym> sur une unité de disque
      <acronym>RAID&nbsp;1</acronym> avec un membre
      <acronym>iSCSI</acronym></term>
      <listitem>
      <para>Système de fichiers <option>ext4</option>.</para>

<screen><prompt>$</prompt> mkdir /mnt/lvol0/etu-files/benchmark

<prompt>$</prompt> cd /mnt/lvol0/etu-files/benchmark</screen>

<screen><prompt>$</prompt> sysbench fileio prepare</screen>

<screen><prompt>$</prompt> sysbench fileio --file-test-mode=rndrw run
sysbench 1.0.20 (using system LuaJIT 2.1.0-beta3)

Running the test with following options:
Number of threads: 1
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!

File operations:
    reads/s:                      1309.93
    writes/s:                     873.29
    fsyncs/s:                     2799.10

Throughput:
    <emphasis>read, MiB/s:                  20.47</emphasis>
    <emphasis>written, MiB/s:               13.65</emphasis>

General statistics:
    total time:                          10.0295s
    total number of events:              49850

Latency (ms):
         min:                                    0.00
         avg:                                    0.20
         max:                                   31.26
         95th percentile:                        0.59
         sum:                                 9978.89

Threads fairness:
    events (avg/stddev):           49850.0000/0.00
    execution time (avg/stddev):   9.9789/0.00</screen>
      </listitem>
    </varlistentry>
  </variablelist>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.conclusion'>
	<title>Conclusion</title>

    <para>Ce support de travaux pratiques offre une approche complète et
    progressive des technologies de stockage réseau modernes. Grâce à la
    manipulation concrète des protocoles <acronym>iSCSI</acronym>, de la
    redondance RAID&nbsp;1 et de la gestion <acronym>LVM</acronym>, les
    étudiants acquièrent une expérience pratique essentielle pour comprendre
    les enjeux de la haute disponibilité et de la sauvegarde dans un
    environnement professionnel.</para>

    <para>L'association de ces différentes technologies (stockage réseau,
    réplication synchrone, instantanés) illustre parfaitement la manière de
    construire une infrastructure robuste et évolutive. Les exercices proposés,
    de la configuration de base à l'évaluation des performances, préparent
    efficacement aux défis techniques du stockage en entreprise, tout en
    permettant de développer une compréhension approfondie des mécanismes
    sous-jacents.</para>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.refdocs'>
	<title>Documents de référence</title>

	<variablelist>
	<varlistentry xml:id='sysadm-net.iscsi.infra.moodle'>
	<term><citetitle>Architecture réseau des travaux pratiques</citetitle></term>
	<listitem>
	<para>&url.infra.moodle;&nbsp;: présentation de l'implantation des équipements
	d'interconnexion réseau dans les armoires de brassage et du plan d'adressage
	<acronym>IP</acronym> prédéfini pour l'ensemble des séances de travaux
	pratiques.</para>
	</listitem>
	</varlistentry>

	<varlistentry xml:id='sysadm-net.iscsi.config.interface.lan'>
	<term><citetitle>Configuration d'une interface réseau</citetitle></term>
	<listitem>
	<para>&url.config.interface.lan;&nbsp;: tout sur la configuration des
	interfaces réseau de réseau local.</para>
	</listitem>
	</varlistentry>

	<varlistentry xml:id='sysadm-net.iscsi.debian.wiki'>
	<term><citetitle>iSCSI - Debian Wiki</citetitle></term>
	<listitem>
	<para>La page &url.iscsi.debian.wiki; contient deux sous-rubriques sur les
	rôles <wordasword>Initiator</wordasword> et
	<wordasword>Target</wordasword>.</para>
	</listitem>
	</varlistentry>
	</variablelist>
</sect1>
</article>
